<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‰∏äÊµ∑Êï≤È∫ª - Â§ö‰∫∫ËÅîÊú∫Áâà | AIÂ∞èÊ∏∏ÊàèÂπ≥Âè∞</title>
    <!-- È¢ÑÂä†ËΩΩÂÖ≥ÈîÆËµÑÊ∫ê -->
    <link rel="preload" href="/img/majiang.png" as="image" fetchpriority="high">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            --table-green: #1a5c3a;
            --table-dark: #0d3321;
            --gold: #d4af37;
            --gold-light: #f4d03f;
            --tile-bg: #f5f0e1;
            --tile-border: #c9b896;
            --red: #c0392b;
            --blue: #2980b9;
            --green: #27ae60;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Ê®™Â±èÊèêÁ§∫ */
        .rotate-hint {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .rotate-hint .icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: rotate-phone 1.5s ease-in-out infinite;
        }
        
        @keyframes rotate-phone {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
        }
        
        .rotate-hint h2 {
            font-size: 1.5rem;
            color: var(--gold);
            margin-bottom: 10px;
        }
        
        .rotate-hint p {
            color: rgba(255,255,255,0.7);
            font-size: 1rem;
        }
        
        /* ÊâãÊú∫Á´ñÂ±èÊó∂ÊòæÁ§∫ÊèêÁ§∫ÔºàÊ∏∏ÊàèÁïåÈù¢ÊøÄÊ¥ªÊó∂Ôºâ */
        @media (max-width: 768px) and (orientation: portrait) {
            body.in-game .rotate-hint {
                display: flex;
            }
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: radial-gradient(ellipse at center, var(--table-green) 0%, var(--table-dark) 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        /* ÈÄöÁî®ÂÆπÂô® */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .screen.active { display: flex; }

        /* Â§ßÂéÖÁïåÈù¢ */
        .lobby-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 3.5rem;
            color: var(--gold);
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .lobby-subtitle {
            font-size: 1.2rem;
            color: rgba(255,255,255,0.8);
            margin-bottom: 30px;
        }

        .lobby-container {
            background: rgba(0,0,0,0.4);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 100%;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--gold);
            font-size: 1.1rem;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            border: 2px solid var(--gold);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            outline: none;
            text-transform: uppercase;
        }

        .input-group input::placeholder {
            color: rgba(255,255,255,0.5);
            text-transform: none;
        }

        /* ËØ≠Èü≥ÈÄâÊã©Âô® */
        .voice-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .voice-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px 12px;
            font-size: 0.9rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .voice-btn:hover {
            border-color: var(--gold);
            color: #fff;
        }
        
        .voice-btn.active {
            border-color: var(--gold);
            background: linear-gradient(135deg, rgba(212,175,55,0.3) 0%, rgba(184,134,11,0.3) 100%);
            color: var(--gold);
            font-weight: bold;
        }
        
        .voice-btn i {
            font-size: 1rem;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 16px 30px;
            margin: 12px 0;
            font-size: 1.2rem;
            font-family: 'Ma Shan Zheng', cursive;
            background: linear-gradient(135deg, var(--gold) 0%, #b8860b 100%);
            color: #1a1a1a;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212,175,55,0.4);
        }

        .btn.secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 2px solid var(--gold);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 25px 0;
            color: rgba(255,255,255,0.5);
        }

        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.3);
        }

        .divider span {
            padding: 0 15px;
        }

        /* ÊàøÈó¥ÁïåÈù¢ */
        .room-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .room-code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 2.8rem;
            font-weight: bold;
            color: var(--gold);
            letter-spacing: 6px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid var(--gold);
        }

        .room-code-label {
            font-size: 1rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 5px;
        }

        .copy-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .room-container {
            background: rgba(0,0,0,0.4);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .player-slot {
            background: rgba(255,255,255,0.1);
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .player-slot.filled {
            border-style: solid;
            border-color: var(--gold);
            background: rgba(212,175,55,0.1);
        }

        .player-slot.ready {
            border-color: var(--green);
            background: rgba(39,174,96,0.2);
        }

        .player-avatar {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .player-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .player-wind {
            font-size: 0.9rem;
            color: var(--gold);
        }

        .player-status {
            font-size: 0.85rem;
            margin-top: 5px;
            padding: 3px 12px;
            border-radius: 10px;
        }

        .player-status.ready {
            background: var(--green);
            color: #fff;
        }

        .player-status.waiting {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }

        .player-status.host {
            background: var(--gold);
            color: #1a1a1a;
        }

        .empty-slot {
            color: rgba(255,255,255,0.5);
            font-size: 1rem;
        }

        .room-actions {
            display: flex;
            gap: 15px;
        }

        .room-actions .btn {
            flex: 1;
        }

        /* Ê∏∏ÊàèÁïåÈù¢ */
        .game-screen {
            padding: 10px;
            justify-content: flex-start;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 900px;
            padding: 10px 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .game-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .game-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .game-info-icon {
            width: 30px;
            height: 30px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a1a;
            font-weight: bold;
        }

        /* È∫ªÂ∞ÜÊ°å */
        .mahjong-table {
            background: radial-gradient(ellipse at center, #2d8b57 0%, #1a5c3a 50%, #0d3321 100%);
            border: 8px solid #5d4037;
            border-radius: 20px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.3), 0 10px 30px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 900px;
            aspect-ratio: 4/3;
            position: relative;
            display: grid;
            grid-template-rows: 1fr 2fr 1fr;
            grid-template-columns: 1fr 2fr 1fr;
            padding: 15px;
            gap: 10px;
        }

        /* Áé©ÂÆ∂Âå∫Âüü */
        .seat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .seat-top { grid-row: 1; grid-column: 2; }
        .seat-left { grid-row: 2; grid-column: 1; }
        .seat-right { grid-row: 2; grid-column: 3; }
        .seat-bottom { grid-row: 3; grid-column: 2; }

        .seat-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .seat-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--gold) 0%, #b8860b 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            border: 2px solid white;
        }

        .seat-avatar.current-turn {
            animation: pulse 1s infinite;
            box-shadow: 0 0 15px var(--gold);
        }
        
        /* „ÄêÊñ∞Â¢û„ÄëÁ¶ªÁ∫øÁé©ÂÆ∂Ê†∑Âºè */
        .seat-avatar.offline {
            filter: grayscale(100%);
            opacity: 0.5;
        }
        
        .seat-info.offline .seat-name::after {
            content: ' (Á¶ªÁ∫ø)';
            color: #ff6b6b;
            font-size: 0.7rem;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .seat-name {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .seat-wind {
            background: var(--red);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .seat-tiles {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* ‰∏≠Â§ÆÂå∫Âüü */
        .table-center {
            grid-row: 2;
            grid-column: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .discard-area {
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 15px;
            min-width: 200px;
            min-height: 100px;
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            justify-content: center;
            align-content: flex-start;
        }

        .last-discard-label {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }

        /* ÊâãÁâåÂå∫Âüü */
        .my-hand-area {
            width: 100%;
            max-width: 900px;
            background: rgba(0,0,0,0.4);
            border-radius: 15px;
            padding: 15px;
            margin-top: 10px;
        }

        .my-hand-label {
            font-size: 0.9rem;
            color: var(--gold);
            margin-bottom: 10px;
        }

        .my-hand {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .my-melds {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            justify-content: center;
        }

        .meld-group {
            display: flex;
            gap: 2px;
            background: rgba(255,255,255,0.1);
            padding: 5px;
            border-radius: 5px;
        }

        /* È∫ªÂ∞ÜÁâåÊ†∑Âºè - ‰ΩøÁî®Á≤æÁÅµÂõæ */
        .tile {
            width: 45px;
            height: 63px;
            background-color: #f5f0e1;
            background-image: url('/img/majiang.png');
            background-repeat: no-repeat;
            border: 2px solid var(--tile-border);
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            position: relative;
            user-select: none;
        }
        
        /* ÁâåÈù¢Âä†ËΩΩ‰∏≠Áä∂ÊÄÅ */
        .tile.loading {
            background-image: none;
            background: linear-gradient(135deg, #e0d8c8 25%, #f5f0e1 50%, #e0d8c8 75%);
            background-size: 200% 100%;
            animation: tileLoading 1s ease-in-out infinite;
        }
        
        @keyframes tileLoading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Á≤æÁÅµÂõæÂä†ËΩΩÂÆåÊàêÂêéÁßªÈô§Âä†ËΩΩÁä∂ÊÄÅ */
        body.sprites-loaded .tile.loading {
            animation: none;
            background: #f5f0e1;
        }

        .tile:hover {
            transform: translateY(-8px);
            box-shadow: 2px 8px 15px rgba(0,0,0,0.4);
        }

        .tile.selected {
            transform: translateY(-12px);
            border-color: var(--gold);
            box-shadow: 0 0 20px rgba(212,175,55,0.6);
        }
        
        /* ÂàöÊë∏ÁöÑÁâå - Á™ÅÂá∫ÊòæÁ§∫ */
        .tile.new-tile {
            margin-left: 25px;
            border: 3px solid #3498db;
            box-shadow: 0 0 20px rgba(52,152,219,0.9), 0 0 40px rgba(52,152,219,0.5);
            animation: newTilePulse 1s ease-in-out infinite;
            position: relative;
        }
        
        .tile.new-tile::before {
            content: 'Êñ∞';
            position: absolute;
            top: -10px;
            right: -10px;
            background: #e74c3c;
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        @keyframes newTilePulse {
            0%, 100% { box-shadow: 0 0 20px rgba(52,152,219,0.9), 0 0 40px rgba(52,152,219,0.5); }
            50% { box-shadow: 0 0 30px rgba(52,152,219,1), 0 0 60px rgba(52,152,219,0.7); }
        }
        
        /* ÊØè‰∏™Â∫ß‰ΩçÁöÑÂºÉÁâåÂå∫ */
        .seat-discards {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: center;
            margin-top: 8px;
            padding: 5px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            min-height: 35px;
            max-width: 200px;
        }
        
        .seat-top .seat-discards {
            margin-top: 5px;
        }
        
        .seat-left .seat-discards,
        .seat-right .seat-discards {
            margin-top: 5px;
            max-width: 120px;
        }
        
        .my-discards {
            max-width: 350px;
            min-height: 45px;
        }
        
        .deck-info {
            background: rgba(0,0,0,0.4);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.1rem;
            color: var(--gold);
        }

        .tile.back {
            background-image: none;
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            border-color: #1b5e20;
        }

        .tile.back::after {
            content: 'üÄ´';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            opacity: 0.5;
        }

        .tile.small {
            width: 28px;
            height: 39px;
        }

        .tile.small.back::after {
            font-size: 0.8rem;
        }

        .tile.discarded {
            width: 32px;
            height: 45px;
        }

        /* ÊñáÂ≠óÂ§áÁî®ÊòæÁ§∫ */
        .tile-text {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .tile.text-mode {
            background-image: none !important;
            background: linear-gradient(180deg, #fff 0%, var(--tile-bg) 100%);
        }

        .tile.text-mode .tile-text {
            display: flex;
        }

        .tile-value {
            font-size: 1.4rem;
            font-weight: bold;
        }

        .tile-type {
            font-size: 0.8rem;
        }

        .tile.wan .tile-value { color: #c0392b; }
        .tile.tiao .tile-value { color: #27ae60; }
        .tile.tong .tile-value { color: #2980b9; }

        /* Âä®‰ΩúÊåâÈíÆ */
        .action-buttons {
            display: none;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .action-buttons.active {
            display: flex;
        }

        .action-btn {
            padding: 12px 25px;
            font-size: 1.1rem;
            font-family: 'Ma Shan Zheng', cursive;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn.hu {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .action-btn.gang {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        .action-btn.peng {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .action-btn.pass {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .action-btn.draw {
            background: linear-gradient(135deg, var(--gold), #b8860b);
            color: #1a1a1a;
        }

        .action-btn.discard {
            background: linear-gradient(135deg, #27ae60, #1e8449);
            color: white;
        }

        /* ToastÊèêÁ§∫ */
        .toast {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            z-index: 2000;
            animation: fadeInOut 2s ease forwards;
            font-size: 1.2rem;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, 10px); }
            20% { opacity: 1; transform: translate(-50%, 0); }
            80% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -10px); }
        }

        /* ÁªìÊûúÂºπÁ™ó */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--table-green), var(--table-dark));
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 20px;
        }

        .modal-message {
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* ËÅäÂ§©Âå∫Âüü */
        .chat-area {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background: rgba(0,0,0,0.7);
            border-radius: 15px;
            overflow: hidden;
            z-index: 100;
        }

        .chat-messages {
            height: 150px;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-message {
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .chat-message .name {
            color: var(--gold);
            font-weight: bold;
        }

        .chat-input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .chat-input {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: white;
            outline: none;
        }

        .chat-send {
            padding: 8px 15px;
            margin-left: 8px;
            background: var(--gold);
            color: #1a1a1a;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* ËÅäÂ§©ÊåâÈíÆÔºàÊÇ¨ÊµÆÔºâ */
        .chat-toggle-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gold);
            color: #1a1a1a;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none;
        }
        
        body.in-game .chat-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: #fff;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
        }
        
        /* ËÅäÂ§©Èù¢Êùø */
        .chat-panel {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 300px;
            max-height: 350px;
            background: rgba(0,0,0,0.9);
            border: 2px solid var(--gold);
            border-radius: 15px;
            overflow: hidden;
            z-index: 600;
            flex-direction: column;
        }
        
        .chat-panel.active {
            display: flex;
        }
        
        .chat-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(212,175,55,0.2);
            border-bottom: 1px solid var(--gold);
        }
        
        .chat-panel .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            max-height: 200px;
        }
        
        .chat-panel .chat-input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .chat-panel .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.9rem;
        }
        
        .chat-panel .chat-send {
            margin-left: 8px;
            padding: 8px 12px;
            background: var(--gold);
            color: #1a1a1a;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        
        .chat-message {
            padding: 5px 0;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .chat-message .name {
            color: var(--gold);
            font-weight: bold;
        }
        
        /* ÊâãÊú∫‰∏äËÅäÂ§©ÊåâÈíÆ‰ΩçÁΩÆË∞ÉÊï¥ */
        @media (max-width: 768px) {
            .chat-toggle-btn {
                bottom: 15px;
                left: 15px;
                width: 45px;
                height: 45px;
            }
            
            .chat-panel {
                bottom: 70px;
                left: 10px;
                right: 10px;
                width: auto;
                max-height: 250px;
            }
        }

        /* ÁßØÂàÜÈù¢Êùø */
        .score-panel {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .score-item {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 5px 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .flower-count {
            font-size: 0.7rem;
            color: #ff9999;
            min-width: 70px;
        }
        
        .score-name {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
        }
        
        .score-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--gold);
        }
        
        .score-value.positive { color: #2ecc71; }
        .score-value.negative { color: #e74c3c; }
        
        /* Áé©ÂÆ∂ÂáÜÂ§áÁä∂ÊÄÅ */
        .player-ready-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            font-size: 0.9rem;
        }
        .player-ready-item.ready {
            background: rgba(46, 204, 113, 0.3);
            color: #2ecc71;
        }
        .player-ready-item.waiting {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
        }
        .player-ready-item.ai-takeover {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }
        
        /* ÂçïÂ±ÄÁªìÁÆóÂºπÁ™ó */
        .round-result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 4000;
            align-items: center;
            justify-content: center;
        }
        
        .round-result-modal.active { display: flex; }
        
        .round-result-content {
            background: linear-gradient(135deg, var(--table-green), var(--table-dark));
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .round-result-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2rem;
            color: var(--gold);
            margin-bottom: 15px;
        }
        
        .fan-detail-list, .score-change-list {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
        }
        
        .fan-item, .score-change-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .fan-item:last-child, .score-change-item:last-child {
            border-bottom: none;
        }
        
        .fan-name { color: #fff; }
        .fan-value { color: var(--gold); font-weight: bold; }
        
        .score-change-name { color: #fff; }
        .score-change-value { font-weight: bold; }
        .score-change-value.positive { color: #2ecc71; }
        .score-change-value.negative { color: #e74c3c; }
        
        .total-score-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin-top: 10px;
            background: rgba(212,175,55,0.2);
            border-radius: 8px;
            font-size: 1.1rem;
        }
        
        /* ÊúÄÁªàÁªìÁÆóÂºπÁ™ó */
        .match-result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }
        
        .match-result-modal.active { display: flex; }
        
        .match-result-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 600px;
            width: 90%;
        }
        
        .match-result-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 20px;
        }
        
        .ranking-list {
            margin: 20px 0;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
        }
        
        .ranking-item.first { 
            background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,215,0,0.1));
            border: 2px solid gold;
        }
        
        .ranking-item.second { 
            background: linear-gradient(135deg, rgba(192,192,192,0.3), rgba(192,192,192,0.1));
            border: 1px solid silver;
        }
        
        .ranking-item.third { 
            background: linear-gradient(135deg, rgba(205,127,50,0.3), rgba(205,127,50,0.1));
            border: 1px solid #cd7f32;
        }
        
        .ranking-position {
            font-size: 1.5rem;
            font-weight: bold;
            width: 40px;
        }
        
        .ranking-position.first { color: gold; }
        .ranking-position.second { color: silver; }
        .ranking-position.third { color: #cd7f32; }
        
        .ranking-name {
            flex: 1;
            text-align: left;
            margin-left: 15px;
            font-size: 1.1rem;
        }
        
        .ranking-score {
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .ranking-score.positive { color: #2ecc71; }
        .ranking-score.negative { color: #e74c3c; }

        /* ÂìçÂ∫îÂºè - Âπ≥Êùø */
        @media (max-width: 768px) {
            .lobby-title { font-size: 2.5rem; }
            .room-code { font-size: 1.8rem; letter-spacing: 4px; padding: 8px 15px; }
            .players-grid { grid-template-columns: 1fr; }
            .tile { width: 36px; height: 50px; }
            .tile.small { width: 22px; height: 31px; }
            .tile.discarded { width: 26px; height: 36px; }
            .tile.new-tile { margin-left: 10px; }
            .chat-area { display: none !important; }
            .mahjong-table { aspect-ratio: 3/4; }
            .my-hand { gap: 2px; }
            .score-panel { gap: 8px; }
            .score-item { min-width: 60px; padding: 4px 10px; }
        }
        
        /* ÂìçÂ∫îÂºè - ÊâãÊú∫ */
        @media (max-width: 480px) {
            html, body {
                overflow-x: hidden;
            }
            
            .screen {
                padding: 5px;
            }
            
            /* Ê∏∏ÊàèÁïåÈù¢‰ºòÂåñ */
            .game-screen {
                padding: 5px;
                display: flex;
                flex-direction: column;
                height: 100vh;
                height: 100dvh; /* Âä®ÊÄÅËßÜÂè£È´òÂ∫¶ */
                overflow: hidden;
            }
            
            .game-header {
                padding: 5px 10px;
                margin-bottom: 5px;
                flex-shrink: 0;
            }
            
            .game-info {
                gap: 8px;
                flex-wrap: nowrap;
            }
            
            .game-info-item {
                font-size: 0.75rem;
            }
            
            .game-info-icon {
                width: 24px;
                height: 24px;
                font-size: 0.7rem;
            }
            
            /* ÁßØÂàÜÈù¢ÊùøÁ¥ßÂáëÂåñ */
            .score-panel {
                gap: 5px;
                margin-bottom: 5px;
                flex-shrink: 0;
            }
            
            .score-item {
                min-width: 50px;
                padding: 3px 8px;
            }
            
            .score-name { font-size: 0.7rem; }
            .score-value { font-size: 0.9rem; }
            
            /* È∫ªÂ∞ÜÊ°å‰ºòÂåñ */
            .mahjong-table {
                flex: 1;
                min-height: 0;
                aspect-ratio: unset;
                padding: 8px;
                gap: 5px;
                border-width: 4px;
                border-radius: 12px;
                max-height: 45vh;
            }
            
            /* Â∫ß‰Ωç‰ºòÂåñ */
            .seat-info {
                padding: 3px 6px;
                gap: 3px;
            }
            
            .seat-avatar {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }
            
            .seat-name {
                font-size: 0.7rem;
                max-width: 40px;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .seat-wind {
                font-size: 0.6rem;
                padding: 1px 4px;
            }
            
            /* ÁâåÈù¢Â§ßÂ∞èË∞ÉÊï¥ */
            .tile {
                width: 28px;
                height: 38px;
                font-size: 18px;
                border-radius: 4px;
            }
            
            .tile.small {
                width: 18px;
                height: 25px;
                font-size: 12px;
            }
            
            .tile.discarded {
                width: 22px;
                height: 30px;
                font-size: 14px;
            }
            
            .tile.new-tile {
                margin-left: 8px;
            }
            
            /* ÂºÉÁâåÂå∫Á¥ßÂáë */
            .seat-discards {
                gap: 1px;
                max-width: 100%;
                justify-content: center;
            }
            
            .seat-tiles {
                gap: 1px;
            }
            
            /* ‰∏≠Â§ÆÂå∫Âüü */
            .table-center {
                padding: 5px;
            }
            
            .deck-info {
                font-size: 0.8rem;
                padding: 4px 8px;
            }
            
            /* ÊâãÁâåÂå∫Âüü‰ºòÂåñ - ÈáçË¶Å */
            .my-hand-area {
                flex-shrink: 0;
                padding: 8px;
                margin-top: 5px;
                border-radius: 10px;
                max-height: 40vh;
                overflow-y: auto;
            }
            
            .my-hand-label {
                font-size: 0.8rem;
                margin-bottom: 5px;
            }
            
            .my-hand {
                gap: 2px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .my-melds {
                gap: 5px;
                margin-top: 5px;
            }
            
            /* Êìç‰ΩúÊåâÈíÆ */
            .action-buttons {
                gap: 8px;
                margin-top: 8px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .action-btn {
                padding: 8px 16px;
                font-size: 0.9rem;
                min-width: 50px;
            }
            
            /* ÈöêËóèËÅäÂ§© */
            .chat-area {
                display: none !important;
            }
            
            /* ÂºπÁ™ó‰ºòÂåñ */
            .modal-content,
            .round-result-content,
            .match-result-content {
                width: 95%;
                padding: 15px;
                max-height: 85vh;
            }
            
            .round-result-title,
            .match-result-title {
                font-size: 1.5rem;
            }
            
            .fan-detail-list {
                padding: 10px;
                margin: 10px 0;
            }
            
            .ranking-item {
                padding: 10px 15px;
            }
            
            /* ÈÄÄÂá∫ÊåâÈíÆ */
            .game-header .btn {
                padding: 5px 10px !important;
                font-size: 0.8rem !important;
            }
        }
        
        /* Ë∂ÖÂ∞èÂ±èÂπï */
        @media (max-width: 360px) {
            .tile {
                width: 24px;
                height: 34px;
                font-size: 16px;
            }
            
            .tile.discarded {
                width: 20px;
                height: 28px;
                font-size: 12px;
            }
            
            .score-item {
                min-width: 45px;
                padding: 2px 5px;
            }
            
            .action-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }
        
        /* ==================== ÊÄßËÉΩ‰ºòÂåñÊ†∑Âºè ==================== */
        
        /* Âº±ÁΩë/‰ΩéÁ´ØËÆæÂ§áÊ®°Âºè - ÂáèÂ∞ëÂä®Áîª */
        body.reduce-motion *,
        body.reduce-motion *::before,
        body.reduce-motion *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
        
        body.reduce-motion .tile:hover {
            transform: none;
        }
        
        body.reduce-motion .tile.new-tile {
            animation: none;
            box-shadow: 0 0 10px rgba(52,152,219,0.9);
        }
        
        body.reduce-motion .seat-avatar.current-turn {
            animation: none;
            box-shadow: 0 0 10px var(--gold);
        }
        
        /* ÁΩëÁªúÁä∂ÊÄÅÊåáÁ§∫Âô® */
        .network-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            z-index: 1000;
            display: none;
        }
        
        .network-indicator.slow {
            display: block;
            background: rgba(231, 76, 60, 0.9);
            color: white;
        }
        
        .network-indicator.medium {
            display: block;
            background: rgba(241, 196, 15, 0.9);
            color: #333;
        }
        
        /* GPU Âä†ÈÄü‰ºòÂåñ */
        .tile, .seat-avatar, .modal-content {
            will-change: transform;
            transform: translateZ(0);
        }
        
        /* ‰ΩéÁ´ØËÆæÂ§áÈ¢ùÂ§ñ‰ºòÂåñ */
        @media (max-width: 480px) {
            .tile {
                will-change: auto;
            }
        }
        
        /* ==================== UI/UX ÊîπËøõ - Âä®ÁîªÊïàÊûú ==================== */
        
        /* Âá∫ÁâåÈ£ûË°åÂä®Áîª */
        @keyframes discardFly {
            0% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            50% {
                transform: scale(0.8) translateY(-100px);
                opacity: 0.8;
            }
            100% {
                transform: scale(0.6) translateY(-200px);
                opacity: 0;
            }
        }
        
        .tile.discarding {
            animation: discardFly 0.5s ease-out forwards;
            pointer-events: none;
        }
        
        /* Êë∏ÁâåÊªëÂÖ•Âä®Áîª */
        @keyframes drawSlide {
            0% {
                transform: translateX(100px) scale(0.5);
                opacity: 0;
            }
            60% {
                transform: translateX(-10px) scale(1.1);
            }
            100% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }
        
        .tile.drawing {
            animation: drawSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        
        /* Á¢∞/Êù†/ËÉ° Âä®‰ΩúÁâπÊïà */
        .action-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 8000;
            pointer-events: none;
        }
        
        .action-effect-text {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 120px;
            font-weight: bold;
            text-shadow: 0 0 30px currentColor, 0 0 60px currentColor;
            animation: actionPop 1s ease-out forwards;
        }
        
        .action-effect-text.peng {
            color: #3498db;
        }
        
        .action-effect-text.gang {
            color: #9b59b6;
        }
        
        .action-effect-text.hu, .action-effect-text.zimo {
            color: #FFD700;
            animation: actionPop 1.5s ease-out forwards, huGlow 0.5s ease-in-out infinite;
        }
        
        @keyframes actionPop {
            0% {
                transform: scale(0) rotate(-10deg);
                opacity: 0;
            }
            30% {
                transform: scale(1.3) rotate(5deg);
                opacity: 1;
            }
            50% {
                transform: scale(1) rotate(-2deg);
            }
            100% {
                transform: scale(1.1) rotate(0deg);
                opacity: 0;
            }
        }
        
        @keyframes huGlow {
            0%, 100% {
                text-shadow: 0 0 30px #FFD700, 0 0 60px #FFD700, 0 0 90px #FF8C00;
            }
            50% {
                text-shadow: 0 0 50px #FFD700, 0 0 100px #FFD700, 0 0 150px #FF8C00;
            }
        }
        
        /* ÁÉüËä±ÂÆπÂô® */
        .fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 7500;
            overflow: hidden;
        }
        
        /* Âçï‰∏™ÁÉüËä± */
        .firework {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: fireworkExplode 1.5s ease-out forwards;
        }
        
        @keyframes fireworkExplode {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: scale(3);
                opacity: 0;
            }
        }
        
        /* ÁÉüËä±Á≤íÂ≠ê */
        .firework-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: particleFly 1.2s ease-out forwards;
        }
        
        @keyframes particleFly {
            0% {
                opacity: 1;
                transform: translate(0, 0);
            }
            100% {
                opacity: 0;
                transform: var(--particle-end);
            }
        }
        
        /* ËΩÆÂà∞Ëá™Â∑±Êó∂ÁöÑËæπÊ°ÜÂèëÂÖâ */
        .my-hand-area.my-turn {
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.8), 
                        inset 0 0 20px rgba(212, 175, 55, 0.3);
            border: 2px solid var(--gold);
            animation: myTurnPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes myTurnPulse {
            0%, 100% {
                box-shadow: 0 0 30px rgba(212, 175, 55, 0.8), 
                            inset 0 0 20px rgba(212, 175, 55, 0.3);
            }
            50% {
                box-shadow: 0 0 50px rgba(212, 175, 55, 1), 
                            inset 0 0 30px rgba(212, 175, 55, 0.5);
            }
        }
        
        /* ËΩÆÂà∞Ëá™Â∑±Êó∂ÁöÑÊèêÁ§∫ÊñáÂ≠ó */
        .turn-indicator {
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.9), rgba(184, 134, 11, 0.9));
            color: #1a1a1a;
            padding: 12px 30px;
            border-radius: 30px;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 1500;
            animation: turnIndicatorBounce 0.6s ease-out, turnIndicatorPulse 2s ease-in-out infinite 0.6s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none;
        }
        
        .turn-indicator.active {
            display: block;
        }
        
        @keyframes turnIndicatorBounce {
            0% {
                transform: translateX(-50%) translateY(-30px);
                opacity: 0;
            }
            60% {
                transform: translateX(-50%) translateY(5px);
            }
            100% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes turnIndicatorPulse {
            0%, 100% {
                transform: translateX(-50%) scale(1);
            }
            50% {
                transform: translateX(-50%) scale(1.05);
            }
        }
        
        /* Âø´Êç∑Ë°®ÊÉÖÈù¢Êùø */
        .emoji-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid var(--gold);
            border-radius: 15px;
            padding: 15px;
            z-index: 800;
            display: none;
            flex-direction: column;
            gap: 10px;
            max-width: 280px;
        }
        
        .emoji-panel.active {
            display: flex;
            animation: panelSlideUp 0.3s ease-out;
        }
        
        @keyframes panelSlideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .emoji-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .emoji-panel-header h4 {
            color: var(--gold);
            margin: 0;
            font-family: 'Ma Shan Zheng', cursive;
        }
        
        .emoji-panel-close {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .emoji-btn {
            width: 50px;
            height: 50px;
            font-size: 1.8rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .emoji-btn:hover {
            background: rgba(212, 175, 55, 0.3);
            border-color: var(--gold);
            transform: scale(1.1);
        }
        
        .emoji-btn:active {
            transform: scale(0.95);
        }
        
        .quick-phrases {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .phrase-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            padding: 8px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .phrase-btn:hover {
            background: rgba(212, 175, 55, 0.3);
            border-color: var(--gold);
        }
        
        /* Ë°®ÊÉÖÊåâÈíÆÔºàÊÇ¨ÊµÆÔºâ */
        .emoji-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 700;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        
        body.in-game .emoji-toggle-btn {
            display: flex;
        }
        
        .emoji-toggle-btn:hover {
            transform: scale(1.1);
        }
        
        /* Ë°®ÊÉÖÊ∞îÊ≥°ÊòæÁ§∫ */
        .emoji-bubble {
            position: absolute;
            font-size: 2.5rem;
            animation: emojiBubble 2s ease-out forwards;
            pointer-events: none;
            z-index: 6000;
        }
        
        @keyframes emojiBubble {
            0% {
                transform: scale(0) translateY(0);
                opacity: 0;
            }
            20% {
                transform: scale(1.2) translateY(-10px);
                opacity: 1;
            }
            80% {
                transform: scale(1) translateY(-30px);
                opacity: 1;
            }
            100% {
                transform: scale(0.8) translateY(-50px);
                opacity: 0;
            }
        }
        
        /* ËÉåÊôØÁ≤íÂ≠êÊïàÊûú */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            animation: floatParticle linear infinite;
        }
        
        @keyframes floatParticle {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-10vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* ÁâåÈù¢ÁÇπÂáªÊ≥¢Á∫πÊïàÊûú */
        .tile-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.4);
            transform: scale(0);
            animation: ripple 0.6s ease-out;
            pointer-events: none;
        }
        
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        /* ÊâãÊú∫Á´ØË∞ÉÊï¥ */
        @media (max-width: 768px) {
            .emoji-toggle-btn {
                bottom: 15px;
                right: 70px;
                width: 45px;
                height: 45px;
            }
            
            .emoji-panel {
                bottom: 70px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            .action-effect-text {
                font-size: 80px;
            }
            
            .turn-indicator {
                font-size: 1.2rem;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ÁΩëÁªúÁä∂ÊÄÅÊåáÁ§∫Âô® -->
    <div class="network-indicator" id="networkIndicator">
        <span id="networkStatus">‚ö° ÁΩëÁªúËæÉÊÖ¢</span>
    </div>

    <!-- Ê®™Â±èÊèêÁ§∫ -->
    <div class="rotate-hint" id="rotateHint">
        <div class="icon">üì±</div>
        <h2>ËØ∑Ê®™Â±èÊ∏∏Êàè</h2>
        <p>‰∏∫Ëé∑ÂæóÊõ¥Â•ΩÁöÑÊ∏∏Êàè‰ΩìÈ™åÔºåËØ∑Â∞ÜÊâãÊú∫Ê®™ËøáÊù•</p>
    </div>

    <!-- ËÉåÊôØÁ≤íÂ≠êÊïàÊûú -->
    <div class="particles-container" id="particlesContainer"></div>
    
    <!-- ÁÉüËä±ÂÆπÂô® -->
    <div class="fireworks-container" id="fireworksContainer"></div>
    
    <!-- ËΩÆÂà∞Ëá™Â∑±ÁöÑÊèêÁ§∫ -->
    <div class="turn-indicator" id="turnIndicator">üéØ ËΩÆÂà∞‰Ω†Âá∫Áâå‰∫ÜÔºÅ</div>
    
    <!-- Âø´Êç∑Ë°®ÊÉÖÊåâÈíÆ -->
    <button class="emoji-toggle-btn" id="emojiToggleBtn" onclick="toggleEmojiPanel()">üòä</button>
    
    <!-- Âø´Êç∑Ë°®ÊÉÖÈù¢Êùø -->
    <div class="emoji-panel" id="emojiPanel">
        <div class="emoji-panel-header">
            <h4>Âø´Êç∑Ë°®ÊÉÖ</h4>
            <button class="emoji-panel-close" onclick="toggleEmojiPanel()">‚úï</button>
        </div>
        <div class="emoji-grid">
            <button class="emoji-btn" onclick="sendEmoji('üòÑ')">üòÑ</button>
            <button class="emoji-btn" onclick="sendEmoji('üò≠')">üò≠</button>
            <button class="emoji-btn" onclick="sendEmoji('üò°')">üò°</button>
            <button class="emoji-btn" onclick="sendEmoji('ü§î')">ü§î</button>
            <button class="emoji-btn" onclick="sendEmoji('üëç')">üëç</button>
            <button class="emoji-btn" onclick="sendEmoji('üëé')">üëé</button>
            <button class="emoji-btn" onclick="sendEmoji('üéâ')">üéâ</button>
            <button class="emoji-btn" onclick="sendEmoji('üí™')">üí™</button>
            <button class="emoji-btn" onclick="sendEmoji('üôè')">üôè</button>
            <button class="emoji-btn" onclick="sendEmoji('üòé')">üòé</button>
            <button class="emoji-btn" onclick="sendEmoji('ü§£')">ü§£</button>
            <button class="emoji-btn" onclick="sendEmoji('üò±')">üò±</button>
        </div>
        <div class="quick-phrases">
            <button class="phrase-btn" onclick="sendPhrase('Á®≥‰ΩèÔºåÂà´Êµ™ÔºÅ')">üéØ Á®≥‰ΩèÔºåÂà´Êµ™ÔºÅ</button>
            <button class="phrase-btn" onclick="sendPhrase('Âø´ÁÇπÂá∫ÁâåÂï¶ÔΩû')">‚è∞ Âø´ÁÇπÂá∫ÁâåÂï¶ÔΩû</button>
            <button class="phrase-btn" onclick="sendPhrase('ÊâìÂæó‰∏çÈîôÔºÅ')">üëè ÊâìÂæó‰∏çÈîôÔºÅ</button>
            <button class="phrase-btn" onclick="sendPhrase('ËøôÊääÊàëË¶ÅËÉ°ÔºÅ')">üî• ËøôÊääÊàëË¶ÅËÉ°ÔºÅ</button>
        </div>
    </div>

    <!-- Â§ßÂéÖÁïåÈù¢ -->
    <div id="lobbyScreen" class="screen active">
        <h1 class="lobby-title">üÄÑ ‰∏äÊµ∑Êï≤È∫ª</h1>
        <p class="lobby-subtitle">Â§ö‰∫∫ËÅîÊú∫Áâà - ÈÇÄËØ∑Â•ΩÂèã‰∏ÄËµ∑Áé©</p>
        
        <div class="lobby-container">
            <div class="input-group">
                <label><i class="fas fa-user"></i> ‰Ω†ÁöÑÊòµÁß∞</label>
                <input type="text" id="usernameInput" placeholder="ËæìÂÖ•ÊòµÁß∞" maxlength="8">
            </div>
            
            <!-- ËØ≠Èü≥ÈÄâÊã© -->
            <div class="input-group">
                <label><i class="fas fa-volume-up"></i> ÈÄâÊã©ËØ≠Èü≥</label>
                <div class="voice-selector">
                    <button type="button" class="voice-btn active" id="voiceFemale01" onclick="selectVoice('female01')">
                        <i class="fas fa-venus"></i> Â•≥1
                    </button>
                    <button type="button" class="voice-btn" id="voiceFemale02" onclick="selectVoice('female02')">
                        <i class="fas fa-venus"></i> Â•≥2
                    </button>
                    <button type="button" class="voice-btn" id="voiceMale" onclick="selectVoice('male')">
                        <i class="fas fa-mars"></i> Áî∑1
                    </button>
                    <button type="button" class="voice-btn" id="voiceMale02" onclick="selectVoice('male02')">
                        <i class="fas fa-mars"></i> Áî∑2
                    </button>
                </div>
            </div>
            
            <button class="btn" onclick="createRoom()">
                <i class="fas fa-plus-circle"></i> ÂàõÂª∫ÊàøÈó¥
            </button>
            
            <div class="divider"><span>ÊàñËÄÖ</span></div>
            
            <div class="input-group">
                <label><i class="fas fa-door-open"></i> ÊàøÈó¥Âè∑</label>
                <input type="text" id="roomCodeInput" placeholder="ËæìÂÖ•6‰ΩçÊàøÈó¥Âè∑" maxlength="6">
            </div>
            
            <button class="btn secondary" onclick="joinRoom()">
                <i class="fas fa-sign-in-alt"></i> Âä†ÂÖ•ÊàøÈó¥
            </button>
            
            <button class="btn secondary" onclick="window.location.href='./mahjong/index.html'" style="margin-top: 20px;">
                <i class="fas fa-robot"></i> Âçï‰∫∫Ê®°ÂºèÔºà‰∫∫Êú∫ÂØπÊàòÔºâ
            </button>
            
            <div class="divider"><span>ÂÖ∂‰ªñÊ∏∏Êàè</span></div>
            
            <button class="btn secondary" onclick="window.location.href='./gomoku/'" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-color: #e94560;">
                <i class="fas fa-circle"></i> ‰∫îÂ≠êÊ£ã
            </button>
        </div>
    </div>

    <!-- ÊàøÈó¥Á≠âÂæÖÁïåÈù¢ -->
    <div id="roomScreen" class="screen">
        <div class="room-header">
            <div class="room-code-label">ÊàøÈó¥Âè∑</div>
            <div class="room-code" id="displayRoomCode">------</div>
            <button class="copy-btn" onclick="copyRoomCode()">
                <i class="fas fa-copy"></i> Â§çÂà∂ÊàøÈó¥Âè∑
            </button>
        </div>
        
        <div class="room-container">
            <div class="players-grid" id="playersGrid">
                <!-- Âä®ÊÄÅÁîüÊàêÁé©ÂÆ∂ÊßΩ‰Ωç -->
            </div>
            
            <div class="room-actions">
                <button class="btn secondary" onclick="leaveRoom()">
                    <i class="fas fa-sign-out-alt"></i> Á¶ªÂºÄ
                </button>
                <button class="btn" id="readyBtn" onclick="toggleReady()">
                    <i class="fas fa-check"></i> ÂáÜÂ§á
                </button>
            </div>
        </div>
    </div>

    <!-- Ê∏∏ÊàèÁïåÈù¢ -->
    <div id="gameScreen" class="screen game-screen">
        <div class="game-header">
            <div class="game-info">
                <!-- Â±ÄÊï∞ÊòæÁ§∫ -->
                <div class="game-info-item round-display">
                    <div class="game-info-icon" style="background: #e74c3c;">
                        <span id="currentRoundNum">1</span>
                    </div>
                    <span>Á¨¨ <span id="currentRoundText">1</span>/<span id="totalRoundsText">10</span> Â±Ä</span>
                </div>
                <div class="game-info-item">
                    <div class="game-info-icon"><i class="fas fa-layer-group"></i></div>
                    <span>Ââ©‰Ωô: <span id="deckCount">0</span></span>
                </div>
                <div class="game-info-item">
                    <div class="game-info-icon" id="currentWindIcon">‰∏ú</div>
                    <span id="currentTurnText">Á≠âÂæÖ‰∏≠</span>
                </div>
            </div>
            <button class="btn secondary" style="padding: 8px 16px; font-size: 0.9rem;" onclick="leaveGame()">
                <i class="fas fa-sign-out-alt"></i> ÈÄÄÂá∫
            </button>
        </div>
        
        <!-- ÁßØÂàÜÈù¢Êùø -->
        <div class="score-panel" id="scorePanel">
            <div class="score-item" id="scoreItem-0">
                <span class="score-name">Êàë</span>
                <span class="score-value" id="score-0">0</span>
                <span class="flower-count" id="flower-0">üå∏0</span>
            </div>
            <div class="score-item" id="scoreItem-1">
                <span class="score-name" id="scoreName-1">Âè≥ÂÆ∂</span>
                <span class="score-value" id="score-1">0</span>
                <span class="flower-count" id="flower-1">üå∏0</span>
            </div>
            <div class="score-item" id="scoreItem-2">
                <span class="score-name" id="scoreName-2">ÂØπÂÆ∂</span>
                <span class="score-value" id="score-2">0</span>
                <span class="flower-count" id="flower-2">üå∏0</span>
            </div>
            <div class="score-item" id="scoreItem-3">
                <span class="score-name" id="scoreName-3">Â∑¶ÂÆ∂</span>
                <span class="score-value" id="score-3">0</span>
                <span class="flower-count" id="flower-3">üå∏0</span>
            </div>
        </div>

        <div class="mahjong-table">
            <!-- ÂØπÂÆ∂Ôºà‰∏äÊñπÔºâ -->
            <div class="seat seat-top" id="seat-2">
                <div class="seat-info">
                    <div class="seat-avatar" id="avatar-2">ü§ñ</div>
                    <span class="seat-name" id="name-2">Á≠âÂæÖ‰∏≠</span>
                    <span class="seat-wind" id="wind-2">Ë•ø</span>
                </div>
                <div class="seat-tiles" id="tiles-2"></div>
                <div class="seat-discards" id="discards-2"></div>
            </div>

            <!-- Â∑¶ÂÆ∂ -->
            <div class="seat seat-left" id="seat-3">
                <div class="seat-info">
                    <div class="seat-avatar" id="avatar-3">ü§ñ</div>
                    <span class="seat-name" id="name-3">Á≠âÂæÖ‰∏≠</span>
                    <span class="seat-wind" id="wind-3">Âåó</span>
                </div>
                <div class="seat-tiles" id="tiles-3"></div>
                <div class="seat-discards" id="discards-3"></div>
            </div>

            <!-- ‰∏≠Â§ÆÂå∫ÂüüÔºàÂâ©‰ΩôÁâåÊï∞Á≠â‰ø°ÊÅØÔºâ -->
            <div class="table-center">
                <div class="deck-info">üÄÑ Ââ©‰Ωô: <span id="centerDeckCount">0</span></div>
            </div>

            <!-- Âè≥ÂÆ∂ -->
            <div class="seat seat-right" id="seat-1">
                <div class="seat-info">
                    <div class="seat-avatar" id="avatar-1">ü§ñ</div>
                    <span class="seat-name" id="name-1">Á≠âÂæÖ‰∏≠</span>
                    <span class="seat-wind" id="wind-1">Âçó</span>
                </div>
                <div class="seat-tiles" id="tiles-1"></div>
                <div class="seat-discards" id="discards-1"></div>
            </div>

            <!-- Ëá™Â∑±Ôºà‰∏ãÊñπÔºâ -->
            <div class="seat seat-bottom" id="seat-0">
                <div class="seat-info">
                    <div class="seat-avatar" id="avatar-0">üë§</div>
                    <span class="seat-name" id="name-0">Êàë</span>
                    <span class="seat-wind" id="wind-0">‰∏ú</span>
                </div>
                <div class="seat-discards my-discards" id="discards-0"></div>
            </div>
        </div>

        <!-- ÊàëÁöÑÊâãÁâå -->
        <div class="my-hand-area">
            <div class="my-hand-label">ÊàëÁöÑÊâãÁâå</div>
            <div class="my-hand" id="myHand"></div>
            <div class="my-melds" id="myMelds"></div>
            
            <div class="action-buttons" id="actionButtons">
                <button class="action-btn discard" id="discardBtn" onclick="discardTile()" disabled>Âá∫Áâå</button>
            </div>
            
            <!-- Êé•ÁÆ°AIÊåâÈíÆ -->
            <div id="takeoverContainer" style="display: none; margin: 10px 0;">
                <button class="btn" id="takeoverBtn" onclick="takeoverAI()" style="background: #e74c3c; animation: pulse 1s infinite;">
                    <i class="fas fa-hand-paper"></i> Êé•ÁÆ°AIÔºåÊÅ¢Â§çÊéßÂà∂
                </button>
            </div>
            
            <div class="action-buttons" id="responseButtons">
                <button class="action-btn hu" onclick="doAction('hu')">ËÉ°</button>
                <button class="action-btn gang" onclick="doAction('gang')">Êù†</button>
                <button class="action-btn peng" onclick="doAction('peng')">Á¢∞</button>
                <button class="action-btn pass" onclick="doAction('pass')">Ëøá</button>
            </div>
        </div>
    </div>

    <!-- ÁªìÊûúÂºπÁ™óÔºàÊóßÁâà‰øùÁïôÔºâ -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <h2 class="modal-title" id="resultTitle">Ê∏∏ÊàèÁªìÊùü</h2>
            <p class="modal-message" id="resultMessage"></p>
            <button class="btn" onclick="closeResult()">ËøîÂõûÊàøÈó¥</button>
        </div>
    </div>
    
    <!-- ÂçïÂ±ÄÁªìÁÆóÂºπÁ™ó -->
    <div class="round-result-modal" id="roundResultModal">
        <div class="round-result-content">
            <h2 class="round-result-title" id="roundResultTitle">Êú¨Â±ÄÁªìÁÆó</h2>
            
            <div id="roundWinnerInfo" style="font-size: 1.2rem; margin-bottom: 15px;">
                <span id="winnerName"></span> <span id="winType"></span>
            </div>
            
            <!-- Áï™Êï∞ÊòéÁªÜ -->
            <div class="fan-detail-list" id="fanDetailList">
                <h4 style="color: var(--gold); margin-bottom: 10px;">Áï™Êï∞ÊòéÁªÜ</h4>
                <div id="fanItems"></div>
                <div class="total-score-row">
                    <span>ÊÄªÁï™Êï∞</span>
                    <span id="totalFanDisplay">0Áï™</span>
                </div>
            </div>
            
            <!-- Ëä±Êï∞ÊòéÁªÜ -->
            <div class="fan-detail-list" id="huaDetailList">
                <h4 style="color: var(--gold); margin-bottom: 10px;">Ëä±Êï∞ÊòéÁªÜ</h4>
                <div id="huaItems"></div>
                <div class="total-score-row">
                    <span>ÊÄªËä±Êï∞</span>
                    <span id="totalHuaDisplay">0Ëä±</span>
                </div>
            </div>
            
            <!-- ÁßØÂàÜÂèòÂåñ -->
            <div class="score-change-list">
                <h4 style="color: var(--gold); margin-bottom: 10px;">ÁßØÂàÜÂèòÂåñ</h4>
                <div id="scoreChangeItems"></div>
            </div>
            
            <div style="margin-top: 20px; font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                Á¨¨ <span id="roundEndCurrent">1</span>/<span id="roundEndTotal">10</span> Â±Ä
            </div>
            
            <!-- ÂÄíËÆ°Êó∂ÂíåÂáÜÂ§áÁä∂ÊÄÅ -->
            <div id="nextRoundCountdown" style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                <div style="font-size: 1.2rem; color: var(--gold); margin-bottom: 10px;">
                    ‚è± ‰∏ã‰∏ÄÂ±ÄÂºÄÂßã: <span id="countdownSeconds">30</span>Áßí
                </div>
                <div id="playersReadyStatus" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                    <!-- Âä®ÊÄÅÁîüÊàêÁé©ÂÆ∂ÂáÜÂ§áÁä∂ÊÄÅ -->
                </div>
            </div>
            
            <button class="btn" id="continueNextBtn" onclick="continueNextRound()" style="margin-top: 20px;">
                <i class="fas fa-play"></i> ÁªßÁª≠‰∏ã‰∏ÄÂ±Ä
            </button>
        </div>
    </div>
    
    <!-- ÊúÄÁªàÁªìÁÆóÂºπÁ™ó -->
    <div class="match-result-modal" id="matchResultModal">
        <div class="match-result-content">
            <h2 class="match-result-title">üèÜ ÊØîËµõÁªìÊùü üèÜ</h2>
            
            <div style="font-size: 1rem; color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                ÂÖ± <span id="matchTotalRounds">10</span> Â±Ä
            </div>
            
            <div class="ranking-list" id="rankingList">
                <!-- ÊéíÂêçÂä®ÊÄÅÁîüÊàê -->
            </div>
            
            <button class="btn" onclick="closeMatchResult()" style="margin-top: 25px;">
                <i class="fas fa-home"></i> ËøîÂõûÂ§ßÂéÖ
            </button>
        </div>
    </div>

    <!-- ÊúçÂä°Âô®Ë¶ÅÊ±ÇÊèêÁ§∫ -->
    <div class="modal" id="serverRequiredModal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 class="modal-title">üñ•Ô∏è ÈúÄË¶ÅÂêØÂä®ÊúçÂä°Âô®</h2>
            <p class="modal-message" style="text-align: left; line-height: 1.8;">
                Â§ö‰∫∫ËÅîÊú∫ÈúÄË¶ÅËøêË°å WebSocket ÊúçÂä°Âô®ÔºåÈùôÊÄÅÁΩëÈ°µÊâòÁÆ°ÔºàÂ¶Ç GitHub PagesÔºâÊó†Ê≥ïÊîØÊåÅ„ÄÇ<br><br>
                <strong>Êú¨Âú∞ËøêË°åÊñπÊ≥ïÔºö</strong><br>
                1. ‰∏ãËΩΩÈ°πÁõÆ‰ª£Á†Å<br>
                2. ËøõÂÖ• <code style="background:#333;padding:2px 6px;border-radius:4px;">games/mahjong-multiplayer</code> ÁõÆÂΩï<br>
                3. ËøêË°å <code style="background:#333;padding:2px 6px;border-radius:4px;">npm install</code><br>
                4. ËøêË°å <code style="background:#333;padding:2px 6px;border-radius:4px;">npm start</code><br>
                5. ËÆøÈóÆ <code style="background:#333;padding:2px 6px;border-radius:4px;">http://localhost:3000</code><br><br>
                <strong>ÊàñËÄÖÔºö</strong>ÈÉ®ÁΩ≤Âà∞ Render / Railway Á≠âÊîØÊåÅ Node.js ÁöÑ‰∫ëÂπ≥Âè∞
            </p>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn secondary" onclick="closeServerModal()">ÊàëÁü•ÈÅì‰∫Ü</button>
                <button class="btn" onclick="window.location.href='./mahjong/index.html'">
                    <i class="fas fa-robot"></i> Áé©Âçï‰∫∫Ê®°Âºè
                </button>
            </div>
        </div>
    </div>

    <!-- ËÅäÂ§©ÊåâÈíÆÔºàÊÇ¨ÊµÆÔºâ -->
    <button class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleChatPanel()">
        <i class="fas fa-comment"></i>
        <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
    </button>
    
    <!-- ËÅäÂ§©Èù¢ÊùøÔºàÂºπÂá∫ÂºèÔºâ -->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-panel-header">
            <span>üí¨ ÊàøÈó¥ËÅäÂ§©</span>
            <button onclick="toggleChatPanel()" style="background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="ÂèëÈÄÅÊ∂àÊÅØ..." onkeypress="if(event.key==='Enter')sendChat()">
            <button class="chat-send" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    
    <!-- ÊóßÁâàËÅäÂ§©Âå∫ÂüüÔºàÂÖºÂÆπÔºâ -->
    <div class="chat-area" id="chatArea" style="display: none;"></div>

    <script>
        // ==================== ÊÄßËÉΩ‰ºòÂåñÂ∑•ÂÖ∑ ====================
        
        // ËäÇÊµÅÂáΩÊï∞ - ÈôêÂà∂ÂáΩÊï∞Ë∞ÉÁî®È¢ëÁéá
        function throttle(func, limit) {
            let inThrottle;
            let lastResult;
            return function(...args) {
                if (!inThrottle) {
                    lastResult = func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
                return lastResult;
            };
        }
        
        // Èò≤ÊäñÂáΩÊï∞ - Âª∂ËøüÊâßË°åÁõ¥Âà∞ÂÅúÊ≠¢Ë∞ÉÁî®
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        
        // requestAnimationFrame Â∞ÅË£Ö
        let rafPending = false;
        let rafCallback = null;
        function scheduleUpdate(callback) {
            rafCallback = callback;
            if (!rafPending) {
                rafPending = true;
                requestAnimationFrame(() => {
                    rafPending = false;
                    if (rafCallback) rafCallback();
                });
            }
        }
        
        // ÁΩëÁªúÁä∂ÊÄÅÊ£ÄÊµã
        let networkQuality = 'good'; // 'good', 'slow', 'offline'
        let lastPingTime = 0;
        let pingHistory = [];
        
        function updateNetworkQuality(ping) {
            pingHistory.push(ping);
            if (pingHistory.length > 5) pingHistory.shift();
            
            const avgPing = pingHistory.reduce((a, b) => a + b, 0) / pingHistory.length;
            
            if (avgPing > 500) {
                networkQuality = 'slow';
            } else if (avgPing > 200) {
                networkQuality = 'medium';
            } else {
                networkQuality = 'good';
            }
            
            // Âº±ÁΩëÊó∂ÂáèÂ∞ëÂä®Áîª
            document.body.classList.toggle('reduce-motion', networkQuality === 'slow');
        }
        
        // ‰ΩéÊÄßËÉΩËÆæÂ§áÊ£ÄÊµã
        const isLowEndDevice = (function() {
            // Ê£ÄÊµãËÆæÂ§áÂÜÖÂ≠ò (Â¶ÇÊûúÂèØÁî®)
            const memory = navigator.deviceMemory;
            if (memory && memory < 4) return true;
            
            // Ê£ÄÊµãÊòØÂê¶ÊòØÁßªÂä®ËÆæÂ§á
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Ê£ÄÊµãÁ°¨‰ª∂Âπ∂ÂèëÊï∞
            const cores = navigator.hardwareConcurrency;
            if (cores && cores < 4) return true;
            
            return isMobile;
        })();
        
        // ‰ΩéÁ´ØËÆæÂ§áËá™Âä®ÂêØÁî®ÁúÅÁîµÊ®°Âºè
        let performanceMode = isLowEndDevice ? 'low' : 'high';
        
        // DOM ÂÖÉÁ¥†ÁºìÂ≠ò
        const domCache = {};
        function $(id) {
            if (!domCache[id]) {
                domCache[id] = document.getElementById(id);
            }
            return domCache[id];
        }
        
        // ‰∏ä‰∏ÄÊ¨°Ê∏∏ÊàèÁä∂ÊÄÅÔºàÁî®‰∫éÂ¢ûÈáèÊõ¥Êñ∞Ôºâ
        let prevGameState = null;
        
        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let socket = null;
        let currentRoom = null;
        let myPlayerId = null;
        let mySeatIndex = -1;
        let selectedTileId = null;
        let gameState = null;
        let isReady = false;
        let username = '';
        let lastDrawnTileId = null; // ËÆ∞ÂΩïÂàöÊë∏ÁöÑÁâå
        let pendingAutoDiscard = false; // ÊòØÂê¶Á≠âÂæÖËá™Âä®Âá∫Áâå
        let pendingAutoDiscardTileId = null; // Á≠âÂæÖËá™Âä®Âá∫ÁâåÁöÑÁâåID
        let isAITakeover = false; // ÊòØÂê¶Ë¢´AIÊé•ÁÆ°
        let myVoice = 'female01'; // ÊàëÁöÑËØ≠Èü≥Á±ªÂûã
        let playerVoices = {}; // Â≠òÂÇ®ÊâÄÊúâÁé©ÂÆ∂ÁöÑËØ≠Èü≥Á±ªÂûã

        // ÁâåÈù¢ÊòæÁ§∫
        const TYPE_NAMES = { wan: '‰∏á', tiao: 'Êù°', tong: 'Á≠í' };
        const NUM_NAMES = ['', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠', '‰∏É', 'ÂÖ´', '‰πù'];
        const WIND_NAMES = { east: '‰∏ú', south: 'Âçó', west: 'Ë•ø', north: 'Âåó' };
        
        // Á≤æÁÅµÂõæ‰ΩçÁΩÆÊò†Â∞Ñ (8Âàó√ó6Ë°åÁΩëÊ†º)
        const TILE_SPRITE_MAP = {
            // Á¨¨0Ë°å: ‰∏áÂ≠ê 1-8
            'wan1': [0, 0], 'wan2': [0, 1], 'wan3': [0, 2], 'wan4': [0, 3],
            'wan5': [0, 4], 'wan6': [0, 5], 'wan7': [0, 6], 'wan8': [0, 7],
            
            // Á¨¨1Ë°å: Á≠íÂ≠ê 1-8
            'tong1': [1, 0], 'tong2': [1, 1], 'tong3': [1, 2], 'tong4': [1, 3],
            'tong5': [1, 4], 'tong6': [1, 5], 'tong7': [1, 6], 'tong8': [1, 7],
            
            // Á¨¨2Ë°å: Êù°Â≠ê 1-8
            'tiao1': [2, 0], 'tiao2': [2, 1], 'tiao3': [2, 2], 'tiao4': [2, 3],
            'tiao5': [2, 4], 'tiao6': [2, 5], 'tiao7': [2, 6], 'tiao8': [2, 7],
            
            // Á¨¨3Ë°å: Â≠óÁâå ‰∏úÂçóË•øÂåó‰∏≠ÂèëÁôΩ
            'dong': [3, 0], 'nan': [3, 1], 'xi': [3, 2], 'bei': [3, 3],
            'zhong': [3, 4], 'fa': [3, 5], 'bai': [3, 6],
            
            // Á¨¨4Ë°å: Ëä±Áâå
            'qiu': [4, 0], 'lan': [4, 1], 'zhu': [4, 2], 'mei': [4, 3],
            'chun': [4, 4], 'xia': [4, 5], 'dong_hua': [4, 6], 'ju': [4, 7],
            
            // Á¨¨5Ë°å: 9‰∏á 9Á≠í 9Êù°
            'wan9': [5, 0], 'tong9': [5, 1], 'tiao9': [5, 2]
        };
        
        // Ëé∑ÂèñÁ≤æÁÅµÂõæËÉåÊôØ‰ΩçÁΩÆ
        function getSpritePosition(tile) {
            const key = `${tile.type}${tile.value}`;
            const pos = TILE_SPRITE_MAP[key];
            
            if (!pos) return '';
            
            const cols = 8;
            const rows = 6;
            
            // ‰ΩøÁî®ÁôæÂàÜÊØîÂÆö‰Ωç
            const posX = pos[1] === 0 ? 0 : (pos[1] / (cols - 1)) * 100;
            const posY = pos[0] === 0 ? 0 : (pos[0] / (rows - 1)) * 100;
            
            return `background-size: ${cols * 100}% ${rows * 100}%; background-position: ${posX}% ${posY}%;`;
        }
        
        // ==================== Âê¨ÁâåÊ£ÄÊµã ====================
        let isTing = false;
        let tingList = [];
        
        // Ê£ÄÊµãÊòØÂê¶ËÉΩËÉ°ÁâåÔºà3N+2ÁªìÊûÑÔºâ
        function canHuHand(tiles) {
            if (tiles.length === 0) return true;
            if (tiles.length === 2) {
                return tiles[0].type === tiles[1].type && tiles[0].value === tiles[1].value;
            }
            if (tiles.length < 3) return false;
            
            // ÊéíÂ∫è
            const sorted = [...tiles].sort((a, b) => {
                if (a.type !== b.type) return a.type.localeCompare(b.type);
                return a.value - b.value;
            });
            
            // Â∞ùËØï‰Ωú‰∏∫Â∞ÜÔºàÂØπÂ≠êÔºâ
            for (let i = 0; i < sorted.length - 1; i++) {
                if (sorted[i].type === sorted[i+1].type && sorted[i].value === sorted[i+1].value) {
                    const remaining = [...sorted];
                    remaining.splice(i, 2);
                    if (canFormMelds(remaining)) return true;
                }
            }
            return false;
        }
        
        function canFormMelds(tiles) {
            if (tiles.length === 0) return true;
            if (tiles.length % 3 !== 0) return false;
            
            const sorted = [...tiles].sort((a, b) => {
                if (a.type !== b.type) return a.type.localeCompare(b.type);
                return a.value - b.value;
            });
            
            // Â∞ùËØïÂàªÂ≠ê
            if (sorted.length >= 3 &&
                sorted[0].type === sorted[1].type && sorted[1].type === sorted[2].type &&
                sorted[0].value === sorted[1].value && sorted[1].value === sorted[2].value) {
                return canFormMelds(sorted.slice(3));
            }
            
            // Â∞ùËØïÈ°∫Â≠ê
            if (sorted.length >= 3) {
                const first = sorted[0];
                const secondIdx = sorted.findIndex(t => t.type === first.type && t.value === first.value + 1);
                const thirdIdx = sorted.findIndex(t => t.type === first.type && t.value === first.value + 2);
                
                if (secondIdx !== -1 && thirdIdx !== -1) {
                    const remaining = [...sorted];
                    [thirdIdx, secondIdx, 0].sort((a,b) => b-a).forEach(idx => remaining.splice(idx, 1));
                    if (canFormMelds(remaining)) return true;
                }
            }
            return false;
        }
        
        // Ê£ÄÊµãÂê¨Âì™‰∫õÁâå
        function checkTingPai(hand) {
            const tingTiles = [];
            const allTileTypes = ['wan', 'tiao', 'tong'];
            
            for (const type of allTileTypes) {
                for (let value = 1; value <= 9; value++) {
                    const testTile = { type, value };
                    const testHand = [...hand, testTile];
                    if (canHuHand(testHand)) {
                        tingTiles.push(testTile);
                    }
                }
            }
            return tingTiles;
        }
        
        // Ê£ÄÊü•Âπ∂ÊòæÁ§∫Âê¨ÁâåÁä∂ÊÄÅ
        function checkAndShowTing() {
            if (!gameState) return;
            
            const myPlayer = gameState.players.find(p => p.seatIndex === mySeatIndex);
            if (!myPlayer || !myPlayer.hand) return;
            
            // Âè™Êúâ13Âº†ÁâåÊó∂Ê£ÄÊµãÂê¨ÁâåÔºàÊàñ10Âº†Êúâ1Á¢∞Ôºå7Âº†Êúâ2Á¢∞...Ôºâ
            const expectedSize = 13 - (myPlayer.melds?.length || 0) * 3;
            if (myPlayer.hand.length !== expectedSize) return;
            
            const newTingList = checkTingPai(myPlayer.hand);
            
            if (newTingList.length > 0 && !isTing) {
                isTing = true;
                tingList = newTingList;
                
                // ËØ≠Èü≥Êí≠Êä•
                speakTing();
                
                // ÊòæÁ§∫Âê¨Áâå‰ø°ÊÅØ
                const tingNames = newTingList.map(t => `${NUM_NAMES[t.value]}${TYPE_NAMES[t.type]}`).join('„ÄÅ');
                showToast(`üéØ Âê¨ÁâåÔºÅÂê¨Ôºö${tingNames}`, 3000);
            }
        }
        
        // ==================== Èü≥È¢ëÊí≠ÊîæÁ≥ªÁªü ====================
        const audioCache = {}; // ÁºìÂ≠òÂ∑≤Âä†ËΩΩÁöÑÈü≥È¢ë
        let audioUnlocked = false; // ÁßªÂä®ËÆæÂ§áÈü≥È¢ëÊòØÂê¶Â∑≤Ëß£ÈîÅ
        
        // Èü≥È¢ëÊ†ºÂºèÈÖçÁΩÆÔºàÁªü‰∏Ä‰ΩøÁî®mp3Ôºâ
        const AUDIO_FORMATS = {
            female01: '.mp3',
            female02: '.mp3',
            male: '.mp3',
            male02: '.mp3'
        };
        
        // Ëé∑ÂèñÁâåÁöÑÈü≥È¢ëÊñá‰ª∂Âêç
        function getTileAudioName(tile) {
            // Â§ö‰∫∫Ê®°ÂºèÁâåÁªìÊûÑ: 
            // Êï∞Â≠óÁâå: { type: 'wan'|'tiao'|'tong', value: 1-9 }
            // Ëä±Áâå: { type: 'flower', value: 'chun'|'xia'|... }
            if (tile.type === 'flower') {
                return tile.value; // Ëä±ÁâåÁõ¥Êé•ËøîÂõû value (chun, xia, etc.)
            }
            return `${tile.type}${tile.value}`; // Êï∞Â≠óÁâå: wan1, tong2, etc.
        }
        
        // Ê†πÊçÆÁé©ÂÆ∂IDËé∑ÂèñËØ≠Èü≥
        function getPlayerVoice(playerId) {
            return playerVoices[playerId] || 'female01';
        }
        
        // Ê†πÊçÆÂ∫ß‰ΩçÁ¥¢ÂºïËé∑ÂèñÁé©ÂÆ∂ËØ≠Èü≥
        function getPlayerVoiceBySeat(seatIndex) {
            if (!gameState || !gameState.players) return 'female01';
            const player = gameState.players.find(p => p.seatIndex === seatIndex);
            if (player && player.voice) {
                return player.voice;
            }
            return playerVoices[player?.id] || 'female01';
        }
        
        // Ëß£ÈîÅÁßªÂä®ËÆæÂ§áÈü≥È¢ë
        function unlockAudio() {
            if (audioUnlocked) return;
            try {
                const silentAudio = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAAAwAAAbAAqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAbD/kaYhAAAAAAD/4xjAAAAANIAAAAAExBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/jGMAD/0AAAANIAAAAATVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV');
                silentAudio.play().then(() => {
                    audioUnlocked = true;
                    console.log('ÁßªÂä®ËÆæÂ§áÈü≥È¢ëÂ∑≤Ëß£ÈîÅ');
                }).catch(e => {});
            } catch (e) {}
        }
        
        // ÁõëÂê¨Áî®Êà∑‰∫§‰∫í‰ª•Ëß£ÈîÅÈü≥È¢ë
        ['click', 'touchstart'].forEach(event => {
            document.addEventListener(event, unlockAudio, { once: false, passive: true });
        });
        
        // Èü≥È¢ëÂä†ËΩΩÁä∂ÊÄÅ
        const audioLoading = {};
        
        // Êí≠ÊîæÈü≥È¢ëÊñá‰ª∂ÔºàÁõ¥Êé•Êí≠ÊîæÔºåÂêåÊó∂ÁºìÂ≠òÔºâ
        function playAudioFile(path, volume = 1.0) {
            console.log('Êí≠ÊîæÈü≥È¢ë:', path);
            
            try {
                // Ê£ÄÊü•ÁºìÂ≠ò - Â¶ÇÊûúÂ∑≤ÁºìÂ≠òÁõ¥Êé•Êí≠Êîæ
                if (audioCache[path] && audioCache[path].readyState >= 2) {
                    const audio = audioCache[path].cloneNode();
                    audio.volume = volume;
                    audio.play().then(() => {
                        console.log('ÁºìÂ≠òÈü≥È¢ëÊí≠ÊîæÊàêÂäü');
                    }).catch(e => {
                        console.error('ÁºìÂ≠òÈü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', e);
                    });
                    return;
                }
                
                // Êú™ÁºìÂ≠ò - Áõ¥Êé•ÂàõÂª∫Âπ∂Êí≠ÊîæÔºàÂêåÊó∂ÁºìÂ≠òÔºâ
                const audio = new Audio();
                audio.volume = volume;
                audio.preload = 'auto';
                audio.src = path;
                
                // Â∞ùËØïÁõ¥Êé•Êí≠Êîæ
                audio.play().then(() => {
                    // Êí≠ÊîæÊàêÂäüÔºåÁºìÂ≠òËµ∑Êù•
                    audioCache[path] = audio;
                    console.log('Êñ∞Èü≥È¢ëÊí≠ÊîæÊàêÂäüÂπ∂ÁºìÂ≠ò');
                }).catch(e => {
                    // Êí≠ÊîæÂ§±Ë¥•ÔºåÊí≠ÊîæËúÇÈ∏£Èü≥‰Ωú‰∏∫ÂèçÈ¶à
                    console.error('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', e.message);
                    const isTile = path.includes('/tiles/');
                    playBeep(isTile ? 600 : 400, 80);
                });
                
                // ÂêåÊó∂ÁºìÂ≠òÔºàÂç≥‰ΩøÊí≠ÊîæÂ§±Ë¥•‰πüÁºìÂ≠òÔºå‰∏ãÊ¨°Áî®Ôºâ
                audio.addEventListener('canplaythrough', () => {
                    audioCache[path] = audio;
                }, { once: true });
            } catch (e) {
                console.error('Èü≥È¢ëÂºÇÂ∏∏:', e);
                playBeep(523, 80);
            }
        }
        
        // Èü≥ÈáèÈÖçÁΩÆÔºàÊ†πÊçÆ‰∏çÂêåËØ≠Èü≥Ë∞ÉÊï¥Èü≥ÈáèÂπ≥Ë°°Ôºâ
        const AUDIO_VOLUMES = {
            female01: 0.6,  // Â•≥Â£∞1
            female02: 0.8,  // Â•≥Â£∞2
            male: 1.0,      // Áî∑Â£∞1
            male02: 1.0     // Áî∑Â£∞2
        };
        
        // Êí≠ÊîæÁâåÁöÑÈü≥È¢ëÔºàÊîØÊåÅÂ§öÁßçËØ≠Èü≥Ôºâ
        function playTileAudio(tile, voice = 'female01') {
            const name = getTileAudioName(tile);
            const format = AUDIO_FORMATS[voice] || '.mp3';
            const volume = AUDIO_VOLUMES[voice] || 1.0;
            playAudioFile(`audio/${voice}/tiles/${name}${format}`, volume);
        }
        
        // Êí≠ÊîæÂä®‰ΩúÈü≥È¢ëÔºàÊîØÊåÅÂ§öÁßçËØ≠Èü≥Ôºâ
        function playActionAudio(action, voice = 'female01') {
            const format = AUDIO_FORMATS[voice] || '.mp3';
            const volume = AUDIO_VOLUMES[voice] || 1.0;
            playAudioFile(`audio/${voice}/actions/${action}${format}`, volume);
        }
        
        // Èü≥È¢ëÊáíÂä†ËΩΩÈòüÂàó
        let audioLoadQueue = [];
        let audioEnabled = true; // Âº±ÁΩëÊó∂ÂèØÁ¶ÅÁî®
        
        // Êô∫ËÉΩÈ¢ÑÂä†ËΩΩÈü≥È¢ë - Âè™È¢ÑÂä†ËΩΩÂøÖË¶ÅÁöÑÔºåÈÅøÂÖçÂç°È°ø
        function preloadMultiplayerAudio() {
            // Ë∑≥ËøáÈ¢ÑÂä†ËΩΩÔºå‰ΩøÁî®Á∫ØÊáíÂä†ËΩΩÁ≠ñÁï•ÔºåÈÅøÂÖçÂç°È°ø
            console.log('Èü≥È¢ë‰ΩøÁî®ÊáíÂä†ËΩΩÊ®°ÂºèÔºåÈÅøÂÖçÂêØÂä®Âç°È°ø');
        }
        
        // Ê∏∏ÊàèÂºÄÂßãÊó∂È¢ÑÂä†ËΩΩÂΩìÂâçËØ≠Èü≥ÁöÑÂä®‰ΩúÈü≥È¢ë
        // ÈùôÈªòÈ¢ÑÂä†ËΩΩÂ∏∏Áî®Èü≥È¢ëÔºàÊ∏∏ÊàèÂºÄÂßãÂêéÂú®ÂêéÂè∞ÊâßË°åÔºâ
        function silentPreloadAudio(voice) {
            const actions = ['peng', 'gang', 'hu', 'zimo'];
            const commonTiles = ['wan1', 'wan2', 'wan3', 'tong1', 'tong2', 'tong3', 'tiao1', 'tiao2', 'tiao3'];
            
            let index = 0;
            const allPaths = [
                ...actions.map(a => `audio/${voice}/actions/${a}.mp3`),
                ...commonTiles.map(t => `audio/${voice}/tiles/${t}.mp3`)
            ];
            
            function loadNext() {
                if (index >= allPaths.length) return;
                const path = allPaths[index++];
                if (!audioCache[path] && !audioLoading[path]) {
                    audioLoading[path] = true;
                    const audio = new Audio();
                    audio.preload = 'auto';
                    audio.src = path;
                    audio.addEventListener('canplaythrough', () => {
                        audioCache[path] = audio;
                        delete audioLoading[path];
                        setTimeout(loadNext, 200);  // Èó¥ÈöîÂä†ËΩΩÔºå‰∏çÊä¢Â∏¶ÂÆΩ
                    }, { once: true });
                    audio.addEventListener('error', () => {
                        delete audioLoading[path];
                        setTimeout(loadNext, 100);
                    }, { once: true });
                    audio.load();
                } else {
                    setTimeout(loadNext, 50);
                }
            }
            
            loadNext();
            console.log('ÂºÄÂßãÂêéÂè∞È¢ÑÂä†ËΩΩÂ∏∏Áî®Èü≥È¢ë');
        }
        
        // È¢ÑÂä†ËΩΩÂçï‰∏™Èü≥È¢ëÔºà‰øùÁïôÊé•Âè£Ôºâ
        function preloadSingleAudio(path) {
            // ‰ΩøÁî®ÈùôÈªòÈ¢ÑÂä†ËΩΩ
        }
        
        // ÂàÜÊâπÂä†ËΩΩÈü≥È¢ëÔºà‰øùÁïôÊé•Âè£Ôºâ
        function loadAudioBatch(paths, batchSize = 5, delay = 100) {
            // ‰ΩøÁî®ÈùôÈªòÈ¢ÑÂä†ËΩΩ
        }
        
        // Êí≠ÊîæÈü≥È¢ëÔºàÂ∏¶Âº±ÁΩëÊ£ÄÊµãÔºâ
        const originalPlayAudioFile = playAudioFile;
        playAudioFile = function(path, volume = 1.0) {
            // Âº±ÁΩëÊó∂Ë∑≥ËøáÈü≥È¢ëÊí≠Êîæ
            if (networkQuality === 'slow' && !audioEnabled) {
                return;
            }
            
            try {
                if (audioCache[path]) {
                    const audio = audioCache[path].cloneNode();
                    audio.volume = volume;
                    audio.play().catch(e => {});
                    return;
                }
                
                // ÊáíÂä†ËΩΩÂπ∂Êí≠Êîæ
                const audio = new Audio(path);
                audio.volume = volume;
                audio.play().then(() => {
                    audioCache[path] = audio;
                }).catch(e => {});
            } catch (e) {}
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            // ÂàùÂßãÂåñËØ≠Èü≥
            initVoice();
            // Âª∂ËøüÂêØÂä®Èü≥È¢ëÈ¢ÑÂä†ËΩΩ
            setTimeout(preloadMultiplayerAudio, 2000);
        });
        
        // ==================== ËØ≠Èü≥Êí≠Êä•Á≥ªÁªüÔºàÂ§áÁî®Ôºâ ====================
        let speechEnabled = true;
        let audioContext = null;
        let speechReady = false;
        let voicesLoaded = false;
        
        // ÂàùÂßãÂåñËØ≠Èü≥Á≥ªÁªüÔºàÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÔºâ
        function initSpeech() {
            if (speechReady) return;
            
            try {
                // ÂàùÂßãÂåñ AudioContext
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                // Â∞ùËØïÂä†ËΩΩËØ≠Èü≥
                if (window.speechSynthesis) {
                    // Êüê‰∫õÊµèËßàÂô®ÈúÄË¶ÅÂÖàËé∑ÂèñËØ≠Èü≥ÂàóË°®
                    const voices = speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        voicesLoaded = true;
                        console.log('ËØ≠Èü≥ÂàóË°®Â∑≤Âä†ËΩΩ:', voices.length, '‰∏™');
                    }
                    
                    // ÁõëÂê¨ËØ≠Èü≥ÂàóË°®Âä†ËΩΩ
                    speechSynthesis.onvoiceschanged = () => {
                        voicesLoaded = true;
                        console.log('ËØ≠Èü≥ÂàóË°®Â∑≤Êõ¥Êñ∞');
                    };
                    
                    // Êí≠Êîæ‰∏Ä‰∏™Á©∫ÁöÑÊµãËØï
                    const testUtterance = new SpeechSynthesisUtterance('');
                    testUtterance.volume = 0;
                    speechSynthesis.speak(testUtterance);
                }
                
                speechReady = true;
                console.log('ËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñÊàêÂäü');
            } catch (e) {
                console.error('ËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•:', e);
            }
        }
        
        // Âú®Áî®Êà∑È¶ñÊ¨°‰∫§‰∫íÊó∂ÂàùÂßãÂåñ
        document.addEventListener('click', function initOnClick() {
            initSpeech();
            document.removeEventListener('click', initOnClick);
        }, { once: true });
        
        document.addEventListener('touchstart', function initOnTouch() {
            initSpeech();
            document.removeEventListener('touchstart', initOnTouch);
        }, { once: true });
        
        // Ëé∑ÂèñÁâåÁöÑËØ≠Èü≥ÂêçÁß∞
        function getTileSpeechName(tile) {
            const numNames = ['', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠', '‰∏É', 'ÂÖ´', '‰πù'];
            return numNames[tile.value] + TYPE_NAMES[tile.type];
        }
        
        // Ê£ÄÊµãÊòØÂê¶ÊòØÂçé‰∏∫ËÆæÂ§á
        const isHuawei = /huawei|honor/i.test(navigator.userAgent);
        let speechRetryCount = 0;
        const MAX_SPEECH_RETRY = 3;
        
        // ËØ≠Èü≥Êí≠Êä•ÔºàÂ¢ûÂº∫Âçé‰∏∫ÂÖºÂÆπÊÄßÔºâ
        function speak(text, rate = 1.0, pitch = 1.0) {
            if (!speechEnabled) return;
            
            // Â∞ùËØï‰ΩøÁî® Web Speech API
            if (window.speechSynthesis) {
                try {
                    // Âçé‰∏∫ËÆæÂ§áÁâπÊÆäÂ§ÑÁêÜÔºöÂÖàÂèñÊ∂àÂÜçÂª∂ËøüËØ¥ËØù
                    window.speechSynthesis.cancel();
                    
                    // Âçé‰∏∫ËÆæÂ§áÈúÄË¶ÅÂª∂ËøüÊâßË°å
                    const delay = isHuawei ? 100 : 0;
                    
                    setTimeout(() => {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.lang = 'zh-CN';
                        utterance.rate = isHuawei ? Math.min(rate, 0.9) : rate; // Âçé‰∏∫Èôç‰ΩéËØ≠ÈÄü
                        utterance.pitch = pitch;
                        utterance.volume = 1.0;
                        
                        // Â∞ùËØïÈÄâÊã©‰∏≠ÊñáËØ≠Èü≥
                        const voices = speechSynthesis.getVoices();
                        const zhVoice = voices.find(v => v.lang.includes('zh') || v.lang.includes('CN'));
                        if (zhVoice) {
                            utterance.voice = zhVoice;
                        }
                        
                        // Âçé‰∏∫ËÆæÂ§áÔºöÁõëÂê¨ÈîôËØØÂπ∂ÈáçËØï
                        utterance.onerror = (e) => {
                            console.warn('ËØ≠Èü≥Êí≠Êä•Âá∫Èîô:', e.error);
                            if (isHuawei && speechRetryCount < MAX_SPEECH_RETRY) {
                                speechRetryCount++;
                                console.log(`Âçé‰∏∫ËÆæÂ§áÈáçËØïËØ≠Èü≥ (${speechRetryCount}/${MAX_SPEECH_RETRY})`);
                                setTimeout(() => speak(text, rate, pitch), 200);
                            } else {
                                // ‰ΩøÁî®Èü≥ÊïàÂ§áÁî®
                                playBeep(660, 150);
                                vibrate(50);
                            }
                        };
                        
                        utterance.onend = () => {
                            speechRetryCount = 0; // ÊàêÂäüÂêéÈáçÁΩÆËÆ°Êï∞
                        };
                        
                        window.speechSynthesis.speak(utterance);
                        
                        // Âçé‰∏∫ËÆæÂ§áÈ¢ùÂ§ñÊ£ÄÊü•ÔºöÂ¶ÇÊûú3ÁßíÂêéËøòÊ≤°ËØ¥ÂÆåÂèØËÉΩÂç°‰Ωè‰∫Ü
                        if (isHuawei) {
                            setTimeout(() => {
                                if (window.speechSynthesis.speaking) {
                                    // ÂèØËÉΩÂç°‰Ωè‰∫ÜÔºåÂº∫Âà∂ÂèñÊ∂à
                                    window.speechSynthesis.cancel();
                                }
                            }, 3000);
                        }
                    }, delay);
                    
                } catch (e) {
                    console.error('ËØ≠Èü≥Êí≠Êä•Â§±Ë¥•:', e);
                    // Â§áÁî®ÔºöÈü≥Êïà + ÊåØÂä®ÊèêÁ§∫
                    playBeep(660, 150);
                    vibrate(50);
                }
            } else {
                // ‰∏çÊîØÊåÅËØ≠Èü≥ÂêàÊàêÔºå‰ΩøÁî®Èü≥Êïà + ÊåØÂä®
                playBeep(660, 150);
                vibrate(50);
            }
        }
        
        // ÊåØÂä®Â§áÁî®ÊñπÊ°à
        function vibrate(duration = 50) {
            if (navigator.vibrate) {
                navigator.vibrate(duration);
            }
        }
        
        // Êí≠ÊîæÁÆÄÂçïÈü≥ÊïàÔºàÂÖºÂÆπÊÄßÊõ¥Â•ΩÔºâ
        function playBeep(frequency = 440, duration = 100, type = 'sine') {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') audioContext.resume();
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration / 1000);
            } catch (e) {
                console.log('Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•:', e);
            }
        }
        
        // Êí≠Êä•Âá∫ÁâåÔºà‰ΩøÁî®Èü≥È¢ëÊñá‰ª∂ÔºåÊîØÊåÅÂ§öÁßçËØ≠Èü≥Ôºâ
        function speakDiscard(tile, voice = 'female01') {
            // ‰ΩøÁî®Èü≥È¢ëÊí≠Êîæ
            playTileAudio(tile, voice);
        }
        
        // Êí≠Êä•Âê¨Áâå
        function speakTing() {
            speak('Âê¨', 1.0, 1.3);
            playBeep(880, 150);
        }
        
        // Êí≠Êä•Á¢∞Ôºà‰ΩøÁî®Èü≥È¢ëÔºåÊîØÊåÅÂ§öÁßçËØ≠Èü≥Ôºâ
        function speakPeng(voice = 'female01') {
            playActionAudio('peng', voice);
        }
        
        // Êí≠Êä•Êù†Ôºà‰ΩøÁî®Èü≥È¢ëÔºåÊîØÊåÅÂ§öÁßçËØ≠Èü≥Ôºâ
        function speakGang(voice = 'female01') {
            playActionAudio('gang', voice);
        }
        
        // Êí≠Êä•ËÉ°ÁâåÔºà‰ΩøÁî®Èü≥È¢ëÔºåÊîØÊåÅÂ§öÁßçËØ≠Èü≥Ôºâ
        function speakHu(isZimo = false, voice = 'female01') {
            playActionAudio(isZimo ? 'zimo' : 'hu', voice);
            // Êí≠ÊîæËÉúÂà©Èü≥Êïà
            playBeep(523, 100);
            setTimeout(() => playBeep(659, 100), 100);
            setTimeout(() => playBeep(784, 150), 200);
        }
        
        // Êí≠ÊîæÁàÜÁÇ∏Èü≥ÊïàÔºàÊîæÁÇÆÊó∂Ôºâ
        function playExplosionSound() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') audioContext.resume();
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(40, audioContext.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
            } catch (e) {
                console.log('Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•:', e);
                vibrate(200);
            }
        }
        
        // Êí≠Êä•ÊîæÁÇÆ
        function speakFangPao() {
            playExplosionSound();
            setTimeout(() => speak('ÊîæÁÇÆ', 0.8, 0.6), 300);
        }

        // ËøûÊé•ÊúçÂä°Âô®
        let isConnected = false;
        let connectionAttempts = 0;
        
        function connectServer() {
            // Ê£ÄÊµãÊòØÂê¶Âú® GitHub Pages Á≠âÈùôÊÄÅÊâòÁÆ°‰∏ä
            const isStaticHost = window.location.hostname.includes('github.io') || 
                                 window.location.hostname.includes('gitee.io') ||
                                 window.location.hostname.includes('netlify.app') ||
                                 window.location.hostname.includes('vercel.app');
            
            if (isStaticHost) {
                // ÈùôÊÄÅÊâòÁÆ°Êó†Ê≥ïËøêË°å WebSocket ÊúçÂä°Âô®ÔºåÊòæÁ§∫ÊèêÁ§∫
                showServerRequiredModal();
                return;
            }
            
            // Ëá™Âä®Ê£ÄÊµãÊúçÂä°Âô®Âú∞ÂùÄ
            const serverUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? `http://${window.location.hostname}:3000`
                : window.location.origin;
            
            socket = io(serverUrl, {
                timeout: 10000,            // Â¢ûÂä†Ë∂ÖÊó∂Êó∂Èó¥
                reconnectionAttempts: 5,   // Â¢ûÂä†ÈáçËøûÊ¨°Êï∞
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                transports: ['websocket', 'polling'],  // ‰ºòÂÖà WebSocket
                upgrade: true
            });

            socket.on('connect', () => {
                console.log('Â∑≤ËøûÊé•ÊúçÂä°Âô®');
                myPlayerId = socket.id;
                isConnected = true;
                connectionAttempts = 0;
                
                // ÂêØÂä®ÁΩëÁªúË¥®ÈáèÊ£ÄÊµã
                startPingMonitor();
                updateNetworkIndicator('good');
            });

            socket.on('disconnect', () => {
                console.log('‰∏éÊúçÂä°Âô®Êñ≠ÂºÄËøûÊé•');
                isConnected = false;
                showToast('ËøûÊé•Â∑≤Êñ≠ÂºÄ');
            });
            
            socket.on('connect_error', () => {
                connectionAttempts++;
                if (connectionAttempts >= 3) {
                    showServerRequiredModal();
                }
            });

            // ÊàøÈó¥‰∫ã‰ª∂
            socket.on('room_created', (data) => {
                currentRoom = data.roomCode;
                showRoomScreen();
            });

            socket.on('room_joined', (data) => {
                currentRoom = data.roomCode;
                showRoomScreen();
            });

            socket.on('join_error', (data) => {
                showToast(data.message);
            });

            socket.on('room_updated', (data) => {
                updateRoomUI(data.room);
            });
            
            // Áé©ÂÆ∂Á¶ªÁ∫øÊèêÁ§∫
            socket.on('player_offline', (data) => {
                showToast(`‚ö†Ô∏è ${data.username} Êñ≠Á∫ø‰∫ÜÔºåÁ≠âÂæÖÈáçËøû...`, 5000);
            });
            
            // Áé©ÂÆ∂ÈáçËøû
            socket.on('player_reconnected', (data) => {
                showToast(`‚úÖ ${data.username} Â∑≤ÈáçËøûÔºÅ`);
            });

            // Ê∏∏Êàè‰∫ã‰ª∂
            socket.on('game_started', (data) => {
                mySeatIndex = data.yourSeat;
                gameState = data.gameState;
                
                // ÈáçÁΩÆÂê¨ÁâåÁä∂ÊÄÅ
                isTing = false;
                tingList = [];
                lastDrawnTileId = null;
                selectedTileId = null;
                
                // ÂÖ≥Èó≠ÁªìÁÆóÂºπÁ™ó
                document.getElementById('roundResultModal').classList.remove('active');
                
                // Ê£ÄÊü•ÊòØÂê¶Ë¢´AIÊé•ÁÆ°
                const myPlayer = gameState.players.find(p => p.seatIndex === mySeatIndex);
                if (myPlayer && myPlayer.aiTakeover) {
                    isAITakeover = true;
                    showTakeoverButton();
                    showToast('‚ö†Ô∏è AIÊ≠£Âú®‰ª£Êõø‰Ω†ËøõË°åÊ∏∏ÊàèÔºåÁÇπÂáª"Êé•ÁÆ°AI"ÊÅ¢Â§çÊéßÂà∂', 5000);
                } else {
                    isAITakeover = false;
                    hideTakeoverButton();
                }
                
                // Êõ¥Êñ∞Â±ÄÊï∞ÂíåÁßØÂàÜÊòæÁ§∫
                if (data.currentRound !== undefined) {
                    updateRoundDisplay(data.currentRound, data.totalRounds);
                }
                if (data.matchScores) {
                    updateScorePanel(data.matchScores);
                }
                
                showGameScreen();
                updateGameUI();
                
                // ÂêéÂè∞È¢ÑÂä†ËΩΩÂ∏∏Áî®Èü≥È¢ëÔºàÂª∂ËøüÊâßË°åÔºå‰∏çÈòªÂ°ûUIÔºâ
                setTimeout(() => {
                    silentPreloadAudio(myVoice);
                }, 1000);
                
                // „ÄêÂ¢ûÂº∫„ÄëÂ§ÑÁêÜÈáçËøû
                if (data.isReconnect) {
                    showToast('üîÑ Â∑≤ÈáçÊñ∞ËøûÊé•ÔºÅÁªßÁª≠Ê∏∏Êàè...', 3000);
                    console.log('Êñ≠Á∫øÈáçËøûÊàêÂäüÔºåÂ∫ß‰Ωç:', mySeatIndex, 'ÂΩìÂâçËΩÆÂà∞:', gameState.currentPlayerIndex);
                    
                    // Â¶ÇÊûúËΩÆÂà∞Ëá™Â∑±ÔºåËß¶ÂèëËá™Âä®Êë∏ÁâåÊàñÊòæÁ§∫Âá∫ÁâåÊèêÁ§∫
                    if (gameState.currentPlayerIndex === mySeatIndex) {
                        if (gameState.turnPhase === 'draw') {
                            setTimeout(() => autoDrawTile(), 500);
                        }
                    }
                } else {
                    showToast(`Á¨¨ ${data.currentRound || 1}/${data.totalRounds || 10} Â±ÄÂºÄÂßãÔºÅ`);
                }
            });
            
            // „ÄêÊñ∞Â¢û„ÄëËΩÆÂà∞‰Ω†ÁöÑÂõûÂêàÔºàÈáçËøûÂêéÈÄöÁü•Ôºâ
            socket.on('your_turn', (data) => {
                console.log('ËΩÆÂà∞‰Ω†‰∫Ü:', data);
                showToast(`üéØ ${data.message}`, 3000);
                
                if (data.phase === 'draw') {
                    // Ëá™Âä®Êë∏Áâå
                    setTimeout(() => autoDrawTile(), 300);
                }
            });

            socket.on('game_state_update', (data) => {
                const prevPhase = gameState?.turnPhase;
                const prevPlayer = gameState?.currentPlayerIndex;
                
                gameState = data.gameState;
                updateGameUI();
                
                console.log('Ê∏∏ÊàèÁä∂ÊÄÅÊõ¥Êñ∞:', 'Áé©ÂÆ∂:', gameState.currentPlayerIndex, 'Èò∂ÊÆµ:', gameState.turnPhase, 'ÊàëÁöÑÂ∫ß‰Ωç:', mySeatIndex);
                
                // Ëá™Âä®Êë∏ÁâåÔºöËΩÆÂà∞Áé©ÂÆ∂‰∏îÊòØÊë∏ÁâåÈò∂ÊÆµÊó∂Ëá™Âä®Êë∏Áâå
                // Âè™Âú®Áä∂ÊÄÅÂèòÂåñÊó∂Ëß¶ÂèëÔºåÈò≤Ê≠¢ÈáçÂ§ç
                const isMyTurn = gameState.currentPlayerIndex === mySeatIndex;
                const phaseChanged = prevPhase !== gameState.turnPhase || prevPlayer !== gameState.currentPlayerIndex;
                
                // „ÄêUIÊîπËøõ„ÄëËΩÆÂà∞Ëá™Â∑±Êó∂ÊòæÁ§∫ÊèêÁ§∫ÂíåÂèëÂÖâÊïàÊûú
                if (isMyTurn && gameState.turnPhase === 'discard' && phaseChanged) {
                    showTurnIndicator(true);
                    updateMyTurnEffect(true);
                } else if (!isMyTurn || gameState.turnPhase !== 'discard') {
                    updateMyTurnEffect(false);
                }
                
                // „ÄêÊñ∞Â¢û„ÄëÂ¶ÇÊûú‰∏çÊòØÊàëÁöÑÂá∫ÁâåÂõûÂêàÔºåÂÅúÊ≠¢ÂÄíËÆ°Êó∂
                if (!isMyTurn || gameState.turnPhase !== 'discard') {
                    stopDiscardCountdown();
                } else if (isMyTurn && gameState.turnPhase === 'discard' && !discardCountdownTimer) {
                    // ËΩÆÂà∞Ëá™Â∑±Âá∫Áâå‰ΩÜÊ≤°ÊúâÂÄíËÆ°Êó∂Âú®ËøêË°åÔºåÂèØËÉΩÊòØÈáçËøûÂêé
                    console.log('Ê£ÄÊµãÂà∞Âá∫ÁâåÈò∂ÊÆµÊó†ÂÄíËÆ°Êó∂ÔºåÂêØÂä®ÂÄíËÆ°Êó∂');
                    startDiscardCountdown(15);
                }
                
                if (isMyTurn && gameState.turnPhase === 'draw' && phaseChanged) {
                    console.log('Ëß¶ÂèëËá™Âä®Êë∏Áâå...');
                    setTimeout(() => {
                        autoDrawTile();
                    }, 500);
                }
            });

            socket.on('tile_drawn', (data) => {
                lastDrawnTileId = data.tile.id; // ËÆ∞ÂΩïÂàöÊë∏ÁöÑÁâå
                showToast(`Êë∏Âà∞: ${getTileName(data.tile)}`);
                
                // ÈáçÊñ∞Ê∏≤ÊüìÊâãÁâå‰ª•ÊòæÁ§∫Êñ∞ÁâåÈ´ò‰∫Æ
                if (gameState) {
                    const myPlayer = gameState.players.find(p => p.seatIndex === mySeatIndex);
                    if (myPlayer && myPlayer.hand) {
                        renderMyHand(myPlayer.hand);
                    }
                }
                
                // Âê¨ÁâåÂêéËá™Âä®Âá∫ÁâåÔºöÂª∂ËøüÊâßË°åÔºåÂÖàÁ≠âÂæÖÊúçÂä°Âô®Ê£ÄÊü•ÊòØÂê¶ËÉΩËÉ°Áâå
                if (isTing && lastDrawnTileId) {
                    console.log('Â∑≤Âê¨ÁâåÔºåÁ≠âÂæÖÊúçÂä°Âô®Ê£ÄÊü•ËÉ°Áâå...');
                    // Ê†áËÆ∞Á≠âÂæÖËÉ°ÁâåÊ£ÄÊü•
                    pendingAutoDiscard = true;
                    pendingAutoDiscardTileId = lastDrawnTileId;
                    // Âª∂Ëøü1.5ÁßíÂêéËá™Âä®Âá∫ÁâåÔºàÂ¶ÇÊûúÊ≤°ÊúâÊî∂Âà∞ËÉ°ÁâåÈÄâÈ°πÔºâ
                    setTimeout(() => {
                        if (pendingAutoDiscard && pendingAutoDiscardTileId) {
                            console.log('Êú™Êî∂Âà∞ËÉ°ÁâåÈÄâÈ°πÔºåËá™Âä®Âá∫Áâå');
                            showToast('Âê¨Áâå‰∏≠ÔºåËá™Âä®Âá∫Áâå...');
                            selectedTileId = pendingAutoDiscardTileId;
                            discardTile();
                            pendingAutoDiscard = false;
                            pendingAutoDiscardTileId = null;
                        }
                    }, 1500);
                }
            });
            
            // Êë∏Âà∞Ëä±ÁâåËá™Âä®Ë°•Ëä±
            socket.on('flower_drawn', (data) => {
                showToast(`üå∏ Êë∏Âà∞Ëä±ÁâåÔºö${data.flowerName}ÔºåË°•Ëä±‰∏≠...`, 2000);
                playBeep(880, 100); // Êí≠ÊîæÊèêÁ§∫Èü≥
                
                // Êõ¥Êñ∞Ëä±ÁâåÊòæÁ§∫
                const flowerEl = document.getElementById(`flower-${mySeatIndex}`);
                if (flowerEl) {
                    flowerEl.textContent = `üå∏${data.totalFlowers}`;
                }
            });

            socket.on('tile_discarded', (data) => {
                const player = gameState.players[data.playerIndex];
                const playerName = player?.username || 'Áé©ÂÆ∂';
                const playerVoice = player?.voice || getPlayerVoiceBySeat(data.playerIndex);
                const isMe = data.playerIndex === mySeatIndex;
                if (!isMe) {
                    showToast(`${playerName}: ${data.tileName}`);
                }
                // ËØ≠Èü≥Êí≠Êä•Âá∫ÁâåÔºà‰ΩøÁî®Âá∫ÁâåÁé©ÂÆ∂ÁöÑËØ≠Èü≥Ôºâ
                speakDiscard(data.tile, playerVoice);
            });

            socket.on('action_available', (data) => {
                console.log('Êî∂Âà∞ÂèØÊâßË°åÂä®‰Ωú:', data.actions);
                
                // ÂèñÊ∂àÁ≠âÂæÖËá™Âä®Âá∫ÁâåÔºàÊî∂Âà∞‰ªª‰ΩïÂä®‰ΩúÈÄâÈ°πÈÉΩÂ∫îËØ•ÂèñÊ∂àÔºâ
                pendingAutoDiscard = false;
                pendingAutoDiscardTileId = null;
                
                // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ËÉ°ÁâåÔºàÂåÖÊã¨ÁÇπÁÇÆËÉ°ÂíåËá™Êë∏ËÉ°Ôºâ
                const canHu = data.actions.includes('hu') || data.actions.includes('hu_zimo');
                
                // Ëá™Âä®ËÉ°ÁâåÔºöÂ¶ÇÊûúÂèØ‰ª•ËÉ°ÔºåËá™Âä®ÊâßË°å
                if (canHu) {
                    const huAction = data.actions.includes('hu_zimo') ? 'hu_zimo' : 'hu';
                    console.log('ÂèØ‰ª•ËÉ°ÁâåÔºåËá™Âä®ËÉ°ÁâåÔºÅÂä®‰Ωú:', huAction);
                    showToast('üéâ Ëá™Êë∏ËÉ°ÁâåÔºÅ');
                    setTimeout(() => {
                        doAction(huAction);
                    }, 500);
                    return;
                }
                
                // Â¶ÇÊûúÂê¨ÁâåÁä∂ÊÄÅÔºåËá™Âä®ËøáÔºà‰∏çÁ¢∞‰∏çÊù†Ôºâ
                if (isTing) {
                    console.log('Â∑≤Âê¨ÁâåÔºåËá™Âä®Ëøá');
                    setTimeout(() => {
                        doAction('pass');
                    }, 300);
                    return;
                }
                
                showResponseButtons(data.actions);
            });
            
            socket.on('action_timeout', () => {
                console.log('Âä®‰ΩúË∂ÖÊó∂ÔºåÈöêËóèÊåâÈíÆ');
                hideResponseButtons();
            });
            
            socket.on('action_error', (data) => {
                console.log('Âä®‰ΩúÈîôËØØ:', data.message);
                showToast('Êìç‰ΩúË∂ÖÊó∂ÔºåËØ∑Á≠âÂæÖ‰∏ãÊ¨°Êú∫‰ºö');
                hideResponseButtons();
            });

            socket.on('action_executed', (data) => {
                const player = gameState.players.find(p => p.seatIndex === data.playerIndex);
                const playerName = player?.username || 'Áé©ÂÆ∂';
                const playerVoice = player?.voice || getPlayerVoiceBySeat(data.playerIndex);
                const isMe = data.playerIndex === mySeatIndex;
                
                if (data.action === 'peng') {
                    showToast(`${isMe ? '‰Ω†' : playerName} Á¢∞ÔºÅ`);
                    speakPeng(playerVoice);
                } else if (data.action === 'gang') {
                    showToast(`${isMe ? '‰Ω†' : playerName} Êù†ÔºÅ`);
                    speakGang(playerVoice);
                } else if (data.action === 'hu') {
                    showToast(`${isMe ? '‰Ω†' : playerName} ËÉ°‰∫ÜÔºÅ`);
                    speakHu(false, playerVoice);
                }
            });

            socket.on('ai_draw', (data) => {
                // AIÊë∏ÁâåÊèêÁ§∫
            });
            
            // „ÄêÊñ∞Â¢û„ÄëÂá∫ÁâåÂÄíËÆ°Êó∂
            socket.on('discard_countdown', (data) => {
                console.log(`Âá∫ÁâåÂÄíËÆ°Êó∂ÂºÄÂßã: ${data.seconds}Áßí`);
                startDiscardCountdown(data.seconds);
            });
            
            // „ÄêÊñ∞Â¢û„ÄëËá™Âä®Âá∫ÁâåÈÄöÁü•
            socket.on('auto_discard', (data) => {
                console.log('Ë∂ÖÊó∂Ëá™Âä®Âá∫Áâå:', data.tile);
                showToast('‚è∞ ' + data.message);
                stopDiscardCountdown();
            });

            socket.on('game_ended', (data) => {
                // Ê£ÄÊµãÊòØÂê¶Êúâ‰∫∫ËÉ°Áâå
                if (data.result.includes('ËÉ°')) {
                    const isZimo = data.result.includes('Ëá™Êë∏');
                    speakHu(isZimo);
                    
                    // Â¶ÇÊûúÊòØÁÇπÁÇÆÔºåÊí≠ÊîæÁàÜÁÇ∏Èü≥Êïà
                    if (!isZimo && data.result.includes('ËÉ°Áâå')) {
                        setTimeout(() => playExplosionSound(), 500);
                    }
                }
                showResult(data.result, data.players);
            });
            
            // ÂçïÂ±ÄÁªìÁÆó
            socket.on('round_ended', (data) => {
                console.log('ÂçïÂ±ÄÁªìÁÆó:', data);
                // ÈáçÁΩÆÂáÜÂ§áÊåâÈíÆÁä∂ÊÄÅ
                const btn = document.getElementById('continueNextBtn');
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-play"></i> ÁªßÁª≠‰∏ã‰∏ÄÂ±Ä';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                showRoundResult(data);
            });
            
            // ÂÄíËÆ°Êó∂Êõ¥Êñ∞
            socket.on('countdown_update', (data) => {
                console.log('ÂÄíËÆ°Êó∂Êõ¥Êñ∞:', data.seconds);
                const countdownEl = document.getElementById('countdownSeconds');
                if (countdownEl) {
                    countdownEl.textContent = data.seconds;
                    // ÊúÄÂêé5ÁßíÂèòÁ∫¢
                    if (data.seconds <= 5) {
                        countdownEl.style.color = '#e74c3c';
                    } else {
                        countdownEl.style.color = '';
                    }
                }
                // Êõ¥Êñ∞Áé©ÂÆ∂ÂáÜÂ§áÁä∂ÊÄÅ
                if (data.readyStatus) {
                    updatePlayersReadyStatus(data.readyStatus);
                }
            });
            
            // ÂáÜÂ§áÁä∂ÊÄÅÊõ¥Êñ∞
            socket.on('ready_status_update', (data) => {
                console.log('ÂáÜÂ§áÁä∂ÊÄÅÊõ¥Êñ∞:', data);
                updatePlayersReadyStatus(data.readyStatus);
                if (data.countdown !== undefined) {
                    const countdownEl = document.getElementById('countdownSeconds');
                    if (countdownEl) {
                        countdownEl.textContent = data.countdown;
                    }
                }
            });
            
            // AIÊé•ÁÆ°Áä∂ÊÄÅ
            socket.on('ai_takeover_status', (data) => {
                console.log('AIÊé•ÁÆ°Áä∂ÊÄÅ:', data);
                updatePlayersReadyStatus(data.readyStatus);
                
                // Ê£ÄÊü•Ëá™Â∑±ÊòØÂê¶Ë¢´Êé•ÁÆ°
                const myStatus = data.readyStatus.find(p => p.seatIndex === mySeatIndex);
                if (myStatus && myStatus.aiTakeover) {
                    showToast('‚ö†Ô∏è ‰Ω†Êú™ÂáÜÂ§áÔºåAIÂ∞Ü‰ª£Êõø‰Ω†ËøõË°åÊ∏∏Êàè', 3000);
                    isAITakeover = true;
                }
            });
            
            // Êé•ÁÆ°AIÊàêÂäü
            socket.on('takeover_success', (data) => {
                console.log('Êé•ÁÆ°AIÊàêÂäü:', data);
                showToast('‚úÖ Â∑≤ÊÅ¢Â§çÊéßÂà∂ÊùÉÔºÅ', 2000);
                isAITakeover = false;
                hideTakeoverButton();
            });
            
            // ÂÖ∂‰ªñÁé©ÂÆ∂Êé•ÁÆ°AI
            socket.on('player_takeover', (data) => {
                console.log('Áé©ÂÆ∂Êé•ÁÆ°AI:', data);
                showToast(`${data.username} ÊÅ¢Â§ç‰∫ÜÊéßÂà∂ÊùÉ`);
            });
            
            // ÊØîËµõÁªìÊùü
            socket.on('match_ended', (data) => {
                console.log('ÊØîËµõÁªìÊùü:', data);
                showMatchResult(data);
            });

            // ËÅäÂ§©
            socket.on('chat_message', (data) => {
                addChatMessage(data.username, data.message);
            });
            
            // ÁõëÂê¨Ë°®ÊÉÖÊ∞îÊ≥°‰∫ã‰ª∂
            socket.on('emoji_received', (data) => {
                // Âú®ÂèëÈÄÅËÄÖÂ§¥ÂÉè‰ΩçÁΩÆÊòæÁ§∫Ë°®ÊÉÖÊ∞îÊ≥°
                if (data.seatIndex !== mySeatIndex) {
                    showEmojiBubble(data.emoji, data.seatIndex);
                }
            });
            
            // ÁõëÂê¨ËΩªÈáèÁ∫ßÊõ¥Êñ∞ÔºàÊÄßËÉΩ‰ºòÂåñÔºâ
            socket.on('light_update', (data) => {
                // Âø´ÈÄüÊõ¥Êñ∞ÂÖ≥ÈîÆÁä∂ÊÄÅ
                if (gameState && data) {
                    gameState.currentPlayerIndex = data.c;
                    gameState.turnPhase = data.t;
                    gameState.deckRemaining = data.r;
                    // ËΩªÈáèÊõ¥Êñ∞‰∏çÈáçÁªòÊâãÁâå
                    $('deckCount').textContent = data.r;
                }
            });
            
            // ÁΩëÁªúÂª∂ËøüÊ£ÄÊµã
            socket.on('pong', () => {
                const ping = Date.now() - lastPingTime;
                updateNetworkQuality(ping);
                updateNetworkIndicator(networkQuality);
            });
        }
        
        // ==================== ÁΩëÁªúË¥®ÈáèÁõëÊéß ====================
        
        let pingInterval = null;
        
        // ÂêØÂä® Ping ÁõëÊéß
        function startPingMonitor() {
            if (pingInterval) clearInterval(pingInterval);
            
            pingInterval = setInterval(() => {
                if (socket && socket.connected) {
                    lastPingTime = Date.now();
                    socket.emit('ping');
                }
            }, 5000); // ÊØè5ÁßíÊ£ÄÊµã‰∏ÄÊ¨°
        }
        
        // Êõ¥Êñ∞ÁΩëÁªúÊåáÁ§∫Âô®
        function updateNetworkIndicator(quality) {
            const indicator = $('networkIndicator') || document.getElementById('networkIndicator');
            const status = $('networkStatus') || document.getElementById('networkStatus');
            
            if (!indicator) return;
            
            indicator.className = 'network-indicator';
            
            switch (quality) {
                case 'slow':
                    indicator.classList.add('slow');
                    status.textContent = '‚ö†Ô∏è ÁΩëÁªúËæÉÊÖ¢';
                    document.body.classList.add('reduce-motion');
                    break;
                case 'medium':
                    indicator.classList.add('medium');
                    status.textContent = 'üì∂ ÁΩëÁªú‰∏ÄËà¨';
                    break;
                default:
                    // good - ÈöêËóèÊåáÁ§∫Âô®
                    document.body.classList.remove('reduce-motion');
                    break;
            }
        }
        
        // ÁõëÂê¨ÁΩëÁªúÁä∂ÊÄÅÂèòÂåñ
        if ('connection' in navigator) {
            navigator.connection.addEventListener('change', () => {
                const conn = navigator.connection;
                if (conn.effectiveType === '2g' || conn.effectiveType === 'slow-2g') {
                    networkQuality = 'slow';
                    updateNetworkIndicator('slow');
                    showToast('‚ö†Ô∏è Ê£ÄÊµãÂà∞Âº±ÁΩëÁéØÂ¢ÉÔºåÂ∑≤ÂêØÁî®ÁúÅÊµÅÊ®°Âºè');
                }
            });
        }
        
        // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÊó∂Â§ÑÁêÜ
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // È°µÈù¢ÊÅ¢Â§çÂèØËßÅÊó∂ÔºåËØ∑Ê±ÇÂÆåÊï¥Áä∂ÊÄÅÂêåÊ≠•
                if (socket && socket.connected && gameState) {
                    socket.emit('request_sync');
                }
            }
        });

        // ÊòæÁ§∫ÊúçÂä°Âô®Ë¶ÅÊ±ÇÊèêÁ§∫
        function showServerRequiredModal() {
            document.getElementById('serverRequiredModal').classList.add('active');
        }
        
        function closeServerModal() {
            document.getElementById('serverRequiredModal').classList.remove('active');
        }
        
        // ÂàùÂßãÂåñËØ≠Èü≥
        function initVoice() {
            // ÈªòËÆ§Â•≥Â£∞1
            myVoice = 'female01';
            console.log('ÂàùÂßãÂåñËØ≠Èü≥:', myVoice);
        }
        
        // ÈÄâÊã©ËØ≠Èü≥
        function selectVoice(voice) {
            myVoice = voice;
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.getElementById('voiceFemale01').classList.toggle('active', voice === 'female01');
            document.getElementById('voiceFemale02').classList.toggle('active', voice === 'female02');
            document.getElementById('voiceMale').classList.toggle('active', voice === 'male');
            document.getElementById('voiceMale02').classList.toggle('active', voice === 'male02');
            console.log('ÈÄâÊã©ËØ≠Èü≥:', voice);
        }
        
        // ÂàõÂª∫ÊàøÈó¥
        function createRoom() {
            if (!isConnected) {
                showServerRequiredModal();
                return;
            }
            username = document.getElementById('usernameInput').value.trim() || 'Áé©ÂÆ∂' + Math.floor(Math.random() * 1000);
            socket.emit('create_room', { username, avatar: 'üë§', voice: myVoice });
        }

        // Âä†ÂÖ•ÊàøÈó¥
        function joinRoom() {
            if (!isConnected) {
                showServerRequiredModal();
                return;
            }
            username = document.getElementById('usernameInput').value.trim() || 'Áé©ÂÆ∂' + Math.floor(Math.random() * 1000);
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (roomCode.length !== 6) {
                showToast('ËØ∑ËæìÂÖ•6‰ΩçÊàøÈó¥Âè∑');
                return;
            }
            
            socket.emit('join_room', { roomCode, username, avatar: 'üë§', voice: myVoice });
        }

        // ÊòæÁ§∫ÊàøÈó¥ÁïåÈù¢
        function showRoomScreen() {
            document.getElementById('lobbyScreen').classList.remove('active');
            document.getElementById('roomScreen').classList.add('active');
            document.getElementById('displayRoomCode').textContent = currentRoom;
        }

        // Êõ¥Êñ∞ÊàøÈó¥UI
        function updateRoomUI(room) {
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                const player = room.players.find(p => p.seatIndex === i);
                const slot = document.createElement('div');
                slot.className = 'player-slot' + (player ? ' filled' : '') + (player?.ready ? ' ready' : '');
                
                if (player) {
                    const isMe = player.id === myPlayerId;
                    slot.innerHTML = `
                        <div class="player-avatar">${player.avatar || 'üë§'}</div>
                        <div class="player-name">${player.username}${isMe ? ' (Êàë)' : ''}</div>
                        <div class="player-wind">${player.windName}È£é</div>
                        <div class="player-status ${player.isHost ? 'host' : (player.ready ? 'ready' : 'waiting')}">
                            ${player.isHost ? 'Êàø‰∏ª' : (player.ready ? 'Â∑≤ÂáÜÂ§á' : 'Êú™ÂáÜÂ§á')}
                        </div>
                    `;
                } else {
                    slot.innerHTML = `<div class="empty-slot">Á≠âÂæÖÁé©ÂÆ∂Âä†ÂÖ•...</div>`;
                }
                
                grid.appendChild(slot);
            }
        }

        // Â§çÂà∂ÊàøÈó¥Âè∑
        function copyRoomCode() {
            const roomCode = currentRoom || document.getElementById('displayRoomCode').textContent;
            
            // Â∞ùËØï‰ΩøÁî®Áé∞‰ª£ API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(roomCode).then(() => {
                    showToast('ÊàøÈó¥Âè∑Â∑≤Â§çÂà∂: ' + roomCode);
                }).catch(() => {
                    // Â§±Ë¥•Êó∂‰ΩøÁî®Â§áÁî®ÊñπÊ°à
                    fallbackCopy(roomCode);
                });
            } else {
                // ‰∏çÊîØÊåÅ clipboard APIÔºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à
                fallbackCopy(roomCode);
            }
        }
        
        // Â§áÁî®Â§çÂà∂ÊñπÊ≥ïÔºàÂÖºÂÆπ HTTPÔºâ
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            textArea.style.top = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast('ÊàøÈó¥Âè∑Â∑≤Â§çÂà∂: ' + text);
            } catch (err) {
                showToast('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂: ' + text);
            }
            
            document.body.removeChild(textArea);
        }

        // ÂáÜÂ§á/ÂèñÊ∂àÂáÜÂ§á
        function toggleReady() {
            isReady = !isReady;
            socket.emit('toggle_ready', { ready: isReady });
            
            const btn = document.getElementById('readyBtn');
            btn.innerHTML = isReady ? '<i class="fas fa-times"></i> ÂèñÊ∂àÂáÜÂ§á' : '<i class="fas fa-check"></i> ÂáÜÂ§á';
            btn.classList.toggle('secondary', isReady);
        }

        // Á¶ªÂºÄÊàøÈó¥
        function leaveRoom() {
            socket.emit('leave_room');
            currentRoom = null;
            isReady = false;
            document.getElementById('roomScreen').classList.remove('active');
            document.getElementById('lobbyScreen').classList.add('active');
        }

        // ÊòæÁ§∫Ê∏∏ÊàèÁïåÈù¢
        function showGameScreen() {
            document.getElementById('roomScreen').classList.remove('active');
            document.getElementById('gameScreen').classList.add('active');
            // Âè™Âú®Â§ßÂ±èÂπïÊòæÁ§∫ËÅäÂ§©Âå∫Âüü
            if (window.innerWidth > 768) {
                document.getElementById('chatArea').style.display = 'block';
            } else {
                document.getElementById('chatArea').style.display = 'none';
            }
            document.getElementById('actionButtons').classList.add('active');
            // Ê∑ªÂä†Ê∏∏Êàè‰∏≠Ê†áËÆ∞ÔºàËß¶ÂèëÊ®™Â±èÊèêÁ§∫Ôºâ
            document.body.classList.add('in-game');
            
            // „Äê‰øÆÂ§ç„ÄëÂÖ≥Èó≠ÂèØËÉΩÂ≠òÂú®ÁöÑÂºπÁ™ó
            document.getElementById('roundResultModal')?.classList.remove('active');
            document.getElementById('matchResultModal')?.classList.remove('active');
            document.getElementById('resultModal')?.classList.remove('active');
        }

        // Êõ¥Êñ∞Ê∏∏ÊàèUI - ‰ºòÂåñÁâàÔºàÂ¢ûÈáèÊõ¥Êñ∞ + RAFÔºâ
        function updateGameUI() {
            if (!gameState) return;
            
            // ‰ΩøÁî® requestAnimationFrame ÊâπÈáèÊõ¥Êñ∞
            scheduleUpdate(() => {
                _doUpdateGameUI();
            });
        }
        
        function _doUpdateGameUI() {
            if (!gameState) return;
            
            const prev = prevGameState;
            
            // Êõ¥Êñ∞Ââ©‰ΩôÁâåÊï∞ÔºàÂè™Âú®ÂèòÂåñÊó∂Êõ¥Êñ∞Ôºâ
            if (!prev || prev.deckRemaining !== gameState.deckRemaining) {
                $('deckCount').textContent = gameState.deckRemaining;
                const centerEl = $('centerDeckCount');
                if (centerEl) centerEl.textContent = gameState.deckRemaining;
            }

            // Êõ¥Êñ∞ÂΩìÂâçÂõûÂêàÊèêÁ§∫
            if (!prev || prev.currentPlayerIndex !== gameState.currentPlayerIndex) {
                const currentPlayer = gameState.players[gameState.currentPlayerIndex];
                const isMyTurn = gameState.currentPlayerIndex === mySeatIndex;
                $('currentTurnText').textContent = 
                    isMyTurn ? 'ËΩÆÂà∞‰Ω†‰∫ÜÔºÅ' : `${currentPlayer?.username || ''}ÁöÑÂõûÂêà`;
                $('currentWindIcon').textContent = 
                    WIND_NAMES[currentPlayer?.wind] || '';
            }

            // Êõ¥Êñ∞ÂêÑ‰∏™Â∫ß‰ΩçÔºàÂè™Êõ¥Êñ∞ÂèòÂåñÁöÑÂ∫ß‰ΩçÔºâ
            gameState.players.forEach((player, idx) => {
                const displaySeat = getDisplaySeat(player.seatIndex);
                const prevPlayer = prev?.players?.[idx];
                
                // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞
                const needUpdate = !prevPlayer ||
                    prevPlayer.handCount !== player.handCount ||
                    prevPlayer.offline !== player.offline ||
                    gameState.currentPlayerIndex !== prev?.currentPlayerIndex;
                    
                if (needUpdate) {
                    updateSeatUI(displaySeat, player);
                }
                
                // Êõ¥Êñ∞Ëä±ÁâåÊòæÁ§∫
                const prevFlowerCount = prevPlayer?.flowers?.length || 0;
                const flowerCount = player.flowers ? player.flowers.length : 0;
                if (prevFlowerCount !== flowerCount) {
                    const flowerEl = $(`flower-${displaySeat}`);
                    if (flowerEl) {
                        flowerEl.textContent = `üå∏${flowerCount}`;
                    }
                }
            });

            // Êõ¥Êñ∞ÊàëÁöÑÊâãÁâåÔºàÂè™Âú®ÊâãÁâåÂèòÂåñÊó∂ÂÆåÂÖ®ÈáçÁªòÔºâ
            const myPlayer = gameState.players.find(p => p.seatIndex === mySeatIndex);
            const prevMyPlayer = prev?.players?.find(p => p.seatIndex === mySeatIndex);
            
            if (myPlayer && myPlayer.hand) {
                const handChanged = !prevMyPlayer || 
                    !prevMyPlayer.hand ||
                    myPlayer.hand.length !== prevMyPlayer.hand.length ||
                    myPlayer.hand.some((t, i) => t.id !== prevMyPlayer.hand[i]?.id);
                    
                if (handChanged) {
                    renderMyHand(myPlayer.hand);
                }
                
                const meldsChanged = !prevMyPlayer ||
                    myPlayer.melds.length !== prevMyPlayer.melds?.length;
                    
                if (meldsChanged) {
                    renderMyMelds(myPlayer.melds);
                }
            }

            // Êõ¥Êñ∞Âá∫ÁâåÂå∫ÔºàÂè™Âú®ÊúâÊñ∞ÂºÉÁâåÊó∂Êõ¥Êñ∞Ôºâ
            const discardsChanged = gameState.players.some((p, i) => {
                const prevP = prev?.players?.[i];
                return !prevP || p.discards.length !== prevP.discards.length;
            });
            
            if (discardsChanged) {
                updateDiscardArea();
            }

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            updateActionButtons();
            
            // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÁî®‰∫é‰∏ãÊ¨°ÊØîËæÉ
            prevGameState = JSON.parse(JSON.stringify(gameState));
        }

        // Ëé∑ÂèñÊòæÁ§∫Â∫ß‰ΩçÔºàÁõ∏ÂØπ‰∫éËá™Â∑±ÁöÑ‰ΩçÁΩÆÔºâ
        function getDisplaySeat(seatIndex) {
            // Â∞ÜÁªùÂØπÂ∫ß‰ΩçËΩ¨Êç¢‰∏∫Áõ∏ÂØπ‰ΩçÁΩÆÔºö0=Ëá™Â∑±, 1=Âè≥ÂÆ∂, 2=ÂØπÂÆ∂, 3=Â∑¶ÂÆ∂
            return (seatIndex - mySeatIndex + 4) % 4;
        }

        // Êõ¥Êñ∞Â∫ß‰ΩçUI
        function updateSeatUI(displaySeat, player) {
            if (displaySeat === 0) return; // Ëá™Â∑±ÁöÑÂ∫ß‰ΩçÂçïÁã¨Â§ÑÁêÜ

            const prefix = displaySeat === 1 ? 'seat-1' : displaySeat === 2 ? 'seat-2' : 'seat-3';
            
            const avatarEl = document.getElementById(`avatar-${displaySeat}`);
            avatarEl.textContent = player.avatar || 'ü§ñ';
            avatarEl.classList.toggle('current-turn', gameState.currentPlayerIndex === player.seatIndex);
            avatarEl.classList.toggle('offline', player.offline === true);  // „ÄêÊñ∞Â¢û„ÄëÁ¶ªÁ∫øÊ†∑Âºè
            
            document.getElementById(`name-${displaySeat}`).textContent = player.username;
            document.getElementById(`wind-${displaySeat}`).textContent = player.windName;
            
            // „ÄêÊñ∞Â¢û„ÄëÂ∫ß‰Ωç‰ø°ÊÅØÁ¶ªÁ∫øÊ†∑Âºè
            const seatInfo = avatarEl.closest('.seat-info') || avatarEl.parentElement;
            if (seatInfo) {
                seatInfo.classList.toggle('offline', player.offline === true);
            }

            // ÊòæÁ§∫ÊâãÁâåÊï∞ÈáèÔºàËÉåÈù¢Ôºâ
            const tilesDiv = document.getElementById(`tiles-${displaySeat}`);
            tilesDiv.innerHTML = '';
            for (let i = 0; i < player.handCount; i++) {
                const tile = document.createElement('div');
                tile.className = 'tile small back';
                tilesDiv.appendChild(tile);
            }
        }

        // Ê∏≤ÊüìÊàëÁöÑÊâãÁâå - ‰ºòÂåñÁâàÔºà‰ΩøÁî® DocumentFragmentÔºâ
        function renderMyHand(hand) {
            const container = $('myHand') || document.getElementById('myHand');
            
            // ‰ΩøÁî® DocumentFragment ÊâπÈáèÊûÑÂª∫ DOM
            const fragment = document.createDocumentFragment();
            
            hand.forEach((tile, index) => {
                const isNewTile = (tile.id === lastDrawnTileId);
                const tileEl = createTileElement(tile, { isNew: isNewTile });
                
                // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÊèêÂçáÊÄßËÉΩ
                tileEl.dataset.tileId = tile.id;
                if (tile.id === selectedTileId) {
                    tileEl.classList.add('selected');
                }
                fragment.appendChild(tileEl);
            });
            
            // ‰∏ÄÊ¨°ÊÄßÊõøÊç¢ÊâÄÊúâÂÜÖÂÆπ
            container.innerHTML = '';
            container.appendChild(fragment);
        }
        
        // ÊâãÁâåÂå∫ÂüüÁÇπÂáª‰∫ã‰ª∂ÂßîÊâòÔºàÂáèÂ∞ë‰∫ã‰ª∂ÁõëÂê¨Âô®Êï∞ÈáèÔºâ
        document.addEventListener('DOMContentLoaded', () => {
            const handContainer = document.getElementById('myHand');
            if (handContainer) {
                handContainer.addEventListener('click', (e) => {
                    const tileEl = e.target.closest('.tile');
                    if (tileEl && tileEl.dataset.tileId) {
                        selectTile(tileEl.dataset.tileId);
                    }
                });
            }
        });

        // ÂàõÂª∫È∫ªÂ∞ÜÁâåÂÖÉÁ¥†
        function createTileElement(tile, options = {}) {
            const { small = false, isNew = false, discarded = false } = options;
            const el = document.createElement('div');
            
            let classes = ['tile', tile.type];
            if (small) classes.push('small');
            if (discarded) classes.push('discarded');
            if (isNew) classes.push('new-tile');
            
            // Á≤æÁÅµÂõæÊú™Âä†ËΩΩÂÆåÊàêÊó∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            if (!spritesLoaded) {
                classes.push('loading');
            }
            
            el.className = classes.join(' ');
            
            // Â∫îÁî®Á≤æÁÅµÂõæ‰ΩçÁΩÆ
            const spritePos = getSpritePosition(tile);
            if (spritePos && spritesLoaded) {
                el.style.cssText = spritePos;
            } else if (!spritesLoaded) {
                // ÂõæÁâáÂä†ËΩΩ‰∏≠ÔºåÂª∂ËøüËÆæÁΩÆÊ†∑Âºè
                el.dataset.spriteStyle = spritePos;
            } else {
                // Â§áÁî®ÊñáÂ≠óÊòæÁ§∫
                el.classList.add('text-mode');
                el.innerHTML = `
                    <div class="tile-text">
                        <span class="tile-value">${NUM_NAMES[tile.value]}</span>
                        <span class="tile-type">${TYPE_NAMES[tile.type]}</span>
                    </div>
                `;
            }
            
            el.title = `${NUM_NAMES[tile.value]}${TYPE_NAMES[tile.type]}`;
            return el;
        }

        // Ê∏≤ÊüìÊàëÁöÑÂâØÈú≤
        function renderMyMelds(melds) {
            const container = document.getElementById('myMelds');
            container.innerHTML = '';

            melds.forEach(meld => {
                const group = document.createElement('div');
                group.className = 'meld-group';
                meld.tiles.forEach(tile => {
                    group.appendChild(createTileElement(tile, { small: true }));
                });
                container.appendChild(group);
            });
        }

        // Êõ¥Êñ∞Âá∫ÁâåÂå∫
        function updateDiscardArea() {
            // Êõ¥Êñ∞‰∏≠Â§ÆÂâ©‰ΩôÁâåÊï∞
            const centerDeckCount = document.getElementById('centerDeckCount');
            if (centerDeckCount) {
                centerDeckCount.textContent = gameState.deckRemaining;
            }
            
            // ÊØè‰∏™Áé©ÂÆ∂ÁöÑÂºÉÁâåÊòæÁ§∫Âú®Ëá™Â∑±Èó®Ââç
            gameState.players.forEach(player => {
                const displaySeat = getDisplaySeat(player.seatIndex);
                const container = document.getElementById(`discards-${displaySeat}`);
                if (!container) return;
                
                container.innerHTML = '';
                player.discards.forEach(tile => {
                    const tileEl = createTileElement(tile, { small: true });
                    container.appendChild(tileEl);
                });
            });
        }

        // ÈÄâÊã©ÊâãÁâåÔºàÂèåÂáªÁõ¥Êé•Âá∫ÁâåÔºâ
        function selectTile(tileId) {
            console.log('ÈÄâÁâå:', tileId, 'ÂΩìÂâçÁé©ÂÆ∂:', gameState.currentPlayerIndex, 'ÊàëÁöÑÂ∫ß‰Ωç:', mySeatIndex, 'Èò∂ÊÆµ:', gameState.turnPhase);
            
            // Âè™ËÉΩÂú®Ëá™Â∑±ÁöÑÂõûÂêàÈÄâÁâå
            if (gameState.currentPlayerIndex !== mySeatIndex) {
                showToast('‰∏çÊòØ‰Ω†ÁöÑÂõûÂêà');
                return;
            }
            
            // ÂøÖÈ°ªÊòØÂá∫ÁâåÈò∂ÊÆµ
            if (gameState.turnPhase !== 'discard') {
                showToast('ËØ∑Á≠âÂæÖÊë∏Áâå...');
                return;
            }
            
            if (selectedTileId === tileId) {
                // ÂèåÂáªÁõ¥Êé•Âá∫Áâå
                discardTile();
                return;
            } else {
                selectedTileId = tileId;
            }
            
            document.querySelectorAll('#myHand .tile').forEach(el => {
                el.classList.remove('selected');
            });
            
            if (selectedTileId) {
                const myPlayer = gameState.players.find(p => p.seatIndex === mySeatIndex);
                const tileIndex = myPlayer.hand.findIndex(t => t.id === selectedTileId);
                if (tileIndex !== -1) {
                    document.querySelectorAll('#myHand .tile')[tileIndex]?.classList.add('selected');
                }
            }
            
            document.getElementById('discardBtn').disabled = !selectedTileId;
        }

        // Êõ¥Êñ∞Âä®‰ΩúÊåâÈíÆ
        function updateActionButtons() {
            const isMyTurn = gameState.currentPlayerIndex === mySeatIndex;
            const actionBtns = document.getElementById('actionButtons');
            
            // Âè™Âú®Âá∫ÁâåÈò∂ÊÆµÊòæÁ§∫Âá∫ÁâåÊåâÈíÆÔºàÊë∏ÁâåÊòØËá™Âä®ÁöÑÔºâ
            if (isMyTurn && gameState.turnPhase === 'discard') {
                actionBtns.classList.add('active');
                document.getElementById('discardBtn').disabled = !selectedTileId;
            } else {
                actionBtns.classList.remove('active');
            }
        }

        // ÊòæÁ§∫ÂìçÂ∫îÊåâÈíÆ
        function showResponseButtons(actions) {
            const container = document.getElementById('responseButtons');
            container.classList.add('active');
            
            container.querySelectorAll('.action-btn').forEach(btn => {
                const action = btn.classList.contains('hu') ? 'hu' :
                              btn.classList.contains('gang') ? 'gang' :
                              btn.classList.contains('peng') ? 'peng' : 'pass';
                btn.style.display = actions.includes(action) || action === 'pass' ? 'block' : 'none';
            });

            document.getElementById('actionButtons').classList.remove('active');
        }

        // ÈöêËóèÂìçÂ∫îÊåâÈíÆ
        function hideResponseButtons() {
            document.getElementById('responseButtons').classList.remove('active');
            document.getElementById('actionButtons').classList.add('active');
        }

        // ÊâãÂä®Êë∏ÁâåÔºàÂ§áÁî®Ôºâ
        function drawTile() {
            socket.emit('draw_tile');
        }
        
        // Ëá™Âä®Êë∏Áâå
        function autoDrawTile() {
            if (!gameState || gameState.currentPlayerIndex !== mySeatIndex) return;
            if (gameState.turnPhase !== 'draw') return;
            
            console.log('Ëá™Âä®Êë∏Áâå...');
            socket.emit('draw_tile');
        }

        // Âá∫Áâå
        function discardTile() {
            if (!selectedTileId) {
                showToast('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊâìÂá∫ÁöÑÁâå');
                return;
            }
            
            // Â¶ÇÊûúÂ∑≤Âê¨ÁâåÔºåÂè™ËÉΩÊâìÂàöÊë∏ÁöÑÁâå
            if (isTing && selectedTileId !== lastDrawnTileId) {
                showToast('Â∑≤Âê¨ÁâåÔºåÂè™ËÉΩÊâìÂàöÊë∏ÁöÑÁâåÔºÅ');
                return;
            }
            
            // Ê∏ÖÈô§ÂàöÊë∏ÁöÑÁâåÊ†áËÆ∞
            lastDrawnTileId = null;
            
            // „ÄêÊñ∞Â¢û„ÄëÂÅúÊ≠¢Âá∫ÁâåÂÄíËÆ°Êó∂
            stopDiscardCountdown();
            
            socket.emit('discard_tile', { tileId: selectedTileId });
            selectedTileId = null;
            
            // Âá∫ÁâåÂêéÊ£ÄÊµãÂê¨ÁâåÔºàÂª∂ËøüÁ≠âÂæÖÊúçÂä°Âô®Êõ¥Êñ∞Ôºâ
            setTimeout(() => {
                if (!isTing) {
                    checkAndShowTing();
                }
            }, 500);
        }

        // ÊâßË°åÂä®‰Ωú
        function doAction(action) {
            console.log('ÊâßË°åÂä®‰Ωú:', action);
            socket.emit('player_action', { action });
            hideResponseButtons();
            
            // ÊòæÁ§∫Âä®‰ΩúÁâπÊïà
            if (action === 'peng' || action === 'gang' || action === 'hu' || action === 'hu_zimo') {
                showActionEffect(action);
                
                // Êí≠ÊîæÂØπÂ∫îÈü≥È¢ë
                const myVoice = getPlayerVoiceBySeat(mySeatIndex);
                if (action === 'peng') {
                    playActionAudio('peng', myVoice);
                } else if (action === 'gang') {
                    playActionAudio('gang', myVoice);
                } else if (action === 'hu' || action === 'hu_zimo') {
                    playActionAudio('hu', myVoice);
                }
            }
        }
        
        // „ÄêÊñ∞Â¢û„ÄëÂá∫ÁâåÂÄíËÆ°Êó∂Áõ∏ÂÖ≥
        let discardCountdownTimer = null;
        let discardCountdownValue = 0;
        
        function startDiscardCountdown(seconds) {
            stopDiscardCountdown(); // ÂÖàÊ∏ÖÈô§‰πãÂâçÁöÑ
            discardCountdownValue = seconds;
            
            // ÂàõÂª∫ÊàñÊõ¥Êñ∞ÂÄíËÆ°Êó∂ÊòæÁ§∫
            let countdownEl = document.getElementById('discardCountdown');
            if (!countdownEl) {
                countdownEl = document.createElement('div');
                countdownEl.id = 'discardCountdown';
                countdownEl.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: #FFD700;
                    font-size: 48px;
                    font-weight: bold;
                    padding: 20px 40px;
                    border-radius: 15px;
                    z-index: 1000;
                    pointer-events: none;
                    transition: opacity 0.3s;
                `;
                document.body.appendChild(countdownEl);
            }
            
            countdownEl.style.display = 'block';
            countdownEl.style.opacity = '1';
            updateCountdownDisplay();
            
            discardCountdownTimer = setInterval(() => {
                discardCountdownValue--;
                if (discardCountdownValue <= 0) {
                    stopDiscardCountdown();
                } else {
                    updateCountdownDisplay();
                    // ÊúÄÂêé5ÁßíÂèòÁ∫¢Ëâ≤Ë≠¶Âëä
                    if (discardCountdownValue <= 5) {
                        countdownEl.style.color = '#FF4444';
                    }
                }
            }, 1000);
        }
        
        function updateCountdownDisplay() {
            const countdownEl = document.getElementById('discardCountdown');
            if (countdownEl) {
                countdownEl.textContent = `‚è± ${discardCountdownValue}`;
            }
        }
        
        function stopDiscardCountdown() {
            if (discardCountdownTimer) {
                clearInterval(discardCountdownTimer);
                discardCountdownTimer = null;
            }
            const countdownEl = document.getElementById('discardCountdown');
            if (countdownEl) {
                countdownEl.style.opacity = '0';
                setTimeout(() => {
                    countdownEl.style.display = 'none';
                    countdownEl.style.color = '#FFD700'; // ÈáçÁΩÆÈ¢úËâ≤
                }, 300);
            }
        }

        // Ëé∑ÂèñÁâåÂêç
        function getTileName(tile) {
            return NUM_NAMES[tile.value] + TYPE_NAMES[tile.type];
        }

        // ËØ≠Èü≥Êí≠Êä•
        function speakTile(tile) {
            if ('speechSynthesis' in window) {
                const text = getTileName(tile);
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 1.2;
                speechSynthesis.speak(utterance);
            }
        }

        // ÊòæÁ§∫ÁªìÊûú
        function showResult(result, players) {
            document.getElementById('resultTitle').textContent = result;
            
            let msg = 'ÊúÄÁªàÁªìÊûúÔºö\n\n';
            players.forEach(p => {
                msg += `${p.username}: ${p.score}ÂàÜ\n`;
            });
            document.getElementById('resultMessage').textContent = msg;
            
            document.getElementById('resultModal').classList.add('active');
        }

        // ÂÖ≥Èó≠ÁªìÊûú
        function closeResult() {
            document.getElementById('resultModal').classList.remove('active');
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('roomScreen').classList.add('active');
            document.getElementById('chatArea').style.display = 'none';
            document.body.classList.remove('in-game');
            isReady = false;
            document.getElementById('readyBtn').innerHTML = '<i class="fas fa-check"></i> ÂáÜÂ§á';
        }
        
        // ==================== ËÆ°ÂàÜÁ≥ªÁªü UI ====================
        
        // ÂΩìÂâçÊØîËµõÁöÑÁßØÂàÜ
        let matchScores = [0, 0, 0, 0];
        let currentRound = 1;
        let totalRounds = 10;
        
        // Êõ¥Êñ∞ÁßØÂàÜÈù¢Êùø
        function updateScorePanel(scores) {
            matchScores = scores;
            for (let i = 0; i < 4; i++) {
                const displaySeat = getDisplaySeat(i);
                const scoreEl = document.getElementById(`score-${displaySeat}`);
                if (scoreEl) {
                    const score = scores[i];
                    scoreEl.textContent = score >= 0 ? `+${score}` : score;
                    scoreEl.className = 'score-value ' + (score >= 0 ? 'positive' : 'negative');
                }
            }
        }
        
        // Êõ¥Êñ∞Â±ÄÊï∞ÊòæÁ§∫
        function updateRoundDisplay(current, total) {
            currentRound = current;
            totalRounds = total;
            document.getElementById('currentRoundNum').textContent = current;
            document.getElementById('currentRoundText').textContent = current;
            document.getElementById('totalRoundsText').textContent = total;
        }
        
        // ÊòæÁ§∫ÂçïÂ±ÄÁªìÁÆó
        function showRoundResult(data) {
            const { roundResult, currentRound, totalRounds, matchScores } = data;
            
            // Êõ¥Êñ∞ÁßØÂàÜÈù¢Êùø
            updateScorePanel(matchScores);
            
            // ËÆæÁΩÆÊ†áÈ¢ò
            let title = 'Êú¨Â±ÄÁªìÁÆó';
            if (roundResult.resultType === 'draw') {
                title = 'ÊµÅÂ±Ä';
                document.getElementById('roundWinnerInfo').style.display = 'none';
                document.getElementById('fanDetailList').style.display = 'none';
                document.getElementById('huaDetailList').style.display = 'none';
            } else {
                document.getElementById('roundWinnerInfo').style.display = 'block';
                document.getElementById('fanDetailList').style.display = 'block';
                document.getElementById('huaDetailList').style.display = 'block';
                
                const winner = roundResult.players.find(p => p.seatIndex === roundResult.winnerIndex);
                const winType = roundResult.resultType === 'zimo' ? 'Ëá™Êë∏ËÉ°ÁâåÔºÅ' : 'ËÉ°ÁâåÔºÅ';
                document.getElementById('winnerName').textContent = winner ? winner.username : '';
                document.getElementById('winType').textContent = winType;
                
                // ÊòæÁ§∫Áï™Êï∞ÊòéÁªÜ
                if (roundResult.scoreResult) {
                    const fanItems = document.getElementById('fanItems');
                    fanItems.innerHTML = '';
                    if (roundResult.scoreResult.fanDetail && roundResult.scoreResult.fanDetail.length > 0) {
                        roundResult.scoreResult.fanDetail.forEach(item => {
                            fanItems.innerHTML += `<div class="fan-item"><span class="fan-name">${item.name}</span><span class="fan-value">+${item.fan}Áï™</span></div>`;
                        });
                    } else {
                        fanItems.innerHTML = '<div class="fan-item"><span class="fan-name">È∏°ËÉ°</span><span class="fan-value">0Áï™</span></div>';
                    }
                    document.getElementById('totalFanDisplay').textContent = roundResult.scoreResult.totalFan + 'Áï™';
                    
                    // ÊòæÁ§∫Ëä±Êï∞ÊòéÁªÜ
                    const huaItems = document.getElementById('huaItems');
                    huaItems.innerHTML = '';
                    if (roundResult.scoreResult.huaDetail) {
                        roundResult.scoreResult.huaDetail.forEach(item => {
                            huaItems.innerHTML += `<div class="fan-item"><span class="fan-name">${item.name}</span><span class="fan-value">+${item.hua}Ëä±</span></div>`;
                        });
                    }
                    document.getElementById('totalHuaDisplay').textContent = roundResult.scoreResult.totalHua + 'Ëä±';
                }
            }
            
            document.getElementById('roundResultTitle').textContent = title;
            
            // ÊòæÁ§∫ÁßØÂàÜÂèòÂåñÔºàË°®Ê†ºÊ†∑ÂºèÔºåÊó†Ë°®Ê†ºÁ∫øÔºâ
            const scoreChangeItems = document.getElementById('scoreChangeItems');
            
            // ÊåâÊú¨Â±ÄÂæóÂàÜÊéíÂ∫è
            const sortedPlayers = [...roundResult.players].sort((a, b) => b.roundScore - a.roundScore);
            
            let tableHtml = '<table style="width: 100%; border-collapse: collapse;">';
            tableHtml += '<thead><tr style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">';
            tableHtml += '<th style="padding: 8px 5px; text-align: left;">ÊéíÂêç</th>';
            tableHtml += '<th style="padding: 8px 5px; text-align: left;">Áé©ÂÆ∂</th>';
            tableHtml += '<th style="padding: 8px 5px; text-align: right;">Êú¨Â±Ä</th>';
            tableHtml += '<th style="padding: 8px 5px; text-align: right;">Á¥ØËÆ°</th>';
            tableHtml += '</tr></thead><tbody>';
            
            sortedPlayers.forEach((p, idx) => {
                const change = p.roundScore;
                const changeColor = change > 0 ? '#2ecc71' : change < 0 ? '#e74c3c' : '#fff';
                const changeText = change >= 0 ? `+${change}` : change;
                const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : '4Ô∏è‚É£';
                const totalColor = p.totalScore > 0 ? '#2ecc71' : p.totalScore < 0 ? '#e74c3c' : '#fff';
                const totalText = p.totalScore >= 0 ? `+${p.totalScore}` : p.totalScore;
                const rowBg = idx === 0 && change > 0 ? 'rgba(46,204,113,0.15)' : 'transparent';
                
                tableHtml += `<tr style="background: ${rowBg};">`;
                tableHtml += `<td style="padding: 8px 5px;">${medal}</td>`;
                tableHtml += `<td style="padding: 8px 5px;">${p.username}${p.isBot ? ' (AI)' : ''}</td>`;
                tableHtml += `<td style="padding: 8px 5px; text-align: right; color: ${changeColor}; font-weight: bold;">${changeText}</td>`;
                tableHtml += `<td style="padding: 8px 5px; text-align: right; color: ${totalColor};">${totalText}</td>`;
                tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody></table>';
            scoreChangeItems.innerHTML = tableHtml;
            
            // ÊòæÁ§∫Â±ÄÊï∞
            document.getElementById('roundEndCurrent').textContent = currentRound;
            document.getElementById('roundEndTotal').textContent = totalRounds;
            
            // Â¶ÇÊûúÊòØÊúÄÂêé‰∏ÄÂ±ÄÔºåÈöêËóèÁªßÁª≠ÊåâÈíÆÂíåÂÄíËÆ°Êó∂Âå∫Âüü
            const continueBtn = document.getElementById('continueNextBtn');
            const countdownArea = document.getElementById('nextRoundCountdown');
            if (currentRound >= totalRounds) {
                continueBtn.style.display = 'none';
                countdownArea.style.display = 'none';
            } else {
                continueBtn.style.display = 'block';
                countdownArea.style.display = 'block';
                
                // ÂàùÂßãÂåñÂÄíËÆ°Êó∂ÊòæÁ§∫
                const countdownSeconds = data.countdownSeconds || 30;
                document.getElementById('countdownSeconds').textContent = countdownSeconds;
                
                // ÂàùÂßãÂåñÁé©ÂÆ∂ÂáÜÂ§áÁä∂ÊÄÅÔºàÊòæÁ§∫4‰∏™Á≠âÂæÖ‰∏≠Ôºâ
                updatePlayersReadyStatus([]);
            }
            
            document.getElementById('roundResultModal').classList.add('active');
        }
        
        // Êõ¥Êñ∞Áé©ÂÆ∂ÂáÜÂ§áÁä∂ÊÄÅÊòæÁ§∫
        function updatePlayersReadyStatus(readyStatus) {
            const container = document.getElementById('playersReadyStatus');
            if (!container) return;
            
            // Â¶ÇÊûúÊ≤°ÊúâÁä∂ÊÄÅÊï∞ÊçÆÔºå‰ΩøÁî®Ê∏∏Êàè‰∏≠ÁöÑÁé©ÂÆ∂‰ø°ÊÅØ
            if (!readyStatus || readyStatus.length === 0) {
                if (gameState && gameState.players) {
                    readyStatus = gameState.players.map(p => ({
                        seatIndex: p.seatIndex,
                        username: p.username,
                        ready: p.isBot,
                        isBot: p.isBot,
                        aiTakeover: false
                    }));
                } else {
                    return;
                }
            }
            
            container.innerHTML = readyStatus.map(p => {
                let statusClass = 'waiting';
                let statusIcon = '‚è≥';
                let statusText = 'Á≠âÂæÖ‰∏≠';
                
                if (p.isBot) {
                    statusClass = 'ready';
                    statusIcon = 'ü§ñ';
                    statusText = 'AI';
                } else if (p.aiTakeover) {
                    statusClass = 'ai-takeover';
                    statusIcon = 'ü§ñ';
                    statusText = 'AIÊé•ÁÆ°';
                } else if (p.ready) {
                    statusClass = 'ready';
                    statusIcon = '‚úì';
                    statusText = 'Â∑≤ÂáÜÂ§á';
                }
                
                const isMe = p.seatIndex === mySeatIndex ? ' (Êàë)' : '';
                
                return `
                    <div class="player-ready-item ${statusClass}">
                        ${statusIcon} ${p.username}${isMe}: ${statusText}
                    </div>
                `;
            }).join('');
        }
        
        // ÁªßÁª≠‰∏ã‰∏ÄÂ±Ä
        function continueNextRound() {
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            const btn = document.getElementById('continueNextBtn');
            btn.innerHTML = '<i class="fas fa-check"></i> Â∑≤ÂáÜÂ§áÔºåÁ≠âÂæÖÂÖ∂‰ªñÁé©ÂÆ∂...';
            btn.disabled = true;
            btn.style.opacity = '0.7';
            
            // ÂèëÈÄÅÂáÜÂ§áÁä∂ÊÄÅ
            isReady = true;
            socket.emit('toggle_ready', { ready: true });
            
            showToast('Â∑≤ÂáÜÂ§áÔºÅÁ≠âÂæÖÂÖ∂‰ªñÁé©ÂÆ∂...');
            console.log('Â∑≤ÂèëÈÄÅÂáÜÂ§áÁä∂ÊÄÅÔºåÁ≠âÂæÖ‰∏ã‰∏ÄÂ±Ä');
        }
        
        // Êé•ÁÆ°AIÔºàÊÅ¢Â§çÊéßÂà∂ÊùÉÔºâ
        function takeoverAI() {
            if (socket && isAITakeover) {
                socket.emit('takeover_ai');
                showToast('Ê≠£Âú®Êé•ÁÆ°...');
            }
        }
        
        // ÊòæÁ§∫Êé•ÁÆ°AIÊåâÈíÆ
        function showTakeoverButton() {
            const container = document.getElementById('takeoverContainer');
            if (container) {
                container.style.display = 'block';
            }
        }
        
        // ÈöêËóèÊé•ÁÆ°AIÊåâÈíÆ
        function hideTakeoverButton() {
            const container = document.getElementById('takeoverContainer');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        // ÊòæÁ§∫ÊúÄÁªàÁªìÁÆó
        function showMatchResult(data) {
            const { ranking, matchScores, totalRounds } = data;
            
            document.getElementById('matchTotalRounds').textContent = totalRounds;
            
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';
            
            const positionEmojis = ['ü•á', 'ü•à', 'ü•â', '4'];
            const positionClasses = ['first', 'second', 'third', ''];
            
            ranking.forEach((player, idx) => {
                const posClass = positionClasses[idx] || '';
                const posEmoji = positionEmojis[idx] || (idx + 1);
                const scoreClass = player.totalScore >= 0 ? 'positive' : 'negative';
                const scoreText = player.totalScore >= 0 ? `+${player.totalScore}` : player.totalScore;
                
                rankingList.innerHTML += `
                    <div class="ranking-item ${posClass}">
                        <span class="ranking-position ${posClass}">${posEmoji}</span>
                        <span class="ranking-name">${player.username}${player.isBot ? ' (AI)' : ''}</span>
                        <span class="ranking-score ${scoreClass}">${scoreText}</span>
                    </div>
                `;
            });
            
            // ÂÖ≥Èó≠ÂçïÂ±ÄÁªìÁÆóÂºπÁ™óÔºàÂ¶ÇÊûúËøòÂºÄÁùÄÔºâ
            document.getElementById('roundResultModal').classList.remove('active');
            document.getElementById('matchResultModal').classList.add('active');
        }
        
        // ÂÖ≥Èó≠ÊúÄÁªàÁªìÁÆó
        function closeMatchResult() {
            document.getElementById('matchResultModal').classList.remove('active');
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('roomScreen').classList.add('active');
            document.getElementById('chatArea').style.display = 'none';
            document.body.classList.remove('in-game');
            isReady = false;
            document.getElementById('readyBtn').innerHTML = '<i class="fas fa-check"></i> ÂáÜÂ§á';
            
            // ÈáçÁΩÆÁßØÂàÜ
            matchScores = [0, 0, 0, 0];
            updateScorePanel(matchScores);
        }

        // Á¶ªÂºÄÊ∏∏Êàè
        function leaveGame() {
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫Ê∏∏ÊàèÂêóÔºü')) {
                socket.emit('leave_room');
                document.getElementById('gameScreen').classList.remove('active');
                document.getElementById('lobbyScreen').classList.add('active');
                document.getElementById('chatArea').style.display = 'none';
                document.body.classList.remove('in-game');
                currentRoom = null;
            }
        }

        // ËÅäÂ§©Èù¢ÊùøÁä∂ÊÄÅ
        let chatPanelOpen = false;
        let unreadMessages = 0;
        
        // ÂàáÊç¢ËÅäÂ§©Èù¢Êùø
        function toggleChatPanel() {
            chatPanelOpen = !chatPanelOpen;
            const panel = document.getElementById('chatPanel');
            
            if (chatPanelOpen) {
                panel.classList.add('active');
                unreadMessages = 0;
                updateChatBadge();
                document.getElementById('chatInput').focus();
            } else {
                panel.classList.remove('active');
            }
        }
        
        // Êõ¥Êñ∞Êú™ËØªÊ∂àÊÅØÂæΩÁ´†
        function updateChatBadge() {
            const badge = document.getElementById('chatBadge');
            if (unreadMessages > 0) {
                badge.textContent = unreadMessages > 99 ? '99+' : unreadMessages;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // ÂèëÈÄÅËÅäÂ§©
        function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                socket.emit('chat_message', { message });
                input.value = '';
            }
        }

        // Ê∑ªÂä†ËÅäÂ§©Ê∂àÊÅØ
        function addChatMessage(name, message) {
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'chat-message';
            msg.innerHTML = `<span class="name">${name}:</span> ${message}`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
            
            // Â¶ÇÊûúËÅäÂ§©Èù¢ÊùøÊú™ÊâìÂºÄÔºåÂ¢ûÂä†Êú™ËØªÊ∂àÊÅØÊï∞
            if (!chatPanelOpen) {
                unreadMessages++;
                updateChatBadge();
            }
            
            // ÂêåÊó∂ÊòæÁ§∫Ê∂àÊÅØ Toast
            showToast(`üí¨ ${name}: ${message}`, 3000);
            container.scrollTop = container.scrollHeight;
        }

        // ToastÊèêÁ§∫
        function showToast(message, duration = 2000) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), duration);
        }

        // ÂõûËΩ¶ÂèëÈÄÅËÅäÂ§©
        document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        // ==================== Á≤æÁÅµÂõæÈ¢ÑÂä†ËΩΩ ====================
        
        let spritesLoaded = false;
        
        // È¢ÑÂä†ËΩΩÈ∫ªÂ∞ÜÁâåÁ≤æÁÅµÂõæ
        function preloadSprites() {
            const img = new Image();
            img.onload = function() {
                spritesLoaded = true;
                document.body.classList.add('sprites-loaded');
                console.log('È∫ªÂ∞ÜÁâåÁ≤æÁÅµÂõæÂä†ËΩΩÂÆåÊàê');
                
                // Â∫îÁî®Ê†∑ÂºèÂà∞ÊâÄÊúâÂä†ËΩΩ‰∏≠ÁöÑÁâå
                document.querySelectorAll('.tile.loading').forEach(tile => {
                    tile.classList.remove('loading');
                    if (tile.dataset.spriteStyle) {
                        tile.style.cssText = tile.dataset.spriteStyle;
                    }
                });
                
                // Â¶ÇÊûúÊ∏∏ÊàèÂ∑≤ÂºÄÂßãÔºåÂà∑Êñ∞ÊòæÁ§∫
                if (gameState) {
                    scheduleUpdate(() => _doUpdateGameUI());
                }
            };
            img.onerror = function() {
                console.warn('Á≤æÁÅµÂõæÂä†ËΩΩÂ§±Ë¥•ÔºåÂ∞Ü‰ΩøÁî®ÊñáÂ≠óÊ®°Âºè');
                spritesLoaded = true;
                document.body.classList.add('sprites-loaded');
                // ËΩ¨Êç¢ÊâÄÊúâÁâå‰∏∫ÊñáÂ≠óÊ®°Âºè
                document.querySelectorAll('.tile.loading').forEach(tile => {
                    tile.classList.remove('loading');
                    tile.classList.add('text-mode');
                });
            };
            img.src = '/img/majiang.png';
            
            // ÂêåÊó∂È¢ÑÂä†ËΩΩÂà∞ CSS ÁºìÂ≠òÔºàÈ´ò‰ºòÂÖàÁ∫ßÔºâ
            const preloadLink = document.createElement('link');
            preloadLink.rel = 'preload';
            preloadLink.as = 'image';
            preloadLink.href = '/img/majiang.png';
            preloadLink.fetchPriority = 'high';
            document.head.appendChild(preloadLink);
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂Á´ãÂç≥È¢ÑÂä†ËΩΩÁ≤æÁÅµÂõæ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', preloadSprites);
        } else {
            preloadSprites();
        }
        
        // ==================== UI/UX ÊîπËøõ - Âä®ÁîªÊïàÊûúÁ≥ªÁªü ====================
        
        // ÂàõÂª∫ËÉåÊôØÁ≤íÂ≠êÊïàÊûú
        function initParticles() {
            const container = document.getElementById('particlesContainer');
            if (!container) return;
            
            const particleCount = window.innerWidth < 768 ? 15 : 30;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDuration = (15 + Math.random() * 20) + 's';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.opacity = 0.1 + Math.random() * 0.3;
                particle.style.width = (3 + Math.random() * 4) + 'px';
                particle.style.height = particle.style.width;
                container.appendChild(particle);
            }
        }
        
        // ÊòæÁ§∫Âä®‰ΩúÁâπÊïàÔºàÁ¢∞/Êù†/ËÉ°Ôºâ
        function showActionEffect(action, playerName = '') {
            const effectTexts = {
                'peng': 'Á¢∞ÔºÅ',
                'gang': 'Êù†ÔºÅ',
                'hu': 'ËÉ°ÔºÅ',
                'zimo': 'Ëá™Êë∏ÔºÅ',
                'hu_zimo': 'Ëá™Êë∏ÔºÅ'
            };
            
            const text = effectTexts[action];
            if (!text) return;
            
            const effect = document.createElement('div');
            effect.className = 'action-effect';
            effect.innerHTML = `<div class="action-effect-text ${action}">${text}</div>`;
            document.body.appendChild(effect);
            
            // Êí≠ÊîæÁâπÊïàÂêéÁßªÈô§
            setTimeout(() => effect.remove(), 1500);
            
            // Â¶ÇÊûúÊòØËÉ°ÁâåÔºåÊòæÁ§∫ÁÉüËä±
            if (action === 'hu' || action === 'zimo' || action === 'hu_zimo') {
                showFireworks();
            }
        }
        
        // ÁÉüËä±ÊïàÊûú
        function showFireworks() {
            const container = document.getElementById('fireworksContainer');
            if (!container) return;
            
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
            const fireworkCount = window.innerWidth < 768 ? 5 : 10;
            
            for (let i = 0; i < fireworkCount; i++) {
                setTimeout(() => {
                    createFirework(container, colors);
                }, i * 200);
            }
        }
        
        function createFirework(container, colors) {
            const x = 20 + Math.random() * 60; // 20% ~ 80% Â±èÂπïÂÆΩÂ∫¶
            const y = 20 + Math.random() * 40; // 20% ~ 60% Â±èÂπïÈ´òÂ∫¶
            const color = colors[Math.floor(Math.random() * colors.length)];
            const particleCount = 12;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'firework-particle';
                particle.style.left = x + '%';
                particle.style.top = y + '%';
                particle.style.background = color;
                particle.style.boxShadow = `0 0 6px ${color}`;
                
                // ËÆ°ÁÆóÁ≤íÂ≠êÈ£ûË°åÊñπÂêë
                const angle = (i / particleCount) * 2 * Math.PI;
                const distance = 50 + Math.random() * 100;
                const endX = Math.cos(angle) * distance;
                const endY = Math.sin(angle) * distance;
                particle.style.setProperty('--particle-end', `translate(${endX}px, ${endY}px)`);
                
                container.appendChild(particle);
                
                // Âä®ÁîªÁªìÊùüÂêéÁßªÈô§
                setTimeout(() => particle.remove(), 1200);
            }
        }
        
        // ÊòæÁ§∫/ÈöêËóèËΩÆÂà∞Ëá™Â∑±ÁöÑÊèêÁ§∫
        function showTurnIndicator(show = true) {
            const indicator = document.getElementById('turnIndicator');
            if (!indicator) return;
            
            if (show) {
                indicator.classList.add('active');
                // 3ÁßíÂêéËá™Âä®ÈöêËóè
                setTimeout(() => {
                    indicator.classList.remove('active');
                }, 3000);
            } else {
                indicator.classList.remove('active');
            }
        }
        
        // Êõ¥Êñ∞ÊâãÁâåÂå∫ÂüüÁöÑËΩÆÂà∞Ëá™Â∑±ÊïàÊûú
        function updateMyTurnEffect(isMyTurn) {
            const handArea = document.querySelector('.my-hand-area');
            if (!handArea) return;
            
            if (isMyTurn && gameState?.turnPhase === 'discard') {
                handArea.classList.add('my-turn');
            } else {
                handArea.classList.remove('my-turn');
            }
        }
        
        // Âá∫ÁâåÈ£ûË°åÂä®Áîª
        function playDiscardAnimation(tileElement, callback) {
            if (!tileElement || document.body.classList.contains('reduce-motion')) {
                if (callback) callback();
                return;
            }
            
            tileElement.classList.add('discarding');
            
            setTimeout(() => {
                if (callback) callback();
            }, 400);
        }
        
        // Êë∏ÁâåÂä®Áîª
        function playDrawAnimation(tileElement) {
            if (!tileElement || document.body.classList.contains('reduce-motion')) return;
            
            tileElement.classList.add('drawing');
            
            setTimeout(() => {
                tileElement.classList.remove('drawing');
            }, 400);
        }
        
        // ÁâåÈù¢ÁÇπÂáªÊ≥¢Á∫πÊïàÊûú
        function createTileRipple(event, tileElement) {
            if (document.body.classList.contains('reduce-motion')) return;
            
            const rect = tileElement.getBoundingClientRect();
            const ripple = document.createElement('div');
            ripple.className = 'tile-ripple';
            ripple.style.left = (event.clientX - rect.left) + 'px';
            ripple.style.top = (event.clientY - rect.top) + 'px';
            ripple.style.width = '20px';
            ripple.style.height = '20px';
            
            tileElement.style.position = 'relative';
            tileElement.style.overflow = 'hidden';
            tileElement.appendChild(ripple);
            
            setTimeout(() => ripple.remove(), 600);
        }
        
        // Âø´Êç∑Ë°®ÊÉÖÈù¢Êùø
        let emojiPanelOpen = false;
        
        function toggleEmojiPanel() {
            emojiPanelOpen = !emojiPanelOpen;
            const panel = document.getElementById('emojiPanel');
            
            if (emojiPanelOpen) {
                panel.classList.add('active');
            } else {
                panel.classList.remove('active');
            }
        }
        
        // ÂèëÈÄÅË°®ÊÉÖ
        function sendEmoji(emoji) {
            socket.emit('chat_message', { message: emoji, isEmoji: true });
            toggleEmojiPanel();
            
            // Âú®Ëá™Â∑±Â§¥ÂÉè‰ΩçÁΩÆÊòæÁ§∫Ë°®ÊÉÖÊ∞îÊ≥°
            showEmojiBubble(emoji, mySeatIndex);
        }
        
        // ÂèëÈÄÅÂø´Êç∑ËØ≠Âè•
        function sendPhrase(phrase) {
            socket.emit('chat_message', { message: phrase });
            toggleEmojiPanel();
        }
        
        // ÊòæÁ§∫Ë°®ÊÉÖÊ∞îÊ≥°
        function showEmojiBubble(emoji, seatIndex) {
            // Ëé∑ÂèñÂØπÂ∫îÂ∫ß‰ΩçÁöÑ‰ΩçÁΩÆ
            const displaySeat = typeof seatIndex === 'number' ? getDisplaySeat(seatIndex) : seatIndex;
            const seatEl = document.querySelector(`.seat-${displaySeat} .seat-avatar`) ||
                          document.querySelector(`#seat-${displaySeat} .seat-avatar`);
            
            if (!seatEl) return;
            
            const rect = seatEl.getBoundingClientRect();
            const bubble = document.createElement('div');
            bubble.className = 'emoji-bubble';
            bubble.textContent = emoji;
            bubble.style.left = rect.left + rect.width / 2 + 'px';
            bubble.style.top = rect.top + 'px';
            
            document.body.appendChild(bubble);
            
            setTimeout(() => bubble.remove(), 2000);
        }
        
        // Ë¶ÜÁõñÂéüÊúâÁöÑ showToast ÂáΩÊï∞ÔºåÊ∑ªÂä†Âä®ÁîªÊïàÊûú
        const originalShowToast = showToast;
        showToast = function(message, duration = 2000) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.style.animation = 'none';
            toast.style.opacity = '0';
            toast.style.transform = 'translate(-50%, 10px)';
            
            document.body.appendChild(toast);
            
            // Âº∫Âà∂ÈáçÁªòÂêéÊ∑ªÂä†Âä®Áîª
            requestAnimationFrame(() => {
                toast.style.transition = 'all 0.3s ease-out';
                toast.style.opacity = '1';
                toast.style.transform = 'translate(-50%, 0)';
            });
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, -10px)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        };
        
        // Â¢ûÂº∫Ê∏∏ÊàèÁä∂ÊÄÅÊõ¥Êñ∞ÔºåÊ∑ªÂä†Âä®ÁîªÊïàÊûú
        const originalUpdateGameUI = scheduleUpdate;
        
        // ÁõëÂê¨Âä®‰ΩúÊâßË°å‰∫ã‰ª∂ÔºåÊòæÁ§∫ÁâπÊïà
        if (socket) {
            socket.on('action_executed', (data) => {
                console.log('Âä®‰ΩúÊâßË°å:', data);
                const player = gameState?.players?.[data.playerIndex];
                showActionEffect(data.action, player?.username);
                
                // Êí≠ÊîæÂØπÂ∫îÂä®‰ΩúÁöÑÈü≥È¢ë
                if (data.action === 'peng') {
                    playActionAudio('peng', getPlayerVoiceBySeat(data.playerIndex));
                } else if (data.action === 'gang') {
                    playActionAudio('gang', getPlayerVoiceBySeat(data.playerIndex));
                }
            });
            
            // ÁõëÂê¨Ë°®ÊÉÖÊ∂àÊÅØ
            socket.on('emoji_received', (data) => {
                showEmojiBubble(data.emoji, data.seatIndex);
            });
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñÁ≤íÂ≠êÊïàÊûú
        document.addEventListener('DOMContentLoaded', () => {
            initParticles();
            
            // ‰∏∫ÊâãÁâåÊ∑ªÂä†ÁÇπÂáªÊ≥¢Á∫πÊïàÊûú
            document.addEventListener('click', (e) => {
                const tile = e.target.closest('.tile');
                if (tile && !tile.classList.contains('back')) {
                    createTileRipple(e, tile);
                }
            });
        });
        
        // Ë¶ÜÁõñÊõ¥Êñ∞Ê∏∏ÊàèUIÔºåÊ∑ªÂä†ËΩÆÂà∞Ëá™Â∑±ÁöÑÊïàÊûú
        const _originalDoUpdateGameUI = typeof _doUpdateGameUI !== 'undefined' ? _doUpdateGameUI : null;
        if (_originalDoUpdateGameUI) {
            const wrappedUpdateGameUI = _originalDoUpdateGameUI;
            _doUpdateGameUI = function() {
                wrappedUpdateGameUI.apply(this, arguments);
                
                // Ê£ÄÊü•ÊòØÂê¶ËΩÆÂà∞Ëá™Â∑±
                if (gameState) {
                    const isMyTurn = gameState.currentPlayerIndex === mySeatIndex;
                    const isDiscardPhase = gameState.turnPhase === 'discard';
                    updateMyTurnEffect(isMyTurn && isDiscardPhase);
                }
            };
        }
        
        // ÂàùÂßãÂåñ
        connectServer();
    </script>
</body>
</html>


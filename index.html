<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‰∏äÊµ∑Êï≤È∫ª - Â§ö‰∫∫ËÅîÊú∫Áâà | AIÂ∞èÊ∏∏ÊàèÂπ≥Âè∞</title>
    <link rel="preload" href="/img/majiang.png" as="image" fetchpriority="high">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            --table-green: #1a5c3a;
            --table-dark: #0d3321;
            --gold: #d4af37;
            --gold-light: #f4d03f;
            --tile-bg: #f5f0e1;
            --tile-border: #c9b896;
            --red: #c0392b;
            --blue: #2980b9;
            --green: #27ae60;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: radial-gradient(ellipse at center, var(--table-green) 0%, var(--table-dark) 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        /* ÈÄöÁî®ÂÆπÂô® */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .screen.active { display: flex; }

        /* Â§ßÂéÖÁïåÈù¢ */
        .lobby-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 3.5rem;
            color: var(--gold);
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .lobby-subtitle {
            font-size: 1.2rem;
            color: rgba(255,255,255,0.8);
            margin-bottom: 30px;
        }

        .lobby-container {
            background: rgba(0,0,0,0.4);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 100%;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--gold);
            font-size: 1.1rem;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            border: 2px solid var(--gold);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            outline: none;
            text-transform: uppercase;
        }

        .input-group input::placeholder {
            color: rgba(255,255,255,0.5);
            text-transform: none;
        }

        /* ËØ≠Èü≥ÈÄâÊã©Âô® */
        .voice-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .voice-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px 12px;
            font-size: 0.9rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .voice-btn:hover {
            border-color: var(--gold);
            color: #fff;
        }
        
        .voice-btn.active {
            border-color: var(--gold);
            background: linear-gradient(135deg, rgba(212,175,55,0.3) 0%, rgba(184,134,11,0.3) 100%);
            color: var(--gold);
            font-weight: bold;
        }
        
        .voice-btn i {
            font-size: 1rem;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 16px 30px;
            margin: 12px 0;
            font-size: 1.2rem;
            font-family: 'Ma Shan Zheng', cursive;
            background: linear-gradient(135deg, var(--gold) 0%, #b8860b 100%);
            color: #1a1a1a;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212,175,55,0.4);
        }

        .btn.secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 2px solid var(--gold);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 25px 0;
            color: rgba(255,255,255,0.5);
        }

        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.3);
        }

        .divider span {
            padding: 0 15px;
        }

        /* ÊàøÈó¥ÁïåÈù¢ */
        .room-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .room-code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 2.8rem;
            font-weight: bold;
            color: var(--gold);
            letter-spacing: 6px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid var(--gold);
        }

        .room-code-label {
            font-size: 1rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 5px;
        }

        .copy-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .room-container {
            background: rgba(0,0,0,0.4);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .player-slot {
            background: rgba(255,255,255,0.1);
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .player-slot.filled {
            border-style: solid;
            border-color: var(--gold);
            background: rgba(212,175,55,0.1);
        }

        .player-slot.ready {
            border-color: var(--green);
            background: rgba(39,174,96,0.2);
        }

        .player-avatar {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .player-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .player-wind {
            font-size: 0.9rem;
            color: var(--gold);
        }

        .player-status {
            font-size: 0.85rem;
            margin-top: 5px;
            padding: 3px 12px;
            border-radius: 10px;
        }

        .player-status.ready {
            background: var(--green);
            color: #fff;
        }

        .player-status.waiting {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }

        .player-status.host {
            background: var(--gold);
            color: #1a1a1a;
        }

        .empty-slot {
            color: rgba(255,255,255,0.5);
            font-size: 1rem;
        }

        .room-actions {
            display: flex;
            gap: 15px;
        }

        .room-actions .btn {
            flex: 1;
        }

        /* Ê∏∏ÊàèÁïåÈù¢ - ÈááÁî®Âçï‰∫∫Ê®°ÂºèÂ∏ÉÂ±Ä */
        .game-screen {
            padding: 8px;
            justify-content: flex-start;
            min-height: 100vh;
            min-height: 100dvh;
        }

        /* È°∂ÈÉ®Áä∂ÊÄÅÊ†è - Âçï‰∫∫Ê®°ÂºèÊ†∑Âºè */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            margin-bottom: 10px;
            width: 100%;
            max-width: 800px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-icon {
            width: 30px;
            height: 30px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a1a;
            font-weight: bold;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .takeover-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        .takeover-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border: 2px solid #fff;
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* È∫ªÂ∞ÜÊ°åÈù¢ - Âçï‰∫∫Ê®°ÂºèÊ†∑Âºè */
        .mahjong-table { 
            background: radial-gradient(ellipse at center, #2d8b57 0%, #1a5c3a 50%, #0d3321 100%);
            border: 8px solid #5d4037;
            border-radius: 20px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.3), 0 10px 30px rgba(0,0,0,0.5);
            padding: 20px;
            position: relative;
            min-height: 500px;
            width: 100%;
            max-width: 800px;
        }

        /* ÂØπÊâãÂå∫Âüü - Âçï‰∫∫Ê®°ÂºèÁΩëÊ†ºÂ∏ÉÂ±Ä */
        .opponents-area {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .opponent {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 10px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--gold) 0%, #b8860b 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 3px solid white;
        }

        .player-avatar.current-turn {
            animation: pulse 1s infinite;
        }

        .player-avatar.offline {
            filter: grayscale(100%);
            opacity: 0.5;
        }

        .player-avatar.dealer {
            border: 3px solid #ffd700;
            box-shadow: 0 0 10px #ffd700;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(212,175,55,0.7); }
            50% { box-shadow: 0 0 0 10px rgba(212,175,55,0); }
        }

        .player-name {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .player-wind {
            background: var(--red);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .opponent-hand {
            display: flex;
            justify-content: center;
            gap: 2px;
            flex-wrap: wrap;
        }

        .melds-area {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .meld-group {
            display: flex;
            gap: 2px;
            background: rgba(255,255,255,0.1);
            padding: 5px;
            border-radius: 5px;
        }

        /* ‰∏≠Â§ÆÂá∫ÁâåÂå∫Âüü - Âçï‰∫∫Ê®°ÂºèÂõõÊñπÂêëÂºÉÁâåÂå∫ */
        .center-area {
            background: rgba(0,0,0,0.15);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
        }

        .discard-zone {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 8px;
            margin: 5px 0;
        }

        .discard-zone .zone-label {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
            margin-bottom: 5px;
            text-align: center;
        }

        .discard-zone .discards {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            justify-content: center;
            min-height: 35px;
        }

        .discard-sides {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .discard-zone.left,
        .discard-zone.right {
            flex: 1;
        }

        .discard-zone.bottom {
            border: 1px solid var(--gold);
            background: rgba(212,175,55,0.1);
        }

        .discard-zone.bottom .zone-label {
            color: var(--gold);
        }

        /* Áé©ÂÆ∂Âå∫Âüü - Âçï‰∫∫Ê®°ÂºèÊ†∑Âºè */
        .player-area {
            position: relative;
        }

        /* ÊâãÁâåÂå∫Âüü */
        .hand-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 4px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            min-height: 100px;
        }

        /* Ëä±ÁâåÂå∫Âüü */
        .flowers-area {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .flower-tile {
            width: 35px;
            height: 50px;
        }

        /* ÂØπÊâãËä±ÁâåÊòæÁ§∫Âå∫Âüü */
        .opponent-flowers {
            display: flex;
            gap: 3px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 5px;
            min-height: 30px;
        }

        .opponent-flowers .tile {
            width: 24px;
            height: 34px;
            font-size: 0.7rem;
        }

        .opponent-flowers .tile.small {
            width: 22px;
            height: 30px;
        }

        /* Êìç‰ΩúÊåâÈíÆ - Âçï‰∫∫Ê®°ÂºèÊ†∑Âºè */
        .action-panel {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 25px;
            font-size: 1.1rem;
            font-family: 'Ma Shan Zheng', cursive;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--gold) 0%, #b8860b 100%);
            color: #1a1a1a;
        }

        .action-btn.secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .action-btn.success {
            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
            color: white;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .action-btn:not(:disabled):hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* È∫ªÂ∞ÜÁâåÊ†∑Âºè */
        .tile { 
            width: 50px;
            height: 70px;
            background-color: #f5f0e1;
            background-image: url('/img/majiang.png');
            background-repeat: no-repeat;
            border: 2px solid var(--tile-border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            position: relative;
            user-select: none;
        }

        .tile:hover {
            transform: translateY(-8px);
            box-shadow: 2px 8px 15px rgba(0,0,0,0.4);
        }

        .tile.selected {
            transform: translateY(-15px);
            border-color: var(--gold);
            box-shadow: 0 0 20px rgba(212,175,55,0.6);
        }
        
        .tile.new-tile {
            margin-left: 15px;
            border-color: #3498db;
            box-shadow: 0 0 15px rgba(52,152,219,0.8);
            animation: newTilePulse 1s ease-in-out infinite;
        }
        
        @keyframes newTilePulse {
            0%, 100% { box-shadow: 0 0 15px rgba(52,152,219,0.8); }
            50% { box-shadow: 0 0 25px rgba(52,152,219,1); }
        }

        .tile.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .tile.small {
            width: 32px;
            height: 45px;
        }
        
        .tile.loading {
            background-image: none;
            background: linear-gradient(135deg, #e0d8c8 25%, #f5f0e1 50%, #e0d8c8 75%);
            background-size: 200% 100%;
            animation: tileLoading 1s ease-in-out infinite;
        }
        
        @keyframes tileLoading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        body.sprites-loaded .tile.loading {
            animation: none;
            background: #f5f0e1;
        }

        .tile.back {
            background-image: none;
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            border-color: #1b5e20;
        }

        .tile.back::after {
            content: 'üÄ´';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            opacity: 0.5;
        }

        .tile.small.back::after {
            font-size: 0.8rem;
        }

        .tile-text {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .tile.text-mode {
            background-image: none !important;
            background: linear-gradient(180deg, #fff 0%, var(--tile-bg) 100%);
        }

        .tile.text-mode .tile-text {
            display: flex;
        }

        .tile-value {
            font-size: 1.6rem;
            font-weight: bold;
            line-height: 1;
        }

        .tile-suit {
            font-size: 0.65rem;
            color: #666;
            margin-top: 2px;
        }

        .tile.wan .tile-value { color: var(--red); }
        .tile.tiao .tile-value { color: var(--green); }
        .tile.tong .tile-value { color: var(--blue); }
        .tile.feng .tile-value { color: #333; }
        .tile.hua .tile-value { color: #9b59b6; }

        /* Âä®‰ΩúÊèêÁ§∫ÊåâÈíÆ */
        .action-hints {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 500;
        }

        .hint-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            font-family: 'Ma Shan Zheng', cursive;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: 3px solid white;
            border-radius: 15px;
            cursor: pointer;
            animation: bounce 0.5s ease infinite;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Ê∂àÊÅØÂºπÁ™ó */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 20px;
        }

        .modal-message {
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* ÁßØÂàÜÈù¢Êùø */
        .score-panel {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .score-item {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 5px 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .flower-count {
            font-size: 0.7rem;
            color: #ff9999;
            min-width: 70px;
        }
        
        .score-name {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
        }
        
        .score-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--gold);
        }
        
        .score-value.positive { color: #2ecc71; }
        .score-value.negative { color: #e74c3c; }

        /* ËÅäÂ§©Èù¢Êùø */
        .chat-toggle-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gold);
            color: #1a1a1a;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none;
        }
        
        body.in-game .chat-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: #fff;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
        }
        
        .chat-panel {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 300px;
            max-height: 350px;
            background: rgba(0,0,0,0.9);
            border: 2px solid var(--gold);
            border-radius: 15px;
            overflow: hidden;
            z-index: 600;
            flex-direction: column;
        }
        
        .chat-panel.active {
            display: flex;
        }
        
        .chat-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(212,175,55,0.2);
            border-bottom: 1px solid var(--gold);
        }
        
        .chat-panel .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            max-height: 200px;
        }
        
        .chat-panel .chat-input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .chat-panel .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.9rem;
        }
        
        .chat-panel .chat-send {
            margin-left: 8px;
            padding: 8px 12px;
            background: var(--gold);
            color: #1a1a1a;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        
        .chat-message {
            padding: 5px 0;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .chat-message .name {
            color: var(--gold);
            font-weight: bold;
        }

        /* Ë°®ÊÉÖÈù¢Êùø */
        .emoji-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid var(--gold);
            border-radius: 15px;
            padding: 15px;
            z-index: 800;
            display: none;
            flex-direction: column;
            gap: 10px;
            max-width: 280px;
        }
        
        .emoji-panel.active {
            display: flex;
            animation: panelSlideUp 0.3s ease-out;
        }
        
        @keyframes panelSlideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .emoji-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .emoji-panel-header h4 {
            color: var(--gold);
            margin: 0;
            font-family: 'Ma Shan Zheng', cursive;
        }
        
        .emoji-panel-close {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .emoji-btn {
            width: 50px;
            height: 50px;
            font-size: 1.8rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .emoji-btn:hover {
            background: rgba(212, 175, 55, 0.3);
            border-color: var(--gold);
            transform: scale(1.1);
        }
        
        .emoji-btn:active {
            transform: scale(0.95);
        }
        
        .quick-phrases {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .phrase-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            padding: 8px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .phrase-btn:hover {
            background: rgba(212, 175, 55, 0.3);
            border-color: var(--gold);
        }

        /* Ë°®ÊÉÖÊåâÈíÆ */
        .emoji-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 80px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none;
        }
        
        body.in-game .emoji-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ÁΩëÁªúÁä∂ÊÄÅÊåáÁ§∫Âô® */
        .network-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            z-index: 1000;
            display: none;
        }
        
        .network-indicator.slow {
            display: block;
            background: rgba(231, 76, 60, 0.9);
            color: white;
        }
        
        .network-indicator.medium {
            display: block;
            background: rgba(241, 196, 15, 0.9);
            color: #333;
        }

        /* Âä®‰ΩúÁâπÊïà */
        .action-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 8000;
            pointer-events: none;
        }
        
        .action-effect-text {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 120px;
            font-weight: bold;
            text-shadow: 0 0 30px currentColor, 0 0 60px currentColor;
            animation: actionPop 1s ease-out forwards;
        }
        
        .action-effect-text.peng {
            color: #3498db;
        }
        
        .action-effect-text.chi {
            color: #e74c3c;
        }
        
        .action-effect-text.gang {
            color: #9b59b6;
        }
        
        .action-effect-text.hu, .action-effect-text.zimo {
            color: #FFD700;
            animation: actionPop 1.5s ease-out forwards, huGlow 0.5s ease-in-out infinite;
        }
        
        @keyframes actionPop {
            0% {
                transform: scale(0) rotate(-10deg);
                opacity: 0;
            }
            30% {
                transform: scale(1.3) rotate(5deg);
                opacity: 1;
            }
            50% {
                transform: scale(1) rotate(-2deg);
            }
            100% {
                transform: scale(1.1) rotate(0deg);
                opacity: 0;
            }
        }
        
        @keyframes huGlow {
            0%, 100% {
                text-shadow: 0 0 30px #FFD700, 0 0 60px #FFD700, 0 0 90px #FF8C00;
            }
            50% {
                text-shadow: 0 0 50px #FFD700, 0 0 100px #FFD700, 0 0 150px #FF8C00;
            }
        }

        /* ÁÉüËä±ÂÆπÂô® */
        .fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 7500;
            overflow: hidden;
        }
        
        .firework-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: particleFly 1.2s ease-out forwards;
        }
        
        @keyframes particleFly {
            0% {
                opacity: 1;
                transform: translate(0, 0);
            }
            100% {
                opacity: 0;
                transform: var(--particle-end);
            }
        }

        /* ËΩÆÂà∞Ëá™Â∑±Êó∂ÁöÑÊèêÁ§∫ */
        .turn-indicator {
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.9), rgba(184, 134, 11, 0.9));
            color: #1a1a1a;
            padding: 12px 30px;
            border-radius: 30px;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 1500;
            animation: turnIndicatorBounce 0.6s ease-out, turnIndicatorPulse 2s ease-in-out infinite 0.6s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none;
        }
        
        .turn-indicator.active {
            display: block;
        }
        
        @keyframes turnIndicatorBounce {
            0% {
                transform: translateX(-50%) translateY(-30px);
                opacity: 0;
            }
            60% {
                transform: translateX(-50%) translateY(5px);
            }
            100% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes turnIndicatorPulse {
            0%, 100% {
                transform: translateX(-50%) scale(1);
            }
            50% {
                transform: translateX(-50%) scale(1.05);
            }
        }

        /* ToastÊèêÁ§∫ */
        .toast {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            z-index: 2000;
            font-size: 1.2rem;
        }

        /* ÂçïÂ±ÄÁªìÁÆóÂºπÁ™ó */
        .round-result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 4000;
            align-items: center;
            justify-content: center;
        }
        
        .round-result-modal.active { display: flex; }
        
        .round-result-content {
            background: linear-gradient(135deg, #1a3a2a 0%, #0d1f14 100%);
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .round-result-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2.2rem;
            color: var(--gold);
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        /* Ëµ¢ÂÆ∂‰ø°ÊÅØÂå∫Âüü */
        #roundWinnerInfo {
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(212,175,55,0.25) 0%, rgba(184,134,11,0.15) 100%);
            border-radius: 12px;
            border: 1px solid rgba(212,175,55,0.3);
        }
        
        #winnerName {
            color: var(--gold-light);
        }
        
        #winType {
            color: #fff;
        }
        
        /* Áï™Êï∞/Ëä±Êï∞ÊòéÁªÜÂå∫Âüü */
        .fan-detail-list {
            background: rgba(0,0,0,0.25);
            border-radius: 12px;
            padding: 15px;
            margin: 12px 0;
            text-align: left;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .fan-detail-list .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        
        .fan-detail-list .section-title {
            color: var(--gold);
            font-weight: bold;
            font-size: 1rem;
        }
        
        .fan-detail-list .section-total {
            color: var(--gold-light);
            font-weight: bold;
            font-size: 1rem;
        }
        
        /* ËÉ°ÁâåËØ¶ÊÉÖÂå∫Âüü */
        .hu-detail-list {
            background: rgba(0,0,0,0.25);
            border-radius: 12px;
            padding: 15px;
            margin: 12px 0;
            text-align: left;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .hu-detail-list .hu-info {
            margin-bottom: 12px;
            font-size: 1rem;
            color: #fff;
        }
        
        .hu-detail-list .hu-info .hu-from {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .hu-detail-list .hu-info .hu-to {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .hu-detail-list .hand-tiles {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }
        
        .hu-detail-list .meld-section {
            margin-top: 12px;
        }
        
        .hu-detail-list .meld-section-title {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .hu-detail-list .melds {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .hu-detail-list .final-tile-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.15);
        }
        
        .hu-detail-list .final-tile-title {
            color: var(--gold);
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }
        
        .fan-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            font-size: 0.95rem;
        }
        
        .fan-item:last-child {
            border-bottom: none;
        }
        
        .fan-name { 
            color: rgba(255,255,255,0.9); 
        }
        
        .fan-value { 
            color: var(--gold-light); 
            font-weight: bold; 
        }
        
        /* ÁßØÂàÜÂèòÂåñÂàóË°® */
        .score-change-list {
            background: rgba(0,0,0,0.25);
            border-radius: 12px;
            padding: 15px;
            margin: 12px 0;
            text-align: left;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .score-change-list .ranking-title {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: var(--gold);
            font-weight: bold;
        }
        
        .score-change-list table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        
        .score-change-list th {
            color: rgba(255,255,255,0.6);
            font-size: 0.85rem;
            padding: 8px 5px;
            font-weight: normal;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        
        .score-change-list td {
            padding: 10px 5px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        
        .score-change-list tr:last-child td {
            border-bottom: none;
        }
        
        .score-change-list tr.winner-row {
            background: rgba(46,204,113,0.1);
        }
        
        /* Â±ÄÊï∞‰ø°ÊÅØ */
        .round-info {
            text-align: center;
            margin: 15px 0;
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
        }
        
        /* ÂÄíËÆ°Êó∂ */
        #nextRoundCountdown {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            color: rgba(255,255,255,0.5);
            font-size: 0.85rem;
        }
        
        #nextRoundCountdown i {
            color: var(--gold);
        }
        
        /* Áé©ÂÆ∂ÂáÜÂ§áÁä∂ÊÄÅ */
        #playersReadyStatus {
            margin: 10px 0;
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .player-ready-item {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.6);
        }
        
        .player-ready-item.ready {
            background: rgba(46,204,113,0.2);
            color: #2ecc71;
        }

        /* ÊúÄÁªàÁªìÁÆóÂºπÁ™ó */
        .match-result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }
        
        .match-result-modal.active { display: flex; }
        
        .match-result-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 600px;
            width: 90%;
        }
        
        .match-result-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 20px;
        }
        
        .ranking-list {
            margin: 20px 0;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
        }
        
        .ranking-item.first { 
            background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,215,0,0.1));
            border: 2px solid gold;
        }
        
        .ranking-item.second { 
            background: linear-gradient(135deg, rgba(192,192,192,0.3), rgba(192,192,192,0.1));
            border: 1px solid silver;
        }
        
        .ranking-item.third { 
            background: linear-gradient(135deg, rgba(205,127,50,0.3), rgba(205,127,50,0.1));
            border: 1px solid #cd7f32;
        }
        
        .ranking-position {
            font-size: 1.5rem;
            font-weight: bold;
            width: 40px;
        }
        
        .ranking-position.first { color: gold; }
        .ranking-position.second { color: silver; }
        .ranking-position.third { color: #cd7f32; }
        
        .ranking-name {
            flex: 1;
            text-align: left;
            margin-left: 15px;
            font-size: 1.1rem;
        }
        
        .ranking-score {
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .ranking-score.positive { color: #2ecc71; }
        .ranking-score.negative { color: #e74c3c; }

        /* ÊöÇÂÅúÂºπÁ™ó */
        .pause-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 6000;
            align-items: center;
            justify-content: center;
        }
        
        /* ËÆ°ÂàÜÊùøÊ®°ÊÄÅÊ°Ü */
        .scoreboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 6000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .scoreboard-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .scoreboard-content {
            background: linear-gradient(145deg, #1e1e3f 0%, #16213e 50%, #0f0f23 100%);
            border: 2px solid var(--gold);
            border-radius: 24px;
            padding: 0;
            max-width: 420px;
            width: 92%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.5),
                0 0 0 1px rgba(212,175,55,0.3),
                inset 0 1px 0 rgba(255,255,255,0.1);
            animation: slideUp 0.4s ease;
        }
        
        .scoreboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 28px 20px;
            background: linear-gradient(135deg, rgba(212,175,55,0.15) 0%, rgba(212,175,55,0.05) 100%);
            border-bottom: 1px solid rgba(212,175,55,0.3);
        }
        
        .scoreboard-header h2 {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.6rem;
            color: var(--gold);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .scoreboard-header h2::before {
            content: "üìä";
            font-size: 1.4rem;
        }
        
        .close-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.8);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(231,76,60,0.8);
            border-color: rgba(231,76,60,1);
            color: #fff;
            transform: rotate(90deg);
        }
        
        .scoreboard-body {
            padding: 20px 24px;
        }
        
        .scoreboard-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .scoreboard-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-radius: 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s ease;
        }
        
        .scoreboard-item:hover {
            background: rgba(255,255,255,0.06);
            transform: translateX(4px);
        }
        
        .scoreboard-item.is-me {
            background: linear-gradient(135deg, rgba(212,175,55,0.15) 0%, rgba(212,175,55,0.05) 100%);
            border: 1px solid rgba(212,175,55,0.3);
            box-shadow: 0 4px 15px rgba(212,175,55,0.1);
        }
        
        .scoreboard-rank {
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            border-radius: 10px;
            margin-right: 14px;
            flex-shrink: 0;
        }
        
        .scoreboard-rank.rank-1 {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a1a2e;
            font-size: 1.3rem;
            box-shadow: 0 4px 12px rgba(255,215,0,0.4);
        }
        
        .scoreboard-rank.rank-2 {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            color: #1a1a2e;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(192,192,192,0.3);
        }
        
        .scoreboard-rank.rank-3 {
            background: linear-gradient(135deg, #cd7f32, #daa520);
            color: #1a1a2e;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(205,127,50,0.3);
        }
        
        .scoreboard-rank.rank-other {
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.6);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .scoreboard-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .scoreboard-name {
            font-size: 1rem;
            color: #fff;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .scoreboard-name .me-badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            background: var(--gold);
            color: #1a1a2e;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .scoreboard-score {
            font-size: 1.25rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
        
        .scoreboard-score.positive {
            color: #2ecc71;
            text-shadow: 0 0 10px rgba(46,204,113,0.3);
        }
        
        .scoreboard-score.negative {
            color: #e74c3c;
            text-shadow: 0 0 10px rgba(231,76,60,0.3);
        }
        
        .scoreboard-score.zero {
            color: #95a5a6;
        }
        
        .scoreboard-footer {
            padding: 16px 24px;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        .scoreboard-footer .round-icon {
            font-size: 1.1rem;
        }
        
        .scoreboard-footer .round-text {
            color: rgba(255,255,255,0.7);
            font-size: 0.95rem;
        }
        
        .scoreboard-footer .round-num {
            color: var(--gold);
            font-weight: bold;
            font-size: 1rem;
        }
        
        .pause-modal.active {
            display: flex;
        }
        
        .pause-modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 450px;
            width: 90%;
        }
        
        .pause-modal-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2.2rem;
            color: var(--gold);
            margin-bottom: 15px;
        }
        
        .pause-player-name {
            font-size: 1.5rem;
            color: #fff;
            margin-bottom: 20px;
        }
        
        .pause-timer {
            font-size: 3rem;
            color: var(--gold);
            font-weight: bold;
            margin: 20px 0;
        }
        
        .pause-timer-label {
            font-size: 1rem;
            color: #aaa;
            margin-top: -15px;
            margin-bottom: 20px;
        }
        
        .pause-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 25px;
        }
        
        .btn-cancel-pause {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-cancel-pause:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        }
        
        .btn-dissolve {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-dissolve:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(244, 67, 54, 0.4);
        }
        
        /* Ëß£Êï£ÊäïÁ•®ÂºπÁ™ó */
        .dissolve-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 6000;
            align-items: center;
            justify-content: center;
        }
        
        .dissolve-modal.active {
            display: flex;
        }
        
        .dissolve-modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 3px solid #f44336;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 450px;
            width: 90%;
        }
        
        .dissolve-modal-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2rem;
            color: #f44336;
            margin-bottom: 15px;
        }
        
        .dissolve-requester {
            font-size: 1.3rem;
            color: #fff;
            margin-bottom: 20px;
        }
        
        .dissolve-votes {
            margin: 20px 0;
            font-size: 1.1rem;
            color: #aaa;
        }
        
        .dissolve-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 25px;
        }
        
        .btn-agree-dissolve {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-agree-dissolve:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        }
        
        .btn-reject-dissolve {
            background: linear-gradient(135deg, #9e9e9e, #757575);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-reject-dissolve:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(158, 158, 158, 0.4);
        }
        
        /* Ëß£Êï£ÊàêÂäüÂºπÁ™ó */
        .dissolve-result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 7000;
            align-items: center;
            justify-content: center;
        }
        
        .dissolve-result-modal.active {
            display: flex;
        }
        
        .dissolve-result-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 3px solid var(--gold);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 600px;
            width: 90%;
        }
        
        .dissolve-result-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 20px;
        }
        
        .dissolve-result-info {
            font-size: 1.1rem;
            color: #ccc;
            margin-bottom: 30px;
            line-height: 1.8;
        }

        /* Á≤íÂ≠êÊïàÊûú */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: var(--gold);
            border-radius: 50%;
            opacity: 0.2;
            animation: particleFloat 20s linear infinite;
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) rotate(0deg);
            }
            100% {
                transform: translateY(-100vh) rotate(360deg);
            }
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .lobby-title { font-size: 2.5rem; }
            .room-code { font-size: 1.8rem; letter-spacing: 4px; padding: 8px 15px; }
            .players-grid { grid-template-columns: 1fr; }
            .tile { width: 38px; height: 55px; }
            .tile.small { width: 25px; height: 35px; }
            .opponents-area { grid-template-columns: 1fr; }
            .status-bar { flex-wrap: wrap; gap: 10px; }
            .action-btn { padding: 10px 18px; font-size: 1rem; }
            
            .chat-panel {
                bottom: 70px;
                left: 10px;
                right: 10px;
                width: auto;
                max-height: 250px;
            }
        }

        @media (max-width: 480px) {
            html, body {
                overflow-x: hidden;
            }
            
            .screen {
                padding: 5px;
            }
            
            .game-screen {
                padding: 5px;
                flex-direction: column;
                min-height: 100vh;
                min-height: 100dvh;
            }
            
            .game-screen.active {
                display: flex;
            }
            
            .status-bar {
                padding: 5px 8px;
                margin-bottom: 5px;
            }
            
            .mahjong-table {
                padding: 6px;
                gap: 5px;
                border-width: 4px;
                border-radius: 10px;
            }
            
            .opponents-area {
                gap: 8px;
            }
            
            .tile {
                width: 30px;
                height: 42px;
            }
            
            .tile.small {
                width: 16px;
                height: 22px;
            }
            
            .score-panel {
                gap: 4px;
                margin-bottom: 5px;
            }
            
            .score-item {
                min-width: 45px;
                padding: 3px 6px;
            }
            
            .score-name { font-size: 0.65rem; }
            .score-value { font-size: 0.85rem; }
            
            .action-panel {
                gap: 8px;
                margin-top: 10px;
                flex-wrap: wrap;
            }
            
            .action-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
                min-width: 60px;
            }
            
            .modal-content,
            .round-result-content,
            .match-result-content {
                width: 95%;
                padding: 15px;
                max-height: 85vh;
            }
            
            .round-result-title,
            .match-result-title {
                font-size: 1.5rem;
            }
            
            .fan-detail-list {
                padding: 10px;
                margin: 10px 0;
            }
            
            .ranking-item {
                padding: 10px 15px;
            }
        }

        @media (max-width: 360px) {
            .tile {
                width: 24px;
                height: 34px;
            }
            
            .score-item {
                min-width: 45px;
                padding: 2px 5px;
            }
            
            .action-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }

        /* ÊÄßËÉΩ‰ºòÂåñ */
        body.reduce-motion *,
        body.reduce-motion *::before,
        body.reduce-motion *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }

        body.reduce-motion .tile:hover {
            transform: none;
        }

        body.reduce-motion .tile.new-tile {
            animation: none;
            box-shadow: 0 0 10px rgba(52,152,219,0.9);
        }

        body.reduce-motion .player-avatar.current-turn {
            animation: none;
            box-shadow: 0 0 10px var(--gold);
        }

        .tile, .player-avatar, .modal-content {
            will-change: transform;
            transform: translateZ(0);
        }

        @media (max-width: 480px) {
            .tile {
                will-change: auto;
            }
        }
    </style>
</head>
<body>
    <div class="particles-container" id="particlesContainer"></div>
    <div class="network-indicator" id="networkIndicator"></div>
    <div class="fireworks-container" id="fireworksContainer"></div>
    <div class="turn-indicator" id="turnIndicator">ËΩÆÂà∞‰Ω†‰∫ÜÔºÅ</div>

    <!-- Â§ßÂéÖÁïåÈù¢ -->
    <div class="screen" id="lobbyScreen">
        <h1 class="lobby-title">üÄÑ ‰∏äÊµ∑Êï≤È∫ª</h1>
        <p class="lobby-subtitle">Â§ö‰∫∫ËÅîÊú∫Áâà</p>
        
        <div class="lobby-container">
            <div class="input-group">
                <label><i class="fas fa-user"></i> ‰Ω†ÁöÑÊòµÁß∞</label>
                <input type="text" id="usernameInput" placeholder="ËæìÂÖ•‰Ω†ÁöÑÊòµÁß∞">
            </div>
            
            <div class="voice-selector" style="margin-bottom: 20px;">
                <div style="width: 100%; color: var(--gold); margin-bottom: 8px;">
                    <i class="fas fa-volume-up"></i> ÈÄâÊã©ËØ≠Èü≥
                </div>
                <button type="button" class="voice-btn active" id="voiceFemale01" onclick="selectVoice('female01')">
                    <i class="fas fa-venus"></i> Â•≥1
                </button>
                <button type="button" class="voice-btn" id="voiceFemale02" onclick="selectVoice('female02')">
                    <i class="fas fa-venus"></i> Â•≥2
                </button>
                <button type="button" class="voice-btn" id="voiceMale" onclick="selectVoice('male')">
                    <i class="fas fa-mars"></i> Áî∑1
                </button>
                <button type="button" class="voice-btn" id="voiceMale02" onclick="selectVoice('male02')">
                    <i class="fas fa-mars"></i> Áî∑2
                </button>
            </div>
            
            <button class="btn" onclick="createRoom()">
                <i class="fas fa-plus"></i> ÂàõÂª∫ÊàøÈó¥
            </button>
            
            <div class="divider"><span>Êàñ</span></div>
            
            <div class="input-group">
                <label><i class="fas fa-door-open"></i> Âä†ÂÖ•ÊàøÈó¥</label>
                <input type="text" id="roomCodeInput" placeholder="ËæìÂÖ•ÊàøÈó¥Á†ÅÔºà4‰ΩçÂ≠óÊØçÔºâ">
            </div>
            
            <button class="btn secondary" onclick="joinRoom()">
                <i class="fas fa-sign-in-alt"></i> Âä†ÂÖ•
            </button>
            
            <button class="btn secondary" onclick="window.location.href='mahjong/index.html'" style="margin-top: 20px;">
                <i class="fas fa-robot"></i> Âçï‰∫∫Ê®°Âºè
            </button>
        </div>
    </div>

    <!-- ÊàøÈó¥ÁïåÈù¢ -->
    <div class="screen" id="roomScreen">
        <div class="room-header">
            <div class="room-code-label">ÊàøÈó¥Á†Å</div>
            <div class="room-code" id="roomCodeDisplay">----</div>
            <button class="copy-btn" onclick="copyRoomCode()">
                <i class="fas fa-copy"></i> Â§çÂà∂ÊàøÈó¥Á†Å
            </button>
        </div>
        
        <div class="room-container">
            <div class="players-grid" id="playersGrid"></div>
            
            <div class="room-actions">
                <button class="btn" id="readyBtn" onclick="toggleReady()">
                    <i class="fas fa-check"></i> ÂáÜÂ§á
                </button>
                <button class="btn secondary" onclick="leaveRoom()">
                    <i class="fas fa-sign-out-alt"></i> Á¶ªÂºÄ
                </button>
            </div>
        </div>
    </div>

    <!-- Ê∏∏ÊàèÁïåÈù¢ - ÈááÁî®Âçï‰∫∫Ê®°ÂºèÂ∏ÉÂ±Ä -->
    <div class="screen game-screen" id="gameScreen">
        <!-- È°∂ÈÉ®Áä∂ÊÄÅÊ†è -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-icon">üé¥</div>
                <span>Ââ©‰Ωô: <span id="remainingTiles">92</span>Âº†</span>
            </div>
            <div class="status-item">
                <div class="status-icon">üèÜ</div>
                <span>ÂàÜÊï∞: <span id="playerScore">0</span></span>
            </div>
            <div class="status-item">
                <div class="status-icon" id="menqingIcon">üö™</div>
                <span id="menqingStatus">Èó®Ê∏Ö</span>
            </div>
            <div class="status-item">
                <div class="status-icon">üé≤</div>
                <span>Â±ÄÊï∞: <span id="roundNum">1</span>/4</span>
            </div>
            <div class="status-item">
                <div class="status-icon">üè†</div>
                <span id="roomInfo">ÊàøÈó¥: ----</span>
            </div>
            <button class="back-btn" onclick="showScoreboard()">
                <i class="fas fa-list-alt"></i> ËÆ°ÂàÜÊùø
            </button>
            <button class="back-btn" onclick="pauseGame()">
                <i class="fas fa-pause"></i> ÊöÇÂÅú
            </button>
            <button class="back-btn" onclick="leaveGame()">
                <i class="fas fa-home"></i> ÈÄÄÂá∫
            </button>
        </div>

        <!-- ËÆ°ÂàÜÊùøÊ®°ÊÄÅÊ°Ü -->
        <div class="scoreboard-modal" id="scoreboardModal">
            <div class="scoreboard-content">
                <div class="scoreboard-header">
                    <h2>ÂÆûÊó∂ËÆ°ÂàÜÊùø</h2>
                    <button class="close-btn" onclick="closeScoreboard()">&times;</button>
                </div>
                <div class="scoreboard-body">
                    <div class="scoreboard-list" id="scoreboardList">
                    </div>
                </div>
                <div class="scoreboard-footer">
                    <span class="round-icon">üé≤</span>
                    <span class="round-text">ÂΩìÂâçÂ±ÄÊï∞Ôºö</span>
                    <span class="round-num" id="scoreboardRound">Á¨¨ 1 / 10 Â±Ä</span>
                </div>
            </div>
        </div>

        <!-- ÁßØÂàÜÈù¢Êùø -->
        <div class="score-panel" id="scorePanel"></div>

        <!-- È∫ªÂ∞ÜÊ°åÈù¢ -->
        <div class="mahjong-table">
            <!-- ÂØπÊâãÂå∫Âüü - ÁΩëÊ†ºÂ∏ÉÂ±Ä -->
            <div class="opponents-area">
                <div class="opponent" id="opponent2">
                    <div class="player-info">
                        <div class="player-avatar" id="opponent2Avatar">ü§ñ</div>
                        <span class="player-name" id="opponent2Name">AI-Âçó</span>
                        <span class="player-wind">Âçó</span>
                    </div>
                    <div class="opponent-hand" id="opponent2Hand"></div>
                    <div class="melds-area" id="opponent2Melds"></div>
                    <div class="opponent-flowers" id="opponent2Flowers"></div>
                    <div class="seat-discards" id="opponent2Discards"></div>
                </div>
                <div class="opponent" id="opponent1">
                    <div class="player-info">
                        <div class="player-avatar" id="opponent1Avatar">ü§ñ</div>
                        <span class="player-name" id="opponent1Name">AI-‰∏ú</span>
                        <span class="player-wind">‰∏ú</span>
                    </div>
                    <div class="opponent-hand" id="opponent1Hand"></div>
                    <div class="melds-area" id="opponent1Melds"></div>
                    <div class="opponent-flowers" id="opponent1Flowers"></div>
                    <div class="seat-discards" id="opponent1Discards"></div>
                </div>
                <div class="opponent" id="opponent3">
                    <div class="player-info">
                        <div class="player-avatar" id="opponent3Avatar">ü§ñ</div>
                        <span class="player-name" id="opponent3Name">AI-Âåó</span>
                        <span class="player-wind">Âåó</span>
                    </div>
                    <div class="opponent-hand" id="opponent3Hand"></div>
                    <div class="melds-area" id="opponent3Melds"></div>
                    <div class="opponent-flowers" id="opponent3Flowers"></div>
                    <div class="seat-discards" id="opponent3Discards"></div>
                </div>
            </div>

            <!-- ‰∏≠Â§ÆÂå∫Âüü - ÂõõÊñπÂêëÂºÉÁâåÂå∫ -->
            <div class="center-area">
                <div class="discard-zone top" id="discard1">
                    <div class="zone-label">‰∏úÂÆ∂Âá∫Áâå</div>
                    <div class="discards"></div>
                </div>
                <div class="discard-sides">
                    <div class="discard-zone left" id="discard2">
                        <div class="zone-label">ÂçóÂÆ∂</div>
                        <div class="discards"></div>
                    </div>
                    <div class="discard-zone right" id="discard3">
                        <div class="zone-label">ÂåóÂÆ∂</div>
                        <div class="discards"></div>
                    </div>
                </div>
                <div class="discard-zone bottom" id="discard0">
                    <div class="zone-label">ÊàëÁöÑÂá∫Áâå</div>
                    <div class="discards"></div>
                </div>
            </div>

            <!-- Áé©ÂÆ∂Âå∫Âüü -->
            <div class="player-area">
                <div class="player-info">
                    <div class="player-avatar current-turn" id="playerAvatar">üòä</div>
                    <span class="player-name" id="playerName">Áé©ÂÆ∂</span>
                    <span class="player-wind" id="playerWind">Ë•ø</span>
                    <span id="turnIndicatorLocal" style="margin-left: 10px; color: var(--gold); display: none;">ËΩÆÂà∞‰Ω†‰∫ÜÔºÅ</span>
                    <span id="flowerCount" style="margin-left: 15px; color: #f1c40f;">üå∏ Ëä±Áâå: 0</span>
                </div>
                <div class="hand-container" id="playerHand"></div>
                <div class="melds-area" id="playerMelds"></div>
                <!-- Ëä±ÁâåÂ±ïÁ§∫Âå∫ -->
                <div class="flowers-display" id="playerFlowers" style="margin-top: 10px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;"></div>
            </div>
        </div>

        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <div class="action-panel">
            <button class="action-btn danger" id="discardBtn" onclick="discardSelected()" disabled>
                <i class="fas fa-hand-point-down"></i> ÊâìÁâå
            </button>
            <button class="action-btn success" id="huBtn" onclick="checkHu()" disabled>
                <i class="fas fa-trophy"></i> ËÉ°Áâå
            </button>
            <button class="action-btn secondary" onclick="showTips()">
                <i class="fas fa-lightbulb"></i> ÊèêÁ§∫
            </button>
            <button class="action-btn secondary" id="soundBtn" onclick="toggleSound()">
                <i class="fas fa-volume-up"></i> Â£∞Èü≥
            </button>
        </div>
        
        <!-- Êé•ÁÆ°AIÊåâÈíÆ -->
        <div class="takeover-container" id="takeoverContainer" style="display: none;">
            <button class="takeover-btn" onclick="takeoverAI()">
                <i class="fas fa-user-plus"></i> Êé•ÁÆ°AI
            </button>
        </div>
    </div>

    <!-- Êìç‰ΩúÊèêÁ§∫ÔºàÁ¢∞Êù†ËÉ°ÂêÉÂä†Êù†Ôºâ -->
    <div class="action-hints" id="actionHints" style="display: none;">
        <button class="hint-btn" id="jiaGangBtn" onclick="doAction('jia_gang')" style="display: none; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">Âä†Êù†</button>
        <button class="hint-btn" id="pengBtn" onclick="doAction('peng')" style="display: none; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">Á¢∞</button>
        <button class="hint-btn" id="gangBtn" onclick="doAction('gang')" style="display: none; background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">Êù†</button>
        <button class="hint-btn" id="huBtn2" onclick="doAction('hu')" style="display: none; background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">ËÉ°</button>
        <button class="hint-btn" id="chiBtn" onclick="handleChiClick()" style="display: none; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">ÂêÉ</button>
        <button class="hint-btn" id="passBtn" onclick="doAction('pass')" style="background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%);">Ëøá</button>
    </div>

    <!-- Ê∂àÊÅØÂºπÁ™ó -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 class="modal-title" id="modalTitle">üéâ ÊÅ≠ÂñúÔºÅ</h2>
            <p class="modal-message" id="modalMessage">‰Ω†Ëµ¢‰∫ÜÔºÅ</p>
            <div id="modalButtons" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn" onclick="continueNextRound()" id="continueNextBtn" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                    <i class="fas fa-play"></i> ÁªßÁª≠‰∏ã‰∏ÄÂ±Ä
                </button>
                <button class="btn secondary" onclick="closeModalAndBack()">
                    <i class="fas fa-home"></i> ËøîÂõû
                </button>
            </div>
            <div id="startGameButtons" style="display: none;">
                <button class="btn" onclick="closeModal()" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                    <i class="fas fa-play"></i> ÂºÄÂßãÂá∫Áâå
                </button>
            </div>
            <div id="tingButtons" style="display: none;">
                <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-top: 15px;">
                    <i class="fas fa-hand-pointer"></i> ÁÇπÂáª‰ªªÊÑè‰ΩçÁΩÆÁªßÁª≠
                </p>
            </div>
        </div>
    </div>

    <!-- ÂçïÂ±ÄÁªìÁÆóÂºπÁ™ó -->
    <div class="round-result-modal" id="roundResultModal">
        <div class="round-result-content">
            <h2 class="round-result-title" id="roundResultTitle">üÄÑ Êú¨Â±ÄÁªìÁÆó</h2>
            
            <!-- Ëµ¢ÂÆ∂‰ø°ÊÅØ -->
            <div id="roundWinnerInfo">
                <div style="font-size: 1.3rem; font-weight: bold;">
                    <span id="winnerName"></span> <span id="winType"></span>
                </div>
            </div>
            
            <!-- ËÉ°ÁâåËØ¶ÊÉÖ -->
            <div class="hu-detail-list" id="huDetailList" style="display: none;">
                <div class="hu-info" id="huInfo"></div>
                <div class="hand-section" id="handSection">
                    <div class="meld-section-title">üÄÑ ËÉ°ÁâåÊâãÁâå</div>
                    <div class="hand-tiles" id="winnerHandTiles"></div>
                </div>
                <div class="meld-section" id="meldSection" style="display: none;">
                    <div class="meld-section-title">üìã ÂâØÈú≤</div>
                    <div class="melds" id="winnerMelds"></div>
                </div>
                <div class="final-tile-section" id="finalTileSection">
                    <div class="final-tile-title" id="finalTileTitle"></div>
                    <div class="hand-tiles" id="finalTileDisplay"></div>
                </div>
            </div>
            
            <!-- Áï™Êï∞ÊòéÁªÜ -->
            <div class="fan-detail-list" id="fanDetailList">
                <div class="section-header">
                    <span class="section-title">üéØ Áï™Êï∞ÊòéÁªÜ</span>
                    <span class="section-total" id="totalFanDisplay">0Áï™</span>
                </div>
                <div id="fanItems"></div>
            </div>
            
            <!-- Ëä±Êï∞ÊòéÁªÜ -->
            <div class="fan-detail-list" id="huaDetailList">
                <div class="section-header">
                    <span class="section-title">üå∏ Ëä±Êï∞ÊòéÁªÜ</span>
                    <span class="section-total" id="totalHuaDisplay">0Ëä±</span>
                </div>
                <div id="huaItems"></div>
            </div>
            
            <!-- ÁßØÂàÜÂèòÂåñÂàóË°® -->
            <div class="score-change-list" id="scoreChangeList">
                <div class="ranking-title">üèÜ Êú¨Â±ÄÁªìÁÆóÊ¶úÂçï üèÜ</div>
                <div id="scoreChangeItems"></div>
            </div>
            
            <!-- Â±ÄÊï∞‰ø°ÊÅØ -->
            <div class="round-info">
                Á¨¨ <span id="roundEndCurrent">1</span> / <span id="roundEndTotal">4</span> Â±Ä
            </div>
            
            <!-- ÂÄíËÆ°Êó∂Âå∫Âüü -->
            <div id="nextRoundCountdown">
                <i class="fas fa-clock"></i> <span id="countdownSeconds">30</span> ÁßíÂêéËá™Âä®ÂºÄÂßã‰∏ã‰∏ÄÂ±Ä
            </div>
            
            <!-- Áé©ÂÆ∂ÂáÜÂ§áÁä∂ÊÄÅ -->
            <div id="playersReadyStatus"></div>
            
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">
                <button class="btn" id="continueNextBtn" onclick="continueNextRound()" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                    <i class="fas fa-play"></i> ÁªßÁª≠‰∏ã‰∏ÄÂ±Ä
                </button>
            </div>
        </div>
    </div>

    <!-- ÊúÄÁªàÁªìÁÆóÂºπÁ™ó -->
    <div class="match-result-modal" id="matchResultModal">
        <div class="match-result-content">
            <h2 class="match-result-title">üèÜ ÂÖ®Âú∫ÊØîËµõÁªìÊùü</h2>
            <p style="margin-bottom: 15px; font-size: 1.1rem;">ÂÖ±ËøõË°å <span id="matchTotalRounds">0</span> Â±Ä</p>
            <div class="ranking-list" id="rankingList"></div>
            <div style="margin-top: 20px;">
                <button class="btn" onclick="closeMatchResult()">
                    <i class="fas fa-home"></i> ËøîÂõûÊàøÈó¥
                </button>
            </div>
        </div>
    </div>

    <!-- ÊöÇÂÅúÂºπÁ™ó -->
    <div class="pause-modal" id="pauseModal">
        <div class="pause-modal-content">
            <h2 class="pause-modal-title">‚è∏Ô∏è Ê∏∏ÊàèÊöÇÂÅú</h2>
            <p class="pause-player-name"><span id="pausedPlayerName"></span> Â∑≤ÊöÇÂÅúÊ∏∏Êàè</p>
            <div class="pause-timer" id="pauseTimer">00:00</div>
            <p class="pause-timer-label">ÊöÇÂÅúÊó∂Èïø</p>
            <div class="pause-buttons">
                <button class="btn-cancel-pause" onclick="cancelPause()">
                    ÂèñÊ∂àÊöÇÂÅú
                </button>
                <button class="btn-dissolve" onclick="requestDissolve()">
                    ÊèêËÆÆËß£Êï£
                </button>
            </div>
        </div>
    </div>

    <!-- ÂèñÊ∂àÊöÇÂÅúÂÄíËÆ°Êó∂ÂºπÁ™ó -->
    <div class="pause-modal" id="resumeCountdownModal">
        <div class="pause-modal-content">
            <h2 class="pause-modal-title">‚è±Ô∏è Âç≥Â∞ÜÊÅ¢Â§çÊ∏∏Êàè</h2>
            <p class="pause-player-name"><span id="resumeCancellerName"></span> ÂèñÊ∂à‰∫ÜÊöÇÂÅú</p>
            <div class="pause-timer" id="resumeCountdown">10</div>
            <p class="pause-timer-label">ÁßíÂêéÁªßÁª≠Ê∏∏Êàè</p>
        </div>
    </div>

    <!-- Ëß£Êï£ÊäïÁ•®ÂºπÁ™ó -->
    <div class="dissolve-modal" id="dissolveModal">
        <div class="dissolve-modal-content">
            <h2 class="dissolve-modal-title">‚ö†Ô∏è Ëß£Êï£Ê∏∏ÊàèÊäïÁ•®</h2>
            <p class="dissolve-requester"><span id="dissolveRequesterName"></span> ÂèëËµ∑‰∫ÜËß£Êï£Ê∏∏Êàè</p>
            <div class="dissolve-votes" id="dissolveVotesInfo">Á≠âÂæÖÊäïÁ•®...</div>
            <div class="dissolve-buttons" id="dissolveButtons">
                <button class="btn-agree-dissolve" onclick="voteDissolve(true)">
                    ÂêåÊÑèËß£Êï£
                </button>
                <button class="btn-reject-dissolve" onclick="voteDissolve(false)">
                    ÊãíÁªùËß£Êï£
                </button>
            </div>
        </div>
    </div>

    <!-- Ëß£Êï£ÊàêÂäüÂºπÁ™ó -->
    <div class="dissolve-result-modal" id="dissolveResultModal">
        <div class="dissolve-result-content">
            <h2 class="dissolve-result-title">üéÆ Ê∏∏ÊàèÂ∑≤Ëß£Êï£</h2>
            <div class="dissolve-result-info" id="dissolveResultInfo"></div>
            <button class="btn" onclick="returnToHome()">
                <i class="fas fa-home"></i> ËøîÂõû‰∏ªÈ°µ
            </button>
        </div>
    </div>

    <!-- ËÅäÂ§©Èù¢Êùø -->
    <button class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleChatPanel()">
        <i class="fas fa-comment"></i>
        <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
    </button>
    
    <div class="chat-panel" id="chatPanel">
        <div class="chat-panel-header">
            <h4><i class="fas fa-comments"></i> ËÅäÂ§©</h4>
            <button class="emoji-panel-close" onclick="toggleChatPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
            <button class="chat-send" onclick="sendChat()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Ë°®ÊÉÖÈù¢Êùø -->
    <button class="emoji-toggle-btn" id="emojiToggleBtn" onclick="toggleEmojiPanel()">
        <i class="fas fa-smile"></i>
    </button>
    
    <div class="emoji-panel" id="emojiPanel">
        <div class="emoji-panel-header">
            <h4><i class="fas fa-smile"></i> Ë°®ÊÉÖ</h4>
            <button class="emoji-panel-close" onclick="toggleEmojiPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="emoji-grid">
            <button class="emoji-btn" onclick="sendEmoji('üòÄ')">üòÄ</button>
            <button class="emoji-btn" onclick="sendEmoji('üòÇ')">üòÇ</button>
            <button class="emoji-btn" onclick="sendEmoji('üòç')">üòç</button>
            <button class="emoji-btn" onclick="sendEmoji('üòé')">üòé</button>
            <button class="emoji-btn" onclick="sendEmoji('üòú')">üòú</button>
            <button class="emoji-btn" onclick="sendEmoji('ü§î')">ü§î</button>
            <button class="emoji-btn" onclick="sendEmoji('üò±')">üò±</button>
            <button class="emoji-btn" onclick="sendEmoji('üëè')">üëè</button>
            <button class="emoji-btn" onclick="sendEmoji('üëç')">üëç</button>
            <button class="emoji-btn" onclick="sendEmoji('üëé')">üëé</button>
            <button class="emoji-btn" onclick="sendEmoji('ü§ù')">ü§ù</button>
            <button class="emoji-btn" onclick="sendEmoji('üéâ')">üéâ</button>
        </div>
        <div class="quick-phrases">
            <button class="phrase-btn" onclick="sendPhrase('‰Ω†Â•ΩÔºÅ')">‰Ω†Â•ΩÔºÅ</button>
            <button class="phrase-btn" onclick="sendPhrase('ÊâìÂæóÂ•ΩÔºÅ')">ÊâìÂæóÂ•ΩÔºÅ</button>
            <button class="phrase-btn" onclick="sendPhrase('ËØ∑Â§öÊåáÊïôÔºÅ')">ËØ∑Â§öÊåáÊïôÔºÅ</button>
            <button class="phrase-btn" onclick="sendPhrase('‰∏çÂ•ΩÊÑèÊÄùÔºÅ')">‰∏çÂ•ΩÊÑèÊÄùÔºÅ</button>
        </div>
    </div>

    <script>
// ==================== ÊÄßËÉΩ‰ºòÂåñÂ∑•ÂÖ∑ ====================
        
        // ËäÇÊµÅÂáΩÊï∞ - ÈôêÂà∂ÂáΩÊï∞Ë∞ÉÁî®È¢ëÁéá
        function throttle(func, limit) {
            let inThrottle;
            let lastResult;
            return function(...args) {
                if (!inThrottle) {
                    lastResult = func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
                return lastResult;
            };
        }
        
        // Èò≤ÊäñÂáΩÊï∞ - Âª∂ËøüÊâßË°åÁõ¥Âà∞ÂÅúÊ≠¢Ë∞ÉÁî®
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        
        // requestAnimationFrame Â∞ÅË£Ö
        let rafPending = false;
        let rafCallback = null;
        function scheduleUpdate(callback) {
            rafCallback = callback;
            if (!rafPending) {
                rafPending = true;
                requestAnimationFrame(() => {
                    rafPending = false;
                    if (rafCallback) rafCallback();
                });
            }
        }
        
        // ÁΩëÁªúÁä∂ÊÄÅÊ£ÄÊµã
        let networkQuality = 'good'; // 'good', 'slow', 'offline'
        let lastPingTime = 0;
        let pingHistory = [];
        
        function updateNetworkQuality(ping) {
            pingHistory.push(ping);
            if (pingHistory.length > 5) pingHistory.shift();
            
            const avgPing = pingHistory.reduce((a, b) => a + b, 0) / pingHistory.length;
            
            if (avgPing > 500) {
                networkQuality = 'slow';
            } else if (avgPing > 200) {
                networkQuality = 'medium';
            } else {
                networkQuality = 'good';
            }
            
            // Âº±ÁΩëÊó∂ÂáèÂ∞ëÂä®Áîª
            document.body.classList.toggle('reduce-motion', networkQuality === 'slow');
        }
        
        // ‰ΩéÊÄßËÉΩËÆæÂ§áÊ£ÄÊµã
        const isLowEndDevice = (function() {
            // Ê£ÄÊµãËÆæÂ§áÂÜÖÂ≠ò (Â¶ÇÊûúÂèØÁî®)
            const memory = navigator.deviceMemory;
            if (memory && memory < 4) return true;
            
            // Ê£ÄÊµãÊòØÂê¶ÊòØÁßªÂä®ËÆæÂ§á
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Ê£ÄÊµãÁ°¨‰ª∂Âπ∂ÂèëÊï∞
            const cores = navigator.hardwareConcurrency;
            if (cores && cores < 4) return true;
            
            return isMobile;
        })();
        
        // ‰ΩéÁ´ØËÆæÂ§áËá™Âä®ÂêØÁî®ÁúÅÁîµÊ®°Âºè
        let performanceMode = isLowEndDevice ? 'low' : 'high';
        
        // DOM ÂÖÉÁ¥†ÁºìÂ≠ò
        const domCache = {};
        function $(id) {
            if (!domCache[id]) {
                domCache[id] = document.getElementById(id);
            }
            return domCache[id];
        }
        
        // ‰∏ä‰∏ÄÊ¨°Ê∏∏ÊàèÁä∂ÊÄÅÔºàÁî®‰∫éÂ¢ûÈáèÊõ¥Êñ∞Ôºâ
        let prevGameState = null;
        
        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let socket = null;
        let currentRoom = null;
        let myPlayerId = null;
        let mySeatIndex = -1;
        let selectedTileId = null;
        let gameState = null;
        let gameRunning = false;
        let isReady = false;
        let username = '';
        let lastDrawnTileId = null; // ËÆ∞ÂΩïÂàöÊë∏ÁöÑÁâå
        let pendingAutoDiscard = false; // ÊòØÂê¶Á≠âÂæÖËá™Âä®Âá∫Áâå
        let pendingAutoDiscardTileId = null; // Á≠âÂæÖËá™Âä®Âá∫ÁâåÁöÑÁâåID
        let isAITakeover = false; // ÊòØÂê¶Ë¢´AIÊé•ÁÆ°
        let myVoice = 'female01'; // ÊàëÁöÑËØ≠Èü≥Á±ªÂûã
        let playerVoices = {}; // Â≠òÂÇ®ÊâÄÊúâÁé©ÂÆ∂ÁöÑËØ≠Èü≥Á±ªÂûã

        // ÁâåÈù¢ÊòæÁ§∫
        const TYPE_NAMES = { wan: '‰∏á', tiao: 'Êù°', tong: 'Á≠í', wind: 'È£é' };
        const NUM_NAMES = ['', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠', '‰∏É', 'ÂÖ´', '‰πù'];
        const WIND_NAMES = { east: '‰∏ú', south: 'Âçó', west: 'Ë•ø', north: 'Âåó' };
        const SUITS = ['wan', 'tong', 'tiao'];
        const HONORS = ['dong', 'nan', 'xi', 'bei', 'zhong', 'fa', 'bai'];
        const FLOWERS = ['chun', 'xia', 'qiu', 'dong_hua', 'mei', 'lan', 'zhu', 'ju'];
        const SUIT_NAMES = { wan: '‰∏á', tong: 'Á≠í', tiao: 'Êù°' };
        const HONOR_CHARS = {
            dong: '‰∏ú', nan: 'Âçó', xi: 'Ë•ø', bei: 'Âåó',
            zhong: '‰∏≠', fa: 'Âèë', bai: 'ÁôΩ'
        };
        const FLOWER_CHARS = {
            chun: 'Êò•', xia: 'Â§è', qiu: 'Áßã', dong_hua: 'ÂÜ¨',
            mei: 'Ê¢Ö', lan: 'ÂÖ∞', zhu: 'Á´π', ju: 'Ëèä'
        };

        
        // Á≤æÁÅµÂõæ‰ΩçÁΩÆÊò†Â∞Ñ (8Âàó√ó6Ë°åÁΩëÊ†º)
        const TILE_SPRITE_MAP = {
            // Á¨¨0Ë°å: ‰∏áÂ≠ê 1-8
            'wan1': [0, 0], 'wan2': [0, 1], 'wan3': [0, 2], 'wan4': [0, 3],
            'wan5': [0, 4], 'wan6': [0, 5], 'wan7': [0, 6], 'wan8': [0, 7],
            
            // Á¨¨1Ë°å: Á≠íÂ≠ê 1-8
            'tong1': [1, 0], 'tong2': [1, 1], 'tong3': [1, 2], 'tong4': [1, 3],
            'tong5': [1, 4], 'tong6': [1, 5], 'tong7': [1, 6], 'tong8': [1, 7],
            
            // Á¨¨2Ë°å: Êù°Â≠ê 1-8
            'tiao1': [2, 0], 'tiao2': [2, 1], 'tiao3': [2, 2], 'tiao4': [2, 3],
            'tiao5': [2, 4], 'tiao6': [2, 5], 'tiao7': [2, 6], 'tiao8': [2, 7],
            
            // Á¨¨3Ë°å: Â≠óÁâå ‰∏úÂçóË•øÂåó‰∏≠ÂèëÁôΩ
            'dong': [3, 0], 'nan': [3, 1], 'xi': [3, 2], 'bei': [3, 3],
            'zhong': [3, 4], 'fa': [3, 5], 'bai': [3, 6],
            
            // Á¨¨4Ë°å: Ëä±Áâå
            'qiu': [4, 0], 'lan': [4, 1], 'zhu': [4, 2], 'mei': [4, 3],
            'chun': [4, 4], 'xia': [4, 5], 'dong_hua': [4, 6], 'ju': [4, 7],
            
            // Á¨¨5Ë°å: 9‰∏á 9Á≠í 9Êù°
            'wan9': [5, 0], 'tong9': [5, 1], 'tiao9': [5, 2]
        };
        
        // Ëé∑ÂèñÁ≤æÁÅµÂõæËÉåÊôØ‰ΩçÁΩÆÔºà8Âàó√ó6Ë°åÁΩëÊ†ºÔºå512x512Ôºâ
        // ‰ΩøÁî®ÁôæÂàÜÊØîÁ°Æ‰øùÂú®‰ªª‰ΩïÂ∞∫ÂØ∏‰∏ãÈÉΩÊ≠£Á°ÆÊòæÁ§∫
        function getSpritePosition(tile, small = false) {
            let key;
            
            if (tile.type === 'number') {
                // Âçï‰∫∫Ê®°Âºè: { type: 'number', suit: 'wan', value: 1 }
                key = `${tile.suit}${tile.value}`;
            } else if (tile.type === 'flower') {
                // Ëä±Áâå: { type: 'flower', value: 'chun' }
                key = tile.value;
            } else if (['wan', 'tong', 'tiao'].includes(tile.type)) {
                // Â§ö‰∫∫Ê®°ÂºèÊï∞Â≠óÁâå: { type: 'wan', value: 1 }
                key = `${tile.type}${tile.value}`;
            } else {
                // Â≠óÁâå: { type: 'honor', value: 'dong' } Êàñ { type: 'dong', ... }
                key = tile.value;
            }
            
            const pos = TILE_SPRITE_MAP[key];
            
            if (!pos) {
                // Ê≤°ÊâæÂà∞Êò†Â∞ÑÔºå‰ΩøÁî®ÊñáÂ≠óÊ®°Âºè
                return '';
            }
            
            // 8Âàó√ó6Ë°åÁΩëÊ†º
            const cols = 8;
            const rows = 6;
            
            // ‰ΩøÁî®ÁôæÂàÜÊØîÂÆö‰ΩçÔºåÁ°Æ‰øùÂú®‰ªª‰ΩïÂ∞∫ÂØ∏‰∏ãÈÉΩÊ≠£Á°Æ
            // background-size: 800% 600% Ë°®Á§∫ÂéüÂõæÊîæÂ§ßÂà∞8ÂÄçÂÆΩ„ÄÅ6ÂÄçÈ´òÔºàÊØèÊ†ºÂç†100%/8, 100%/6Ôºâ
            // background-position: ÁôæÂàÜÊØîÂÖ¨Âºè = col/(cols-1)*100%, row/(rows-1)*100%
            const posX = pos[1] === 0 ? 0 : (pos[1] / (cols - 1)) * 100;
            const posY = pos[0] === 0 ? 0 : (pos[0] / (rows - 1)) * 100;
            
            return `background-size: ${cols * 100}% ${rows * 100}%; background-position: ${posX}% ${posY}%;`;
        }

        // ÁâåÈù¢ÊòæÁ§∫
        function getTileDisplay(tile) {
            if (tile.type === 'number') {
                // Âçï‰∫∫Ê®°Âºè: { type: 'number', suit: 'wan', value: 1 }
                return {
                    value: tile.value,
                    suit: SUIT_NAMES[tile.suit],
                    class: tile.suit
                };
            } else if (['wan', 'tong', 'tiao'].includes(tile.type)) {
                // Â§ö‰∫∫Ê®°ÂºèÊï∞Â≠óÁâå: { type: 'wan', value: 1 }
                return {
                    value: tile.value,
                    suit: SUIT_NAMES[tile.type],
                    class: tile.type
                };
            } else if (tile.type === 'flower') {
                // Ëä±Áâå: { type: 'flower', value: 'chun' }
                return {
                    value: FLOWER_CHARS[tile.value],
                    suit: 'Ëä±',
                    class: 'hua'
                };
            } else {
                // Â≠óÁâå: { type: 'honor', value: 'dong' } Êàñ { type: 'dong', ... }
                return {
                    value: HONOR_CHARS[tile.value] || tile.value,
                    suit: '',
                    class: 'feng'
                };
            }
        }

        function renderTile(tile, options = {}) {
            const { small = false, back = false, selectable = false, index = -1, isNew = false } = options;
            const display = getTileDisplay(tile);
            
            let classes = ['tile', display.class];
            if (small) classes.push('small');
            if (back) classes.push('back');
            if (selectable && gameState && gameState.selectedTile === index) classes.push('selected');
            if (isNew) classes.push('new-tile');
            
            // Á≤æÁÅµÂõæÊú™Âä†ËΩΩÂÆåÊàêÊó∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            if (!spriteLoaded) {
                classes.push('loading');
            }
            
            if (back) {
                return `<div class="${classes.join(' ')}"></div>`;
            }
            
            // Ëé∑ÂèñÁ≤æÁÅµÂõæ‰ΩçÁΩÆ
            const spritePos = getSpritePosition(tile, small);
            const tileId = tile.id !== undefined ? String(tile.id) : String(index);
            const onclick = selectable ? `onclick="selectTile('${tileId}')"` : '';
            
            // Á≤æÁÅµÂõæÂä†ËΩΩÂÆåÊàêÊâçÂ∫îÁî®‰ΩçÁΩÆÊ†∑Âºè
            const styleAttr = spriteLoaded ? spritePos : '';
            const dataStyle = spriteLoaded ? '' : `data-sprite-style="${spritePos}"`;
            
            return `<div class="${classes.join(' ')}" style="${styleAttr}" ${dataStyle} ${onclick} title="${display.value}${display.suit}">
                <div class="tile-text">
                    <span class="tile-value">${display.value}</span>
                    <span class="tile-suit">${display.suit}</span>
                </div>
            </div>`;
        }
        
        // ==================== Âê¨ÁâåÊ£ÄÊµã ====================
        let isTing = false;
        let isQiao = false;  // Êï≤ÁâåÁä∂ÊÄÅ
        let tingList = [];
        let pendingQiao = false;  // ÊòØÂê¶Á≠âÂæÖÊï≤ÁâåÁ°ÆËÆ§
        
        // Ê£ÄÊµãÊòØÂê¶ËÉΩËÉ°ÁâåÔºà3N+2ÁªìÊûÑÔºâ
        function canHuHand(tiles) {
            if (tiles.length === 0) return true;
            if (tiles.length === 2) {
                return tiles[0].type === tiles[1].type && tiles[0].value === tiles[1].value;
            }
            if (tiles.length < 3) return false;
            
            // ÊéíÂ∫è
            const sorted = [...tiles].sort((a, b) => {
                if (a.type !== b.type) return a.type.localeCompare(b.type);
                return a.value - b.value;
            });
            
            // Â∞ùËØï‰Ωú‰∏∫Â∞ÜÔºàÂØπÂ≠êÔºâ
            for (let i = 0; i < sorted.length - 1; i++) {
                if (sorted[i].type === sorted[i+1].type && sorted[i].value === sorted[i+1].value) {
                    const remaining = [...sorted];
                    remaining.splice(i, 2);
                    if (canFormMelds(remaining)) return true;
                }
            }
            return false;
        }
        
        function canFormMelds(tiles) {
            if (tiles.length === 0) return true;
            if (tiles.length % 3 !== 0) return false;
            
            const sorted = [...tiles].sort((a, b) => {
                if (a.type !== b.type) return a.type.localeCompare(b.type);
                return a.value - b.value;
            });
            
            // Â∞ùËØïÂàªÂ≠ê
            if (sorted.length >= 3 &&
                sorted[0].type === sorted[1].type && sorted[1].type === sorted[2].type &&
                sorted[0].value === sorted[1].value && sorted[1].value === sorted[2].value) {
                return canFormMelds(sorted.slice(3));
            }
            
            // Â∞ùËØïÈ°∫Â≠ê
            if (sorted.length >= 3) {
                const first = sorted[0];
                const secondIdx = sorted.findIndex(t => t.type === first.type && t.value === first.value + 1);
                const thirdIdx = sorted.findIndex(t => t.type === first.type && t.value === first.value + 2);
                
                if (secondIdx !== -1 && thirdIdx !== -1) {
                    const remaining = [...sorted];
                    [thirdIdx, secondIdx, 0].sort((a,b) => b-a).forEach(idx => remaining.splice(idx, 1));
                    if (canFormMelds(remaining)) return true;
                }
            }
            return false;
        }
        
        // Ê£ÄÊµãÂê¨Âì™‰∫õÁâå
        function checkTingPai(hand) {
            const tingTiles = [];
            const allTileTypes = ['wan', 'tiao', 'tong'];
            
            for (const type of allTileTypes) {
                for (let value = 1; value <= 9; value++) {
                    const testTile = { type, value };
                    const testHand = [...hand, testTile];
                    if (canHuHand(testHand)) {
                        tingTiles.push(testTile);
                    }
                }
            }
            return tingTiles;
        }
        
        // Ê£ÄÊü•Âπ∂ÊòæÁ§∫Âê¨ÁâåÁä∂ÊÄÅ
        function checkAndShowTing() {
            if (!gameState) return;
            
            const myPlayer = gameState.players.find(p => p.seatIndex === mySeatIndex);
            if (!myPlayer || !myPlayer.hand) return;
            
            // Âè™Êúâ13Âº†ÁâåÊó∂Ê£ÄÊµãÂê¨ÁâåÔºàÊàñ10Âº†Êúâ1Á¢∞Ôºå7Âº†Êúâ2Á¢∞...Ôºâ
            const expectedSize = 13 - (myPlayer.melds?.length || 0) * 3;
            if (myPlayer.hand.length !== expectedSize) return;
            
            const newTingList = checkTingPai(myPlayer.hand);
            
            if (newTingList.length > 0 && !isTing) {
                isTing = true;
                tingList = newTingList;
                
                // ËØ≠Èü≥Êí≠Êä•
                speakTing();
                
                // ÊòæÁ§∫Âê¨Áâå‰ø°ÊÅØ
                const tingNames = newTingList.map(t => {
                    const tileText = getTileText(t);
                    return tileText.value + tileText.type;
                }).join('„ÄÅ');
                showToast(`üéØ Âê¨ÁâåÔºÅÂê¨Ôºö${tingNames}`, 3000);
            }
        }
        
        // ==================== Èü≥È¢ëÊí≠ÊîæÁ≥ªÁªü ====================
        const audioCache = {}; // ÁºìÂ≠òÂ∑≤Âä†ËΩΩÁöÑÈü≥È¢ë
        let audioUnlocked = false; // ÁßªÂä®ËÆæÂ§áÈü≥È¢ëÊòØÂê¶Â∑≤Ëß£ÈîÅ
        
        // Èü≥È¢ëÊ†ºÂºèÈÖçÁΩÆÔºàÁªü‰∏Ä‰ΩøÁî®mp3Ôºâ
        const AUDIO_FORMATS = {
            female01: '.mp3',
            female02: '.mp3',
            male: '.mp3',
            male02: '.mp3'
        };
        
        // Ëé∑ÂèñÁâåÁöÑÈü≥È¢ëÊñá‰ª∂Âêç
        function getTileAudioName(tile) {
            // Â§ö‰∫∫Ê®°ÂºèÁâåÁªìÊûÑ:
            // Êï∞Â≠óÁâå: { type: 'wan'|'tiao'|'tong', value: 1-9 }
            // Ëä±Áâå: { type: 'flower', value: 'chun'|'xia'|... }
            // ‰∏≠ÂèëÁôΩ: { type: 'honor', value: 'zhong'|'fa'|'bai' }
            // È£éÁâå: { type: 'wind', value: 'dong'|'nan'|'xi'|'bei' }
            if (tile.type === 'flower') {
                return tile.value; // Ëä±ÁâåÁõ¥Êé•ËøîÂõû value (chun, xia, etc.)
            } else if (tile.type === 'honor') {
                return tile.value; // ‰∏≠ÂèëÁôΩÁõ¥Êé•ËøîÂõû value (zhong, fa, bai)
            } else if (tile.type === 'wind') {
                return tile.value; // È£éÁâåÁõ¥Êé•ËøîÂõû value (dong, nan, xi, bei)
            }
            return `${tile.type}${tile.value}`; // Êï∞Â≠óÁâå: wan1, tong2, etc.
        }
        
        // Ê†πÊçÆÁé©ÂÆ∂IDËé∑ÂèñËØ≠Èü≥
        function getPlayerVoice(playerId) {
            return playerVoices[playerId] || 'female01';
        }
        
        // Ê†πÊçÆÂ∫ß‰ΩçÁ¥¢ÂºïËé∑ÂèñÁé©ÂÆ∂ËØ≠Èü≥
        function getPlayerVoiceBySeat(seatIndex) {
            if (!gameState || !gameState.players) return 'female01';
            const player = gameState.players.find(p => p.seatIndex === seatIndex);
            if (player && player.voice) {
                return player.voice;
            }
            return playerVoices[player?.id] || 'female01';
        }
        
        // Ëß£ÈîÅÁßªÂä®ËÆæÂ§áÈü≥È¢ë
        function unlockAudio() {
            if (audioUnlocked) return;
            try {
                const silentAudio = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAAAwAAAbAAqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAbD/kaYhAAAAAAD/4xjAAAAANIAAAAAExBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/jGMAD/0AAAANIAAAAATVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV');
                silentAudio.play().then(() => {
                    audioUnlocked = true;
                    console.log('ÁßªÂä®ËÆæÂ§áÈü≥È¢ëÂ∑≤Ëß£ÈîÅ');
                }).catch(e => {});
            } catch (e) {}
        }
        
        // ÁõëÂê¨Áî®Êà∑‰∫§‰∫í‰ª•Ëß£ÈîÅÈü≥È¢ë
        ['click', 'touchstart'].forEach(event => {
            document.addEventListener(event, unlockAudio, { once: false, passive: true });
        });
        
        // Èü≥È¢ëÂä†ËΩΩÁä∂ÊÄÅ
        const audioLoading = {};
        
        // Êí≠ÊîæÈü≥È¢ëÊñá‰ª∂ÔºàÁõ¥Êé•Êí≠ÊîæÔºåÂêåÊó∂ÁºìÂ≠òÔºâ
        function playAudioFile(path, volume = 1.0) {
            // Ê£ÄÊü•ÊòØÂê¶ÈùôÈü≥
            if (!soundEnabled) return;

            console.log('Êí≠ÊîæÈü≥È¢ë:', path);

            try {
                // Ê£ÄÊü•ÁºìÂ≠ò - Â¶ÇÊûúÂ∑≤ÁºìÂ≠òÁõ¥Êé•Êí≠Êîæ
                if (audioCache[path] && audioCache[path].readyState >= 2) {
                    const audio = audioCache[path].cloneNode();
                    audio.volume = volume;
                    audio.play().then(() => {
                        console.log('ÁºìÂ≠òÈü≥È¢ëÊí≠ÊîæÊàêÂäü');
                    }).catch(e => {
                        console.error('ÁºìÂ≠òÈü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', e);
                    });
                    return;
                }
                
                // Êú™ÁºìÂ≠ò - Áõ¥Êé•ÂàõÂª∫Âπ∂Êí≠ÊîæÔºàÂêåÊó∂ÁºìÂ≠òÔºâ
                const audio = new Audio();
                audio.volume = volume;
                audio.preload = 'auto';
                audio.src = path;
                
                // Â∞ùËØïÁõ¥Êé•Êí≠Êîæ
                audio.play().then(() => {
                    // Êí≠ÊîæÊàêÂäüÔºåÁºìÂ≠òËµ∑Êù•
                    audioCache[path] = audio;
                    console.log('Êñ∞Èü≥È¢ëÊí≠ÊîæÊàêÂäüÂπ∂ÁºìÂ≠ò');
                }).catch(e => {
                    // Êí≠ÊîæÂ§±Ë¥•ÔºåÊí≠ÊîæËúÇÈ∏£Èü≥‰Ωú‰∏∫ÂèçÈ¶à
                    console.error('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', e.message);
                    const isTile = path.includes('/tiles/');
                    playBeep(isTile ? 600 : 400, 80);
                });
                
                // ÂêåÊó∂ÁºìÂ≠òÔºàÂç≥‰ΩøÊí≠ÊîæÂ§±Ë¥•‰πüÁºìÂ≠òÔºå‰∏ãÊ¨°Áî®Ôºâ
                audio.addEventListener('canplaythrough', () => {
                    audioCache[path] = audio;
                }, { once: true });
            } catch (e) {
                console.error('Èü≥È¢ëÂºÇÂ∏∏:', e);
                playBeep(523, 80);
            }
        }
        
        // Èü≥ÈáèÈÖçÁΩÆÔºàÊ†πÊçÆ‰∏çÂêåËØ≠Èü≥Ë∞ÉÊï¥Èü≥ÈáèÂπ≥Ë°°Ôºâ
        const AUDIO_VOLUMES = {
            female01: 0.6,  // Â•≥Â£∞1
            female02: 0.8,  // Â•≥Â£∞2
            male: 1.0,      // Áî∑Â£∞1
            male02: 1.0     // Áî∑Â£∞2
        };
        
        // Êí≠ÊîæÁâåÁöÑÈü≥È¢ëÔºàÊîØÊåÅÂ§öÁßçËØ≠Èü≥Ôºâ
        function playTileAudio(tile, voice = 'female01') {
            const name = getTileAudioName(tile);
            const format = AUDIO_FORMATS[voice] || '.mp3';
            const volume = AUDIO_VOLUMES[voice] || 1.0;
            playAudioFile(`audio/${voice}/tiles/${name}${format}`, volume);
        }
        
        // Êí≠ÊîæÂä®‰ΩúÈü≥È¢ëÔºàÊîØÊåÅÂ§öÁßçËØ≠Èü≥Ôºâ
        function playActionAudio(action, voice = 'female01') {
            const format = AUDIO_FORMATS[voice] || '.mp3';
            const volume = AUDIO_VOLUMES[voice] || 1.0;
            playAudioFile(`audio/${voice}/actions/${action}${format}`, volume);
        }
        
        // Èü≥È¢ëÊáíÂä†ËΩΩÈòüÂàó
        let audioLoadQueue = [];
        let audioEnabled = true; // Âº±ÁΩëÊó∂ÂèØÁ¶ÅÁî®
        
        // Êô∫ËÉΩÈ¢ÑÂä†ËΩΩÈü≥È¢ë - Âè™È¢ÑÂä†ËΩΩÂøÖË¶ÅÁöÑÔºåÈÅøÂÖçÂç°È°ø
        function preloadMultiplayerAudio() {
            // Ë∑≥ËøáÈ¢ÑÂä†ËΩΩÔºå‰ΩøÁî®Á∫ØÊáíÂä†ËΩΩÁ≠ñÁï•ÔºåÈÅøÂÖçÂç°È°ø
            console.log('Èü≥È¢ë‰ΩøÁî®ÊáíÂä†ËΩΩÊ®°ÂºèÔºåÈÅøÂÖçÂêØÂä®Âç°È°ø');
        }
        
        // Ê∏∏ÊàèÂºÄÂßãÊó∂È¢ÑÂä†ËΩΩÂΩìÂâçËØ≠Èü≥ÁöÑÂä®‰ΩúÈü≥È¢ë
        // ÈùôÈªòÈ¢ÑÂä†ËΩΩÂ∏∏Áî®Èü≥È¢ëÔºàÊ∏∏ÊàèÂºÄÂßãÂêéÂú®ÂêéÂè∞ÊâßË°åÔºâ
        function silentPreloadAudio(voice) {
            const actions = ['peng', 'gang', 'hu', 'zimo'];
            const commonTiles = ['wan1', 'wan2', 'wan3', 'tong1', 'tong2', 'tong3', 'tiao1', 'tiao2', 'tiao3'];
            
            let index = 0;
            const allPaths = [
                ...actions.map(a => `audio/${voice}/actions/${a}.mp3`),
                ...commonTiles.map(t => `audio/${voice}/tiles/${t}.mp3`)
            ];
            
            function loadNext() {
                if (index >= allPaths.length) return;
                const path = allPaths[index++];
                if (!audioCache[path] && !audioLoading[path]) {
                    audioLoading[path] = true;
                    const audio = new Audio();
                    audio.preload = 'auto';
                    audio.src = path;
                    audio.addEventListener('canplaythrough', () => {
                        audioCache[path] = audio;
                        delete audioLoading[path];
                        setTimeout(loadNext, 200);  // Èó¥ÈöîÂä†ËΩΩÔºå‰∏çÊä¢Â∏¶ÂÆΩ
                    }, { once: true });
                    audio.addEventListener('error', () => {
                        delete audioLoading[path];
                        setTimeout(loadNext, 100);
                    }, { once: true });
                    audio.load();
                } else {
                    setTimeout(loadNext, 50);
                }
            }
            
            loadNext();
            console.log('ÂºÄÂßãÂêéÂè∞È¢ÑÂä†ËΩΩÂ∏∏Áî®Èü≥È¢ë');
        }
        
        // È¢ÑÂä†ËΩΩÂçï‰∏™Èü≥È¢ëÔºà‰øùÁïôÊé•Âè£Ôºâ
        function preloadSingleAudio(path) {
            // ‰ΩøÁî®ÈùôÈªòÈ¢ÑÂä†ËΩΩ
        }
        
        // ÂàÜÊâπÂä†ËΩΩÈü≥È¢ëÔºà‰øùÁïôÊé•Âè£Ôºâ
        function loadAudioBatch(paths, batchSize = 5, delay = 100) {
            // ‰ΩøÁî®ÈùôÈªòÈ¢ÑÂä†ËΩΩ
        }
        
        // Êí≠ÊîæÈü≥È¢ëÔºàÂ∏¶Âº±ÁΩëÊ£ÄÊµãÔºâ
        const originalPlayAudioFile = playAudioFile;
        playAudioFile = function(path, volume = 1.0) {
            // Ê£ÄÊü•ÊòØÂê¶ÈùôÈü≥
            if (!soundEnabled) return;

            // Âº±ÁΩëÊó∂Ë∑≥ËøáÈü≥È¢ëÊí≠Êîæ
            if (networkQuality === 'slow' && !audioEnabled) {
                return;
            }

            try {
                if (audioCache[path]) {
                    const audio = audioCache[path].cloneNode();
                    audio.volume = volume;
                    audio.play().catch(e => {});
                    return;
                }
                
                // ÊáíÂä†ËΩΩÂπ∂Êí≠Êîæ
                const audio = new Audio(path);
                audio.volume = volume;
                audio.play().then(() => {
                    audioCache[path] = audio;
                }).catch(e => {});
            } catch (e) {}
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            // ÂàùÂßãÂåñËØ≠Èü≥
            initVoice();
            // Âª∂ËøüÂêØÂä®Èü≥È¢ëÈ¢ÑÂä†ËΩΩ
            setTimeout(preloadMultiplayerAudio, 2000);
        });
        
        // ==================== ËØ≠Èü≥Êí≠Êä•Á≥ªÁªüÔºàÂ§áÁî®Ôºâ ====================
        let speechEnabled = true;
        let audioContext = null;
        let speechReady = false;
        let voicesLoaded = false;
        
        // ÂàùÂßãÂåñËØ≠Èü≥Á≥ªÁªüÔºàÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÔºâ
        function initSpeech() {
            if (speechReady) return;
            
            try {
                // ÂàùÂßãÂåñ AudioContext
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                // Â∞ùËØïÂä†ËΩΩËØ≠Èü≥
                if (window.speechSynthesis) {
                    // Êüê‰∫õÊµèËßàÂô®ÈúÄË¶ÅÂÖàËé∑ÂèñËØ≠Èü≥ÂàóË°®
                    const voices = speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        voicesLoaded = true;
                        console.log('ËØ≠Èü≥ÂàóË°®Â∑≤Âä†ËΩΩ:', voices.length, '‰∏™');
                    }
                    
                    // ÁõëÂê¨ËØ≠Èü≥ÂàóË°®Âä†ËΩΩ
                    speechSynthesis.onvoiceschanged = () => {
                        voicesLoaded = true;
                        console.log('ËØ≠Èü≥ÂàóË°®Â∑≤Êõ¥Êñ∞');
                    };
                    
                    // Êí≠Êîæ‰∏Ä‰∏™Á©∫ÁöÑÊµãËØï
                    const testUtterance = new SpeechSynthesisUtterance('');
                    testUtterance.volume = 0;
                    speechSynthesis.speak(testUtterance);
                }
                
                speechReady = true;
                console.log('ËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñÊàêÂäü');
            } catch (e) {
                console.error('ËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•:', e);
            }
        }
        
        // Âú®Áî®Êà∑È¶ñÊ¨°‰∫§‰∫íÊó∂ÂàùÂßãÂåñ
        document.addEventListener('click', function initOnClick() {
            initSpeech();
            document.removeEventListener('click', initOnClick);
        }, { once: true });
        
        document.addEventListener('touchstart', function initOnTouch() {
            initSpeech();
            document.removeEventListener('touchstart', initOnTouch);
        }, { once: true });
        
        // Ëé∑ÂèñÁâåÁöÑËØ≠Èü≥ÂêçÁß∞
        function getTileSpeechName(tile) {
            const tileText = getTileText(tile);
            return tileText.value + tileText.type;
        }
        
        // Ê£ÄÊµãÊòØÂê¶ÊòØÂçé‰∏∫ËÆæÂ§á
        const isHuawei = /huawei|honor/i.test(navigator.userAgent);
        let speechRetryCount = 0;
        const MAX_SPEECH_RETRY = 3;
        
        // ËØ≠Èü≥Êí≠Êä•ÔºàÂ¢ûÂº∫Âçé‰∏∫ÂÖºÂÆπÊÄßÔºâ
        function speak(text, rate = 1.0, pitch = 1.0) {
            // Ê£ÄÊü•ÊòØÂê¶ÈùôÈü≥ÔºàsoundEnabledÊéßÂà∂ÊâÄÊúâÂ£∞Èü≥Ôºâ
            if (!soundEnabled) return;
            
            // Â∞ùËØï‰ΩøÁî® Web Speech API
            if (window.speechSynthesis) {
                try {
                    // Âçé‰∏∫ËÆæÂ§áÁâπÊÆäÂ§ÑÁêÜÔºöÂÖàÂèñÊ∂àÂÜçÂª∂ËøüËØ¥ËØù
                    window.speechSynthesis.cancel();
                    
                    // Âçé‰∏∫ËÆæÂ§áÈúÄË¶ÅÂª∂ËøüÊâßË°å
                    const delay = isHuawei ? 100 : 0;
                    
                    setTimeout(() => {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.lang = 'zh-CN';
                        utterance.rate = isHuawei ? Math.min(rate, 0.9) : rate; // Âçé‰∏∫Èôç‰ΩéËØ≠ÈÄü
                        utterance.pitch = pitch;
                        utterance.volume = 1.0;
                        
                        // Â∞ùËØïÈÄâÊã©‰∏≠ÊñáËØ≠Èü≥
                        const voices = speechSynthesis.getVoices();
                        const zhVoice = voices.find(v => v.lang.includes('zh') || v.lang.includes('CN'));
                        if (zhVoice) {
                            utterance.voice = zhVoice;
                        }
                        
                        // Âçé‰∏∫ËÆæÂ§áÔºöÁõëÂê¨ÈîôËØØÂπ∂ÈáçËØï
                        utterance.onerror = (e) => {
                            console.warn('ËØ≠Èü≥Êí≠Êä•Âá∫Èîô:', e.error);
                            if (isHuawei && speechRetryCount < MAX_SPEECH_RETRY) {
                                speechRetryCount++;
                                console.log(`Âçé‰∏∫ËÆæÂ§áÈáçËØïËØ≠Èü≥ (${speechRetryCount}/${MAX_SPEECH_RETRY})`);
                                setTimeout(() => speak(text, rate, pitch), 200);
                            } else {
                                // ‰ΩøÁî®Èü≥ÊïàÂ§áÁî®
                                playBeep(660, 150);
                                vibrate(50);
                            }
                        };
                        
                        utterance.onend = () => {
                            speechRetryCount = 0; // ÊàêÂäüÂêéÈáçÁΩÆËÆ°Êï∞
                        };
                        
                        window.speechSynthesis.speak(utterance);
                        
                        // Âçé‰∏∫ËÆæÂ§áÈ¢ùÂ§ñÊ£ÄÊü•ÔºöÂ¶ÇÊûú3ÁßíÂêéËøòÊ≤°ËØ¥ÂÆåÂèØËÉΩÂç°‰Ωè‰∫Ü
                        if (isHuawei) {
                            setTimeout(() => {
                                if (window.speechSynthesis.speaking) {
                                    // ÂèØËÉΩÂç°‰Ωè‰∫ÜÔºåÂº∫Âà∂ÂèñÊ∂à
                                    window.speechSynthesis.cancel();
                                }
                            }, 3000);
                        }
                    }, delay);
                    
                } catch (e) {
                    console.error('ËØ≠Èü≥Êí≠Êä•Â§±Ë¥•:', e);
                    // Â§áÁî®ÔºöÈü≥Êïà + ÊåØÂä®ÊèêÁ§∫
                    playBeep(660, 150);
                    vibrate(50);
                }
            } else {
                // ‰∏çÊîØÊåÅËØ≠Èü≥ÂêàÊàêÔºå‰ΩøÁî®Èü≥Êïà + ÊåØÂä®
                playBeep(660, 150);
                vibrate(50);
            }
        }
        
        // ÊåØÂä®Â§áÁî®ÊñπÊ°à
        function vibrate(duration = 50) {
            if (navigator.vibrate) {
                navigator.vibrate(duration);
            }
        }
        
        // Êí≠ÊîæÁÆÄÂçïÈü≥ÊïàÔºàÂÖºÂÆπÊÄßÊõ¥Â•ΩÔºâ
        function playBeep(frequency = 440, duration = 100, type = 'sine') {
            // Ê£ÄÊü•ÊòØÂê¶ÈùôÈü≥
            if (!soundEnabled) return;

            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') audioContext.resume();
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration / 1000);
            } catch (e) {
                console.log('Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•:', e);
            }
        }
        
        // Êí≠Êä•Âá∫ÁâåÔºà‰ΩøÁî®Èü≥È¢ëÊñá‰ª∂ÔºåÊîØÊåÅÂ§öÁßçËØ≠Èü≥Ôºâ
        function speakDiscard(tile, voice = 'female01') {
            // ‰ΩøÁî®Èü≥È¢ëÊí≠Êîæ
            playTileAudio(tile, voice);
        }
        
        // Êí≠Êä•Âê¨Áâå
        function speakTing() {
            playActionAudio('ting', myVoice); // Êí≠ÊîæÂê¨ÁâåÈü≥Êïà
            speak('Âê¨', 1.0, 1.3);
            playBeep(880, 150);
        }
        
        // Êí≠Êä•Á¢∞Ôºà‰ΩøÁî®Èü≥È¢ëÔºåÊîØÊåÅÂ§öÁßçËØ≠Èü≥Ôºâ
        function speakPeng(voice = 'female01') {
            playActionAudio('peng', voice);
        }
        
        // Êí≠Êä•ÂêÉÁâåÔºà‰ΩøÁî®Èü≥È¢ëÔºåÊîØÊåÅÂ§öÁßçËØ≠Èü≥Ôºâ
        function speakChi(voice = 'female01') {
            playActionAudio('chi', voice);
        }
        
        // Êí≠Êä•Êù†Ôºà‰ΩøÁî®Èü≥È¢ëÔºåÊîØÊåÅÂ§öÁßçËØ≠Èü≥Ôºâ
        function speakGang(voice = 'female01') {
            playActionAudio('gang', voice);
        }
        
        // Êí≠Êä•ËÉ°ÁâåÔºà‰ΩøÁî®Èü≥È¢ëÔºåÊîØÊåÅÂ§öÁßçËØ≠Èü≥Ôºâ
        function speakHu(isZimo = false, voice = 'female01') {
            playActionAudio(isZimo ? 'zimo' : 'hu', voice);
            // Êí≠ÊîæËÉúÂà©Èü≥Êïà
            playBeep(523, 100);
            setTimeout(() => playBeep(659, 100), 100);
            setTimeout(() => playBeep(784, 150), 200);
        }
        
        // Êí≠ÊîæÁàÜÁÇ∏Èü≥ÊïàÔºàÊîæÁÇÆÊó∂Ôºâ
        function playExplosionSound() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') audioContext.resume();
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(40, audioContext.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
            } catch (e) {
                console.log('Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•:', e);
                vibrate(200);
            }
        }
        
        // Êí≠Êä•ÊîæÁÇÆ
        function speakFangPao() {
            playExplosionSound();
            setTimeout(() => speak('ÊîæÁÇÆ', 0.8, 0.6), 300);
        }

        // ËøûÊé•ÊúçÂä°Âô®
        let isConnected = false;
        let connectionAttempts = 0;
        
        function connectServer() {
            // Ê£ÄÊµãÊòØÂê¶Âú® GitHub Pages Á≠âÈùôÊÄÅÊâòÁÆ°‰∏ä
            const isStaticHost = window.location.hostname.includes('github.io') || 
                                 window.location.hostname.includes('gitee.io') ||
                                 window.location.hostname.includes('netlify.app') ||
                                 window.location.hostname.includes('vercel.app');
            
            if (isStaticHost) {
                // ÈùôÊÄÅÊâòÁÆ°Êó†Ê≥ïËøêË°å WebSocket ÊúçÂä°Âô®ÔºåÊòæÁ§∫ÊèêÁ§∫
                showServerRequiredModal();
                return;
            }
            
            // Ëá™Âä®Ê£ÄÊµãÊúçÂä°Âô®Âú∞ÂùÄ
            const serverUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? `http://${window.location.hostname}:3000`
                : window.location.origin;
            
            socket = io(serverUrl, {
                timeout: 10000,            // Â¢ûÂä†Ë∂ÖÊó∂Êó∂Èó¥
                reconnectionAttempts: 5,   // Â¢ûÂä†ÈáçËøûÊ¨°Êï∞
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                transports: ['websocket', 'polling'],  // ‰ºòÂÖà WebSocket
                upgrade: true
            });

            socket.on('connect', () => {
                console.log('Â∑≤ËøûÊé•ÊúçÂä°Âô®');
                myPlayerId = socket.id;
                isConnected = true;
                connectionAttempts = 0;
                
                // ÂêØÂä®ÁΩëÁªúË¥®ÈáèÊ£ÄÊµã
                startPingMonitor();
                updateNetworkIndicator('good');
                
                // Ê£ÄÊü•ÊòØÂê¶Êúâ‰øùÂ≠òÁöÑÊàøÈó¥‰ø°ÊÅØÔºåÂ∞ùËØïÈáçËøû
                const savedRoomCode = sessionStorage.getItem('mahjong_room_code');
                const savedUsername = sessionStorage.getItem('mahjong_username');
                const savedVoice = sessionStorage.getItem('mahjong_voice') || 'female01';
                if (savedRoomCode && savedUsername) {
                    console.log('Â∞ùËØïËá™Âä®ÈáçËøûÂà∞ÊàøÈó¥:', savedRoomCode);
                    myVoice = savedVoice;
                    socket.emit('join_room', { 
                        roomCode: savedRoomCode, 
                        username: savedUsername, 
                        avatar: 'üë§', 
                        voice: savedVoice 
                    });
                }
            });

            socket.on('disconnect', () => {
                console.log('‰∏éÊúçÂä°Âô®Êñ≠ÂºÄËøûÊé•');
                isConnected = false;
                showToast('ËøûÊé•Â∑≤Êñ≠ÂºÄ');
            });
            
            socket.on('connect_error', () => {
                connectionAttempts++;
                if (connectionAttempts >= 3) {
                    showServerRequiredModal();
                }
            });

            // ÊàøÈó¥‰∫ã‰ª∂
            socket.on('room_created', (data) => {
                currentRoom = data.roomCode;
                showRoomScreen();
            });

            socket.on('room_joined', (data) => {
                currentRoom = data.roomCode;
                sessionStorage.setItem('mahjong_room_code', data.roomCode);
                sessionStorage.setItem('mahjong_username', username);
                showRoomScreen();
            });

            socket.on('join_error', (data) => {
                showToast(data.message);
            });

            socket.on('room_updated', (data) => {
                updateRoomUI(data.room);
            });
            
            // Áé©ÂÆ∂Á¶ªÁ∫øÊèêÁ§∫
            socket.on('player_offline', (data) => {
                showToast(`‚ö†Ô∏è ${data.username} Êñ≠Á∫ø‰∫ÜÔºåÁ≠âÂæÖÈáçËøû...`, 5000);
            });
            
            // Áé©ÂÆ∂ÈáçËøû
            socket.on('player_reconnected', (data) => {
                showToast(`‚úÖ ${data.username} Â∑≤ÈáçËøûÔºÅ`);
            });

            // Ê∏∏Êàè‰∫ã‰ª∂
            socket.on('game_started', (data) => {
                mySeatIndex = data.yourSeat;
                gameState = data.gameState;
                gameRunning = true;
                
                // ÈáçÁΩÆÂê¨ÁâåÁä∂ÊÄÅ
                isTing = false;
                isQiao = false;
                tingList = [];
                lastDrawnTileId = null;
                selectedTileId = null;
                pendingQiao = false;
                
                // ÂÖ≥Èó≠ÁªìÁÆóÂºπÁ™ó
                document.getElementById('roundResultModal').classList.remove('active');
                
                // Ê£ÄÊü•ÊòØÂê¶Ë¢´AIÊé•ÁÆ°
                const myPlayer = gameState.players.find(p => p.seatIndex === mySeatIndex);
                if (myPlayer && myPlayer.aiTakeover) {
                    isAITakeover = true;
                    showTakeoverButton();
                    showToast('‚ö†Ô∏è AIÊ≠£Âú®‰ª£Êõø‰Ω†ËøõË°åÊ∏∏ÊàèÔºåÁÇπÂáª"Êé•ÁÆ°AI"ÊÅ¢Â§çÊéßÂà∂', 5000);
                } else {
                    isAITakeover = false;
                    hideTakeoverButton();
                }
                
                // Êõ¥Êñ∞Â±ÄÊï∞ÂíåÁßØÂàÜÊòæÁ§∫
                if (data.currentRound !== undefined) {
                    updateRoundDisplay(data.currentRound, data.totalRounds);
                }
                if (data.matchScores) {
                    updateScorePanel(data.matchScores);
                }
                
                showGameScreen();
                updateGameUI();
                
                // ÂêéÂè∞È¢ÑÂä†ËΩΩÂ∏∏Áî®Èü≥È¢ëÔºàÂª∂ËøüÊâßË°åÔºå‰∏çÈòªÂ°ûUIÔºâ
                setTimeout(() => {
                    silentPreloadAudio(myVoice);
                }, 1000);
                
                // „ÄêÂ¢ûÂº∫„ÄëÂ§ÑÁêÜÈáçËøû
                if (data.isReconnect) {
                    showToast('üîÑ Â∑≤ÈáçÊñ∞ËøûÊé•ÔºÅÁªßÁª≠Ê∏∏Êàè...', 3000);
                    console.log('Êñ≠Á∫øÈáçËøûÊàêÂäüÔºåÂ∫ß‰Ωç:', mySeatIndex, 'ÂΩìÂâçËΩÆÂà∞:', gameState.currentPlayerIndex);
                    
                    // Â¶ÇÊûúËΩÆÂà∞Ëá™Â∑±ÔºåËß¶ÂèëËá™Âä®Êë∏ÁâåÊàñÊòæÁ§∫Âá∫ÁâåÊèêÁ§∫
                    if (gameState.currentPlayerIndex === mySeatIndex) {
                        if (gameState.turnPhase === 'draw') {
                            setTimeout(() => autoDrawTile(), 500);
                        }
                    }
                } else {
                    showToast(`Á¨¨ ${data.currentRound || 1}/${data.totalRounds || 10} Â±ÄÂºÄÂßãÔºÅ`);
                }
            });
            
            // „ÄêÊñ∞Â¢û„ÄëËΩÆÂà∞‰Ω†ÁöÑÂõûÂêàÔºàÈáçËøûÂêéÈÄöÁü•Ôºâ
            socket.on('your_turn', (data) => {
                console.log('ËΩÆÂà∞‰Ω†‰∫Ü:', data);
                showToast(`üéØ ${data.message}`, 3000);
                
                if (data.phase === 'draw') {
                    // Ëá™Âä®Êë∏Áâå
                    setTimeout(() => autoDrawTile(), 300);
                }
            });

            socket.on('game_state_update', (data) => {
                const prevPhase = gameState?.turnPhase;
                const prevPlayer = gameState?.currentPlayerIndex;
                
                gameState = data.gameState;
                updateGameUI();
                
                console.log('Ê∏∏ÊàèÁä∂ÊÄÅÊõ¥Êñ∞:', 'Áé©ÂÆ∂:', gameState.currentPlayerIndex, 'Èò∂ÊÆµ:', gameState.turnPhase, 'ÊàëÁöÑÂ∫ß‰Ωç:', mySeatIndex);
                
                // Ê£ÄÊü•ÊòØÂê¶Ë¢´AIÊé•ÁÆ°
                const myPlayer = gameState.players.find(p => p.seatIndex === mySeatIndex);
                if (myPlayer && myPlayer.aiTakeover) {
                    if (!isAITakeover) {
                        isAITakeover = true;
                        showTakeoverButton();
                        showToast('‚ö†Ô∏è AIÊ≠£Âú®‰ª£Êõø‰Ω†ËøõË°åÊ∏∏ÊàèÔºåÁÇπÂáª"Êé•ÁÆ°AI"ÊÅ¢Â§çÊéßÂà∂', 5000);
                    }
                } else {
                    if (isAITakeover) {
                        isAITakeover = false;
                        hideTakeoverButton();
                    }
                }
                
                // Ëá™Âä®Êë∏ÁâåÔºöËΩÆÂà∞Áé©ÂÆ∂‰∏îÊòØÊë∏ÁâåÈò∂ÊÆµÊó∂Ëá™Âä®Êë∏Áâå
                // Âè™Âú®Áä∂ÊÄÅÂèòÂåñÊó∂Ëß¶ÂèëÔºåÈò≤Ê≠¢ÈáçÂ§ç
                const isMyTurn = gameState.currentPlayerIndex === mySeatIndex;
                const phaseChanged = prevPhase !== gameState.turnPhase || prevPlayer !== gameState.currentPlayerIndex;
                
                // „ÄêUIÊîπËøõ„ÄëËΩÆÂà∞Ëá™Â∑±Êó∂ÊòæÁ§∫ÊèêÁ§∫ÂíåÂèëÂÖâÊïàÊûú
                if (isMyTurn && gameState.turnPhase === 'discard' && phaseChanged) {
                    showTurnIndicator(true);
                    updateMyTurnEffect(true);
                } else if (!isMyTurn || gameState.turnPhase !== 'discard') {
                    updateMyTurnEffect(false);
                }
                
                // „ÄêÊñ∞Â¢û„ÄëÂ¶ÇÊûú‰∏çÊòØÊàëÁöÑÂá∫ÁâåÂõûÂêàÔºåÂÅúÊ≠¢ÂÄíËÆ°Êó∂
                if (!isMyTurn || gameState.turnPhase !== 'discard') {
                    stopDiscardCountdown('game_state_update: not my turn or not discard phase');
                }
                // ÂÄíËÆ°Êó∂Áî±ÊúçÂä°Âô®ÈÄöËøá discard_countdown ‰∫ã‰ª∂Ëß¶ÂèëÂêØÂä®
                
                if (isMyTurn && gameState.turnPhase === 'draw' && phaseChanged) {
                    console.log('Ëß¶ÂèëËá™Âä®Êë∏Áâå...');
                    setTimeout(() => {
                        autoDrawTile();
                    }, 500);
                }
            });

            socket.on('tile_drawn', (data) => {
                lastDrawnTileId = data.tile.id; // ËÆ∞ÂΩïÂàöÊë∏ÁöÑÁâå
                showToast(`Êë∏Âà∞: ${getTileName(data.tile)}`);
                
                // ÈáçÊñ∞Ê∏≤ÊüìÊâãÁâå‰ª•ÊòæÁ§∫Êñ∞ÁâåÈ´ò‰∫Æ
                if (gameState) {
                    const myPlayer = gameState.players.find(p => p.seatIndex === mySeatIndex);
                    if (myPlayer && myPlayer.hand) {
                        renderMyHand(myPlayer.hand);
                    }
                }
                
                // Âê¨ÁâåÂêéËá™Âä®Âá∫ÁâåÔºöÂª∂ËøüÊâßË°åÔºåÂÖàÁ≠âÂæÖÊúçÂä°Âô®Ê£ÄÊü•ÊòØÂê¶ËÉΩËÉ°Áâå
                if (isTing && lastDrawnTileId) {
                    console.log('Â∑≤Âê¨ÁâåÔºåÁ≠âÂæÖÊúçÂä°Âô®Ê£ÄÊü•ËÉ°Áâå...');
                    // Ê†áËÆ∞Á≠âÂæÖËÉ°ÁâåÊ£ÄÊü•
                    pendingAutoDiscard = true;
                    pendingAutoDiscardTileId = lastDrawnTileId;
                    // Âª∂Ëøü1.5ÁßíÂêéËá™Âä®Âá∫ÁâåÔºàÂ¶ÇÊûúÊ≤°ÊúâÊî∂Âà∞ËÉ°ÁâåÈÄâÈ°πÔºâ
                    setTimeout(() => {
                        if (pendingAutoDiscard && pendingAutoDiscardTileId) {
                            console.log('Êú™Êî∂Âà∞ËÉ°ÁâåÈÄâÈ°πÔºåËá™Âä®Âá∫Áâå');
                            showToast('Âê¨Áâå‰∏≠ÔºåËá™Âä®Âá∫Áâå...');
                            selectedTileId = pendingAutoDiscardTileId;
                            discardTile();
                            pendingAutoDiscard = false;
                            pendingAutoDiscardTileId = null;
                        }
                    }, 1500);
                }
            });
            
            // Êë∏Âà∞Ëä±ÁâåËá™Âä®Ë°•Ëä±
            socket.on('flower_drawn', (data) => {
                showToast(`üå∏ Êë∏Âà∞Ëä±ÁâåÔºö${data.flowerName}ÔºåË°•Ëä±‰∏≠...`, 2000);
                playActionAudio('buhua', myVoice); // Êí≠ÊîæË°•Ëä±Èü≥Êïà
                playBeep(880, 100); // Êí≠ÊîæÊèêÁ§∫Èü≥

                // Êõ¥Êñ∞Ëä±ÁâåÊòæÁ§∫
                const flowerEl = document.getElementById(`flower-${mySeatIndex}`);
                if (flowerEl) {
                    flowerEl.textContent = `üå∏${data.totalFlowers}`;
                }
            });

            socket.on('tile_discarded', (data) => {
                const player = gameState.players[data.playerIndex];
                const playerName = player?.username || 'Áé©ÂÆ∂';
                const playerVoice = player?.voice || getPlayerVoiceBySeat(data.playerIndex);
                const isMe = data.playerIndex === mySeatIndex;
                if (!isMe) {
                    showToast(`${playerName}: ${data.tileName}`);
                }
                // ËØ≠Èü≥Êí≠Êä•Âá∫ÁâåÔºà‰ΩøÁî®Âá∫ÁâåÁé©ÂÆ∂ÁöÑËØ≠Èü≥Ôºâ
                speakDiscard(data.tile, playerVoice);
            });

            socket.on('action_available', (data) => {
                console.log('Êî∂Âà∞ÂèØÊâßË°åÂä®‰Ωú:', data.actions);
                
                // ÂèñÊ∂àÁ≠âÂæÖËá™Âä®Âá∫ÁâåÔºàÊî∂Âà∞‰ªª‰ΩïÂä®‰ΩúÈÄâÈ°πÈÉΩÂ∫îËØ•ÂèñÊ∂àÔºâ
                pendingAutoDiscard = false;
                pendingAutoDiscardTileId = null;
                
                // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ËÉ°ÁâåÔºàÂåÖÊã¨ÁÇπÁÇÆËÉ°ÂíåËá™Êë∏ËÉ°Ôºâ
                const canHu = data.actions.includes('hu') || data.actions.includes('hu_zimo');
                
                // Ëá™Âä®ËÉ°ÁâåÔºöÂ¶ÇÊûúÂèØ‰ª•ËÉ°ÔºåËá™Âä®ÊâßË°å
                if (canHu) {
                    const huAction = data.actions.includes('hu_zimo') ? 'hu_zimo' : 'hu';
                    const isZimo = huAction === 'hu_zimo';
                    console.log('ÂèØ‰ª•ËÉ°ÁâåÔºåËá™Âä®ËÉ°ÁâåÔºÅÂä®‰Ωú:', huAction, 'ÊòØÂê¶Ëá™Êë∏:', isZimo);
                    showToast(isZimo ? 'üéâ Ëá™Êë∏ËÉ°ÁâåÔºÅ' : 'üéâ ÊçâÈì≥ËÉ°ÁâåÔºÅ');
                    setTimeout(() => {
                        doAction(huAction);
                    }, 500);
                    return;
                }
                
                // Â¶ÇÊûúÂê¨ÁâåÁä∂ÊÄÅÔºåËá™Âä®ËøáÔºà‰∏çÁ¢∞‰∏çÊù†Ôºâ
                if (isTing) {
                    console.log('Â∑≤Âê¨ÁâåÔºåËá™Âä®Ëøá');
                    setTimeout(() => {
                        doAction('pass');
                    }, 300);
                    return;
                }
                
                showResponseButtons(data.actions, data);
            });
            
            socket.on('action_timeout', () => {
                console.log('Âä®‰ΩúË∂ÖÊó∂ÔºåÈöêËóèÊåâÈíÆ');
                hideResponseButtons();
            });
            
            socket.on('action_error', (data) => {
                console.log('Âä®‰ΩúÈîôËØØ:', data.message);
                showToast('Êìç‰ΩúË∂ÖÊó∂ÔºåËØ∑Á≠âÂæÖ‰∏ãÊ¨°Êú∫‰ºö');
                hideResponseButtons();
            });

            socket.on('action_executed', (data) => {
                const player = gameState.players.find(p => p.seatIndex === data.playerIndex);
                const playerName = player?.username || 'Áé©ÂÆ∂';
                const playerVoice = player?.voice || getPlayerVoiceBySeat(data.playerIndex);
                const isMe = data.playerIndex === mySeatIndex;
                
                // ÊòæÁ§∫Âä®‰ΩúÁâπÊïàÔºàÁ¢∞/Êù†/ËÉ°/Âä†Êù†/ÂêÉ Â§ßÂ≠óÂä®ÁîªÔºâ
                if (data.action === 'peng' || data.action === 'gang' || data.action === 'hu' || data.action === 'hu_zimo' || data.action === 'jia_gang' || data.action === 'chi') {
                    showActionEffect(data.action, playerName);
                }
                
                if (data.action === 'peng') {
                    showToast(`${isMe ? '‰Ω†' : playerName} Á¢∞ÔºÅ`);
                    speakPeng(playerVoice);
                } else if (data.action === 'gang') {
                    showToast(`${isMe ? '‰Ω†' : playerName} Êù†ÔºÅ`);
                    speakGang(playerVoice);
                } else if (data.action === 'jia_gang') {
                    showToast(`${isMe ? '‰Ω†' : playerName} Âä†Êù†ÔºÅ`);
                    speakGang(playerVoice);
                } else if (data.action === 'hu') {
                    showToast(`${isMe ? '‰Ω†' : playerName} ËÉ°‰∫ÜÔºÅ`);
                    speakHu(false, playerVoice);
                } else if (data.action === 'chi') {
                    showToast(`${isMe ? '‰Ω†' : playerName} ÂêÉÔºÅ`);
                    speakChi(playerVoice);
                }
            });

            socket.on('ai_draw', (data) => {
                // AIÊë∏ÁâåÊèêÁ§∫
            });
            
            // „ÄêÊñ∞Â¢û„ÄëÂá∫ÁâåÂÄíËÆ°Êó∂
            socket.on('discard_countdown', (data) => {
                console.log(`Âá∫ÁâåÂÄíËÆ°Êó∂ÂºÄÂßã: ${data.seconds}Áßí`);
                // Âª∂Ëøü‰∏ÄÁÇπÂêØÂä®ÂÄíËÆ°Êó∂ÔºåÁ°Æ‰øù game_state_update ÂÖàÂ§ÑÁêÜÂÆåÊàê
                setTimeout(() => {
                    startDiscardCountdown(data.seconds);
                }, 100);
            });
            
            // „ÄêÊñ∞Â¢û„ÄëËá™Âä®Âá∫ÁâåÈÄöÁü•
            socket.on('auto_discard', (data) => {
                console.log('Ë∂ÖÊó∂Ëá™Âä®Âá∫Áâå:', data.tile);
                showToast('‚è∞ ' + data.message);
                stopDiscardCountdown('auto_discard');
            });

            // Âê¨ÁâåÊï≤ÁâåÂºπÁ™ó
            socket.on('ting_and_qiao_prompt', (data) => {
                console.log('Êî∂Âà∞Âê¨ÁâåÊï≤ÁâåÂºπÁ™ó:', data);
                showQiaoModal(data.message, data.tingTiles);
            });
            
            // Áé©ÂÆ∂Êï≤ÁâåÂπøÊí≠ÔºàÊòæÁ§∫Êï≤ÁâåÊ†áËÆ∞Ôºâ
            socket.on('player_qiao', (data) => {
                console.log('Áé©ÂÆ∂Êï≤Áâå:', data);
                showToast(`${data.username} Â∑≤Êï≤ÁâåÔºÅ`, 2000);
                renderGame();
            });
            
            // Êï≤ÁâåË∂ÖÊó∂Ëá™Âä®Á°ÆËÆ§
            socket.on('qiao_timeout_auto_confirm', (data) => {
                console.log('Êï≤ÁâåË∂ÖÊó∂Ëá™Âä®Á°ÆËÆ§');
                const modal = document.getElementById('qiaoModal');
                if (modal) modal.remove();
                isQiao = true;
                pendingQiao = false;
                showToast('üîî Ë∂ÖÊó∂Êú™ÈÄâÊã©ÔºåÂ∑≤Ëá™Âä®Êï≤ÁâåÔºÅ', 3000);
            });
            
            // ÂçïÂ±ÄÁªìÁÆó
            socket.on('round_ended', (data) => {
                console.log('ÂçïÂ±ÄÁªìÁÆó:', data);

                // Ê£ÄÊµãÊòØÂê¶Êúâ‰∫∫ËÉ°ÁâåÔºåÊí≠ÊîæÂØπÂ∫îËØ≠Èü≥
                if (data.roundResult && data.roundResult.resultType) {
                    const resultType = data.roundResult.resultType;
                    if (resultType === 'zimo' || resultType === 'hu') {
                        const isZimo = data.roundResult.isZimo === true;
                        const winnerIndex = data.roundResult.winnerIndex;
                        const winnerPlayer = gameState.players.find(p => p.seatIndex === winnerIndex);
                        const voice = winnerPlayer?.voice || 'female01';
                        speakHu(isZimo, voice);

                        // Â¶ÇÊûúÊòØÁÇπÁÇÆÔºåÊí≠ÊîæÁàÜÁÇ∏Èü≥Êïà
                        if (!isZimo) {
                            setTimeout(() => playExplosionSound(), 500);
                        }
                    }
                }

                // ÈáçÁΩÆÂáÜÂ§áÊåâÈíÆÁä∂ÊÄÅ
                const btn = document.getElementById('continueNextBtn');
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-play"></i> ÁªßÁª≠‰∏ã‰∏ÄÂ±Ä';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                showRoundResult(data);
            });
            
            // ÂÄíËÆ°Êó∂Êõ¥Êñ∞
            socket.on('countdown_update', (data) => {
                console.log('ÂÄíËÆ°Êó∂Êõ¥Êñ∞:', data.seconds);
                const countdownEl = document.getElementById('countdownSeconds');
                if (countdownEl) {
                    countdownEl.textContent = data.seconds;
                    // ÊúÄÂêé5ÁßíÂèòÁ∫¢
                    if (data.seconds <= 5) {
                        countdownEl.style.color = '#e74c3c';
                    } else {
                        countdownEl.style.color = '';
                    }
                }
                // Êõ¥Êñ∞Áé©ÂÆ∂ÂáÜÂ§áÁä∂ÊÄÅ
                if (data.readyStatus) {
                    updatePlayersReadyStatus(data.readyStatus);
                }
            });
            
            // ÂáÜÂ§áÁä∂ÊÄÅÊõ¥Êñ∞
            socket.on('ready_status_update', (data) => {
                console.log('ÂáÜÂ§áÁä∂ÊÄÅÊõ¥Êñ∞:', data);
                updatePlayersReadyStatus(data.readyStatus);
                if (data.countdown !== undefined) {
                    const countdownEl = document.getElementById('countdownSeconds');
                    if (countdownEl) {
                        countdownEl.textContent = data.countdown;
                    }
                }
            });
            
            // AIÊé•ÁÆ°Áä∂ÊÄÅ
            socket.on('ai_takeover_status', (data) => {
                console.log('AIÊé•ÁÆ°Áä∂ÊÄÅ:', data);
                updatePlayersReadyStatus(data.readyStatus);
                
                // Ê£ÄÊü•Ëá™Â∑±ÊòØÂê¶Ë¢´Êé•ÁÆ°
                const myStatus = data.readyStatus.find(p => p.seatIndex === mySeatIndex);
                if (myStatus && myStatus.aiTakeover) {
                    showToast('‚ö†Ô∏è ‰Ω†Êú™ÂáÜÂ§áÔºåAIÂ∞Ü‰ª£Êõø‰Ω†ËøõË°åÊ∏∏Êàè', 3000);
                    isAITakeover = true;
                }
            });
            
            // Êé•ÁÆ°AIÊàêÂäü
            socket.on('takeover_success', (data) => {
                console.log('Êé•ÁÆ°AIÊàêÂäü:', data);
                showToast('‚úÖ Â∑≤ÊÅ¢Â§çÊéßÂà∂ÊùÉÔºÅ', 2000);
                isAITakeover = false;
                hideTakeoverButton();
            });
            
            // ÂÖ∂‰ªñÁé©ÂÆ∂Êé•ÁÆ°AI
            socket.on('player_takeover', (data) => {
                console.log('Áé©ÂÆ∂Êé•ÁÆ°AI:', data);
                showToast(`${data.username} ÊÅ¢Â§ç‰∫ÜÊéßÂà∂ÊùÉ`);
            });
            
            // ÊØîËµõÁªìÊùü
            socket.on('match_ended', (data) => {
                console.log('ÊØîËµõÁªìÊùü:', data);
                showMatchResult(data);
            });

            // Ê∏∏ÊàèÊöÇÂÅú
            socket.on('game_paused', (data) => {
                console.log('Ê∏∏ÊàèÊöÇÂÅú:', data);
                showPauseModal(data.pausedPlayer, data.pauseTime);
            });

            // ÂèñÊ∂àÊöÇÂÅú
            socket.on('pause_cancelled', (data) => {
                console.log('ÂèñÊ∂àÊöÇÂÅú:', data);
                showResumeCountdown(data.cancelledPlayer, data.resumeCountdown);
            });

            // ÊöÇÂÅúÊÅ¢Â§çÂÄíËÆ°Êó∂
            socket.on('pause_resume_countdown', (data) => {
                console.log('ÊÅ¢Â§çÂÄíËÆ°Êó∂:', data.seconds);
                const countdownEl = document.getElementById('resumeCountdown');
                if (countdownEl) {
                    countdownEl.textContent = data.seconds;
                }
            });

            // Ê∏∏ÊàèÊÅ¢Â§ç
            socket.on('game_resumed', (data) => {
                console.log('Ê∏∏ÊàèÊÅ¢Â§ç');
                hidePauseModals();
            });

            // Ëß£Êï£ËØ∑Ê±Ç
            socket.on('dissolve_requested', (data) => {
                console.log('Ëß£Êï£ËØ∑Ê±Ç:', data);
                showDissolveModal(data.requester);
            });

            // Ëß£Êï£ÊäïÁ•®Êõ¥Êñ∞
            socket.on('dissolve_vote_update', (data) => {
                console.log('Ëß£Êï£ÊäïÁ•®Êõ¥Êñ∞:', data);
                updateDissolveVotes(data.votes, data.totalPlayers);
            });

            // Ëß£Êï£Ë¢´ÊãíÁªù
            socket.on('dissolve_rejected', (data) => {
                console.log('Ëß£Êï£Ë¢´ÊãíÁªù');
                hideDissolveModal();
                showModal('Ëß£Êï£ÊäïÁ•®Êú™ÈÄöËøá', 'Êúâ‰∫∫ÊãíÁªù‰∫ÜËß£Êï£Ê∏∏Êàè');
            });

            // Ê∏∏ÊàèËß£Êï£
            socket.on('game_dissolved', (data) => {
                console.log('Ê∏∏ÊàèËß£Êï£:', data);
                hidePauseModals();
                hideDissolveModal();
                showDissolveResultModal(data);
            });

            // ËÅäÂ§©
            socket.on('chat_message', (data) => {
                addChatMessage(data.username, data.message);
            });
            
            // ÁõëÂê¨Ë°®ÊÉÖÊ∞îÊ≥°‰∫ã‰ª∂
            socket.on('emoji_received', (data) => {
                // Âú®ÂèëÈÄÅËÄÖÂ§¥ÂÉè‰ΩçÁΩÆÊòæÁ§∫Ë°®ÊÉÖÊ∞îÊ≥°
                if (data.seatIndex !== mySeatIndex) {
                    showEmojiBubble(data.emoji, data.seatIndex);
                }
            });
            
            // ÁõëÂê¨ËΩªÈáèÁ∫ßÊõ¥Êñ∞ÔºàÊÄßËÉΩ‰ºòÂåñÔºâ
            socket.on('light_update', (data) => {
                // Âø´ÈÄüÊõ¥Êñ∞ÂÖ≥ÈîÆÁä∂ÊÄÅ
                if (gameState && data) {
                    gameState.currentPlayerIndex = data.c;
                    gameState.turnPhase = data.t;
                    gameState.deckRemaining = data.r;
                    // ËΩªÈáèÊõ¥Êñ∞‰∏çÈáçÁªòÊâãÁâå
                    const remainingTilesEl = document.getElementById('remainingTiles');
                    if (remainingTilesEl) remainingTilesEl.textContent = data.r;
                }
            });
            
            // ÁΩëÁªúÂª∂ËøüÊ£ÄÊµã
            socket.on('pong', () => {
                const ping = Date.now() - lastPingTime;
                updateNetworkQuality(ping);
                updateNetworkIndicator(networkQuality);
            });
        }
        
        // ==================== ÁΩëÁªúË¥®ÈáèÁõëÊéß ====================
        
        let pingInterval = null;
        
        // ÂêØÂä® Ping ÁõëÊéß
        function startPingMonitor() {
            if (pingInterval) clearInterval(pingInterval);
            
            pingInterval = setInterval(() => {
                if (socket && socket.connected) {
                    lastPingTime = Date.now();
                    socket.emit('ping');
                }
            }, 5000); // ÊØè5ÁßíÊ£ÄÊµã‰∏ÄÊ¨°
        }
        
        // Êõ¥Êñ∞ÁΩëÁªúÊåáÁ§∫Âô®
        function updateNetworkIndicator(quality) {
            const indicator = $('networkIndicator') || document.getElementById('networkIndicator');
            const status = $('networkStatus') || document.getElementById('networkStatus');
            
            if (!indicator) return;
            
            indicator.className = 'network-indicator';
            
            switch (quality) {
                case 'slow':
                    indicator.classList.add('slow');
                    if (status) status.textContent = '‚ö†Ô∏è ÁΩëÁªúËæÉÊÖ¢';
                    document.body.classList.add('reduce-motion');
                    break;
                case 'medium':
                    indicator.classList.add('medium');
                    if (status) status.textContent = 'üì∂ ÁΩëÁªú‰∏ÄËà¨';
                    break;
                default:
                    // good - ÈöêËóèÊåáÁ§∫Âô®
                    document.body.classList.remove('reduce-motion');
                    break;
            }
        }
        
        // ÁõëÂê¨ÁΩëÁªúÁä∂ÊÄÅÂèòÂåñ
        if ('connection' in navigator) {
            navigator.connection.addEventListener('change', () => {
                const conn = navigator.connection;
                if (conn.effectiveType === '2g' || conn.effectiveType === 'slow-2g') {
                    networkQuality = 'slow';
                    updateNetworkIndicator('slow');
                    showToast('‚ö†Ô∏è Ê£ÄÊµãÂà∞Âº±ÁΩëÁéØÂ¢ÉÔºåÂ∑≤ÂêØÁî®ÁúÅÊµÅÊ®°Âºè');
                }
            });
        }
        
        // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÊó∂Â§ÑÁêÜ
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // È°µÈù¢ÊÅ¢Â§çÂèØËßÅÊó∂ÔºåËØ∑Ê±ÇÂÆåÊï¥Áä∂ÊÄÅÂêåÊ≠•
                if (socket && socket.connected && gameState) {
                    socket.emit('request_sync');
                }
            }
        });

        // ÊòæÁ§∫ÊúçÂä°Âô®Ë¶ÅÊ±ÇÊèêÁ§∫
        function showServerRequiredModal() {
            document.getElementById('serverRequiredModal').classList.add('active');
        }
        
        function closeServerModal() {
            document.getElementById('serverRequiredModal').classList.remove('active');
        }
        
        // ÂàùÂßãÂåñËØ≠Èü≥
        function initVoice() {
            const savedVoice = sessionStorage.getItem('mahjong_voice');
            myVoice = savedVoice || 'female01';
            
            // Êõ¥Êñ∞ÁïåÈù¢‰∏äÁöÑËØ≠Èü≥ÈÄâÊã©Áä∂ÊÄÅ
            document.getElementById('voiceFemale01').classList.toggle('active', myVoice === 'female01');
            document.getElementById('voiceFemale02').classList.toggle('active', myVoice === 'female02');
            document.getElementById('voiceMale').classList.toggle('active', myVoice === 'male');
            document.getElementById('voiceMale02').classList.toggle('active', myVoice === 'male02');
            
            console.log('ÂàùÂßãÂåñËØ≠Èü≥:', myVoice);
        }
        
        // ÈÄâÊã©ËØ≠Èü≥
        function selectVoice(voice) {
            myVoice = voice;
            sessionStorage.setItem('mahjong_voice', voice);
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.getElementById('voiceFemale01').classList.toggle('active', voice === 'female01');
            document.getElementById('voiceFemale02').classList.toggle('active', voice === 'female02');
            document.getElementById('voiceMale').classList.toggle('active', voice === 'male');
            document.getElementById('voiceMale02').classList.toggle('active', voice === 'male02');
            console.log('ÈÄâÊã©ËØ≠Èü≥:', voice);
        }
        
        // ÂàõÂª∫ÊàøÈó¥
        function createRoom() {
            if (!isConnected) {
                showServerRequiredModal();
                return;
            }
            username = document.getElementById('usernameInput').value.trim() || 'Áé©ÂÆ∂' + Math.floor(Math.random() * 1000);
            socket.emit('create_room', { username, avatar: 'üë§', voice: myVoice });
        }

        // Âä†ÂÖ•ÊàøÈó¥
        function joinRoom() {
            if (!isConnected) {
                showServerRequiredModal();
                return;
            }
            username = document.getElementById('usernameInput').value.trim() || 'Áé©ÂÆ∂' + Math.floor(Math.random() * 1000);
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (roomCode.length !== 6) {
                showToast('ËØ∑ËæìÂÖ•6‰ΩçÊàøÈó¥Âè∑');
                return;
            }
            
            socket.emit('join_room', { roomCode, username, avatar: 'üë§', voice: myVoice });
        }

        // ÊòæÁ§∫ÊàøÈó¥ÁïåÈù¢
        function showRoomScreen() {
            document.getElementById('lobbyScreen').classList.remove('active');
            document.getElementById('roomScreen').classList.add('active');
            document.getElementById('roomCodeDisplay').textContent = currentRoom;
        }

        // Êõ¥Êñ∞ÊàøÈó¥UI
        function updateRoomUI(room) {
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                const player = room.players.find(p => p.seatIndex === i);
                const slot = document.createElement('div');
                slot.className = 'player-slot' + (player ? ' filled' : '') + (player?.ready ? ' ready' : '');
                
                if (player) {
                    const isMe = player.id === myPlayerId;
                    slot.innerHTML = `
                        <div class="player-avatar">${player.avatar || 'üë§'}</div>
                        <div class="player-name">${player.username}${isMe ? ' (Êàë)' : ''}</div>
                        <div class="player-wind">${player.windName}È£é</div>
                        <div class="player-status ${player.isHost ? 'host' : (player.ready ? 'ready' : 'waiting')}">
                            ${player.isHost ? 'Êàø‰∏ª' : (player.ready ? 'Â∑≤ÂáÜÂ§á' : 'Êú™ÂáÜÂ§á')}
                        </div>
                    `;
                } else {
                    slot.innerHTML = `<div class="empty-slot">Á≠âÂæÖÁé©ÂÆ∂Âä†ÂÖ•...</div>`;
                }
                
                grid.appendChild(slot);
            }
        }

        // Â§çÂà∂ÊàøÈó¥Âè∑
        function copyRoomCode() {
            const roomCode = currentRoom || document.getElementById('roomCodeDisplay').textContent;
            
            // Â∞ùËØï‰ΩøÁî®Áé∞‰ª£ API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(roomCode).then(() => {
                    showToast('ÊàøÈó¥Âè∑Â∑≤Â§çÂà∂: ' + roomCode);
                }).catch(() => {
                    // Â§±Ë¥•Êó∂‰ΩøÁî®Â§áÁî®ÊñπÊ°à
                    fallbackCopy(roomCode);
                });
            } else {
                // ‰∏çÊîØÊåÅ clipboard APIÔºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à
                fallbackCopy(roomCode);
            }
        }
        
        // Â§áÁî®Â§çÂà∂ÊñπÊ≥ïÔºàÂÖºÂÆπ HTTPÔºâ
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            textArea.style.top = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast('ÊàøÈó¥Âè∑Â∑≤Â§çÂà∂: ' + text);
            } catch (err) {
                showToast('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂: ' + text);
            }
            
            document.body.removeChild(textArea);
        }

        // ÂáÜÂ§á/ÂèñÊ∂àÂáÜÂ§á
        function toggleReady() {
            isReady = !isReady;
            socket.emit('toggle_ready', { ready: isReady });
            
            const btn = document.getElementById('readyBtn');
            btn.innerHTML = isReady ? '<i class="fas fa-times"></i> ÂèñÊ∂àÂáÜÂ§á' : '<i class="fas fa-check"></i> ÂáÜÂ§á';
            btn.classList.toggle('secondary', isReady);
        }

        // Á¶ªÂºÄÊàøÈó¥
        function leaveRoom() {
            socket.emit('leave_room');
            currentRoom = null;
            isReady = false;
            sessionStorage.removeItem('mahjong_room_code');
            sessionStorage.removeItem('mahjong_username');
            document.getElementById('roomScreen').classList.remove('active');
            document.getElementById('lobbyScreen').classList.add('active');
        }

        // ÊòæÁ§∫Ê∏∏ÊàèÁïåÈù¢
        function showGameScreen() {
            const roomScreenEl = document.getElementById('roomScreen');
            if (roomScreenEl) roomScreenEl.classList.remove('active');
            const gameScreenEl = document.getElementById('gameScreen');
            if (gameScreenEl) gameScreenEl.classList.add('active');

            // Êõ¥Êñ∞ÊàøÈó¥Âè∑ÊòæÁ§∫
            const roomInfoEl = document.getElementById('roomInfo');
            if (roomInfoEl && currentRoom) {
                roomInfoEl.textContent = 'ÊàøÈó¥: ' + currentRoom;
            }

            // Âè™Âú®Â§ßÂ±èÂπïÊòæÁ§∫ËÅäÂ§©Âå∫Âüü
            const chatAreaEl = document.getElementById('chatArea');
            if (chatAreaEl) {
                if (window.innerWidth > 768) {
                    chatAreaEl.style.display = 'block';
                } else {
                    chatAreaEl.style.display = 'none';
                }
            }
            const actionButtonsEl = document.getElementById('actionButtons');
            if (actionButtonsEl) actionButtonsEl.classList.add('active');
            // Ê∑ªÂä†Ê∏∏Êàè‰∏≠Ê†áËÆ∞ÔºàÁî®‰∫éÊ∏∏ÊàèÁïåÈù¢Ê†∑ÂºèÔºâ
            document.body.classList.add('in-game');
            
            // „Äê‰øÆÂ§ç„ÄëÂÖ≥Èó≠ÂèØËÉΩÂ≠òÂú®ÁöÑÂºπÁ™ó
            const roundResultModalEl = document.getElementById('roundResultModal');
            if (roundResultModalEl) roundResultModalEl.classList.remove('active');
            const matchResultModalEl = document.getElementById('matchResultModal');
            if (matchResultModalEl) matchResultModalEl.classList.remove('active');
            const resultModalEl = document.getElementById('resultModal');
            if (resultModalEl) resultModalEl.classList.remove('active');
        }

        // Êõ¥Êñ∞Ê∏∏ÊàèUI - ‰ºòÂåñÁâàÔºàÂ¢ûÈáèÊõ¥Êñ∞ + RAFÔºâ
        function updateGameUI() {
            if (!gameState) return;
            
            // ‰ΩøÁî® requestAnimationFrame ÊâπÈáèÊõ¥Êñ∞
            scheduleUpdate(() => {
                _doUpdateGameUI();
            });
        }
        
        function _doUpdateGameUI() {
            if (!gameState) return;
            
            const myPlayer = gameState.players.find(p => p.seatIndex === mySeatIndex);
            if (!myPlayer) return;
            
            const remainingTilesEl = document.getElementById('remainingTiles');
            if (remainingTilesEl) remainingTilesEl.textContent = gameState.deckRemaining;
            
            const mySeatIdx = gameState.players.findIndex(p => p.seatIndex === mySeatIndex);
            const seatMapping = [];
            for (let i = 0; i < 4; i++) {
                seatMapping[(i - mySeatIdx + 4) % 4] = i;
            }
            
            // Êõ¥Êñ∞Ëá™Â∑±ÁöÑÁé©ÂÆ∂‰ø°ÊÅØ
            const playerAvatarEl = document.getElementById('playerAvatar');
            if (playerAvatarEl) {
                playerAvatarEl.textContent = myPlayer.avatar || 'üòä';
                playerAvatarEl.classList.toggle('dealer', gameState.dealerIndex === myPlayer.seatIndex);
            }
            const playerNameEl = document.getElementById('playerName');
            if (playerNameEl) {
                playerNameEl.textContent = myPlayer.username || 'Áé©ÂÆ∂';
            }
            const playerWindEl = document.getElementById('playerWind');
            if (playerWindEl) {
                playerWindEl.textContent = myPlayer.windName || '';
            }

            const playerHandEl = document.getElementById('playerHand');
            if (playerHandEl && myPlayer.hand) {
                playerHandEl.innerHTML = myPlayer.hand.map((tile, index) => {
                    const isNewTile = tile.id === lastDrawnTileId;
                    return renderTile(tile, { selectable: true, index, isNew: isNewTile });
                }).join('');
            }
            
            const playerFlowersEl = document.getElementById('playerFlowers');
            if (playerFlowersEl && myPlayer.flowers) {
                playerFlowersEl.innerHTML = myPlayer.flowers.map(tile => 
                    renderTile(tile, { small: true })
                ).join('');
            }
            
            const flowerCountEl = document.getElementById('flowerCount');
            if (flowerCountEl && myPlayer.flowers) {
                const flowerCount = myPlayer.flowers.length;
                const handCount = myPlayer.hand ? myPlayer.hand.length : 0;
                const meldsCount = myPlayer.melds ? myPlayer.melds.length : 0;
                let statusText = `üÉè ÊâãÁâå: ${handCount}Âº†`;
                if (meldsCount > 0) {
                    statusText += ` (Á¢∞${meldsCount}ÁªÑ)`;
                }
                statusText += ` | üå∏ Ëä±Áâå: ${flowerCount}`;
                flowerCountEl.innerHTML = statusText;
            }
            
            for (let relSeat = 1; relSeat <= 3; relSeat++) {
                const absSeat = seatMapping[relSeat];
                const player = gameState.players[absSeat];
                if (!player) continue;

                const opponentId = `opponent${relSeat}`;

                // Êõ¥Êñ∞ÂØπÊâãÂêçÁß∞„ÄÅÂ§¥ÂÉèÂíåÈ£éÁâå
                const opponentAvatarEl = document.getElementById(`${opponentId}Avatar`);
                if (opponentAvatarEl) {
                    opponentAvatarEl.textContent = player.avatar || 'ü§ñ';
                }
                const opponentNameEl = document.getElementById(`${opponentId}Name`);
                if (opponentNameEl) {
                    opponentNameEl.textContent = player.username || `AI-${player.windName || ''}`;
                }
                const opponentWindEl = document.querySelector(`#${opponentId} .player-wind`);
                if (opponentWindEl) {
                    opponentWindEl.textContent = player.windName || '';
                }

                const opponentHandEl = document.getElementById(`${opponentId}Hand`);
                if (opponentHandEl) {
                    let handHtml = '';
                    const handCount = player.handCount || (player.hand ? player.hand.length : 0);
                    for (let i = 0; i < handCount; i++) {
                        handHtml += '<div class="tile small back"></div>';
                    }
                    opponentHandEl.innerHTML = handHtml;
                }
                
                const opponentInfoEl = document.querySelector(`#${opponentId} .player-info`);
                if (opponentInfoEl && player.flowers) {
                    const aiFlowers = player.flowers.length;
                    let flowerSpan = opponentInfoEl.querySelector('.flower-count');
                    if (!flowerSpan) {
                        flowerSpan = document.createElement('span');
                        flowerSpan.className = 'flower-count';
                        flowerSpan.style.cssText = 'margin-left: 10px; color: #f1c40f; font-size: 0.9rem;';
                        opponentInfoEl.appendChild(flowerSpan);
                    }
                    flowerSpan.textContent = `üå∏${aiFlowers}`;
                }
                
                const opponentMeldsEl = document.getElementById(`${opponentId}Melds`);
                if (opponentMeldsEl && player.melds) {
                    opponentMeldsEl.innerHTML = player.melds.map(meld => {
                        const tilesHtml = meld.tiles.map(tile => renderTile(tile, { small: true })).join('');
                        return `<div class="meld-group ${meld.type}">${tilesHtml}</div>`;
                    }).join('');
                }

                // Ê∏≤ÊüìÂØπÊâãËä±Áâå
                const opponentFlowersEl = document.getElementById(`${opponentId}Flowers`);
                if (opponentFlowersEl && player.flowers) {
                    opponentFlowersEl.innerHTML = player.flowers.map(tile => 
                        renderTile(tile, { small: true })
                    ).join('');
                }
            }
            
            // ÂºÉÁâåÂå∫Êò†Â∞ÑÔºörelSeat 0=Ëá™Â∑±(Â∫ïÈÉ®), 1=Âè≥ÂÆ∂(Âè≥‰æß), 2=ÂØπÂÆ∂(È°∂ÈÉ®), 3=Â∑¶ÂÆ∂(Â∑¶‰æß)
            const discardMapping = [0, 3, 1, 2];
            for (let relSeat = 0; relSeat < 4; relSeat++) {
                const absSeat = seatMapping[relSeat];
                const player = gameState.players[absSeat];
                if (!player || !player.discards) continue;
                
                const discardZoneEl = document.getElementById(`discard${discardMapping[relSeat]}`);
                if (discardZoneEl) {
                    const discardsDiv = discardZoneEl.querySelector('.discards');
                    if (discardsDiv) {
                        discardsDiv.innerHTML = player.discards.map(tile => 
                            renderTile(tile, { small: true })
                        ).join('');
                    }
                }
            }
            
            const playerMeldsEl = document.getElementById('playerMelds');
            if (playerMeldsEl && myPlayer.melds) {
                playerMeldsEl.innerHTML = myPlayer.melds.map(meld => {
                    const tilesHtml = meld.tiles.map(tile => renderTile(tile, { small: true })).join('');
                    return `<div class="meld-group ${meld.type}">${tilesHtml}</div>`;
                }).join('');
            }
            
            updateActionButtons();
            
            const isMenQing = !myPlayer.melds || myPlayer.melds.length === 0;
            const menqingStatusEl = document.getElementById('menqingStatus');
            const menqingIconEl = document.getElementById('menqingIcon');
            if (menqingStatusEl && menqingIconEl) {
                if (isMenQing) {
                    menqingStatusEl.textContent = 'Èó®Ê∏Ö ‚úì';
                    menqingStatusEl.style.color = '#2ecc71';
                    menqingIconEl.textContent = 'üö™';
                } else {
                    menqingStatusEl.textContent = 'Â∑≤Á¢∞Êù†';
                    menqingStatusEl.style.color = '#e74c3c';
                    menqingIconEl.textContent = '‚ùå';
                }
            }
            
            prevGameState = JSON.parse(JSON.stringify(gameState));
        }
        // Ëé∑ÂèñÊòæÁ§∫Â∫ß‰ΩçÔºàÁõ∏ÂØπ‰∫éËá™Â∑±ÁöÑ‰ΩçÁΩÆÔºâ
        function getDisplaySeat(seatIndex) {
            // Â∞ÜÁªùÂØπÂ∫ß‰ΩçËΩ¨Êç¢‰∏∫Áõ∏ÂØπ‰ΩçÁΩÆÔºö0=Ëá™Â∑±, 1=Âè≥ÂÆ∂, 2=ÂØπÂÆ∂, 3=Â∑¶ÂÆ∂
            return (seatIndex - mySeatIndex + 4) % 4;
        }

        // Êõ¥Êñ∞Â∫ß‰ΩçUI
        function updateSeatUI(displaySeat, player) {
            if (displaySeat === 0) return; // Ëá™Â∑±ÁöÑÂ∫ß‰ΩçÂçïÁã¨Â§ÑÁêÜ

            const prefix = displaySeat === 1 ? 'seat-1' : displaySeat === 2 ? 'seat-2' : 'seat-3';
            
            const avatarEl = document.getElementById(`avatar-${displaySeat}`);
            if (!avatarEl) return;
            
            avatarEl.textContent = player.avatar || 'ü§ñ';
            avatarEl.classList.toggle('current-turn', gameState.currentPlayerIndex === player.seatIndex);
            avatarEl.classList.toggle('offline', player.offline === true);
            avatarEl.classList.toggle('dealer', gameState.dealerIndex === player.seatIndex);
            
            const nameEl = document.getElementById(`name-${displaySeat}`);
            if (nameEl) nameEl.textContent = player.username;
            const windEl = document.getElementById(`wind-${displaySeat}`);
            if (windEl) windEl.textContent = player.windName;
            
            // „ÄêÊñ∞Â¢û„ÄëÂ∫ß‰Ωç‰ø°ÊÅØÁ¶ªÁ∫øÊ†∑Âºè
            const seatInfo = avatarEl.closest('.seat-info') || avatarEl.parentElement;
            if (seatInfo) {
                seatInfo.classList.toggle('offline', player.offline === true);
            }

            // ÊòæÁ§∫ÊâãÁâåÊï∞ÈáèÔºàËÉåÈù¢Ôºâ
            const tilesDiv = document.getElementById(`tiles-${displaySeat}`);
            if (!tilesDiv) return;
            
            tilesDiv.innerHTML = '';
            for (let i = 0; i < player.handCount; i++) {
                const tile = document.createElement('div');
                tile.className = 'tile small back';
                tilesDiv.appendChild(tile);
            }
        }

        // Ê∏≤ÊüìÊàëÁöÑÊâãÁâå - ‰ºòÂåñÁâàÔºà‰ΩøÁî® DocumentFragmentÔºâ
        function renderMyHand(hand) {
            const container = document.getElementById('playerHand');
            
            // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
            if (!container) return;
            
            // ‰ΩøÁî® DocumentFragment ÊâπÈáèÊûÑÂª∫ DOM
            const fragment = document.createDocumentFragment();
            
            hand.forEach((tile, index) => {
                const isNewTile = (tile.id === lastDrawnTileId);
                const tileEl = createTileElement(tile, { isNew: isNewTile });
                
                // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÊèêÂçáÊÄßËÉΩ
                tileEl.dataset.tileId = tile.id;
                if (tile.id === selectedTileId) {
                    tileEl.classList.add('selected');
                }
                fragment.appendChild(tileEl);
            });
            
            // ‰∏ÄÊ¨°ÊÄßÊõøÊç¢ÊâÄÊúâÂÜÖÂÆπ
            container.innerHTML = '';
            container.appendChild(fragment);
        }
        
        // ÊâãÁâåÂå∫ÂüüÁÇπÂáª‰∫ã‰ª∂ÂßîÊâòÔºàÂáèÂ∞ë‰∫ã‰ª∂ÁõëÂê¨Âô®Êï∞ÈáèÔºâ
        document.addEventListener('DOMContentLoaded', () => {
            const handContainer = document.getElementById('playerHand');
            if (handContainer) {
                handContainer.addEventListener('click', (e) => {
                    const tileEl = e.target.closest('.tile');
                    if (tileEl && tileEl.dataset.tileId) {
                        selectTile(tileEl.dataset.tileId);
                    }
                });
            }
        });

        // Ëé∑ÂèñÁâåÁöÑÊñáÂ≠óÊòæÁ§∫
        function getTileText(tile) {
            if (tile.type === 'wind') {
                // È£éÁâå: ‰∏ú„ÄÅÂçó„ÄÅË•ø„ÄÅÂåó
                return { value: HONOR_CHARS[tile.value] || tile.value, type: '' };
            } else if (tile.type === 'honor') {
                // ‰∏≠ÂèëÁôΩ
                return { value: HONOR_CHARS[tile.value] || tile.value, type: '' };
            } else if (tile.type === 'flower') {
                // Ëä±Áâå
                return { value: FLOWER_CHARS[tile.value] || tile.value, type: '' };
            } else {
                // Êï∞Â≠óÁâå: ‰∏á„ÄÅÁ≠í„ÄÅÊù°
                return { value: NUM_NAMES[tile.value], type: TYPE_NAMES[tile.type] };
            }
        }

        // ÂàõÂª∫È∫ªÂ∞ÜÁâåÂÖÉÁ¥†
        function createTileElement(tile, options = {}) {
            const { small = false, isNew = false, discarded = false } = options;
            const el = document.createElement('div');
            
            let classes = ['tile', tile.type];
            if (small) classes.push('small');
            if (discarded) classes.push('discarded');
            if (isNew) classes.push('new-tile');
            
            // Á≤æÁÅµÂõæÊú™Âä†ËΩΩÂÆåÊàêÊó∂‰ΩøÁî®ÊñáÂ≠óÊ®°ÂºèÊòæÁ§∫
            if (!spriteLoaded) {
                classes.push('text-mode');
            }
            
            el.className = classes.join(' ');
            
            // Â∫îÁî®Á≤æÁÅµÂõæ‰ΩçÁΩÆ
            const spritePos = getSpritePosition(tile);
            if (spritePos && spriteLoaded) {
                el.style.cssText = spritePos;
            } else if (!spriteLoaded) {
                // ÂõæÁâáÂä†ËΩΩ‰∏≠ÔºåÂª∂ËøüËÆæÁΩÆÊ†∑ÂºèÂπ∂ÊòæÁ§∫ÊñáÂ≠ó
                el.dataset.spriteStyle = spritePos;
                const tileText = getTileText(tile);
                el.innerHTML = '<div class="tile-text"><span class="tile-value">' + tileText.value + '</span><span class="tile-type">' + tileText.type + '</span></div>';
            } else {
                // Â§áÁî®ÊñáÂ≠óÊòæÁ§∫
                el.classList.add('text-mode');
                const tileText = getTileText(tile);
                el.innerHTML = '<div class="tile-text"><span class="tile-value">' + tileText.value + '</span><span class="tile-type">' + tileText.type + '</span></div>';
            }
            
            const tileText = getTileText(tile);
            el.title = tileText.value + tileText.type;
            return el;
        }

        // Ê∏≤ÊüìÊàëÁöÑÂâØÈú≤
        function renderMyMelds(melds) {
            const container = document.getElementById('playerMelds');
            if (!container) return;
            
            container.innerHTML = '';

            melds.forEach(meld => {
                const group = document.createElement('div');
                group.className = 'meld-group';
                meld.tiles.forEach(tile => {
                    group.appendChild(createTileElement(tile, { small: true }));
                });
                container.appendChild(group);
            });
        }

        // Êõ¥Êñ∞Âá∫ÁâåÂå∫
        function updateDiscardArea() {
            // Êõ¥Êñ∞‰∏≠Â§ÆÂâ©‰ΩôÁâåÊï∞
            const centerDeckCount = document.getElementById('centerDeckCount');
            if (centerDeckCount) {
                centerDeckCount.textContent = gameState.deckRemaining;
            }
            
            // ÊØè‰∏™Áé©ÂÆ∂ÁöÑÂºÉÁâåÊòæÁ§∫Âú®Ëá™Â∑±Èó®Ââç
            gameState.players.forEach(player => {
                const displaySeat = getDisplaySeat(player.seatIndex);
                const discardZone = document.getElementById(`discard${displaySeat}`);
                if (!discardZone) return;
                
                const container = discardZone.querySelector('.discards');
                if (!container) return;
                
                container.innerHTML = '';
                player.discards.forEach(tile => {
                    const tileEl = createTileElement(tile, { small: true });
                    container.appendChild(tileEl);
                });
                
                // ÊòæÁ§∫Êï≤ÁâåÊ†áËÆ∞
                const zoneLabel = discardZone.querySelector('.zone-label');
                if (zoneLabel && player.isQiao) {
                    zoneLabel.innerHTML = `<span style="color: #e74c3c; font-weight: bold;">üîî Êï≤Áâå</span>`;
                } else if (zoneLabel && displaySeat === 0) {
                    // ÊÅ¢Â§çÈªòËÆ§Ê†áÁ≠æ
                    zoneLabel.textContent = 'ÊàëÁöÑÂá∫Áâå';
                } else if (zoneLabel) {
                    const windNames = ['', '‰∏úÂÆ∂Âá∫Áâå', 'ÂçóÂÆ∂', 'ÂåóÂÆ∂'];
                    if (windNames[displaySeat]) {
                        zoneLabel.textContent = windNames[displaySeat];
                    }
                }
            });
        }

        // ÈÄâÊã©ÊâãÁâåÔºàÂèåÂáªÁõ¥Êé•Âá∫ÁâåÔºâ
        function selectTile(tileId) {
            console.log('ÈÄâÁâå:', tileId, 'ÂΩìÂâçÁé©ÂÆ∂:', gameState.currentPlayerIndex, 'ÊàëÁöÑÂ∫ß‰Ωç:', mySeatIndex, 'Èò∂ÊÆµ:', gameState.turnPhase);
            
            // Âè™ËÉΩÂú®Ëá™Â∑±ÁöÑÂõûÂêàÈÄâÁâå
            if (gameState.currentPlayerIndex !== mySeatIndex) {
                showToast('‰∏çÊòØ‰Ω†ÁöÑÂõûÂêà');
                return;
            }
            
            // ÂøÖÈ°ªÊòØÂá∫ÁâåÈò∂ÊÆµ
            if (gameState.turnPhase !== 'discard') {
                showToast('ËØ∑Á≠âÂæÖÊë∏Áâå...');
                return;
            }
            
            if (selectedTileId === tileId) {
                // ÂèåÂáªÁõ¥Êé•Âá∫Áâå
                discardTile();
                return;
            } else {
                selectedTileId = tileId;
            }
            
            document.querySelectorAll('#myHand .tile').forEach(el => {
                el.classList.remove('selected');
            });
            
            if (selectedTileId) {
                const myPlayer = gameState.players.find(p => p.seatIndex === mySeatIndex);
                const tileIndex = myPlayer.hand.findIndex(t => String(t.id) === String(selectedTileId));
                if (tileIndex !== -1) {
                    document.querySelectorAll('#myHand .tile')[tileIndex]?.classList.add('selected');
                }
            }
            
            document.getElementById('discardBtn').disabled = !selectedTileId;
        }

        // Êõ¥Êñ∞Âä®‰ΩúÊåâÈíÆ
        function updateActionButtons() {
            const isMyTurn = gameState.currentPlayerIndex === mySeatIndex;
            const actionBtns = document.getElementById('actionButtons');
            
            if (!actionBtns) return;
            
            // Âè™Âú®Âá∫ÁâåÈò∂ÊÆµÊòæÁ§∫Âá∫ÁâåÊåâÈíÆÔºàÊë∏ÁâåÊòØËá™Âä®ÁöÑÔºâ
            if (isMyTurn && gameState.turnPhase === 'discard') {
                actionBtns.classList.add('active');
                const discardBtn = document.getElementById('discardBtn');
                if (discardBtn) discardBtn.disabled = !selectedTileId;
            } else {
                actionBtns.classList.remove('active');
            }
        }

        // ÊòæÁ§∫ÂìçÂ∫îÊåâÈíÆÔºà‰ΩøÁî®Áé∞ÊúâÁöÑactionHintsÂÖÉÁ¥†Ôºâ
        function showResponseButtons(actions, data) {
            const actionHints = document.getElementById('actionHints');
            if (!actionHints) return;
            
            const jiaGangBtn = document.getElementById('jiaGangBtn');
            const pengBtn = document.getElementById('pengBtn');
            const gangBtn = document.getElementById('gangBtn');
            const huBtn2 = document.getElementById('huBtn2');
            const chiBtn = document.getElementById('chiBtn');
            const passBtn = document.getElementById('passBtn');
            
            // ÈáçÁΩÆÊâÄÊúâÊåâÈíÆ
            if (jiaGangBtn) jiaGangBtn.style.display = 'none';
            if (pengBtn) pengBtn.style.display = 'none';
            if (gangBtn) gangBtn.style.display = 'none';
            if (huBtn2) huBtn2.style.display = 'none';
            if (chiBtn) chiBtn.style.display = 'none';
            if (passBtn) passBtn.style.display = 'none';
            
            // Ê†πÊçÆactionsÂèÇÊï∞ÊòæÁ§∫ÂØπÂ∫îÊåâÈíÆ
            if (jiaGangBtn && actions.includes('jia_gang')) {
                jiaGangBtn.style.display = 'inline-block';
            }
            if (pengBtn && actions.includes('peng')) {
                pengBtn.style.display = 'inline-block';
            }
            if (gangBtn && actions.includes('gang')) {
                gangBtn.style.display = 'inline-block';
            }
            if (huBtn2 && actions.includes('hu')) {
                huBtn2.style.display = 'inline-block';
            }
            if (chiBtn && actions.includes('chi')) {
                chiBtn.style.display = 'inline-block';
                // ‰øùÂ≠òÂêÉÁâåÈÄâÈ°π‰æõÂêéÁª≠‰ΩøÁî®
                if (data && data.chiOptions) {
                    window.currentChiOptions = data.chiOptions;
                }
            }
            if (passBtn) {
                passBtn.style.display = 'inline-block';
            }
            
            actionHints.style.display = 'flex';
            
            // ‰øùÂ≠òÂä†Êù†ÈÄâÈ°π‰æõÂêéÁª≠‰ΩøÁî®
            if (data && data.jiaGangOptions) {
                window.currentJiaGangOptions = data.jiaGangOptions;
            }
            
            // ÊòæÁ§∫Êìç‰ΩúÊèêÁ§∫
            const lastDiscard = gameState.lastDiscard;
            if (lastDiscard) {
                const display = getTileDisplay(lastDiscard);
                let actionText = '';
                if (actions.includes('jia_gang')) actionText += 'Âä†Êù† ';
                if (actions.includes('peng')) actionText += 'Á¢∞ ';
                if (actions.includes('gang')) actionText += 'Êù† ';
                if (actions.includes('hu')) actionText += 'ËÉ° ';
                if (actions.includes('chi')) actionText += 'ÂêÉ ';
                showToast(`AIÊâìÂá∫ ${display.value}${display.suit} - ÂèØ${actionText}ÁÇπÂáªÊåâÈíÆÈÄâÊã©`);
            }
        }

        // ÈöêËóèÂìçÂ∫îÊåâÈíÆ
        function hideResponseButtons() {
            const actionHints = document.getElementById('actionHints');
            if (actionHints) {
                actionHints.style.display = 'none';
            }
        }

        // ÊâãÂä®Êë∏ÁâåÔºàÂ§áÁî®Ôºâ
        function drawTile() {
            socket.emit('draw_tile');
        }
        
        // Ëá™Âä®Êë∏Áâå
        function autoDrawTile() {
            if (!gameState || gameState.currentPlayerIndex !== mySeatIndex) return;
            if (gameState.turnPhase !== 'draw') return;
            
            console.log('Ëá™Âä®Êë∏Áâå...');
            socket.emit('draw_tile');
        }

        // Âá∫Áâå
        function discardTile() {
            if (!selectedTileId) {
                showToast('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊâìÂá∫ÁöÑÁâå');
                return;
            }
            
            // Â¶ÇÊûúÂ∑≤Êï≤ÁâåÔºåÂè™ËÉΩÊâìÂàöÊë∏ÁöÑÁâå
            if (isQiao && selectedTileId !== lastDrawnTileId) {
                showToast('Â∑≤Êï≤ÁâåÔºåÂè™ËÉΩÊâìÂàöÊë∏ÁöÑÁâåÔºÅ');
                return;
            }
            
            // Â¶ÇÊûúÂ∑≤Âê¨Áâå‰ΩÜÊú™Êï≤ÁâåÔºàpendingQiao‰∏∫trueË°®Á§∫Ê≠£Âú®Á≠âÂæÖÊï≤ÁâåÁ°ÆËÆ§ÔºâÔºåÈôêÂà∂Âá∫Áâå
            if (pendingQiao && selectedTileId !== lastDrawnTileId) {
                showToast('ËØ∑ÂÖàÈÄâÊã©ÊòØÂê¶Êï≤ÁâåÔºÅ');
                return;
            }
            
            // Ê∏ÖÈô§ÂàöÊë∏ÁöÑÁâåÊ†áËÆ∞
            lastDrawnTileId = null;
            
            // „ÄêÊñ∞Â¢û„ÄëÂÅúÊ≠¢Âá∫ÁâåÂÄíËÆ°Êó∂
            stopDiscardCountdown('discard_tile');
            
            socket.emit('discard_tile', { tileId: selectedTileId });
            selectedTileId = null;
            
            // Âá∫ÁâåÂêéÊ£ÄÊµãÂê¨ÁâåÔºàÂª∂ËøüÁ≠âÂæÖÊúçÂä°Âô®Êõ¥Êñ∞Ôºâ
            setTimeout(() => {
                if (!isTing) {
                    checkAndShowTing();
                }
            }, 500);
        }

        // ÊâßË°åÂä®‰Ωú
        function doAction(action) {
            console.log('ÊâßË°åÂä®‰Ωú:', action);
            
            // Â¶ÇÊûúÊòØÂä†Êù†Ôºå‰º†ÈÄíÂä†Êù†ÈÄâÈ°π‰ø°ÊÅØ
            if (action === 'jia_gang') {
                const actionData = { action };
                if (window.currentJiaGangOptions && window.currentJiaGangOptions.length > 0) {
                    if (window.currentJiaGangOptions.length === 1) {
                        actionData.selectedMeldIndex = window.currentJiaGangOptions[0].meldIndex;
                    } else {
                        // Â§ö‰∏™Âä†Êù†ÈÄâÈ°πÊó∂ÔºåÈªòËÆ§ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÔºàÂêéÁª≠ÂèØ‰ª•Ê∑ªÂä†ÈÄâÊã©UIÔºâ
                        actionData.selectedMeldIndex = window.currentJiaGangOptions[0].meldIndex;
                    }
                }
                socket.emit('player_action', actionData);
            } else {
                socket.emit('player_action', { action });
            }
            
            hideResponseButtons();
            
            // ÊòæÁ§∫Âä®‰ΩúÁâπÊïàÔºàÂè™Âú®Êú¨Âú∞ÊòæÁ§∫Ôºå‰∏çÈáçÂ§çÊí≠ÊîæÈü≥È¢ëÔºâ
            if (action === 'peng' || action === 'gang' || action === 'hu' || action === 'hu_zimo' || action === 'jia_gang') {
                showActionEffect(action);
            }
        }
        
        // Â§ÑÁêÜÂêÉÁâåÁÇπÂáªÔºàÊúâÂ§öÈÄâ‰∏ÄÊó∂ÊòæÁ§∫ÈÄâÊã©Ôºâ
        function handleChiClick() {
            const chiOptions = window.currentChiOptions;
            
            if (!chiOptions || chiOptions.length === 0) {
                return;
            }
            
            if (chiOptions.length === 1) {
                socket.emit('player_action', {
                    action: 'chi',
                    extraData: { selectedChiIndex: 0 }
                });
                hideResponseButtons();
                showActionEffect('chi');
                const myVoice = getPlayerVoiceBySeat(mySeatIndex);
                playActionAudio('chi', myVoice);
            } else {
                showChiSelectionModal(chiOptions);
            }
        }
        
        // ÊòæÁ§∫ÂêÉÁâåÈÄâÊã©ÂºπÁ™ó
        function showChiSelectionModal(chiOptions) {
            const modal = document.createElement('div');
            modal.id = 'chiModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border-radius: 15px;
                padding: 20px;
                max-width: 400px;
                width: 90%;
                border: 2px solid #e74c3c;
                box-shadow: 0 0 30px rgba(231, 76, 60, 0.3);
            `;
            
            const title = document.createElement('h2');
            title.textContent = 'üéØ ÈÄâÊã©ÂêÉÁâåÊñπÂºè';
            title.style.cssText = `
                text-align: center;
                color: #e74c3c;
                margin: 0 0 20px 0;
                font-size: 24px;
            `;
            content.appendChild(title);
            
            chiOptions.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.style.cssText = `
                    display: block;
                    width: 100%;
                    padding: 15px;
                    margin: 10px 0;
                    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                    border: none;
                    border-radius: 10px;
                    color: white;
                    font-size: 18px;
                    cursor: pointer;
                    transition: transform 0.2s;
                `;
                
                // ÊòæÁ§∫ÂêÉÁâåÁªÑÂêà
                const tileNames = option.tiles.map(t => getTileDisplay(t).value + getTileDisplay(t).suit).join(' ');
                btn.textContent = `${tileNames} (${option.pattern || ''})`;
                
                btn.onmouseover = () => btn.style.transform = 'scale(1.02)';
                btn.onmouseout = () => btn.style.transform = 'scale(1)';
                
                btn.onclick = () => {
                    socket.emit('player_action', {
                        action: 'chi',
                        extraData: { selectedChiIndex: index }
                    });
                    modal.remove();
                    hideResponseButtons();
                    showActionEffect('chi');
                    const myVoice = getPlayerVoiceBySeat(mySeatIndex);
                    playActionAudio('chi', myVoice);
                };
                
                content.appendChild(btn);
            });
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'ÂèñÊ∂à';
            cancelBtn.style.cssText = `
                display: block;
                width: 100%;
                padding: 12px;
                margin-top: 15px;
                background: #7f8c8d;
                border: none;
                border-radius: 10px;
                color: white;
                font-size: 16px;
                cursor: pointer;
            `;
            cancelBtn.onclick = () => modal.remove();
            content.appendChild(cancelBtn);
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        // „ÄêÊñ∞Â¢û„ÄëÂá∫ÁâåÂÄíËÆ°Êó∂Áõ∏ÂÖ≥
        let discardCountdownTimer = null;
        let discardCountdownValue = 0;
        
        function startDiscardCountdown(seconds) {
            // Âè™Ê∏ÖÈô§ËÆ°Êó∂Âô®Ôºå‰∏çÈöêËóèÂÖÉÁ¥†ÔºàÈÅøÂÖçÈó™ÁÉÅÔºâ
            if (discardCountdownTimer) {
                clearInterval(discardCountdownTimer);
                discardCountdownTimer = null;
            }
            discardCountdownValue = seconds;
            
            // ÂàõÂª∫ÊàñÊõ¥Êñ∞ÂÄíËÆ°Êó∂ÊòæÁ§∫
            let countdownEl = document.getElementById('discardCountdown');
            if (!countdownEl) {
                countdownEl = document.createElement('div');
                countdownEl.id = 'discardCountdown';
                countdownEl.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: #FFD700;
                    font-size: 48px;
                    font-weight: bold;
                    padding: 20px 40px;
                    border-radius: 15px;
                    z-index: 1000;
                    pointer-events: none;
                    display: none;
                `;
                document.body.appendChild(countdownEl);
            }
            
            // Áõ¥Êé•ÊòæÁ§∫Ôºå‰∏ç‰ΩøÁî®ËøáÊ∏°Âä®Áîª
            countdownEl.style.display = 'block';
            countdownEl.style.opacity = '1';
            countdownEl.style.color = '#FFD700'; // ÈáçÁΩÆÈ¢úËâ≤
            updateCountdownDisplay();
            
            discardCountdownTimer = setInterval(() => {
                discardCountdownValue--;
                if (discardCountdownValue <= 0) {
                    stopDiscardCountdown('countdown reached zero');
                } else {
                    updateCountdownDisplay();
                    // ÊúÄÂêé5ÁßíÂèòÁ∫¢Ëâ≤Ë≠¶Âëä
                    if (discardCountdownValue <= 5) {
                        countdownEl.style.color = '#FF4444';
                    }
                }
            }, 1000);
        }
        
        function updateCountdownDisplay() {
            const countdownEl = document.getElementById('discardCountdown');
            if (countdownEl) {
                countdownEl.textContent = `‚è± ${discardCountdownValue}`;
            }
        }
        
        function stopDiscardCountdown(reason = 'unknown') {
            console.log('ÂÅúÊ≠¢ÂÄíËÆ°Êó∂, ÂéüÂõ†:', reason);
            if (discardCountdownTimer) {
                clearInterval(discardCountdownTimer);
                discardCountdownTimer = null;
            }
            const countdownEl = document.getElementById('discardCountdown');
            if (countdownEl) {
                countdownEl.style.opacity = '0';
                setTimeout(() => {
                    countdownEl.style.display = 'none';
                    countdownEl.style.color = '#FFD700'; // ÈáçÁΩÆÈ¢úËâ≤
                }, 300);
            }
        }

        // Ëé∑ÂèñÁâåÂêç
        function getTileName(tile) {
            const tileText = getTileText(tile);
            return tileText.value + tileText.type;
        }

        // ËØ≠Èü≥Êí≠Êä•
        function speakTile(tile) {
            if ('speechSynthesis' in window) {
                const text = getTileName(tile);
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 1.2;
                speechSynthesis.speak(utterance);
            }
        }

        // ÊòæÁ§∫ÁªìÊûú
        function showResult(result, players) {
            const resultTitleEl = document.getElementById('resultTitle');
            if (resultTitleEl) resultTitleEl.textContent = result;
            
            let msg = 'ÊúÄÁªàÁªìÊûúÔºö\n\n';
            players.forEach(p => {
                msg += `${p.username}: ${p.score}ÂàÜ\n`;
            });
            const resultMessageEl = document.getElementById('resultMessage');
            if (resultMessageEl) resultMessageEl.textContent = msg;
            
            const resultModalEl = document.getElementById('resultModal');
            if (resultModalEl) resultModalEl.classList.add('active');
        }

        // ÂÖ≥Èó≠ÁªìÊûú
        function closeResult() {
            const resultModalEl = document.getElementById('resultModal');
            if (resultModalEl) resultModalEl.classList.remove('active');
            const gameScreenEl = document.getElementById('gameScreen');
            if (gameScreenEl) gameScreenEl.classList.remove('active');
            const roomScreenEl = document.getElementById('roomScreen');
            if (roomScreenEl) roomScreenEl.classList.add('active');
            const chatAreaEl = document.getElementById('chatArea');
            if (chatAreaEl) chatAreaEl.style.display = 'none';
            document.body.classList.remove('in-game');
            isReady = false;
            const readyBtnEl = document.getElementById('readyBtn');
            if (readyBtnEl) readyBtnEl.innerHTML = '<i class="fas fa-check"></i> ÂáÜÂ§á';
        }
        
        // ==================== ËÆ°ÂàÜÁ≥ªÁªü UI ====================
        
        // ÂΩìÂâçÊØîËµõÁöÑÁßØÂàÜ
        let matchScores = [0, 0, 0, 0];
        let currentRound = 1;
        let totalRounds = 10;
        let soundEnabled = true;
        
        // ÊâìÁâå
        function discardSelected() {
            if (selectedTileId) {
                socket.emit('discard_tile', { tileId: selectedTileId });
                selectedTileId = null;
            }
        }
        
        // ÊòæÁ§∫ÊèêÁ§∫
        function showTips() {
            const myPlayer = gameState?.players?.find(p => p.seatIndex === mySeatIndex);
            if (!myPlayer || !myPlayer.hand) return;
            
            let tip = '';
            const hand = myPlayer.hand;
            
            // ÁÆÄÂçïÊèêÁ§∫ÔºöÊ£ÄÊü•Âê¨Áâå
            const tingCount = checkTing(hand);
            if (tingCount > 0) {
                tip = `Âê¨${tingCount}Âº†ÁâåÔºåÂª∫ËÆÆÊâìÂá∫‰∏çÈúÄË¶ÅÁöÑÁâå`;
            } else {
                tip = 'Âª∫ËÆÆ‰øùÁïôÂ≠óÁâåÂíåÈù†Âº†';
            }
            
            showToast(tip);
        }
        
        // Ê£ÄÊü•Âê¨ÁâåÊï∞
        function checkTing(hand) {
            return 0;
        }
        
        // ÂàáÊç¢Â£∞Èü≥
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const soundBtn = document.getElementById('soundBtn');
            if (soundBtn) {
                soundBtn.innerHTML = soundEnabled ? 
                    '<i class="fas fa-volume-up"></i> Â£∞Èü≥' : 
                    '<i class="fas fa-volume-mute"></i> ÈùôÈü≥';
            }
        }
        
        // Êõ¥Êñ∞ÁßØÂàÜÈù¢Êùø
        function updateScorePanel(scores) {
            matchScores = scores;
            for (let i = 0; i < 4; i++) {
                const displaySeat = getDisplaySeat(i);
                const scoreEl = document.getElementById(`score-${displaySeat}`);
                if (scoreEl) {
                    const score = scores[i];
                    scoreEl.textContent = score >= 0 ? `+${score}` : score;
                    scoreEl.className = 'score-value ' + (score >= 0 ? 'positive' : 'negative');
                }
            }
            const scoreboardModal = document.getElementById('scoreboardModal');
            if (scoreboardModal && scoreboardModal.classList.contains('active')) {
                updateScoreboardDisplay();
            }
        }
        
        // Êõ¥Êñ∞Â±ÄÊï∞ÊòæÁ§∫
        function updateRoundDisplay(current, total) {
            currentRound = current;
            totalRounds = total;
            const roundNumEl = document.getElementById('roundNum');
            if (roundNumEl) {
                roundNumEl.textContent = current + '/' + total;
            }
        }
        
        // ÊòæÁ§∫ÂçïÂ±ÄÁªìÁÆó
        function showRoundResult(data) {
            const { roundResult, currentRound, totalRounds, matchScores } = data;
            
            // Êõ¥Êñ∞ÁßØÂàÜÈù¢Êùø
            updateScorePanel(matchScores);
            
            // ËÆæÁΩÆÊ†áÈ¢ò
            let title = 'Êú¨Â±ÄÁªìÁÆó';
            if (roundResult.resultType === 'draw') {
                title = 'ÊµÅÂ±Ä';
                const roundWinnerInfoEl = document.getElementById('roundWinnerInfo');
                if (roundWinnerInfoEl) roundWinnerInfoEl.style.display = 'none';
                const fanDetailListEl = document.getElementById('fanDetailList');
                if (fanDetailListEl) fanDetailListEl.style.display = 'none';
                const huaDetailListEl = document.getElementById('huaDetailList');
                if (huaDetailListEl) huaDetailListEl.style.display = 'none';
                const huDetailListEl = document.getElementById('huDetailList');
                if (huDetailListEl) huDetailListEl.style.display = 'none';
            } else {
                const roundWinnerInfoEl = document.getElementById('roundWinnerInfo');
                if (roundWinnerInfoEl) roundWinnerInfoEl.style.display = 'block';
                const fanDetailListEl = document.getElementById('fanDetailList');
                if (fanDetailListEl) fanDetailListEl.style.display = 'block';
                const huaDetailListEl = document.getElementById('huaDetailList');
                if (huaDetailListEl) huaDetailListEl.style.display = 'block';
                
                const winner = roundResult.players.find(p => p.seatIndex === roundResult.winnerIndex);
                const winType = roundResult.isZimo === true ? 'Ëá™Êë∏ËÉ°ÁâåÔºÅ' : 'ËÉ°ÁâåÔºÅ';
                const winnerNameEl = document.getElementById('winnerName');
                if (winnerNameEl) winnerNameEl.textContent = winner ? winner.username : '';
                const winTypeEl = document.getElementById('winType');
                if (winTypeEl) winTypeEl.textContent = winType;
                
                // ÊòæÁ§∫ËÉ°ÁâåËØ¶ÊÉÖ
                const huDetailListEl = document.getElementById('huDetailList');
                if (huDetailListEl) {
                    huDetailListEl.style.display = 'block';
                    
                    const huInfoEl = document.getElementById('huInfo');
                    if (huInfoEl) {
                        if (roundResult.isZimo) {
                            huInfoEl.innerHTML = `<span class="hu-to">${winner ? winner.username : ''}</span> Ëá™Êë∏ËÉ°ÁâåÔºÅ`;
                        } else if (roundResult.loserUsername) {
                            huInfoEl.innerHTML = `<span class="hu-from">${roundResult.loserUsername}</span> ÊîæÈì≥ ‚Üí <span class="hu-to">${winner ? winner.username : ''}</span> ËÉ°ÁâåÔºÅ`;
                        } else {
                            huInfoEl.innerHTML = `<span class="hu-to">${winner ? winner.username : ''}</span> ËÉ°ÁâåÔºÅ`;
                        }
                    }
                    
                    const winnerHandTilesEl = document.getElementById('winnerHandTiles');
                    if (winnerHandTilesEl && roundResult.winnerHand) {
                        winnerHandTilesEl.innerHTML = roundResult.winnerHand.map(tile => renderTile(tile, { small: true })).join('');
                    }
                    
                    const meldSectionEl = document.getElementById('meldSection');
                    const winnerMeldsEl = document.getElementById('winnerMelds');
                    if (meldSectionEl && winnerMeldsEl) {
                        if (roundResult.winnerMelds && roundResult.winnerMelds.length > 0) {
                            meldSectionEl.style.display = 'block';
                            winnerMeldsEl.innerHTML = roundResult.winnerMelds.map(meld => {
                                return meld.tiles.map(tile => renderTile(tile, { small: true })).join('');
                            }).join(' ');
                        } else {
                            meldSectionEl.style.display = 'none';
                        }
                    }
                    
                    const finalTileSectionEl = document.getElementById('finalTileSection');
                    const finalTileTitleEl = document.getElementById('finalTileTitle');
                    const finalTileDisplayEl = document.getElementById('finalTileDisplay');
                    if (finalTileSectionEl && finalTileTitleEl && finalTileDisplayEl) {
                        if (roundResult.finalTile) {
                            finalTileSectionEl.style.display = 'block';
                            if (roundResult.isZimo) {
                                finalTileTitleEl.textContent = 'üèÅ ÊúÄÂêéÊë∏Âà∞ÁöÑÁâå';
                            } else {
                                finalTileTitleEl.textContent = 'üí• Èì≥Áâå';
                            }
                            finalTileDisplayEl.innerHTML = renderTile(roundResult.finalTile, { small: true });
                        } else {
                            finalTileSectionEl.style.display = 'none';
                        }
                    }
                }
                
                // ÊòæÁ§∫Áï™Êï∞ÊòéÁªÜ
                if (roundResult.scoreResult) {
                    const fanItems = document.getElementById('fanItems');
                    if (fanItems) {
                        fanItems.innerHTML = '';
                        if (roundResult.scoreResult.fanDetail && roundResult.scoreResult.fanDetail.length > 0) {
                            roundResult.scoreResult.fanDetail.forEach(item => {
                                fanItems.innerHTML += `<div class="fan-item"><span class="fan-name">${item.name}</span><span class="fan-value">+${item.fan}Áï™</span></div>`;
                            });
                        } else {
                            fanItems.innerHTML = '<div class="fan-item"><span class="fan-name">È∏°ËÉ°</span><span class="fan-value">0Áï™</span></div>';
                        }
                    }
                    const totalFanDisplayEl = document.getElementById('totalFanDisplay');
                    if (totalFanDisplayEl) totalFanDisplayEl.textContent = roundResult.scoreResult.totalFan + 'Áï™';
                    
                    // ÊòæÁ§∫Ëä±Êï∞ÊòéÁªÜ
                    const huaItems = document.getElementById('huaItems');
                    if (huaItems) {
                        huaItems.innerHTML = '';
                        if (roundResult.scoreResult.huaDetail) {
                            roundResult.scoreResult.huaDetail.forEach(item => {
                                huaItems.innerHTML += `<div class="fan-item"><span class="fan-name">${item.name}</span><span class="fan-value">+${item.hua}Ëä±</span></div>`;
                            });
                        }
                    }
                    const totalHuaDisplayEl = document.getElementById('totalHuaDisplay');
                    if (totalHuaDisplayEl) totalHuaDisplayEl.textContent = roundResult.scoreResult.totalHua + 'Ëä±';
                }
            }
            
            const roundResultTitleEl = document.getElementById('roundResultTitle');
            if (roundResultTitleEl) roundResultTitleEl.textContent = title;
            
            // ÊòæÁ§∫ÁßØÂàÜÂèòÂåñÔºàË°®Ê†ºÊ†∑ÂºèÔºåÊó†Ë°®Ê†ºÁ∫øÔºâ
            const scoreChangeItems = document.getElementById('scoreChangeItems');
            
            // ÊåâÊú¨Â±ÄÂæóÂàÜÊéíÂ∫è
            const sortedPlayers = [...roundResult.players].sort((a, b) => b.roundScore - a.roundScore);
            
            let tableHtml = '<table style="width: 100%; border-collapse: collapse;">';
            tableHtml += '<thead><tr style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">';
            tableHtml += '<th style="padding: 8px 5px; text-align: left;">ÊéíÂêç</th>';
            tableHtml += '<th style="padding: 8px 5px; text-align: left;">Áé©ÂÆ∂</th>';
            tableHtml += '<th style="padding: 8px 5px; text-align: right;">Êú¨Â±Ä</th>';
            tableHtml += '<th style="padding: 8px 5px; text-align: right;">Á¥ØËÆ°</th>';
            tableHtml += '</tr></thead><tbody>';
            
            sortedPlayers.forEach((p, idx) => {
                const change = p.roundScore;
                const changeColor = change > 0 ? '#2ecc71' : change < 0 ? '#e74c3c' : '#fff';
                const changeText = change >= 0 ? `+${change}` : change;
                const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : '4Ô∏è‚É£';
                const totalColor = p.totalScore > 0 ? '#2ecc71' : p.totalScore < 0 ? '#e74c3c' : '#fff';
                const totalText = p.totalScore >= 0 ? `+${p.totalScore}` : p.totalScore;
                const rowBg = idx === 0 && change > 0 ? 'rgba(46,204,113,0.15)' : 'transparent';
                
                tableHtml += `<tr style="background: ${rowBg};">`;
                tableHtml += `<td style="padding: 8px 5px;">${medal}</td>`;
                tableHtml += `<td style="padding: 8px 5px;">${p.username}${p.isBot ? ' (AI)' : ''}</td>`;
                tableHtml += `<td style="padding: 8px 5px; text-align: right; color: ${changeColor}; font-weight: bold;">${changeText}</td>`;
                tableHtml += `<td style="padding: 8px 5px; text-align: right; color: ${totalColor};">${totalText}</td>`;
                tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody></table>';
            if (scoreChangeItems) scoreChangeItems.innerHTML = tableHtml;
            
            // ÊòæÁ§∫Â±ÄÊï∞
            const roundEndCurrentEl = document.getElementById('roundEndCurrent');
            if (roundEndCurrentEl) roundEndCurrentEl.textContent = currentRound;
            const roundEndTotalEl = document.getElementById('roundEndTotal');
            if (roundEndTotalEl) roundEndTotalEl.textContent = totalRounds;
            
            // Â¶ÇÊûúÊòØÊúÄÂêé‰∏ÄÂ±ÄÔºåÈöêËóèÁªßÁª≠ÊåâÈíÆÂíåÂÄíËÆ°Êó∂Âå∫Âüü
            const continueBtn = document.getElementById('continueNextBtn');
            const countdownArea = document.getElementById('nextRoundCountdown');
            if (continueBtn && countdownArea) {
                if (currentRound >= totalRounds) {
                    continueBtn.style.display = 'none';
                    countdownArea.style.display = 'none';
                } else {
                    continueBtn.style.display = 'block';
                    countdownArea.style.display = 'block';
                    
                    // ÂàùÂßãÂåñÂÄíËÆ°Êó∂ÊòæÁ§∫
                    const countdownSeconds = data.countdownSeconds || 30;
                    const countdownSecondsEl = document.getElementById('countdownSeconds');
                    if (countdownSecondsEl) countdownSecondsEl.textContent = countdownSeconds;
                    
                    // ÂàùÂßãÂåñÁé©ÂÆ∂ÂáÜÂ§áÁä∂ÊÄÅÔºàÊòæÁ§∫4‰∏™Á≠âÂæÖ‰∏≠Ôºâ
                    updatePlayersReadyStatus([]);
                }
            }
            
            document.getElementById('roundResultModal').classList.add('active');
        }
        
        // Êõ¥Êñ∞Áé©ÂÆ∂ÂáÜÂ§áÁä∂ÊÄÅÊòæÁ§∫
        function updatePlayersReadyStatus(readyStatus) {
            const container = document.getElementById('playersReadyStatus');
            if (!container) return;
            
            // Â¶ÇÊûúÊ≤°ÊúâÁä∂ÊÄÅÊï∞ÊçÆÔºå‰ΩøÁî®Ê∏∏Êàè‰∏≠ÁöÑÁé©ÂÆ∂‰ø°ÊÅØ
            if (!readyStatus || readyStatus.length === 0) {
                if (gameState && gameState.players) {
                    readyStatus = gameState.players.map(p => ({
                        seatIndex: p.seatIndex,
                        username: p.username,
                        ready: p.isBot,
                        isBot: p.isBot,
                        aiTakeover: false
                    }));
                } else {
                    return;
                }
            }
            
            container.innerHTML = readyStatus.map(p => {
                let statusClass = '';
                let statusIcon = '‚è≥';
                let statusText = 'Á≠âÂæÖ‰∏≠';
                
                if (p.isBot) {
                    statusClass = 'ready';
                    statusIcon = 'ü§ñ';
                    statusText = 'AI';
                } else if (p.aiTakeover) {
                    statusClass = '';
                    statusIcon = 'ü§ñ';
                    statusText = 'AIÊé•ÁÆ°';
                } else if (p.ready) {
                    statusClass = 'ready';
                    statusIcon = '‚úì';
                    statusText = 'Â∑≤ÂáÜÂ§á';
                }
                
                const isMe = p.seatIndex === mySeatIndex ? ' (Êàë)' : '';
                
                return `
                    <div class="player-ready-item ${statusClass}">
                        ${statusIcon} ${p.username}${isMe}: ${statusText}
                    </div>
                `;
            }).join('');
        }
        
        // ÁªßÁª≠‰∏ã‰∏ÄÂ±Ä
        function continueNextRound() {
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            const btn = document.getElementById('continueNextBtn');
            btn.innerHTML = '<i class="fas fa-check"></i> Â∑≤ÂáÜÂ§áÔºåÁ≠âÂæÖÂÖ∂‰ªñÁé©ÂÆ∂...';
            btn.disabled = true;
            btn.style.opacity = '0.7';
            
            // ÂèëÈÄÅÂáÜÂ§áÁä∂ÊÄÅ
            isReady = true;
            socket.emit('toggle_ready', { ready: true });
            
            showToast('Â∑≤ÂáÜÂ§áÔºÅÁ≠âÂæÖÂÖ∂‰ªñÁé©ÂÆ∂...');
            console.log('Â∑≤ÂèëÈÄÅÂáÜÂ§áÁä∂ÊÄÅÔºåÁ≠âÂæÖ‰∏ã‰∏ÄÂ±Ä');
        }
        
        // Êé•ÁÆ°AIÔºàÊÅ¢Â§çÊéßÂà∂ÊùÉÔºâ
        function takeoverAI() {
            if (socket && isAITakeover) {
                socket.emit('takeover_ai');
                showToast('Ê≠£Âú®Êé•ÁÆ°...');
            }
        }
        
        // ÊòæÁ§∫Êé•ÁÆ°AIÊåâÈíÆ
        function showTakeoverButton() {
            const container = document.getElementById('takeoverContainer');
            if (container) {
                container.style.display = 'block';
            }
        }
        
        // ÈöêËóèÊé•ÁÆ°AIÊåâÈíÆ
        function hideTakeoverButton() {
            const container = document.getElementById('takeoverContainer');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        // ÊòæÁ§∫ÊúÄÁªàÁªìÁÆó
        function showMatchResult(data) {
            const { ranking, matchScores, totalRounds } = data;
            
            const matchTotalRoundsEl = document.getElementById('matchTotalRounds');
            if (matchTotalRoundsEl) matchTotalRoundsEl.textContent = totalRounds;
            
            const rankingList = document.getElementById('rankingList');
            if (rankingList) {
                rankingList.innerHTML = '';
                
                const positionEmojis = ['ü•á', 'ü•à', 'ü•â', '4'];
                const positionClasses = ['first', 'second', 'third', ''];
                
                ranking.forEach((player, idx) => {
                    const posClass = positionClasses[idx] || '';
                    const posEmoji = positionEmojis[idx] || (idx + 1);
                    const scoreClass = player.totalScore >= 0 ? 'positive' : 'negative';
                    const scoreText = player.totalScore >= 0 ? `+${player.totalScore}` : player.totalScore;
                    
                    rankingList.innerHTML += `
                        <div class="ranking-item ${posClass}">
                            <span class="ranking-position ${posClass}">${posEmoji}</span>
                            <span class="ranking-name">${player.username}${player.isBot ? ' (AI)' : ''}</span>
                            <span class="ranking-score ${scoreClass}">${scoreText}</span>
                        </div>
                    `;
                });
            }
            
            // ÂÖ≥Èó≠ÂçïÂ±ÄÁªìÁÆóÂºπÁ™óÔºàÂ¶ÇÊûúËøòÂºÄÁùÄÔºâ
            const roundResultModalEl = document.getElementById('roundResultModal');
            if (roundResultModalEl) roundResultModalEl.classList.remove('active');
            const matchResultModalEl = document.getElementById('matchResultModal');
            if (matchResultModalEl) matchResultModalEl.classList.add('active');
        }
        
        // ÂÖ≥Èó≠ÊúÄÁªàÁªìÁÆó
        function closeMatchResult() {
            const matchResultModalEl = document.getElementById('matchResultModal');
            if (matchResultModalEl) matchResultModalEl.classList.remove('active');
            const gameScreenEl = document.getElementById('gameScreen');
            if (gameScreenEl) gameScreenEl.classList.remove('active');
            const roomScreenEl = document.getElementById('roomScreen');
            if (roomScreenEl) roomScreenEl.classList.add('active');
            const chatAreaEl = document.getElementById('chatArea');
            if (chatAreaEl) chatAreaEl.style.display = 'none';
            document.body.classList.remove('in-game');
            isReady = false;
            const readyBtnEl = document.getElementById('readyBtn');
            if (readyBtnEl) readyBtnEl.innerHTML = '<i class="fas fa-check"></i> ÂáÜÂ§á';
            
            // Ê∏ÖÈô§ÊàøÈó¥‰ø°ÊÅØ
            sessionStorage.removeItem('mahjong_room_code');
            sessionStorage.removeItem('mahjong_username');
            
            // ÈáçÁΩÆÁßØÂàÜ
            matchScores = [0, 0, 0, 0];
            updateScorePanel(matchScores);
        }

        // ÊöÇÂÅúÁõ∏ÂÖ≥ÂèòÈáè
        let pauseTimerInterval = null;
        let pauseStartTime = null;

        // ÊòæÁ§∫ÊöÇÂÅúÂºπÁ™ó
        function showPauseModal(playerName, pauseTime) {
            pauseStartTime = pauseTime;
            
            const pausedPlayerNameEl = document.getElementById('pausedPlayerName');
            if (pausedPlayerNameEl) pausedPlayerNameEl.textContent = playerName;
            
            const pauseModalEl = document.getElementById('pauseModal');
            if (pauseModalEl) pauseModalEl.classList.add('active');
            
            // ÂêØÂä®ÊöÇÂÅúÊó∂ÈïøËÆ°Êó∂Âô®
            if (pauseTimerInterval) clearInterval(pauseTimerInterval);
            pauseTimerInterval = setInterval(() => {
                if (!pauseStartTime) return;
                const elapsed = Math.floor((Date.now() - pauseStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                const pauseTimerEl = document.getElementById('pauseTimer');
                if (pauseTimerEl) pauseTimerEl.textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        // ÈöêËóèÊöÇÂÅúÂºπÁ™ó
        function hidePauseModals() {
            const pauseModalEl = document.getElementById('pauseModal');
            if (pauseModalEl) pauseModalEl.classList.remove('active');
            
            const resumeCountdownModalEl = document.getElementById('resumeCountdownModal');
            if (resumeCountdownModalEl) resumeCountdownModalEl.classList.remove('active');
            
            if (pauseTimerInterval) {
                clearInterval(pauseTimerInterval);
                pauseTimerInterval = null;
            }
            pauseStartTime = null;
        }

        // ÊòæÁ§∫ÊÅ¢Â§çÂÄíËÆ°Êó∂ÂºπÁ™ó
        function showResumeCountdown(cancellerName, countdownSeconds) {
            // ÂÖàÈöêËóèÊöÇÂÅúÂºπÁ™óÔºåÊòæÁ§∫ÂÄíËÆ°Êó∂ÂºπÁ™ó
            hidePauseModals();
            
            const resumeCancellerNameEl = document.getElementById('resumeCancellerName');
            if (resumeCancellerNameEl) resumeCancellerNameEl.textContent = cancellerName;
            
            const resumeCountdownEl = document.getElementById('resumeCountdown');
            if (resumeCountdownEl) resumeCountdownEl.textContent = countdownSeconds;
            
            const resumeCountdownModalEl = document.getElementById('resumeCountdownModal');
            if (resumeCountdownModalEl) resumeCountdownModalEl.classList.add('active');
        }

        // ÂèñÊ∂àÊöÇÂÅú
        function cancelPause() {
            socket.emit('cancel_pause');
            hidePauseModals();
        }

        // ÂèëËµ∑Ëß£Êï£Ê∏∏Êàè
        function requestDissolve() {
            socket.emit('request_dissolve');
            hidePauseModals();
        }

        // ÊòæÁ§∫Ëß£Êï£ÊäïÁ•®ÂºπÁ™ó
        function showDissolveModal(requesterName) {
            const dissolveRequesterNameEl = document.getElementById('dissolveRequesterName');
            if (dissolveRequesterNameEl) dissolveRequesterNameEl.textContent = requesterName;
            
            const dissolveVotesInfoEl = document.getElementById('dissolveVotesInfo');
            if (dissolveVotesInfoEl) dissolveVotesInfoEl.textContent = 'Á≠âÂæÖÊäïÁ•®...';
            
            const dissolveModalEl = document.getElementById('dissolveModal');
            if (dissolveModalEl) dissolveModalEl.classList.add('active');
        }

        // ÈöêËóèËß£Êï£ÊäïÁ•®ÂºπÁ™ó
        function hideDissolveModal() {
            const dissolveModalEl = document.getElementById('dissolveModal');
            if (dissolveModalEl) dissolveModalEl.classList.remove('active');
        }

        // Êõ¥Êñ∞Ëß£Êï£ÊäïÁ•®‰ø°ÊÅØ
        function updateDissolveVotes(votes, totalPlayers) {
            const dissolveVotesInfoEl = document.getElementById('dissolveVotesInfo');
            if (dissolveVotesInfoEl) {
                dissolveVotesInfoEl.textContent = `Â∑≤Êúâ ${votes}/${totalPlayers} ‰∫∫ÂêåÊÑè`;
            }
        }

        // ÊäïÁ•®Ëß£Êï£Ê∏∏Êàè
        function voteDissolve(agree) {
            socket.emit('vote_dissolve', { agree: agree });
            // ÊòæÁ§∫ÊäïÁ•®ÁªìÊûúÔºåÁ≠âÂæÖÂÖ∂‰ªñÁé©ÂÆ∂
            const dissolveButtonsEl = document.getElementById('dissolveButtons');
            if (dissolveButtonsEl) {
                dissolveButtonsEl.innerHTML = '<p style="color: #aaa;">ÊÇ®Â∑≤ÊäïÁ•®ÔºåÁ≠âÂæÖÂÖ∂‰ªñÁé©ÂÆ∂...</p>';
            }
        }

        // ÊòæÁ§∫Ëß£Êï£ÁªìÊûúÂºπÁ™ó
        function showDissolveResultModal(data) {
            const dissolveResultInfoEl = document.getElementById('dissolveResultInfo');
            if (dissolveResultInfoEl) {
                let info = `Êú¨Â±ÄÊØîËµõÂÖ±ËøõË°å‰∫Ü <strong>${data.currentRound || 0}</strong> Â±Ä<br>`;
                info += `ÂΩìÂâçÁßØÂàÜ: `;
                
                if (data.matchScores && data.roundHistory) {
                    const playerNames = [];
                    for (let i = 0; i < 4; i++) {
                        const player = data.roundHistory.length > 0 ? 
                            data.roundHistory[data.roundHistory.length - 1].players.find(p => p.seatIndex === i) : null;
                        playerNames.push(player ? player.username : `Áé©ÂÆ∂${i + 1}`);
                    }
                    
                    info += '<br>';
                    for (let i = 0; i < 4; i++) {
                        info += `${playerNames[i]}: ${data.matchScores[i]} ÂàÜ<br>`;
                    }
                }
                
                dissolveResultInfoEl.innerHTML = info;
            }
            
            const dissolveResultModalEl = document.getElementById('dissolveResultModal');
            if (dissolveResultModalEl) dissolveResultModalEl.classList.add('active');
        }

        // ËøîÂõû‰∏ªÈ°µ
        function returnToHome() {
            // Ê∏ÖÈô§ÊâÄÊúâËÆ°Êó∂Âô®
            stopDiscardCountdown('returnToHome');
            hidePauseModals();
            
            // Ê∏ÖÈô§‰∏ã‰∏ÄÂ±ÄÂÄíËÆ°Êó∂
            const nextRoundCountdownEl = document.getElementById('nextRoundCountdown');
            if (nextRoundCountdownEl) {
                nextRoundCountdownEl.style.display = 'none';
                nextRoundCountdownEl.innerHTML = '';
            }
            
            const dissolveResultModalEl = document.getElementById('dissolveResultModal');
            if (dissolveResultModalEl) dissolveResultModalEl.classList.remove('active');
            
            const gameScreenEl = document.getElementById('gameScreen');
            if (gameScreenEl) gameScreenEl.classList.remove('active');
            
            const roomScreenEl = document.getElementById('roomScreen');
            if (roomScreenEl) roomScreenEl.classList.remove('active');
            
            const lobbyScreenEl = document.getElementById('lobbyScreen');
            if (lobbyScreenEl) lobbyScreenEl.classList.add('active');
            
            const chatAreaEl = document.getElementById('chatArea');
            if (chatAreaEl) chatAreaEl.style.display = 'none';
            
            document.body.classList.remove('in-game');
            currentRoom = null;
            gameState = null;
            gameRunning = false;
        }

        // ÊöÇÂÅúÊ∏∏Êàè
        function pauseGame() {
            if (!gameRunning) {
                showModal('ÊèêÁ§∫', 'Ê∏∏ÊàèÊú™ÂºÄÂßãÔºåÊó†Ê≥ïÊöÇÂÅú');
                return;
            }
            socket.emit('pause_game');
        }

        // ÊòæÁ§∫ËÆ°ÂàÜÊùø
        function showScoreboard() {
            if (!gameRunning) {
                showModal('ÊèêÁ§∫', 'Ê∏∏ÊàèÊú™ÂºÄÂßã');
                return;
            }
            updateScoreboardDisplay();
            const modal = document.getElementById('scoreboardModal');
            modal.classList.add('active');
            
            setTimeout(() => {
                const closeHandler = (e) => {
                    if (e.target === modal) {
                        closeScoreboard();
                        modal.removeEventListener('click', closeHandler);
                    }
                };
                modal.addEventListener('click', closeHandler);
            }, 100);
        }

        // ÂÖ≥Èó≠ËÆ°ÂàÜÊùø
        function closeScoreboard() {
            document.getElementById('scoreboardModal').classList.remove('active');
        }

        // Êõ¥Êñ∞ËÆ°ÂàÜÊùøÊòæÁ§∫
        function updateScoreboardDisplay() {
            const listEl = document.getElementById('scoreboardList');
            if (!listEl || !gameState || !gameState.players) return;

            const playerScores = gameState.players.map((player, index) => {
                return {
                    name: player.username || player.name || `Áé©ÂÆ∂${index + 1}`,
                    score: matchScores[index] || 0,
                    seatIndex: player.seatIndex
                };
            });

            playerScores.sort((a, b) => b.score - a.score);

            listEl.innerHTML = playerScores.map((player, rank) => {
                const displayRank = rank + 1;
                const isMe = player.seatIndex === mySeatIndex;
                const rankClass = displayRank <= 3 ? `rank-${displayRank}` : 'rank-other';
                const scoreClass = player.score > 0 ? 'positive' : (player.score < 0 ? 'negative' : 'zero');
                const scoreDisplay = player.score >= 0 ? `+${player.score}` : player.score;
                
                return `<div class="scoreboard-item ${isMe ? 'is-me' : ''}">
                    <div class="scoreboard-rank ${rankClass}">${displayRank}</div>
                    <div class="scoreboard-info">
                        <div class="scoreboard-name">
                            ${player.name}
                            ${isMe ? '<span class="me-badge">‰Ω†</span>' : ''}
                        </div>
                    </div>
                    <div class="scoreboard-score ${scoreClass}">${scoreDisplay}</div>
                </div>`;
            }).join('');

            const roundEl = document.getElementById('scoreboardRound');
            if (roundEl) {
                roundEl.textContent = `Á¨¨ ${currentRound || 1} / ${totalRounds || 10} Â±Ä`;
            }
        }

        // Á¶ªÂºÄÊ∏∏Êàè
        function leaveGame() {
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫Ê∏∏ÊàèÂêóÔºü')) {
                socket.emit('leave_room');
                document.getElementById('gameScreen').classList.remove('active');
                document.getElementById('lobbyScreen').classList.add('active');
                document.getElementById('chatArea').style.display = 'none';
                document.body.classList.remove('in-game');
                currentRoom = null;
            }
        }

        // ËÅäÂ§©Èù¢ÊùøÁä∂ÊÄÅ
        let chatPanelOpen = false;
        let unreadMessages = 0;
        
        // ÂàáÊç¢ËÅäÂ§©Èù¢Êùø
        function toggleChatPanel() {
            chatPanelOpen = !chatPanelOpen;
            const panel = document.getElementById('chatPanel');
            
            if (chatPanelOpen) {
                panel.classList.add('active');
                unreadMessages = 0;
                updateChatBadge();
                document.getElementById('chatInput').focus();
            } else {
                panel.classList.remove('active');
            }
        }
        
        // Êõ¥Êñ∞Êú™ËØªÊ∂àÊÅØÂæΩÁ´†
        function updateChatBadge() {
            const badge = document.getElementById('chatBadge');
            if (unreadMessages > 0) {
                badge.textContent = unreadMessages > 99 ? '99+' : unreadMessages;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // ÂèëÈÄÅËÅäÂ§©
        function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                socket.emit('chat_message', { message });
                input.value = '';
            }
        }

        // Ê∑ªÂä†ËÅäÂ§©Ê∂àÊÅØ
        function addChatMessage(name, message) {
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'chat-message';
            msg.innerHTML = `<span class="name">${name}:</span> ${message}`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
            
            // Â¶ÇÊûúËÅäÂ§©Èù¢ÊùøÊú™ÊâìÂºÄÔºåÂ¢ûÂä†Êú™ËØªÊ∂àÊÅØÊï∞
            if (!chatPanelOpen) {
                unreadMessages++;
                updateChatBadge();
            }
            
            // ÂêåÊó∂ÊòæÁ§∫Ê∂àÊÅØ Toast
            showToast(`üí¨ ${name}: ${message}`, 3000);
            container.scrollTop = container.scrollHeight;
        }

        // ToastÊèêÁ§∫
        function showToast(message, duration = 2000) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), duration);
        }

        // ÂõûËΩ¶ÂèëÈÄÅËÅäÂ§©
        document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        // ==================== Á≤æÁÅµÂõæÈ¢ÑÂä†ËΩΩ ====================
        
        let spriteLoaded = false;
        
        // È¢ÑÂä†ËΩΩÈ∫ªÂ∞ÜÁâåÁ≤æÁÅµÂõæ
        function preloadSprites() {
            const img = new Image();
            img.onload = function() {
                spriteLoaded = true;
                document.body.classList.add('sprites-loaded');
                console.log('È∫ªÂ∞ÜÁâåÁ≤æÁÅµÂõæÂä†ËΩΩÂÆåÊàê');
                
                // Â∫îÁî®Ê†∑ÂºèÂà∞ÊâÄÊúâÂä†ËΩΩ‰∏≠ÁöÑÁâå
                document.querySelectorAll('.tile.loading').forEach(tile => {
                    tile.classList.remove('loading');
                    if (tile.dataset.spriteStyle) {
                        tile.style.cssText = tile.dataset.spriteStyle;
                    }
                });
                
                // Â¶ÇÊûúÊ∏∏ÊàèÂ∑≤ÂºÄÂßãÔºåÂà∑Êñ∞ÊòæÁ§∫
                if (gameState) {
                    scheduleUpdate(() => _doUpdateGameUI());
                }
            };
            img.onerror = function() {
                console.warn('Á≤æÁÅµÂõæÂä†ËΩΩÂ§±Ë¥•ÔºåÂ∞Ü‰ΩøÁî®ÊñáÂ≠óÊ®°Âºè');
                spriteLoaded = true;
                document.body.classList.add('sprites-loaded');
                // ËΩ¨Êç¢ÊâÄÊúâÁâå‰∏∫ÊñáÂ≠óÊ®°Âºè
                document.querySelectorAll('.tile.loading').forEach(tile => {
                    tile.classList.remove('loading');
                    tile.classList.add('text-mode');
                });
            };
            img.src = '/img/majiang.png';
            
            // ÂêåÊó∂È¢ÑÂä†ËΩΩÂà∞ CSS ÁºìÂ≠òÔºàÈ´ò‰ºòÂÖàÁ∫ßÔºâ
            const preloadLink = document.createElement('link');
            preloadLink.rel = 'preload';
            preloadLink.as = 'image';
            preloadLink.href = '/img/majiang.png';
            preloadLink.fetchPriority = 'high';
            document.head.appendChild(preloadLink);
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂Á´ãÂç≥È¢ÑÂä†ËΩΩÁ≤æÁÅµÂõæ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', preloadSprites);
        } else {
            preloadSprites();
        }
        
        // ==================== UI/UX ÊîπËøõ - Âä®ÁîªÊïàÊûúÁ≥ªÁªü ====================
        
        // ÂàõÂª∫ËÉåÊôØÁ≤íÂ≠êÊïàÊûú
        function initParticles() {
            const container = document.getElementById('particlesContainer');
            if (!container) return;
            
            const particleCount = window.innerWidth < 768 ? 15 : 30;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDuration = (15 + Math.random() * 20) + 's';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.opacity = 0.1 + Math.random() * 0.3;
                particle.style.width = (3 + Math.random() * 4) + 'px';
                particle.style.height = particle.style.width;
                container.appendChild(particle);
            }
        }
        
        // ÊòæÁ§∫Âä®‰ΩúÁâπÊïàÔºàÁ¢∞/Êù†/ËÉ°Ôºâ
        function showActionEffect(action, playerName = '') {
            const effectTexts = {
                'peng': 'Á¢∞ÔºÅ',
                'gang': 'Êù†ÔºÅ',
                'jia_gang': 'Âä†Êù†ÔºÅ',
                'hu': 'ËÉ°ÔºÅ',
                'zimo': 'Ëá™Êë∏ÔºÅ',
                'hu_zimo': 'Ëá™Êë∏ÔºÅ',
                'chi': 'ÂêÉÔºÅ'
            };
            
            const text = effectTexts[action];
            if (!text) return;
            
            const effect = document.createElement('div');
            effect.className = 'action-effect';
            effect.innerHTML = `<div class="action-effect-text ${action}">${text}</div>`;
            document.body.appendChild(effect);
            
            // Êí≠ÊîæÁâπÊïàÂêéÁßªÈô§
            setTimeout(() => effect.remove(), 1500);
            
            // Â¶ÇÊûúÊòØËÉ°ÁâåÔºåÊòæÁ§∫ÁÉüËä±
            if (action === 'hu' || action === 'zimo' || action === 'hu_zimo') {
                showFireworks();
            }
        }
        
        // ÁÉüËä±ÊïàÊûú
        function showFireworks() {
            const container = document.getElementById('fireworksContainer');
            if (!container) return;
            
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
            const fireworkCount = window.innerWidth < 768 ? 5 : 10;
            
            for (let i = 0; i < fireworkCount; i++) {
                setTimeout(() => {
                    createFirework(container, colors);
                }, i * 200);
            }
        }
        
        function createFirework(container, colors) {
            const x = 20 + Math.random() * 60; // 20% ~ 80% Â±èÂπïÂÆΩÂ∫¶
            const y = 20 + Math.random() * 40; // 20% ~ 60% Â±èÂπïÈ´òÂ∫¶
            const color = colors[Math.floor(Math.random() * colors.length)];
            const particleCount = 12;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'firework-particle';
                particle.style.left = x + '%';
                particle.style.top = y + '%';
                particle.style.background = color;
                particle.style.boxShadow = `0 0 6px ${color}`;
                
                // ËÆ°ÁÆóÁ≤íÂ≠êÈ£ûË°åÊñπÂêë
                const angle = (i / particleCount) * 2 * Math.PI;
                const distance = 50 + Math.random() * 100;
                const endX = Math.cos(angle) * distance;
                const endY = Math.sin(angle) * distance;
                particle.style.setProperty('--particle-end', `translate(${endX}px, ${endY}px)`);
                
                container.appendChild(particle);
                
                // Âä®ÁîªÁªìÊùüÂêéÁßªÈô§
                setTimeout(() => particle.remove(), 1200);
            }
        }
        
        // ÊòæÁ§∫/ÈöêËóèËΩÆÂà∞Ëá™Â∑±ÁöÑÊèêÁ§∫
        function showTurnIndicator(show = true) {
            const indicator = document.getElementById('turnIndicator');
            const localIndicator = document.getElementById('turnIndicatorLocal');

            if (show) {
                if (indicator) indicator.classList.add('active');
                if (localIndicator) localIndicator.style.display = 'inline';
                // 3ÁßíÂêéËá™Âä®ÈöêËóè
                setTimeout(() => {
                    if (indicator) indicator.classList.remove('active');
                    if (localIndicator) localIndicator.style.display = 'none';
                }, 3000);
            } else {
                if (indicator) indicator.classList.remove('active');
                if (localIndicator) localIndicator.style.display = 'none';
            }
        }
        
        // Êõ¥Êñ∞ÊâãÁâåÂå∫ÂüüÁöÑËΩÆÂà∞Ëá™Â∑±ÊïàÊûú
        function updateMyTurnEffect(isMyTurn) {
            const handArea = document.querySelector('.my-hand-area');
            if (!handArea) return;
            
            if (isMyTurn && gameState?.turnPhase === 'discard') {
                handArea.classList.add('my-turn');
            } else {
                handArea.classList.remove('my-turn');
            }
        }
        
        // Âá∫ÁâåÈ£ûË°åÂä®Áîª
        function playDiscardAnimation(tileElement, callback) {
            if (!tileElement || document.body.classList.contains('reduce-motion')) {
                if (callback) callback();
                return;
            }
            
            tileElement.classList.add('discarding');
            
            setTimeout(() => {
                if (callback) callback();
            }, 400);
        }
        
        // Êë∏ÁâåÂä®Áîª
        function playDrawAnimation(tileElement) {
            if (!tileElement || document.body.classList.contains('reduce-motion')) return;
            
            tileElement.classList.add('drawing');
            
            setTimeout(() => {
                tileElement.classList.remove('drawing');
            }, 400);
        }
        
        // ÁâåÈù¢ÁÇπÂáªÊ≥¢Á∫πÊïàÊûú
        function createTileRipple(event, tileElement) {
            if (document.body.classList.contains('reduce-motion')) return;
            
            const rect = tileElement.getBoundingClientRect();
            const ripple = document.createElement('div');
            ripple.className = 'tile-ripple';
            ripple.style.left = (event.clientX - rect.left) + 'px';
            ripple.style.top = (event.clientY - rect.top) + 'px';
            ripple.style.width = '20px';
            ripple.style.height = '20px';
            
            tileElement.style.position = 'relative';
            tileElement.style.overflow = 'hidden';
            tileElement.appendChild(ripple);
            
            setTimeout(() => ripple.remove(), 600);
        }
        
        // Âø´Êç∑Ë°®ÊÉÖÈù¢Êùø
        let emojiPanelOpen = false;
        
        function toggleEmojiPanel() {
            emojiPanelOpen = !emojiPanelOpen;
            const panel = document.getElementById('emojiPanel');
            
            if (emojiPanelOpen) {
                panel.classList.add('active');
            } else {
                panel.classList.remove('active');
            }
        }
        
        // ÂèëÈÄÅË°®ÊÉÖ
        function sendEmoji(emoji) {
            socket.emit('chat_message', { message: emoji, isEmoji: true });
            toggleEmojiPanel();
            
            // Âú®Ëá™Â∑±Â§¥ÂÉè‰ΩçÁΩÆÊòæÁ§∫Ë°®ÊÉÖÊ∞îÊ≥°
            showEmojiBubble(emoji, mySeatIndex);
        }
        
        // ÂèëÈÄÅÂø´Êç∑ËØ≠Âè•
        function sendPhrase(phrase) {
            socket.emit('chat_message', { message: phrase });
            toggleEmojiPanel();
        }
        
        // ÊòæÁ§∫Ë°®ÊÉÖÊ∞îÊ≥°
        function showEmojiBubble(emoji, seatIndex) {
            // Ëé∑ÂèñÂØπÂ∫îÂ∫ß‰ΩçÁöÑ‰ΩçÁΩÆ
            const displaySeat = typeof seatIndex === 'number' ? getDisplaySeat(seatIndex) : seatIndex;
            const seatEl = document.querySelector(`.seat-${displaySeat} .seat-avatar`) ||
                          document.querySelector(`#seat-${displaySeat} .seat-avatar`);
            
            if (!seatEl) return;
            
            const rect = seatEl.getBoundingClientRect();
            const bubble = document.createElement('div');
            bubble.className = 'emoji-bubble';
            bubble.textContent = emoji;
            bubble.style.left = rect.left + rect.width / 2 + 'px';
            bubble.style.top = rect.top + 'px';
            
            document.body.appendChild(bubble);
            
            setTimeout(() => bubble.remove(), 2000);
        }
        
        // Ë¶ÜÁõñÂéüÊúâÁöÑ showToast ÂáΩÊï∞ÔºåÊ∑ªÂä†Âä®ÁîªÊïàÊûú
        const originalShowToast = showToast;
        showToast = function(message, duration = 2000) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.style.animation = 'none';
            toast.style.opacity = '0';
            toast.style.transform = 'translate(-50%, 10px)';
            
            document.body.appendChild(toast);
            
            // Âº∫Âà∂ÈáçÁªòÂêéÊ∑ªÂä†Âä®Áîª
            requestAnimationFrame(() => {
                toast.style.transition = 'all 0.3s ease-out';
                toast.style.opacity = '1';
                toast.style.transform = 'translate(-50%, 0)';
            });
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, -10px)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        };
        
        // Âê¨ÁâåÊï≤ÁâåÁ°ÆËÆ§ÂºπÁ™ó
        function showQiaoModal(message, tingTiles) {
            pendingQiao = true;
            isTing = true;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'qiaoModal';
            
            const tingTilesHtml = tingTiles && tingTiles.length > 0 
                ? `<p style="color: rgba(255,255,255,0.8); margin: 10px 0;">Âê¨Ôºö${tingTiles.map(t => t.tileName).join('„ÄÅ')}</p>`
                : '';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <h2 class="modal-title" style="color: #f1c40f;">üéØ Âê¨ÁâåÊèêÁ§∫</h2>
                    <p class="modal-message" style="font-size: 1.2rem; color: #fff;">${message}</p>
                    ${tingTilesHtml}
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                        <button class="btn" onclick="confirmQiao()" style="background: linear-gradient(135deg, #e74c3c, #c0392b); flex: 1; min-width: 120px;">
                            <i class="fas fa-check"></i> Êï≤Áâå
                        </button>
                        <button class="btn secondary" onclick="cancelQiao()" style="flex: 1; min-width: 120px;">
                            ‰∏çÊï≤
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    cancelQiao();
                }
            });
        }
        
        // Á°ÆËÆ§Êï≤Áâå
        function confirmQiao() {
            const modal = document.getElementById('qiaoModal');
            if (modal) modal.remove();

            playActionAudio('ting', myVoice); // Êí≠ÊîæÊï≤ÁâåÈü≥Êïà
            socket.emit('confirm_qiao', {});
            isQiao = true;
            pendingQiao = false;
            showToast('üîî Â∑≤Êï≤ÁâåÔºÅÂè™ËÉΩÊâìÂàöÊë∏ÁöÑÁâå', 3000);
        }
        
        // ÂèñÊ∂àÊï≤Áâå
        function cancelQiao() {
            const modal = document.getElementById('qiaoModal');
            if (modal) modal.remove();
            
            socket.emit('cancel_qiao', {});
            isTing = false;
            isQiao = false;
            pendingQiao = false;
        }
        
        // Â¢ûÂº∫Ê∏∏ÊàèÁä∂ÊÄÅÊõ¥Êñ∞ÔºåÊ∑ªÂä†Âä®ÁîªÊïàÊûú
        const originalUpdateGameUI = scheduleUpdate;
        
        // Ê≥®Ôºöaction_executed Âíå emoji_received ‰∫ã‰ª∂ÁõëÂê¨Â∑≤Âú® connectServer() ‰∏≠Ê≥®ÂÜå
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñÁ≤íÂ≠êÊïàÊûú
        document.addEventListener('DOMContentLoaded', () => {
            initParticles();
            
            // ‰∏∫ÊâãÁâåÊ∑ªÂä†ÁÇπÂáªÊ≥¢Á∫πÊïàÊûú
            document.addEventListener('click', (e) => {
                const tile = e.target.closest('.tile');
                if (tile && !tile.classList.contains('back')) {
                    createTileRipple(e, tile);
                }
            });
        });
        
        // Ë¶ÜÁõñÊõ¥Êñ∞Ê∏∏ÊàèUIÔºåÊ∑ªÂä†ËΩÆÂà∞Ëá™Â∑±ÁöÑÊïàÊûú
        const _originalDoUpdateGameUI = typeof _doUpdateGameUI !== 'undefined' ? _doUpdateGameUI : null;
        if (_originalDoUpdateGameUI) {
            const wrappedUpdateGameUI = _originalDoUpdateGameUI;
            _doUpdateGameUI = function() {
                wrappedUpdateGameUI.apply(this, arguments);
                
                // Ê£ÄÊü•ÊòØÂê¶ËΩÆÂà∞Ëá™Â∑±
                if (gameState) {
                    const isMyTurn = gameState.currentPlayerIndex === mySeatIndex;
                    const isDiscardPhase = gameState.turnPhase === 'discard';
                    updateMyTurnEffect(isMyTurn && isDiscardPhase);
                }
            };
        }
        
        // ÂàùÂßãÂåñ
        connectServer();
        
        // ÊøÄÊ¥ªÂàùÂßãÂ±èÂπï
        document.getElementById('lobbyScreen').classList.add('active');
    </script>
</body>
</html>

# æ•´åˆç‰¹æ®Šç‰Œå‹æ£€æµ‹å’Œç•ªæ•°è®¡ç®—åŠŸèƒ½

## é¡¹ç›®æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•å°† Algorithm Aï¼ˆå•playeræ¨¡å¼ï¼‰ä¸­çš„ç‰¹æ®Šç‰Œå‹æ£€æµ‹å’Œç•ªæ•°è®¡ç®—åŠŸèƒ½æ•´åˆåˆ° Algorithm Bï¼ˆå¤šäººæ¨¡å¼ï¼‰ä¸­ã€‚

### ç›¸å…³æ–‡ä»¶

- **Algorithm A**: `mahjong/index.html` - åŒ…å«å®Œæ•´çš„ç‰¹æ®Šç‰Œå‹æ£€æµ‹å’Œç•ªæ•°è®¡ç®—åŠŸèƒ½
- **Algorithm B å®¢æˆ·ç«¯**: `index.html` - å¤šäººæ¸¸æˆå®¢æˆ·ç«¯ï¼Œéœ€è¦æ·»åŠ ç‰¹æ®Šç‰Œå‹æ£€æµ‹
- **Algorithm B æœåŠ¡å™¨ç«¯**: `server.js` - å¤šäººæ¸¸æˆæœåŠ¡å™¨ï¼Œéœ€è¦åŒæ­¥æ·»åŠ ç›¸å…³åŠŸèƒ½

## åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | Algorithm A | Algorithm B |
|------|-------------|-------------|
| åŸºæœ¬èƒ¡ç‰Œæ£€æµ‹ | âœ… | âœ… |
| ä¸ƒå¯¹å­æ£€æµ‹ | âœ… | âŒ |
| ç¢°ç¢°èƒ¡æ£€æµ‹ | âœ… | âŒ |
| æ¸…ä¸€è‰²æ£€æµ‹ | âœ… | âŒ |
| æ··ä¸€è‰²æ£€æµ‹ | âœ… | âŒ |
| ç•ªæ•°è®¡ç®— | âœ… | âŒ |
| èŠ±ç‰Œè®¡ç®— | âœ… | âŒ |
| è¯¦ç»†å¾—åˆ†æ˜¾ç¤º | âœ… | âŒ |

## ä¸€ã€å®¢æˆ·ç«¯ä¿®æ”¹ï¼ˆindex.htmlï¼‰

### æ­¥éª¤ 1: æ·»åŠ è¾…åŠ©å‡½æ•°

åœ¨ `canFormMelds` å‡½æ•°åæ·»åŠ ä»¥ä¸‹è¾…åŠ©å‡½æ•°ï¼š

```javascript
// ==================== ç‰¹æ®Šç‰Œå‹æ£€æµ‹ ====================
function isQiDui(hand) {
    const counts = {};
    hand.forEach(tile => {
        const key = `${tile.type}${tile.value}`;
        counts[key] = (counts[key] || 0) + 1;
    });
    
    const values = Object.values(counts);
    return values.length === 7 && values.every(v => v === 2);
}

function isPengPengHu(hand) {
    const counts = {};
    hand.forEach(tile => {
        const key = `${tile.type}${tile.value}`;
        counts[key] = (counts[key] || 0) + 1;
    });
    
    let pairCount = 0;
    let tripleCount = 0;
    
    for (const key in counts) {
        const count = counts[key];
        if (count === 2) pairCount++;
        else if (count === 3) tripleCount++;
        else if (count === 4) tripleCount++;
        else if (count === 1) return false;
    }
    
    return pairCount === 1 && tripleCount >= 4;
}

function isQingYiSe(hand) {
    const suits = new Set();
    let hasHonor = false;
    
    hand.forEach(tile => {
        if (['wan', 'tiao', 'tong'].includes(tile.type)) {
            suits.add(tile.type);
        } else if (['feng', 'zhong', 'fa', 'bai'].includes(tile.type)) {
            hasHonor = true;
        }
    });
    
    return suits.size === 1 && !hasHonor;
}

function isHunYiSe(hand) {
    const suits = new Set();
    let hasHonor = false;
    
    hand.forEach(tile => {
        if (['wan', 'tiao', 'tong'].includes(tile.type)) {
            suits.add(tile.type);
        } else if (['feng', 'zhong', 'fa', 'bai'].includes(tile.type)) {
            hasHonor = true;
        }
    });
    
    return suits.size === 1 && hasHonor;
}

// ==================== ç•ªæ•°è®¡ç®— ====================
function calculateFan(hand, isSelfDraw = true, melds = []) {
    let totalFan = 0;
    let fanList = [];
    const isMenQing = melds.length === 0; // é—¨æ¸…ï¼šæ²¡æœ‰ç¢°æ 
    
    // é—¨æ¸… +1ç•ª
    if (isMenQing) {
        totalFan += 1;
        fanList.push('é—¨æ¸…');
    }
    
    // è‡ªæ‘¸ +1ç•ª
    if (isSelfDraw) {
        totalFan += 1;
        fanList.push('è‡ªæ‘¸');
    }
    
    // ä¸ƒå¯¹å­ +2ç•ª
    if (isQiDui(hand)) {
        totalFan += 2;
        fanList.push('ä¸ƒå¯¹å­');
    }
    
    // ç¢°ç¢°èƒ¡ +2ç•ª
    if (isPengPengHu(hand)) {
        totalFan += 2;
        fanList.push('ç¢°ç¢°èƒ¡');
    }
    
    // æ¸…ä¸€è‰² +3ç•ª
    if (isQingYiSe(hand)) {
        totalFan += 3;
        fanList.push('æ¸…ä¸€è‰²');
        
        // æ¸…ç¢°ï¼ˆæ¸…ä¸€è‰²+ç¢°ç¢°èƒ¡ï¼‰é¢å¤–+1ç•ª
        if (isPengPengHu(hand)) {
            totalFan += 1;
            fanList.push('æ¸…ç¢°');
        }
    }
    // æ··ä¸€è‰² +2ç•ª
    else if (isHunYiSe(hand)) {
        totalFan += 2;
        fanList.push('æ··ä¸€è‰²');
    }
    
    // è‡³å°‘1ç•ª
    if (totalFan === 0) totalFan = 1;
    
    return { fan: totalFan, fanList: fanList };
}
```

### æ­¥éª¤ 2: ä¿®æ”¹ `canHuHand` å‡½æ•°

ä¿®æ”¹ç°æœ‰çš„ `canHuHand` å‡½æ•°ä»¥æ”¯æŒç‰¹æ®Šç‰Œå‹ï¼š

```javascript
// æ£€æµ‹æ˜¯å¦èƒ½èƒ¡ç‰Œï¼ˆ3N+2ç»“æ„ + ç‰¹æ®Šç‰Œå‹ï¼‰
function canHuHand(tiles, melds = []) {
    if (tiles.length === 0) return true;
    
    // æ£€æŸ¥ä¸ƒå¯¹å­
    if (tiles.length === 14 && isQiDui(tiles)) {
        return true;
    }
    
    // åŸºæœ¬èƒ¡ç‰Œæ£€æµ‹ï¼š3N+2ç»“æ„
    if (tiles.length === 2) {
        return tiles[0].type === tiles[1].type && tiles[0].value === tiles[1].value;
    }
    if (tiles.length < 3) return false;
    
    // æ’åº
    const sorted = [...tiles].sort((a, b) => {
        if (a.type !== b.type) return a.type.localeCompare(b.type);
        return a.value - b.value;
    });
    
    // å°è¯•ä½œä¸ºå°†ï¼ˆå¯¹å­ï¼‰
    for (let i = 0; i < sorted.length - 1; i++) {
        if (sorted[i].type === sorted[i+1].type && sorted[i].value === sorted[i+1].value) {
            const remaining = [...sorted];
            remaining.splice(i, 2);
            if (canFormMelds(remaining)) return true;
        }
    }
    return false;
}
```

### æ­¥éª¤ 3: ä¿®æ”¹æ¸¸æˆç»“æŸé€»è¾‘

æ‰¾åˆ°å¤„ç†èƒ¡ç‰Œçš„ä»£ç éƒ¨åˆ†ï¼ˆé€šå¸¸åœ¨ `handleGameEnd` æˆ–ç±»ä¼¼å‡½æ•°ä¸­ï¼‰ï¼Œæ·»åŠ ç•ªæ•°è®¡ç®—ï¼š

```javascript
// ç¤ºä¾‹ï¼šåœ¨æ”¶åˆ°èƒ¡ç‰Œæ¶ˆæ¯æ—¶
if (data.type === 'hu') {
    const winner = data.winner;
    const isSelfDraw = data.isSelfDraw;
    const hand = data.hand;
    const melds = data.melds;
    const flowers = data.flowers;
    
    // è®¡ç®—ç•ªæ•°
    const result = calculateFan(hand, isSelfDraw, melds);
    const flowerCount = flowers.length;
    const flowerBonus = flowerCount * 10; // å‡è®¾èŠ±ç‰Œæ¯å¼ 10åˆ†
    const baseScore = 10 * Math.pow(2, result.fan);
    const totalScore = isSelfDraw ? (baseScore + flowerBonus) * 3 : (baseScore + flowerBonus);
    
    let message = `ğŸ‰ ${winner.name} èƒ¡äº†ï¼\n\n`;
    message += `ã€ç•ªå‹ã€‘${result.fanList.join(' + ') || 'åŸºæœ¬èƒ¡'}\n`;
    message += `ã€ç•ªæ•°ã€‘${result.fan}ç•ª\n`;
    message += `ã€åº•åˆ†ã€‘${baseScore}åˆ†\n`;
    message += `ã€èŠ±ç‰Œã€‘${flowerCount}å¼  (+${flowerBonus}åˆ†)\n`;
    if (isSelfDraw) {
        message += `ã€è‡ªæ‘¸ã€‘ä¸‰å®¶å„ä»˜ Ã—3\n`;
    } else {
        message += `ã€ç‚¹ç‚®ã€‘ç‚¹ç‚®è€…æ”¯ä»˜\n`;
    }
    message += `â”â”â”â”â”â”â”â”â”â”\n`;
    message += `ã€æ€»å¾—åˆ†ã€‘${totalScore}åˆ†`;
    
    showMessage('ğŸŠ æ¸¸æˆç»“æŸ', message);
}
```

## äºŒã€æœåŠ¡å™¨ç«¯ä¿®æ”¹ï¼ˆserver.jsï¼‰

### æ­¥éª¤ 1: æ·»åŠ è¾…åŠ©å‡½æ•°

åœ¨ `Game` ç±»ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•ï¼š

```javascript
// ==================== ç‰¹æ®Šç‰Œå‹æ£€æµ‹ ====================
isQiDui(hand) {
    const counts = {};
    hand.forEach(tile => {
        const key = `${tile.type}${tile.value}`;
        counts[key] = (counts[key] || 0) + 1;
    });
    
    const values = Object.values(counts);
    return values.length === 7 && values.every(v => v === 2);
}

isPengPengHu(hand) {
    const counts = {};
    hand.forEach(tile => {
        const key = `${tile.type}${tile.value}`;
        counts[key] = (counts[key] || 0) + 1;
    });
    
    let pairCount = 0;
    let tripleCount = 0;
    
    for (const key in counts) {
        const count = counts[key];
        if (count === 2) pairCount++;
        else if (count === 3) tripleCount++;
        else if (count === 4) tripleCount++;
        else if (count === 1) return false;
    }
    
    return pairCount === 1 && tripleCount >= 4;
}

isQingYiSe(hand) {
    const suits = new Set();
    let hasHonor = false;
    
    hand.forEach(tile => {
        if (['wan', 'tiao', 'tong'].includes(tile.type)) {
            suits.add(tile.type);
        } else if (['feng', 'zhong', 'fa', 'bai'].includes(tile.type)) {
            hasHonor = true;
        }
    });
    
    return suits.size === 1 && !hasHonor;
}

isHunYiSe(hand) {
    const suits = new Set();
    let hasHonor = false;
    
    hand.forEach(tile => {
        if (['wan', 'tiao', 'tong'].includes(tile.type)) {
            suits.add(tile.type);
        } else if (['feng', 'zhong', 'fa', 'bai'].includes(tile.type)) {
            hasHonor = true;
        }
    });
    
    return suits.size === 1 && hasHonor;
}

// ==================== ç•ªæ•°è®¡ç®— ====================
calculateFan(hand, isSelfDraw = true, melds = []) {
    let totalFan = 0;
    let fanList = [];
    const isMenQing = melds.length === 0;
    
    // é—¨æ¸… +1ç•ª
    if (isMenQing) {
        totalFan += 1;
        fanList.push('é—¨æ¸…');
    }
    
    // è‡ªæ‘¸ +1ç•ª
    if (isSelfDraw) {
        totalFan += 1;
        fanList.push('è‡ªæ‘¸');
    }
    
    // ä¸ƒå¯¹å­ +2ç•ª
    if (this.isQiDui(hand)) {
        totalFan += 2;
        fanList.push('ä¸ƒå¯¹å­');
    }
    
    // ç¢°ç¢°èƒ¡ +2ç•ª
    if (this.isPengPengHu(hand)) {
        totalFan += 2;
        fanList.push('ç¢°ç¢°èƒ¡');
    }
    
    // æ¸…ä¸€è‰² +3ç•ª
    if (this.isQingYiSe(hand)) {
        totalFan += 3;
        fanList.push('æ¸…ä¸€è‰²');
        
        // æ¸…ç¢°ï¼ˆæ¸…ä¸€è‰²+ç¢°ç¢°èƒ¡ï¼‰é¢å¤–+1ç•ª
        if (this.isPengPengHu(hand)) {
            totalFan += 1;
            fanList.push('æ¸…ç¢°');
        }
    }
    // æ··ä¸€è‰² +2ç•ª
    else if (this.isHunYiSe(hand)) {
        totalFan += 2;
        fanList.push('æ··ä¸€è‰²');
    }
    
    // è‡³å°‘1ç•ª
    if (totalFan === 0) totalFan = 1;
    
    return { fan: totalFan, fanList: fanList };
}
```

### æ­¥éª¤ 2: ä¿®æ”¹ `canHu` æ–¹æ³•

ä¿®æ”¹ `canHu` æ–¹æ³•ä»¥æ”¯æŒç‰¹æ®Šç‰Œå‹ï¼š

```javascript
canHu(hand, melds) {
    // æ£€æŸ¥æ˜¯å¦æœ‰14å¼ ç‰Œï¼ˆæˆ–11/8/5å¼ +å‰¯éœ²ï¼‰
    const totalTiles = hand.length + melds.length * 3;
    if (totalTiles !== 14) return false;
    
    // æ£€æŸ¥ä¸ƒå¯¹å­
    if (hand.length === 14 && this.isQiDui(hand)) {
        return true;
    }
    
    // åŸºæœ¬èƒ¡ç‰Œæ£€æµ‹ï¼š3N+2ç»“æ„
    return this.checkWinningHand([...hand]);
}
```

### æ­¥éª¤ 3: ä¿®æ”¹èƒ¡ç‰Œå¤„ç†é€»è¾‘

åœ¨å¤„ç†èƒ¡ç‰Œçš„ä»£ç ä¸­æ·»åŠ ç•ªæ•°è®¡ç®—ï¼š

```javascript
// ç¤ºä¾‹ï¼šåœ¨å¤„ç†èƒ¡ç‰Œè¯·æ±‚æ—¶
if (action === 'hu') {
    const player = this.players[seatIndex];
    const hand = player.hand;
    const melds = player.melds;
    const isSelfDraw = data.isSelfDraw;
    
    if (this.canHu(hand, melds)) {
        // è®¡ç®—ç•ªæ•°
        const result = this.calculateFan(hand, isSelfDraw, melds);
        const flowers = player.flowers;
        
        // å¹¿æ’­èƒ¡ç‰Œæ¶ˆæ¯
        this.broadcast('hu', {
            winner: {
                name: player.name,
                seatIndex: seatIndex
            },
            isSelfDraw: isSelfDraw,
            hand: hand,
            melds: melds,
            flowers: flowers,
            fanResult: result
        });
        
        // ç»“æŸæ¸¸æˆæˆ–ç»§ç»­
        this.endGame(seatIndex);
    }
}
```

## ä¸‰ã€æ•°æ®ç»“æ„åŒæ­¥

### å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éœ€è¦åŒæ­¥çš„æ•°æ®ï¼š

```javascript
// èƒ¡ç‰Œæ¶ˆæ¯ç»“æ„
{
    type: 'hu',
    winner: {
        name: 'ç©å®¶åç§°',
        seatIndex: 0
    },
    isSelfDraw: true, // æ˜¯å¦è‡ªæ‘¸
    hand: [...], // æ‰‹ç‰Œ
    melds: [...], // å‰¯éœ²
    flowers: [...], // èŠ±ç‰Œ
    fanResult: {
        fan: 3, // ç•ªæ•°
        fanList: ['é—¨æ¸…', 'è‡ªæ‘¸', 'æ¸…ä¸€è‰²'] // ç•ªå‹åˆ—è¡¨
    }
}
```

## å››ã€æµ‹è¯•å’ŒéªŒè¯

### æµ‹è¯•æ­¥éª¤ï¼š

1. **å¯åŠ¨æœåŠ¡å™¨**ï¼š`node server.js`
2. **æ‰“å¼€å¤šä¸ªæµè§ˆå™¨çª—å£**ï¼šè®¿é—® `http://localhost:3000`
3. **æµ‹è¯•ä¸åŒç‰Œå‹**ï¼š
   - ä¸ƒå¯¹å­ï¼š7å¯¹ç›¸åŒçš„ç‰Œ
   - ç¢°ç¢°èƒ¡ï¼š4ä¸ªåˆ»å­+1å¯¹
   - æ¸…ä¸€è‰²ï¼šåŒä¸€èŠ±è‰²çš„ç‰Œ
   - æ··ä¸€è‰²ï¼šåŒä¸€èŠ±è‰²+å­—ç‰Œ
4. **éªŒè¯ç•ªæ•°è®¡ç®—**ï¼šç¡®ä¿ä¸åŒç‰Œå‹çš„ç•ªæ•°è®¡ç®—æ­£ç¡®
5. **éªŒè¯èŠ±ç‰Œè®¡ç®—**ï¼šç¡®ä¿èŠ±ç‰Œæ•°é‡æ­£ç¡®å½±å“å¾—åˆ†

### æµ‹è¯•ç”¨ä¾‹ï¼š

| ç‰Œå‹ | é¢„æœŸç•ªæ•° | éªŒè¯è¦ç‚¹ |
|------|----------|----------|
| åŸºæœ¬èƒ¡ | 1ç•ª | åŸºç¡€å¾—åˆ†è®¡ç®— |
| ä¸ƒå¯¹å­ | 2ç•ª | ç‰¹æ®Šç‰Œå‹æ£€æµ‹ |
| ç¢°ç¢°èƒ¡ | 2ç•ª | åˆ»å­ç»„åˆæ£€æµ‹ |
| æ¸…ä¸€è‰² | 3ç•ª | èŠ±è‰²æ£€æµ‹ |
| æ··ä¸€è‰² | 2ç•ª | èŠ±è‰²+å­—ç‰Œæ£€æµ‹ |
| æ¸…ç¢° | 4ç•ª | æ¸…ä¸€è‰²+ç¢°ç¢°èƒ¡ç»„åˆ |

## äº”ã€æ³¨æ„äº‹é¡¹

1. **æ•°æ®ç»“æ„ä¸€è‡´æ€§**ï¼šç¡®ä¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ä½¿ç”¨ç›¸åŒçš„ç‰Œå‹æ•°æ®ç»“æ„
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šç‰¹æ®Šç‰Œå‹æ£€æµ‹å¯èƒ½å¢åŠ è®¡ç®—å¼€é”€ï¼Œå»ºè®®åœ¨éœ€è¦æ—¶æ‰è¿›è¡Œè¯¦ç»†æ£€æµ‹
3. **ç½‘ç»œä¼ è¾“**ï¼šç•ªæ•°è®¡ç®—ç»“æœåº”åœ¨æœåŠ¡å™¨ç«¯è®¡ç®—åä¼ è¾“ï¼Œé¿å…å®¢æˆ·ç«¯ä½œå¼Š
4. **é”™è¯¯å¤„ç†**ï¼šæ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†ï¼Œç¡®ä¿æ¸¸æˆåœ¨å„ç§æƒ…å†µä¸‹éƒ½èƒ½æ­£å¸¸è¿è¡Œ
5. **å…¼å®¹æ€§**ï¼šä¿®æ”¹åçš„ä»£ç åº”ä¿æŒä¸åŸæœ‰åŠŸèƒ½çš„å…¼å®¹æ€§

## å…­ã€å¸¸è§é—®é¢˜

### Q: ä¸ƒå¯¹å­æ£€æµ‹å¤±è´¥
**A:** æ£€æŸ¥æ‰‹ç‰Œæ•°é‡æ˜¯å¦ä¸º14å¼ ï¼Œä¸”æ˜¯å¦æ°å¥½7å¯¹ä¸åŒçš„ç‰Œ

### Q: ç•ªæ•°è®¡ç®—ä¸æ­£ç¡®
**A:** æ£€æŸ¥ç‰¹æ®Šç‰Œå‹æ£€æµ‹å‡½æ•°çš„å®ç°ï¼Œç¡®ä¿é€»è¾‘ä¸ Algorithm A ä¸€è‡´

### Q: æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è®¡ç®—ç»“æœä¸ä¸€è‡´
**A:** ç¡®ä¿ä¸¤ç«¯ä½¿ç”¨ç›¸åŒçš„ç®—æ³•å’Œæ•°æ®ç»“æ„ï¼Œå»ºè®®åœ¨æœåŠ¡å™¨ç«¯ç»Ÿä¸€è®¡ç®—

### Q: æ¸¸æˆè¿è¡Œå˜æ…¢
**A:** ä¼˜åŒ–ç‰¹æ®Šç‰Œå‹æ£€æµ‹ç®—æ³•ï¼Œé¿å…é‡å¤è®¡ç®—ï¼Œå¯è€ƒè™‘ç¼“å­˜è®¡ç®—ç»“æœ

## ä¸ƒã€æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¿®æ”¹ï¼Œæ‚¨å·²ç»æˆåŠŸå°† Algorithm A ä¸­çš„ç‰¹æ®Šç‰Œå‹æ£€æµ‹å’Œç•ªæ•°è®¡ç®—åŠŸèƒ½æ•´åˆåˆ° Algorithm B ä¸­ã€‚ç°åœ¨å¤šäººæ¸¸æˆæ¨¡å¼å°†æ”¯æŒï¼š

- âœ… ä¸ƒå¯¹å­ã€ç¢°ç¢°èƒ¡ã€æ¸…ä¸€è‰²ã€æ··ä¸€è‰²ç­‰ç‰¹æ®Šç‰Œå‹
- âœ… è¯¦ç»†çš„ç•ªæ•°è®¡ç®—ç³»ç»Ÿ
- âœ… èŠ±ç‰Œå¾—åˆ†è®¡ç®—
- âœ… ç¾è§‚çš„å¾—åˆ†æ˜¾ç¤ºç•Œé¢
- âœ… æœåŠ¡å™¨ç«¯éªŒè¯ç¡®ä¿å…¬å¹³æ€§

è¿™äº›åŠŸèƒ½å°†å¤§å¤§æå‡å¤šäººéº»å°†æ¸¸æˆçš„è¶£å‘³æ€§å’Œå®Œæ•´æ€§ï¼Œä½¿æ¸¸æˆä½“éªŒæ›´åŠ æ¥è¿‘çœŸå®çš„ä¸Šæµ·éº»å°†è§„åˆ™ã€‚
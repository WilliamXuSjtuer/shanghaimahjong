# 上海敲麻游戏规则区别分析

## 概述

本分析对比了上海敲麻游戏的**单人模式**（人机对战）和**多人模式**（网络联机）在规则实现上的差异。

| 维度 | 单人模式 | 多人模式 |
|------|---------|----------|
| 对战方式 | 本地1人 vs 3个AI | 网络4人实时对战 |
| 规则特点 | 上海敲麻规则，中发白算花牌 | 标准麻将规则，花牌独立 |
| 技术架构 | 纯前端实现 | 前后端分离（WebSocket） |
| 计分系统 | 简化计分 | 完整番数和花数计算 |
| 特殊功能 | AI对战逻辑 | 房间系统、断线重连、AI接管 |

## 核心规则对比

### 1. 牌组生成规则

#### 单人模式（mahjong/index.html:1082-1117）

**核心函数：**
- `createDeck()` (1082-1117)：创建包含万、筒、条各4张，字牌（东南西北中发白）各4张，花牌各1张的牌组
- `isFlowerTile()` (1110-1117)：检查是否是花牌（包括中发白）
- `shuffle()` (1119-1125)：洗牌算法

**关键变量：**
- `SUITS = ['wan', 'tong', 'tiao']` (976)
- `HONORS = ['dong', 'nan', 'xi', 'bei', 'zhong', 'fa', 'bai']` (977)
- `FLOWERS = ['chun', 'xia', 'qiu', 'dong_hua', 'mei', 'lan', 'zhu', 'ju']` (978)

**规则特点：**
- 中发白被视为花牌，摸到自动补花
- 花牌共8张（春夏秋冬梅兰竹菊）
- 总牌数：36（万）+ 36（筒）+ 36（条）+ 28（字牌）+ 8（花牌）= 144张

#### 多人模式（server.js:90-114）

**核心函数：**
- `createDeck()` (90-105)：创建包含万、条、筒各4张，花牌各1张的牌组
- `isFlowerTile()` (108-110)：检查是否是花牌
- `shuffleDeck()` (118-124)：洗牌算法

**关键变量：**
- `TILE_TYPES = ['wan', 'tiao', 'tong']` (64)
- `TILE_VALUES = [1, 2, 3, 4, 5, 6, 7, 8, 9]` (65)
- `FLOWERS = ['chun', 'xia', 'qiu', 'dong_hua', 'mei', 'lan', 'zhu', 'ju']` (69)

**规则特点：**
- 花牌独立，中发白不作为花牌
- 花牌共8张（春夏秋冬梅兰竹菊）
- 总牌数：36（万）+ 36（条）+ 36（筒）+ 8（花牌）= 116张

### 2. 胡牌检测规则

#### 单人模式（mahjong/index.html:3092-3212）

**核心函数：**
- `canHu()` (3092-3117)：检查是否可以胡牌
- `isQiDui()` (3119-3128)：检查七对子
- `isBasicHu()` (3130-3151)：检查基本胡牌型（4组面子+1对将）
- `canFormMelds()` (3153-3212)：检查是否能组成面子

**规则特点：**
- 支持基本胡牌型（4+1）
- 支持七对子
- 支持十三幺检测
- 考虑副露的影响

#### 多人模式（server.js:1275-1343）

**核心函数：**
- `canHu()` (1276-1283)：检查是否可以胡牌
- `checkWinningHand()` (1285-1307)：检查胡牌手牌结构
- `canFormMelds()` (1309-1343)：检查是否能组成面子

**规则特点：**
- 标准3N+2结构检测
- 考虑副露的牌数
- 服务器端严格验证

### 3. 计分规则

#### 单人模式（mahjong/index.html:3214-3277）

**核心函数：**
- `calculateFan()` (3214-3277)：计算番数
- `isMenQing()`：门清检测
- `isQingYiSe()` (3302-3315)：清一色检测
- `isHunYiSe()` (3317-3331)：混一色检测
- `isPengPengHu()` (3280-3300)：碰碰胡检测

**规则特点：**
- 门清 +1番
- 自摸 +1番
- 七对子 +2番
- 碰碰胡 +2番
- 清一色 +3番
- 清碰 +4番
- 海底捞 +1番
- 八花报道 +8番

#### 多人模式（server.js:1347-1437）

**核心函数：**
- `calculateFan()` (1348-1396)：计算番数
- `checkPengPengHu()` (1399-1405)：碰碰胡检测
- `canFormAllPeng()` (1412-1437)：全刻子检测

**规则特点：**
- 清一色 +2番
- 碰碰胡 +1番
- 门清 +1番
- 自摸 +1番
- 杠开 +1番
- 花数独立计算

### 4. 特殊操作规则

#### 单人模式（mahjong/index.html:2446-3063）

**核心函数：**
- `doPeng()` (2523-2560)：碰牌操作
- `doGang()` (2562-2602)：杠牌操作
- `doDianPaoHu()` (2604-2619)：点炮胡牌
- `checkAndShowTing()` (2714-2745)：听牌检测
- `aiTurn()` (2945-2995)：AI回合逻辑
- `aiSelectDiscard()` (2998-3063)：AI出牌策略

**规则特点：**
- 上海敲麻规则：不能吃牌
- 支持碰、杠、胡操作
- 完整的AI对战逻辑
- 听牌后只能打刚摸的牌

#### 多人模式（server.js:823-1138）

**核心函数：**
- `playerDiscard()` (824-871)：玩家出牌
- `playerAction()` (976-1021)：玩家执行动作
- `checkActionsAfterDiscard()` (874-934)：检查出牌后动作
- `resolveActions()` (1024-1055)：解析动作优先级
- `executeAction()` (1058-1138)：执行动作

**规则特点：**
- 标准麻将规则：支持胡、杠、碰操作
- 动作优先级：胡 > 杠 > 碰
- 服务器端动作验证
- 超时自动处理

### 5. 游戏流程规则

#### 单人模式（mahjong/index.html:1894-2320）

**核心函数：**
- `startGame()` (1894-1964)：游戏初始化
- `autoDrawTile()` (2203-2239)：自动摸牌
- `discardSelected()` (2281-2315)：玩家出牌
- `nextPlayer()` (2317-2346)：下一个玩家
- `playerAutoDrawTile()` (2349-2419)：玩家自动摸牌

**规则特点：**
- 庄家14张牌，其他玩家13张
- 摸到花牌自动补花
- 轮流摸牌、出牌
- AI自动行动

#### 多人模式（server.js:449-620）

**核心函数：**
- `startGame()` (449-506)：游戏开始
- `playerDraw()` (761-821)：玩家摸牌
- `setDiscardTimeout()` (604-620)：设置出牌超时
- `autoDiscard()` (623-688)：自动出牌
- `notifyCurrentPlayer()` (578-601)：通知当前玩家

**规则特点：**
- 随机庄家
- 15秒出牌超时
- 超时自动出牌
- 断线AI接管
- 回合阶段：draw → discard → action

## 技术实现差异

### 1. 网络通信

**单人模式：**
- 纯前端实现，无网络通信
- 所有逻辑在浏览器中执行

**多人模式：**
- WebSocket实时通信（server.js:13-36）
- 客户端：Socket.io客户端（index.html:11）
- 服务器：Express + Socket.io（server.js:1-46）
- 支持实时消息传递和状态同步

### 2. 房间系统

**单人模式：**
- 无房间概念，直接开始游戏

**多人模式：**
- `MahjongRoom`类（server.js:146-164）
- `generateRoomCode()` (80-87)：生成6位房间号
- `addPlayer()` (167-275)：添加玩家
- `removePlayer()` (321-389)：移除玩家
- `fillWithAI()` (424-428)：填充AI玩家

### 3. 断线处理

**单人模式：**
- 无断线处理机制

**多人模式：**
- 断线标记（server.js:328-358）
- 重连恢复（server.js:172-244）
- AI接管机制（server.js:341-357）
- 离线超时检测

### 4. AI逻辑

**单人模式：**
- `aiTurn()` (2945-2995)：AI回合
- `aiSelectDiscard()` (2998-3063)：AI出牌策略
- 基于规则的简单AI

**多人模式：**
- `aiAction()` (1151-1199)：AI行动
- `aiDiscard()` (1202-1250)：AI出牌
- `aiDecideAction()` (1253-1273)：AI动作决策
- 支持AI接管离线玩家

## 调用逻辑对比

### 单人模式调用链

1. **游戏启动：** `startGame()` → `createDeck()` → `发牌` → `processInitialFlowers()`
2. **玩家回合：** `autoDrawTile()` → `checkHu()` → `discardSelected()` → `nextPlayer()`
3. **AI回合：** `aiTurn()` → `aiSelectDiscard()` → `nextPlayer()`
4. **动作处理：** `doAction()` → `doPeng()`/`doGang()`/`doDianPaoHu()`
5. **胡牌检测：** `canHu()` → `calculateFan()` → `endGame()`

### 多人模式调用链

1. **房间创建：** `createRoom()` → `addPlayer()` → `fillWithAI()`
2. **游戏开始：** `startGame()` → `shuffleDeck()` → `发牌` → `broadcastGameStart()`
3. **玩家操作：** `playerDraw()` → `playerDiscard()` → `checkActionsAfterDiscard()`
4. **动作处理：** `playerAction()` → `resolveActions()` → `executeAction()`
5. **AI操作：** `aiAction()` → `aiDiscard()` → `checkActionsAfterDiscard()`
6. **计分结算：** `calculateFan()` → `calculateHua()` → `endRound()`

## 关键文件与行号

### 单人模式（mahjong/index.html）

| 功能 | 行号 | 函数名 |
|------|------|--------|
| 牌组生成 | 1082-1117 | createDeck() |
| 花牌检测 | 1110-1117 | isFlowerTile() |
| 游戏启动 | 1894-1964 | startGame() |
| 自动摸牌 | 2203-2239 | autoDrawTile() |
| 玩家出牌 | 2281-2315 | discardSelected() |
| 碰牌操作 | 2523-2560 | doPeng() |
| 杠牌操作 | 2562-2602 | doGang() |
| 胡牌检测 | 3066-3090 | checkHu() |
| 番数计算 | 3214-3277 | calculateFan() |
| AI逻辑 | 2945-3063 | aiTurn(), aiSelectDiscard() |

### 多人模式前端（index.html）

| 功能 | 行号 | 函数名 |
|------|------|--------|
| WebSocket初始化 | 11 | socket.io.min.js |
| 房间创建 | 2083 | createRoom() |
| 加入房间 | 2094 | joinRoom() |
| 玩家准备 | 2129 | toggleReady() |
| 出牌操作 | 2237 | discardTile() |
| 动作处理 | 2248-2251 | doAction() |
| 聊天功能 | 2363-2379 | toggleChatPanel(), sendChat() |

### 多人模式后端（server.js）

| 功能 | 行号 | 函数名 |
|------|------|--------|
| 服务器初始化 | 1-46 | Express + Socket.io |
| 牌组生成 | 90-114 | createDeck(), isFlowerTile() |
| 房间管理 | 146-164 | MahjongRoom类 |
| 游戏开始 | 449-506 | startGame() |
| 玩家摸牌 | 761-821 | playerDraw() |
| 玩家出牌 | 824-871 | playerDiscard() |
| 动作检查 | 874-934 | checkActionsAfterDiscard() |
| 胡牌检测 | 1275-1343 | canHu(), checkWinningHand() |
| 计分系统 | 1347-1437 | calculateFan(), calculateHua() |
| AI逻辑 | 1151-1273 | aiAction(), aiDiscard() |

## 代码优化建议

### 1. 规则统一化

**建议：**
- 统一花牌规则：单人模式和多人模式的花牌定义不一致
- 统一番数计算：确保两种模式的番数规则相同
- 统一胡牌检测：使用相同的胡牌检测算法

**实现：**
- 将核心规则逻辑提取为独立模块
- 确保前后端规则验证一致
- 添加规则版本控制

### 2. 性能优化

**单人模式：**
- 使用 `requestAnimationFrame` 优化动画
- 减少DOM操作，使用虚拟列表
- 音频资源懒加载

**多人模式：**
- 实现增量状态同步，减少数据传输
- 使用WebSocket压缩
- 优化AI决策算法

### 3. 功能增强

**建议：**
- 添加自定义规则选项
- 支持更多麻将变种规则
- 实现游戏回放功能
- 添加好友系统和排行榜

## 总结

上海敲麻游戏的单人模式和多人模式在规则实现上存在显著差异：

1. **规则侧重点：**
   - 单人模式：专注于本地AI对战体验
   - 多人模式：专注于网络实时对战和完整规则

2. **技术架构：**
   - 单人模式：简单直接，适合快速体验
   - 多人模式：复杂健壮，支持多人协作

3. **用户体验：**
   - 单人模式：无需网络，随时随地可玩
   - 多人模式：社交互动，真实对战体验

4. **发展建议：**
   - 统一核心规则实现
   - 增强跨模式兼容性
   - 提升用户体验和功能完整性

通过对比分析，可以看出两种模式各有优势，适合不同的使用场景。统一规则实现将有助于提升整体游戏体验的一致性和可维护性。